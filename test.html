<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon-renma.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon-renma.png">
    <link rel="icon" type="image/png" href="web-app-manifest-192x192-renma.png">
    <title>練磨(防具) 統合ツール</title>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- 全体 --- */
        body {
            font-family: 'Meiryo', sans-serif;
            background-color: #2A2A2A;
            color: #eee;
            margin: 0;
            user-select: none;
        }

        .bottom2 {
            margin-top: 20px;
            font-size: 16pt;
            line-height: 2;
            text-align: center;
        }

        .bottom3 {
            margin-top: 20px;
            font-size: 16pt;
            line-height: 2;
            text-align: left;
        }

        /* --- レイアウトコンテナ --- */
        .main-container {
            padding: 0 20px 20px 20px; /* 上余白を0にし、ヘッダーがページ最上部にくるように */
            box-sizing: border-box;
        }
        
        .main-header {
            position: relative; /* 拡大・縮小ボタンの基準位置 */
            padding-bottom: 7px;
        }

        /* --- ヘッダー固定用のスタイル (ピン留め機能) --- */
        .main-header.pinned {
            position: sticky;
            top: 0;
            z-index: 998; /* サイドメニューより下、コンテンツより上 */
            background-color: #2A2A2A; /* スクロール時に下のコンテンツが透けないように背景色を指定 */
        }
        
        /* --- タブUI --- */
        .tabs {
            display: flex;
            border-bottom: 2px solid #555;
            margin-bottom: 0;
            flex-wrap: nowrap;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #383838;
            border: 1px solid #555;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            font-size: 1.1em;
            color: #ccc;
            transition: background-color 0.3s, color 0.3s;
            flex-basis: auto;
            text-align: center;
        }
        .tab-button:hover {
            background-color: #4a4a4a;
        }
        .tab-button.active {
            background-color: #424242;
            color: #50b4ff;
            border-color: #555;
            border-bottom: 2px solid #424242;
            margin-bottom: -2px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* --- ピン留めボタンのスタイル --- */
        .pin-button {
            /* margin-left: auto; を削除し、タブの直後に配置 */
            padding: 0px 5px;
            font-size: 1.5em;
            cursor: pointer;
            user-select: none;
            align-self: center; /* Flexコンテナ内で垂直中央に配置 */
        }

        /* --- 共通ヘッダー --- */
        h1 {
            margin: 0 0 15px 0;
            padding-top: 20px; /* main-containerの上余白の代わり */
            font-size: 1.8em;
            display: flex;
            align-items: center;
        }
        
        a:link { color: #1D9BF0; text-decoration: underline; }
        a:visited { color: #7755FF; text-decoration: underline; }
        a:hover { color: #0CFF57; }
        a:active { color: #FF0000; text-decoration: underline; }

        /* --- 共通UI: ハンバーガーメニュー --- */
        .hamburger {
            cursor: pointer;
            margin-right: 10px;
            user-select: none;
            color: #eee;

        }
        .hamburger:hover { color: #2A99E6; }
        .side-menu {
            position: fixed; top: 0; left: -320px; width: 320px; min-height: 100vh;
            height: 100%; text-align: left; background-color: #242424;
            border-right: 1px solid #555; transition: left 0.3s ease; z-index: 1001;
            padding: 20px; box-sizing: border-box; overflow-y: auto; overscroll-behavior: contain;
        }
        .side-menu.open { left: 0; }
        .menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 999;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .menu-overlay.open { opacity: 1; visibility: visible; }
        .menu-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #FF6E3D; }
        .menu-item { font-size: 18px; display: inline-block; padding: 6px 0; color: #eee; text-decoration: none; }
        .menu-item:hover { color: #0CFF57; }
        .toggle-button {
            cursor: pointer; color: #7755FF; text-decoration: underline; font-size: 18px;
            display: block; padding: 6px 0; user-select: none;
        }
        .toggle-button:hover { color: #0CFF57; }
        #linkList1, #linkList2 { display: none; }
        #linkList a { display: inline-block; text-decoration: none; color: #7755FF; }
        #linkList a:hover { color: #0CFF57; }

        /* --- 共通UI: ズームボタン --- */
        .zoom-buttons {
            position: absolute; /* 親要素(.main-header)を基準に配置 */
            top: 20px; /* h1のpadding-topに合わせる */
            right: 0; 
            display: flex;
            flex-direction: column; 
            gap: 5px; 
            z-index: 1000;
        }
        .zoom-buttons button { padding: 5px 10px; font-size: 14px; cursor: pointer; }
        
        .bottom-links {
            margin-top: 20px;
            font-size: 16pt;
            line-height: 2;
            text-align: left;
        }

        /* ============================================= */
        /* === 1. リスト (renma-armor.html) のスタイル === */
        /* ============================================= */
        #tab-list header {
            display: flex; flex-direction: column; align-items: stretch;
            gap: 15px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #555;
            margin-top: 8px;
        }
        #tab-list .header-controls {
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        #tab-list .header-controls .left-buttons, #tab-list .header-controls .right-buttons { display: flex; gap: 10px; }
        #tab-list button {
            padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer;
            font-size: 0.9em; transition: background-color 0.3s, box-shadow 0.3s;
        }
        #import-btn, #import-btn-footer { background-color: hotpink; color: white; }
        #export-btn, #export-btn-footer { background-color: orange; color: white; }
        #edit-mode-btn, #edit-mode-btn-footer { background-color: #007bff; color: white; }
        #edit-mode-btn.active, #edit-mode-btn-footer.active { background-color: #dc3545; }
        
        #export-btn.needs-export, #export-btn-footer.needs-export {
            background-color: #ff4500; /* オレンジレッド */
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 69, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
        }

        #import-file-input { display: none; }
        #parts-container { display: flex; flex-direction: column; gap: 15px; margin-top: 12px; }
        .armor-part {
            background-color: #424242; border: 1px solid #555; border-radius: 8px;
            padding: 18px 50px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #search-panel, #sort-panel { background-color: #2A2A2A; border-color: #555; }
        #search-panel.is-collapsed, #sort-panel.is-collapsed {
            min-height: 50px; padding-top: 0; padding-bottom: 0; cursor: pointer;
        }
        #search-panel.is-collapsed .favorite-toggle, #sort-panel.is-collapsed .favorite-toggle,
        #search-panel.is-collapsed .value-sort-btn, #sort-panel.is-collapsed .value-sort-btn { display: none; }
        #search-panel .part-content.collapsed, #sort-panel .part-content.collapsed { display: none; }
        .search-panel-info, .sort-panel-info {
            display: none; position: absolute; top: 50%; left: 40px; transform: translateY(-50%);
            color: #bbb; font-style: italic; white-space: nowrap;
        }
        #filter-btn { background-color: #28a745; color: white; width: 120px; min-height: 40px; }
        #filter-btn.is-active { background-color: #dc3545; }
        #sort-btn { background-color: darkviolet; color: white; width: 120px; min-height: 40px; }
        #tab-list .toggle-collapse-btn, #tab-list .add-part-inline-btn, #tab-list .delete-btn {
            position: absolute; right: 10px; width: 32px; height: 32px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; padding: 0;
            line-height: 1; font-weight: bold; user-select: none;
            font-size: 1.5em;
        }
        #tab-list .toggle-collapse-btn { top: 4px; background: transparent; color: white; font-size: 1.2em; }
        #search-panel.is-collapsed .toggle-collapse-btn, #sort-panel.is-collapsed .toggle-collapse-btn { top: 50%; transform: translateY(-50%); }
        #tab-list .delete-btn { top: 4px; background: transparent; color: white; }
        #tab-list .add-part-inline-btn { bottom: 10px; background-color: #28a745; color: white; border-radius: 50%; }
        .value-sort-btn {
            position: absolute; right: 10px; bottom: 5px; width: 32px; height: 32px;
            display: flex; justify-content: center; align-items: center; font-size: 1.2em;
            font-weight: bold; cursor: pointer; color: gray; user-select: none; border-radius: 5px;
        }
        .value-sort-btn.active { color: dodgerblue; }
        .drag-handle, .favorite-toggle {
            position: absolute; left: 5px; top: 50%; transform: translateY(-50%);
            font-size: 1.5em; padding: 5px; user-select: none;
        }
        .drag-handle { color: white; cursor: grab; display: none; }
        .drag-handle.is-favorite { color: gold; }
        .favorite-toggle { color: #eee; cursor: pointer; transition: color 0.2s; }
        .favorite-toggle.is-favorite { color: gold; }
        #tab-list footer { margin-top: 12px; padding-top: 10px; border-top: 2px solid #555; text-align: left; font-size: 1em; color: white; }
        #tab-list .custom-dropdown-button, #tab-list select {
            min-height: 40px; box-sizing: border-box; background-color: #555;
            color: white; border: 1px solid #777; border-radius: 4px;
            padding: 8px; font-size: 1em;
        }
        .ability-select { height: 40px; }
        input[type="number"].ability-value {
            width: 120px; min-height: 40px; box-sizing: border-box; background-color: #555;
            color: white; border: 1px solid #777; border-radius: 4px; font-size: 1.1em;
            padding: 8px; text-align: right; letter-spacing: 2px;
        }
        .container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .ability-section { margin-top: 10px; background-color: #2A2A2A; overflow: hidden; }
        .ability-section h2 { padding: 8px 12px; margin: 0 0 -1px 0; font-size: 1.2em; text-align: left; border: 1px solid #ccc; }
        #tab-list table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #tab-list th, #tab-list td { padding: 6px 12px; text-align: left; word-wrap: break-word; border: 1px solid #ccc; }
        #tab-list thead th { font-weight: bold; background-color: #333; }
        .ss-ability h2 { background-color: #C99004; color: #e0e0e0; }
        .s-ability h2 { background-color: #616161; color: #e0e0e0; }
        .a-ability h2 { background-color: #c62828; color: #e0e0e0; }
        .type-keigen { background-color: #2a3a4a; }
        .type-iryoku { background-color: #5c3c3c; }
        .type-mikata-iryoku { background-color: #6b4a37; }
        .type-nouryoku { background-color: #394a34; }
        .type-joutai-ijou { background-color: #4a3f5a; }
        #tab-list th:nth-child(3) { text-align: left; }
        #tab-list td:nth-child(3) { text-align: right; }
        .part-content, .form-section, .controls-wrapper { display: flex; gap: 8px; }
        .group-label { font-weight: bold; white-space: nowrap; min-width: 70px; text-align: right; margin-right: 2px; }
        .radio-group { display: flex; align-items: center; flex-shrink: 0; }
        .checkbox-group { display: flex; align-items: center; gap: 5px; min-height: 40px; justify-content: flex-end; width: 100%;}
        .checkbox-group label { cursor: pointer; }
        .part-content { flex-direction: column; }
        .form-section { display: grid; grid-template-columns: 80px 1fr; align-items: flex-start; }
        .controls-wrapper { flex-direction: column; align-items: flex-start; width: 100%; }
        .custom-dropdown, #tab-list select { width: 100%; }
        .group-label { padding-top: 8px; }
        .form-section:has(#approx-search-check), .form-section:has(#save-sort-check) { align-items: center; }
        .form-section:has(#approx-search-check) > .group-label, .form-section:has(#save-sort-check) > .group-label { padding-top: 0; }
        .search-panel-info, .sort-panel-info { font-size: 1.0em; }
        .radio-group input[type="radio"] { display: none; }
        .radio-group label {
            padding: 5px 15px; border: 1px solid #777; border-radius: 20px; cursor: pointer;
            background-color: #555; color: white; transition: all 0.2s; margin-right: 5px;
        }
        .radio-group input[type="radio"]:checked + label { background-color: #007bff; color: white; border-color: #007bff; }
        .value-input-group { display: flex; align-items: center; gap: 5px; }
        .value-input-group .symbol { font-size: 1.2em; font-weight: bold; color: white; display: none; }
        .custom-dropdown { position: relative; }
        .custom-dropdown-button { width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; font-weight: normal; }
        .custom-dropdown-button .button-arrow:after { content: '▼'; margin-left: 8px; font-size: 0.8em; }
        .custom-dropdown-panel {
            display: none; position: absolute; top: 100%; left: 0; width: 100%;
            max-height: 380px; background-color: #3a3a3a; border: 1px solid #777;
            border-radius: 4px; z-index: 100; margin-top: 4px; flex-direction: column; box-sizing: border-box;
        }
        .custom-dropdown-panel.show { display: flex; }
        .dropdown-search-input {
            width: calc(100% - 16px); margin: 8px; padding: 8px; border: 1px solid #777;
            border-radius: 4px; background-color: #555; color: white; box-sizing: border-box; font-size: 1em;
        }
        .dropdown-options-list { overflow-y: auto; flex-grow: 1; }
        .dropdown-option { padding: 8px 12px; cursor: pointer; font-size: 1em; }
        .dropdown-option:hover, .dropdown-option.focused { background-color: #007bff; }
        .dropdown-option.hidden { display: none; }
        .custom-dropdown-submenu {
            display: none; position: absolute; left: 100%; width: 200px;
            background-color: #3a3a3a; border: 1px solid #777; border-radius: 4px;
            z-index: 101; overflow-y: auto; margin-top: 4px;
        }
        .dropdown-option[data-has-submenu] { display: flex; justify-content: space-between; align-items: center; }
        .submenu-arrow { color: #aaa; font-size: 0.8em; }
        
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
        @media (min-width: 769px) {
            .form-section { display: flex; flex-direction: row; align-items: center; }
            .controls-wrapper { flex-direction: row; align-items: center; width: auto; }
            .custom-dropdown, #tab-list select { min-width: 270px; width: auto; }
            .group-label { padding-top: 0; }
        }
        @media (min-width: 1281px) { .part-content { flex-direction: row; align-items: center; flex-wrap: wrap; gap: 16px; } }
        
        /* ================================================= */
        /* === 2. TOP5確認 (armor-top5.html) のスタイル === */
        /* ================================================= */
        .top5-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 8px;
        }
        #tab-top5 .controls-container { text-align: center; border-radius: 8px;}
        #tab-top5 .checkbox-container { padding-top: 5px; margin-bottom: 20px; font-size: 16px; }
        #tab-top5 .checkbox-container label { cursor: pointer; }
        #tab-top5 .results-grid {
            display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
            max-width: 1400px; width: 100%; margin: 0 auto;
        }
        #tab-top5 .category-container {
            background-color: #383838; border: 1px solid #555; border-radius: 8px;
            padding: 20px; box-sizing: border-box; justify-content: center; flex-basis: 100%;
        }
        #tab-top5 h2 {
            color: #c0c0ff; margin-top: -5px; margin-bottom: 15px; border-bottom: 2px solid #555;
            padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        #tab-top5 .nav-buttons { display: flex; gap: 6px; }
        #tab-top5 .nav-button {
            background-color: #555; color: #eee; border: 1px solid #777; padding: 4px 8px;
            cursor: pointer; font-size: 12px; border-radius: 3px; transition: background-color 0.2s;
        }
        #tab-top5 .nav-button:hover { background-color: #666; }
        #tab-top5 .nav-button:disabled { background-color: #333; color: #666; cursor: default; opacity: 0.5; }
        #tab-top5 table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #tab-top5 th, #tab-top5 td { padding: 10px; border: 1px solid #777; text-align: left; word-wrap: break-word; }
        #tab-top5 thead th { background-color: #444; color: #fff; }
        #tab-top5 td.merged-ability-cell { vertical-align: top; color: #98fb98; border-bottom: none; }
        #tab-top5 .ability-total-cell { font-weight: bold; color: #f0e68c; vertical-align: bottom; border-top: none; text-align: right; }
        #tab-top5 .col-ability { width: 37%; }
        #tab-top5 .col-armor { width: 45%; }
        #tab-top5 .col-value { width: 18%; }
        #tab-top5 td.value-col { text-align: right; font-weight: bold; color: #ffd700; }
        #tab-top5 .combined-value { color: red !important; }
        #tab-top5 .combined-armor-name { color: orange; }
        #tab-top5 .special-armor-name { color: magenta; }
        #tab-top5 th.value-col { text-align: left; }
        @media (min-width: 1200px) { #tab-top5 .category-container { flex-basis: 45%; } }
        #top5-placeholder {
            display: none; 
            color: #ffd700;
            font-size: 1em;
            text-align: center;
            padding: 5px 0;
        }


        /* ==================================================== */
        /* === 3. 自動選定ツール (armor-calc.html) のスタイル === */
        /* ==================================================== */
        #tab-calc .file-input-container {
            border-radius: 8px; padding-top: 5px; margin-bottom: 20px; box-sizing: border-box; text-align: center;
            margin-top: 8px;
        }
        #file-status { margin-top: 0px; color: #ffd700; font-size: 1em; }
        #tab-calc .character-grid { margin-top: 0px; display: flex; flex-direction: column; gap: 20px; width: 100%; }
        #tab-calc .character-container { background-color: #383838; border: 1px solid #555; border-radius: 8px; padding: 20px; }
        #tab-calc h2 {
            color: #c0c0ff; margin: 0 0 15px 0; border-bottom: 2px solid #555; padding-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        #tab-calc .series-select {
            background-color: #444; color: #eee; border: 1px solid #777; border-radius: 4px;
            padding: 0 6px; font-size: 16px; margin-left: 10px; height: 30px; box-sizing: border-box;
        }
        #tab-calc .nav-buttons { display: flex; gap: 6px; margin-left: auto; }
        #tab-calc .nav-button {
            background-color: #555; color: #eee; border: 1px solid #777; padding: 4px 8px;
            cursor: pointer; font-size: 12px; border-radius: 3px; transition: background-color 0.2s;
        }
        #tab-calc .nav-button:hover { background-color: #666; }
        #tab-calc .nav-button:disabled { background-color: #333; color: #666; cursor: default; opacity: 0.5; }
        #tab-calc .form-horizontal-row { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px; }
        #tab-calc .form-section { display: block; padding: 15px; border: 1px solid #444; border-radius: 5px; }
        #tab-calc .form-section legend { font-weight: bold; color: #98fb98; padding: 0 5px; }
        #tab-calc .form-type .form-group { display: flex; gap: 25px; }
        #tab-calc .form-conditions { flex-grow: 1; }
        #tab-calc .conditions-wrapper { display: flex; flex-wrap: wrap; gap: 5px 10px; }
        #tab-calc .form-group label { display: inline-flex; align-items: center; gap: 5px; cursor: pointer; }
        #tab-calc .result-area {
            background-color: #2a2a2a; padding: 15px; border-radius: 5px;
            border: 1px dashed #777; display: flex; justify-content: space-between; align-items: center; gap: 20px;
        }
        #tab-calc .result-details { flex-grow: 1; }
        #tab-calc .result-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #tab-calc .result-table td { padding: 8px; text-align: left; vertical-align: middle; border-bottom: 1px solid #3a3a3a; }
        #tab-calc .result-table tr:last-child td { border-bottom: none; }
        #tab-calc .col-heading { width: 7%; } #tab-calc .col-armor { width: 33%; }
        #tab-calc .col-ability { width: 37%; } #tab-calc .col-value { width: 23%; }
        #tab-calc .data-label { display: inline-block; text-align: right; margin-right: 8px; color: #a0a0a0; }
        #tab-calc .heading-text { color: #c0c0ff; font-weight: bold; }
        #tab-calc .armor-text { color: #98fb98; } #tab-calc .ability-text { color: #ccc; }
        #tab-calc .value-text { color: #ffd700; font-weight: bold; }
        #tab-calc .total-container { padding-left: 20px; border-left: 1px solid #555; white-space: nowrap; text-align: right; }
        #tab-calc .total-container .total-row { display: flex; justify-content: space-between; align-items: baseline; gap: 15px; }
        #tab-calc .total-container .label { font-size: 16px; color: #a0a0a0; }
        #tab-calc .total-container .value { font-weight: bold; font-size: 24px; color: #ffd700; }
        #tab-calc .total-container .final-total .label, #tab-calc .total-container .final-total .value { color: red; }
        #tab-calc .global-controls { text-align: center; margin-top: 20px; }
        #calculate-all-button {
            background-color: #f0506e; color: #fff; border: none; padding: 15px 30px;
            border-radius: 8px; cursor: pointer; font-size: 20px; font-weight: bold;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }
        #calculate-all-button:hover:not(:disabled) { background-color: #c8405a; }
        #calculate-all-button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #tab-calc footer { border-top: 1px solid #eee; padding-top: 10px; font-size: 12pt; margin-top: 40px; }
        .styled-form-group { display: flex; align-items: center; flex-wrap: wrap; gap: 5px 10px; }
        .styled-form-group input[type="radio"], .styled-form-group input[type="checkbox"] { display: none; }
        .styled-form-group label {
            padding: 5px 15px; border: 1px solid #777; border-radius: 20px; cursor: pointer;
            background-color: #555; color: white; transition: all 0.2s; margin: 0; user-select: none;
        }
        .styled-form-group input[type="radio"]:checked + label, .styled-form-group input[type="checkbox"]:checked + label {
            background-color: #007bff; color: white; border-color: #007bff;
        }
        #tab-calc .form-type .styled-form-group { flex-wrap: nowrap; }
        .styled-form-group input[value="HP満タン時"]:checked + label,
        .styled-form-group input[value="瀕死時"]:checked + label,
        .styled-form-group input[value="カウンター"]:checked + label { background-color: forestgreen; border-color: forestgreen; }
        .styled-form-group input[value="熱"]:checked + label { background-color: red; border-color: red; }
        .styled-form-group input[value="冷"]:checked + label { background-color: dodgerblue; border-color: dodgerblue; }
        .styled-form-group input[value="雷"]:checked + label { background-color: darkorange; border-color: darkorange; }
        .styled-form-group input[value="陽"]:checked + label { background-color: orangered; border-color: orangered; }
        .styled-form-group input[value="陰"]:checked + label { background-color: darkorchid; border-color: darkorchid; }
        
        @media (max-width: 992px) {
            #tab-calc .result-table tr { display: block; padding: 10px 0; border-bottom: 1px solid #3a3a3a; }
            #tab-calc .result-table tr:last-child { border-bottom: none; padding-bottom: 0; }
            #tab-calc .result-table td { display: block; width: 100%; border-bottom: none; padding: 5px 0; }
            #tab-calc .col-heading, #tab-calc .col-armor, #tab-calc .col-ability, #tab-calc .col-value { width: auto; }
            #tab-calc .data-label { width: 90px; }
        }
        @media (max-width: 768px) {
            #tab-calc .result-area { flex-direction: column; align-items: stretch; }
            #tab-calc .total-container {
                border-left: none; border-top: 1px solid #555;
                padding-left: 0; padding-top: 15px; margin-top: 15px; text-align: right;
            }
            #tab-calc .total-container .total-row { justify-content: flex-end; }
        }
        
        @media (max-width: 480px) {
            h1 {
                display: block;
            }

            .armor-part { padding-left: 40px; padding-right: 20px; }
            .search-panel-info, .sort-panel-info { font-size: 0.8em; }
            .form-section { grid-template-columns: 65px 1fr; }
            .custom-dropdown, #tab-list select { min-width: 0; }
            #tab-calc .form-horizontal-row { flex-direction: column; align-items: stretch; }
            #tab-calc .form-type .styled-form-group { flex-wrap: wrap; }
        }
        
    </style>
</head>
<body>

  <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

  <div class="side-menu" id="sideMenu">
    <div class="menu-title">リユニのWeb版いろいろ</div>
    <a class="menu-item" href="kiokucalc.html">記憶再戦時間計算</a><br>
    <a class="menu-item" href="kiokucalc2.html">記憶再戦回数計算</a><br>
    </br>
    <a class="menu-item" href="ikuseicalc.html">育成効率比較ツール</a><br>
    <a class="menu-item" href="raidcalc.html">レイド周回効率比較ツール</a><br>
    </br>
    <a class="menu-item" href="renma-armor.html">練磨(防具)統合ツール</a><br>
    <span class="toggle-button" data-target="linkList3">練磨(防具)個別ページ</span>
    <div id="linkList3">
      ├ <a class="menu-item" href="armor-renma.html">練磨(防具)リスト</a><br>
      ├ <a class="menu-item" href="armor-top5.html">練磨(防具)TOP5確認</a><br>
      └ <a class="menu-item" href="armor-calc.html">練磨(防具)自動選定ツール</a><br>
    </div>
    </br>
    <span class="toggle-button" data-target="linkList1">アイテム獲得チェッカー</span>
    <div id="linkList1">
      ├ <a class="menu-item" href="checker-4gen.html">四元像ピアスチェッカー</a></br>
      ├ <a class="menu-item" href="checker-stella.html">ステライヤリングチェッカー</a></br>
      └ <a class="menu-item" href="checker-niji.html">虹瑠璃の腕輪チェッカー</a></br>
    </div>
    <span class="toggle-button" data-target="linkList2">アイテム獲得報告用</span>
    <div id="linkList2">
      ├ <a class="menu-item" href="report-4gen.html">四元像ピアス報告用</a></br>
      ├ <a class="menu-item" href="report-stella.html">ステライヤリング報告用</a></br>
      └ <a class="menu-item" href="report-niji.html">虹瑠璃の腕輪報告用</a></br>
    </div>
    </br>
    <a class="menu-item" href="expcalc.html">EXPスタンプ必要数計算</a><br>
    <a class="menu-item" href="https://jessy-rs.github.io/Multi-Stage-Slash/">多段斬りアプリ</a><br>
    </br>
    <a class="menu-item"  href="armor.html">装備候補検索ツール</a><br>
    <a class="menu-item"  href="style-info.html">スタイル情報ビューア</a><br>
    <br>
    <a class="menu-item" href="index.html">インデックスページ</a><br>
    </br>
  </div>

    <div class="main-container">
        <div class="main-header">
            <div class="zoom-buttons">
                <button onclick="changeZoom(0.1)">＋</button>
                <button onclick="changeZoom(-0.1)">－</button>
            </div>
            <h1>
                <span class="hamburger" onclick="toggleMenu()">☰</span>
                <span id="page-title">練磨(防具)リスト管理</span>
            </h1>
            
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('list', event)">リスト管理</button>
                <button class="tab-button" onclick="showTab('top5', event)">TOP5確認</button>
                <button class="tab-button" onclick="showTab('calc', event)">自動選定ツール</button>
                <span id="pin-button" class="pin-button">📍</span>
            </div>
        </div>

        <div id="tab-list" class="tab-content active">
            <header>
                <div class="header-controls">
                    <div class="left-buttons">
                        <button id="import-btn">インポート</button>
                        <input type="file" id="import-file-input" accept=".json">
                        <button id="export-btn">エクスポート</button>
                    </div>
                    <div class="right-buttons">
                        <button id="edit-mode-btn">編集モード開始</button>
                    </div>
                </div>
            </header>

            <main>
                <div id="search-panel" class="armor-part">
                    <div class="drag-handle" style="visibility: hidden;">☰</div>
                    <div class="favorite-toggle" data-favorite="false">☆</div>
                    <div class="part-content">
                        <div class="form-section">
                            <span class="group-label">防具種別:</span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="search-type-main" name="search-armor-type" value="main"><label for="search-type-main">主防具</label>
                                    <input type="radio" id="search-type-sub" name="search-armor-type" value="sub"><label for="search-type-sub">副防具</label>
                                </div>
                                <div class="custom-dropdown armor-name-dropdown">
                                    <button class="custom-dropdown-button" data-value=""><span class="button-label">防具を選択</span><span class="button-arrow"></span></button>
                                    <div class="custom-dropdown-panel">
                                        <input type="text" class="dropdown-search-input" placeholder="検索...">
                                        <div class="dropdown-options-list"></div>
                                    </div>
                                    <div class="custom-dropdown-submenu"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">練磨アビ:</span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="search-grade-ss" name="search-ability-grade" value="SS"><label for="search-grade-ss">SS</label>
                                    <input type="radio" id="search-grade-s" name="search-ability-grade" value="S"><label for="search-grade-s">S</label>
                                    <input type="radio" id="search-grade-a" name="search-ability-grade" value="A"><label for="search-grade-a">A</label>
                                </div>
                                <select class="ability-select"><option value="">アビリティを選択</option></select>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="approx-search-check">
                                    <label for="approx-search-check">近似</label>
                                </div>
                            </span>
                            <div class="controls-wrapper">
                                <button id="filter-btn">絞り込み</button>
                            </div>
                        </div>
                    </div>
                    <div class="search-panel-info">クリックして検索パネルを開く</div>
                    <button class="toggle-collapse-btn">▼</button>
                    <div id="search-value-sort" class="value-sort-btn" title="効果値で並び替え">9↓</div>
                </div>
                
                <div id="sort-panel" class="armor-part" style="display: none;">
                    <div class="drag-handle" style="visibility: hidden;">☰</div>
                    <div class="favorite-toggle" data-favorite="false">☆</div>
                    <div class="part-content">
                        <div class="form-section">
                            <span class="group-label">
                                <div class="sort-checkbox-group">
                                <input type="checkbox" id="sort-type-asc"><label for="sort-type-asc">昇順</label>
                                </div>
                            </span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="sort-type-main" name="sort-armor-type" value="main"><label for="sort-type-main">主防具</label>
                                    <input type="radio" id="sort-type-sub" name="sort-armor-type" value="sub"><label for="sort-type-sub">副防具</label>
                                </div>
                                <div class="custom-dropdown armor-name-dropdown">
                                    <button class="custom-dropdown-button" data-value=""><span class="button-label">防具を選択</span><span class="button-arrow"></span></button>
                                    <div class="custom-dropdown-panel">
                                        <input type="text" class="dropdown-search-input" placeholder="検索...">
                                        <div class="dropdown-options-list"></div>
                                    </div>
                                    <div class="custom-dropdown-submenu"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">
                                <div class="sort-checkbox-group">
                                <input type="checkbox" id="sort-ability-asc"><label for="sort-ability-asc">昇順</label>
                                </div>
                            </span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="sort-grade-ss" name="sort-ability-grade" value="SS"><label for="sort-grade-ss">SS</label>
                                    <input type="radio" id="sort-grade-s" name="sort-ability-grade" value="S"><label for="sort-grade-s">S</label>
                                    <input type="radio" id="sort-grade-a" name="sort-ability-grade" value="A"><label for="sort-grade-a">A</label>
                                </div>
                                <select class="ability-select"><option value="">アビリティを選択</option></select>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">
                                <div class="sort-checkbox-group">
                                    <input type="checkbox" id="save-sort-check">
                                    <label for="save-sort-check">保存</label>
                                </div>
                            </span>
                            <div class="controls-wrapper">
                                <button id="sort-btn">並び替え</button>
                            </div>
                        </div>
                    </div>
                    <div class="sort-panel-info">クリックして並び替えパネルを開く</div>
                    <button class="toggle-collapse-btn">▼</button>
                    <div id="sort-value-sort" class="value-sort-btn" title="効果値で並び替え">9↓</div>
                </div>
                <div id="parts-container"></div>
            </main>

            <template id="armor-part-template">
                <div class="armor-part" draggable="false">
                    <div class="drag-handle">☰</div>
                    <div class="favorite-toggle" data-favorite="false">☆</div>
                    <div class="part-content">
                        <div class="form-section">
                            <span class="group-label">防具種別:</span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="armor-main" name="armor-type" value="main" checked><label for="armor-main">主防具</label>
                                    <input type="radio" id="armor-sub" name="armor-type" value="sub"><label for="armor-sub">副防具</label>
                                </div>
                                <div class="custom-dropdown armor-name-dropdown">
                                    <button class="custom-dropdown-button" data-value=""><span class="button-label">防具を選択</span><span class="button-arrow"></span></button>
                                    <div class="custom-dropdown-panel">
                                        <input type="text" class="dropdown-search-input" placeholder="検索..."><div class="dropdown-options-list"></div>
                                    </div>
                                    <div class="custom-dropdown-submenu"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">練磨アビ:</span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="grade-ss" name="ability-grade" value="SS" checked><label for="grade-ss">SS</label>
                                    <input type="radio" id="grade-s" name="ability-grade" value="S"><label for="grade-s">S</label>
                                    <input type="radio" id="grade-a" name="ability-grade" value="A"><label for="grade-a">A</label>
                                </div>
                                <select class="ability-select"><option value="">アビリティを選択</option></select>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">効果値:</span>
                            <div class="controls-wrapper">
                                <div class="value-input-group">
                                    <span class="symbol prefix">+</span>
                                    <input type="number" class="ability-value">
                                    <span class="symbol suffix">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="delete-btn">×</button>
                    <button class="add-part-inline-btn">+</button>
                </div>
            </template>

            <footer>
                <div class="header-controls" style="margin-bottom: 20px;">
                    <div class="left-buttons">
                        <button id="import-btn-footer">インポート</button>
                        <input type="file" id="import-file-input-footer" accept=".json" style="display: none;">
                        <button id="export-btn-footer">エクスポート</button>
                    </div>
                    <div class="right-buttons">
                        <button id="edit-mode-btn-footer">編集モード開始</button>
                    </div>
                </div>
                <div id="footer-normal-notes">
                    ※使用は自己責任にて。<br>
                    ※アビリティの表記が実際のゲーム内の表記と異なる場合があります。<br>
                    ※検索で星が☆の状態の場合は★も検索対象に含まれます。<br>
                    ※検索で防具種別および練磨アビで、選択されているものを再度クリックすると、全選択解除されます。この状態では検索対象は”すべて”になります。<br>
                </div>
                <div id="footer-edit-notes" style="display: none;">
                    ※使用は自己責任にて。<br>
                    ※アビリティの表記が実際のゲーム内の表記と異なる場合があります。<br>
                    ※並び替え機能で昇順のチェックがオフの場合は降順で並び替えられます。<br>
                    ※並び替え機能で保存のチェックがオフの場合はプレビューとして、並び順が希望の順番になっていれば、保存のチェックをオンにして、再び並び替えボタンを押して状態を反映させてください。並び順が希望の順番になっていない場合は、編集モードを一度終了させる事でキャンセル出来ます。<br>
                </div>
            </footer>
            <div class="bottom-links">
                <a href="#">▲TOPへ戻る</a>　<a href="index.html">■INDEXへ戻る</a><br>
                <span id="toggle-max-value" style="cursor: pointer; color: dodgerblue; text-decoration: underline;">▼最大値確認</span>
            </div>
            <div class="container" style="display: none;">
                <div class="ability-section ss-ability">
                    <h2>SSアビリティ</h2>
                    <table><colgroup><col style="width: 40%;"><col style="width: 35%;"><col style="width: 25%;"></colgroup><thead><tr><th>種類</th><th>分類</th><th>最大値</th></tr></thead><tbody><tr class="type-keigen"><td>軽減</td><td>全</td><td>10%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>全</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>全</td><td>30%</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>全</td><td>+50</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力/器/速/知</td><td>+75</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>体/精/愛/魅</td><td>+75</td></tr></tbody></table>
                </div>
                <div class="ability-section s-ability">
                    <h2>Sアビリティ</h2>
                    <table><colgroup><col style="width: 40%;"><col style="width: 35%;"><col style="width: 25%;"></colgroup><thead><tr><th>種類</th><th>分類</th><th>最大値</th></tr></thead><tbody><tr class="type-keigen"><td>軽減</td><td>斬打突</td><td>15%</td></tr><tr class="type-keigen"><td>軽減</td><td>熱冷雷陽陰</td><td>15%</td></tr><tr class="type-keigen"><td>軽減</td><td>HP満タン時</td><td>30%</td></tr><tr class="type-keigen"><td>軽減</td><td>瀕死時</td><td>40%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>HP満タン時</td><td>400%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>瀕死時</td><td>600%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>カウンター</td><td>600%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>HP満タン時</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>瀕死時</td><td>200%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>カウンター</td><td>200%</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力/体</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力/器</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力/速</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力/知</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力/精</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力/愛</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力/魅</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>体/速</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>体/知</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>体/精</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>体/愛</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>体/魅</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>器/速</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>器/知</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>器/精</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>器/愛</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>器/魅</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>速/知</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>速/精</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>速/愛</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>速/魅</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>知/精</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>知/愛</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>知/魅</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>精/愛</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>精/魅</td><td>+100</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>愛/魅</td><td>+100</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>すべて</td><td>+100</td></tr></tbody></table>
                </div>
                <div class="ability-section a-ability">
                    <h2>Aアビリティ</h2>
                    <table><colgroup><col style="width: 40%;"><col style="width: 35%;"><col style="width: 25%;"></colgroup><thead><tr><th>種類</th><th>分類</th><th>最大値</th></tr></thead><tbody><tr class="type-keigen"><td>軽減</td><td>斬</td><td>30%</td></tr><tr class="type-keigen"><td>軽減</td><td>打</td><td>30%</td></tr><tr class="type-keigen"><td>軽減</td><td>突</td><td>30%</td></tr><tr class="type-keigen"><td>軽減</td><td>熱</td><td>30%</td></tr><tr class="type-keigen"><td>軽減</td><td>冷</td><td>30%</td></tr><tr class="type-keigen"><td>軽減</td><td>雷</td><td>30%</td></tr><tr class="type-keigen"><td>軽減</td><td>陽</td><td>30%</td></tr><tr class="type-keigen"><td>軽減</td><td>陰</td><td>30%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>斬</td><td>300%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>打</td><td>300%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>突</td><td>300%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>熱</td><td>300%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>冷</td><td>300%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>雷</td><td>300%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>陽</td><td>300%</td></tr><tr class="type-iryoku"><td>威力＋</td><td>陰</td><td>300%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>斬</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>打</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>突</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>熱</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>冷</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>雷</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>陽</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>味方威力＋</td><td>陰</td><td>100%</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>力</td><td>+150</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>体</td><td>+150</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>器</td><td>+150</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>速</td><td>+150</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>知</td><td>+150</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>精</td><td>+150</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>愛</td><td>+150</td></tr><tr class="type-nouryoku"><td>能力＋</td><td>魅</td><td>+150</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>毒</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>暗闇</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>スタン</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>マヒ</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>眠り</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>石化</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>混乱</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>魅了</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>狂戦士</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>状態異常耐性＋</td><td>気絶</td><td>+250</td></tr></tbody></table>
                </div>
            </div>
            <div class="bottom-links">
                <span id="toggle-max-value-bottom" style="cursor: pointer; color: dodgerblue; text-decoration: underline; display: none;">×確認を終了</span>
            </div>
        </div>

        <div id="tab-top5" class="tab-content">
            <div class="top5-content-wrapper">
                <div class="controls-container">
                    <div id="top5-placeholder">
                        「リスト管理」タブにてJSONファイルをインポートするか、データを登録してください。
                    </div>
                    <div class="checkbox-container">
                        <label>
                            <input type="checkbox" id="include-unique-ability" checked>
                            装備固有のアビリティも加味する
                        </label>
                    </div>
                </div>
            
                <div class="results-grid">
                    <div class="category-container" id="main-self">
                        <h2>
                            ■威力＋ (主防具)
                            <div class="nav-buttons">
                                <button class="nav-button" disabled>▲</button>
                                <button class="nav-button" onclick="scrollToCategory('sub-self')">▼</button>
                            </div>
                        </h2>
                        <div class="table-wrapper"></div>
                    </div>
                    <div class="category-container" id="sub-self">
                        <h2>
                            ■威力＋ (副防具)
                            <div class="nav-buttons">
                                <button class="nav-button" onclick="scrollToCategory('main-self')">▲</button>
                                <button class="nav-button" onclick="scrollToCategory('main-party')">▼</button>
                            </div>
                        </h2>
                        <div class="table-wrapper"></div>
                    </div>
                    <div class="category-container" id="main-party">
                        <h2>
                            ■味方威力＋ (主防具)
                            <div class="nav-buttons">
                                <button class="nav-button" onclick="scrollToCategory('sub-self')">▲</button>
                                <button class="nav-button" onclick="scrollToCategory('sub-party')">▼</button>
                            </div>
                        </h2>
                        <div class="table-wrapper"></div>
                    </div>
                    <div class="category-container" id="sub-party">
                        <h2>
                            ■味方威力＋ (副防具)
                            <div class="nav-buttons">
                                <button class="nav-button" onclick="scrollToCategory('main-party')">▲</button>
                                <button class="nav-button" disabled>▼</button>
                            </div>
                        </h2>
                        <div class="table-wrapper"></div>
                    </div>
                </div>
            
                <footer>
                    <br>
                    ※使用は自己責任にて。<br>
                    ※名将の鎧(+15)とバトルヴァンブレイス(+20)のシリーズ一致分は加味されていませんので注意してください。
                </footer>
    <div class="bottom2">
        <a href="#">▲TOPへ戻る</a>　<a href="index.html">■INDEXへ戻る</a>
    </div>
              </div>
        </div>

        <div id="tab-calc" class="tab-content">
            <div class="file-input-container">
                <p id="file-status">「リスト管理」タブにてJSONファイルをインポートするか、データを登録してください。</p>
            </div>
    
            <div class="character-grid" id="character-grid">
            </div>
    
            <div class="global-controls">
                <button class="calculate-button" id="calculate-all-button" disabled>全キャラクターをまとめて計算</button>
            </div>
            
            <footer>
                ※使用は自己責任にて。<br>
                ※最適な組み合わせが選定出来ない可能性もあります。あくまで参考としてお考えください。<br>
                ※名将の鎧の固有アビリティ考慮で威力＋選択のキャラにシリーズ指定した場合は、味方威力＋選択のキャラも威力＋選択のキャラとシリーズが同じであるなら必ず指定してください。<br>
                ※シリーズで「その他」を選択してもバトルヴァンブレイズに対応するものはありません。
            </footer>
    <div class="bottom3">
        <a href="#">▲TOPへ戻る</a>　<a href="index.html">■INDEXへ戻る</a>
    </div>
        </div>
    </div>
    
    <script>
    // =========================================================================
    // === グローバル変数と共通関数 ==================================================
    // =========================================================================
    let sharedArmorData = []; // 3つのタブで共有するJSONデータ
    let tabScrollPositions = { list: 0, top5: 0, calc: 0 };

    let isDataDirty = false;
    
    // --- CSVデータ用のグローバル変数 ---
    let armorMainData = [], armorSubData = [], renmaAbilityData = [], allArmorData = [];
    let mainNativeAbilities = new Map(); // 自動選定ツール用
    let subNativeAbilities = new Map();  // 自動選定ツール用
    let uniqueAbilities = {};            // TOP5確認用

    const PAGE_SETTING_KEY = 'PageSettings';
    const BACKUP_SETTINGS_KEY = 'RenmaArmorBackupSettings';
    const UNSAVED_DATA_KEY = 'RenmaArmorUnsavedData';
    let activeTab = 'list'; // 現在アクティブなタブを管理

    // 全ての設定をこのオブジェクトで管理
    let pageSettings = {
        'renma-armor_zoom1': 1.0,
        'renma-armor_zoom2': 1.0,
        'renma-armor_zoom3': 1.0,
        'renma-armor_pin': true // true: ピン留め, false: ピン留め解除
    };

    // タブ名と設定オブジェクトのプロパティ名を対応付ける
    const tabToZoomKey = {
        list: 'renma-armor_zoom1',
        top5: 'renma-armor_zoom2',
        calc: 'renma-armor_zoom3'
    };

    function loadPageSettings() {
        try {
            const savedSettings = localStorage.getItem(PAGE_SETTING_KEY);
            if (savedSettings) {
                pageSettings = { ...pageSettings, ...JSON.parse(savedSettings) };
            }
        } catch (error) {
            console.error("ページ設定の読み込みに失敗しました:", error);
        }
    }

    function savePageSettings() {
        try {
            localStorage.setItem(PAGE_SETTING_KEY, JSON.stringify(pageSettings));
        } catch (error) {
            console.error("ページ設定の保存に失敗しました:", error);
        }
    }

    function setDataDirty(isDirty) {
        isDataDirty = isDirty;
        const exportButtons = document.querySelectorAll('#export-btn, #export-btn-footer');
        exportButtons.forEach(button => {
            if (isDirty) {
                button.classList.add('needs-export');
                button.textContent = 'エクスポート (未保存)';
            } else {
                button.classList.remove('needs-export');
                button.textContent = 'エクスポート';
            }
        });

        if (isDirty) {
            // 未保存の変更があるため、バックアップを保存
            syncDataFromListTab();
            localStorage.setItem(UNSAVED_DATA_KEY, JSON.stringify(sharedArmorData));
            localStorage.setItem(BACKUP_SETTINGS_KEY, JSON.stringify({ hasUnsavedChanges: true }));
        } else {
            // データが保存されたとみなし、バックアップを削除
            localStorage.removeItem(UNSAVED_DATA_KEY);
            localStorage.setItem(BACKUP_SETTINGS_KEY, JSON.stringify({ hasUnsavedChanges: false }));
            
            // 警告メッセージが存在すれば削除
            const existingWarning = document.getElementById('backup-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
        }
    }


    // [新規] 「リスト管理」タブのデータを読み取り、共有データ変数を更新する関数
    function syncDataFromListTab() {
        const partsData = [];
        document.querySelectorAll('#parts-container .armor-part').forEach(part => {
            partsData.push({
                armorType: part.querySelector('input[name*="armor-type"]:checked')?.value || 'main',
                armorName: part.querySelector('.armor-name-dropdown .custom-dropdown-button').dataset.value,
                grade: part.querySelector('input[name*="ability-grade"]:checked')?.value || 'SS',
                abilityName: part.querySelector('.ability-select').value,
                value: part.querySelector('.ability-value').value,
                favorite: part.querySelector('.favorite-toggle').dataset.favorite === 'true'
            });
        });
        sharedArmorData = partsData;
    }


    // --- 共通関数 ---
    function showTab(tabName, event) {
        const previousTabName = activeTab;
        tabScrollPositions[previousTabName] = window.scrollY;

        const clickedButton = event.currentTarget;
        if (clickedButton.classList.contains('active') && window.scrollY > 0) {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            return;
        }

        activeTab = tabName;
        const zoomKey = tabToZoomKey[activeTab];
        document.body.style.zoom = pageSettings[zoomKey];

        if (tabName === 'top5' || tabName === 'calc') {
            syncDataFromListTab();
            if (tabName === 'top5') {
                updateTop5Tab(sharedArmorData);
            }
            if (tabName === 'calc') {
                updateCalcTab(sharedArmorData);
            }
        }

        const contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => {
            content.classList.remove('active');
        });

        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach(button => {
            button.classList.remove('active');
        });

        document.getElementById(`tab-${tabName}`).classList.add('active');
        if (event && event.currentTarget) {
             event.currentTarget.classList.add('active');
        } else {
             document.querySelector(`.tab-button[onclick*="showTab('${tabName}'"]`).classList.add('active');
        }
        
        const titles = {
            'list': '練磨(防具)リスト管理',
            'top5': '練磨(防具)アビリティ TOP5',
            'calc': '練磨(防具)自動選定ツール'
        };
        document.getElementById('page-title').textContent = titles[tabName];

        const newScrollY = tabScrollPositions[tabName] || 0;
        window.scrollTo(0, newScrollY);
    }
    
    function toggleMenu() {
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        sideMenu.classList.toggle('open');
        menuOverlay.classList.toggle('open');
    }

    function closeMenu() {
        document.getElementById('sideMenu').classList.remove('open');
        document.getElementById('menuOverlay').classList.remove('open');
    }

    function changeZoom(delta) {
        const zoomKey = tabToZoomKey[activeTab];
        let currentZoom = pageSettings[zoomKey];

        currentZoom += delta;
        if (currentZoom < 0.5) currentZoom = 0.5;
        if (currentZoom > 2.0) currentZoom = 2.0;
        
        document.body.style.zoom = currentZoom;
        
        pageSettings[zoomKey] = currentZoom;
        
        savePageSettings();
    }


    function scrollToCategory(categoryId) {
        const element = document.getElementById(categoryId);
        if (element) {
            const mainHeader = document.querySelector('.main-header');
            let headerHeight = 0;

            if (mainHeader.classList.contains('pinned')) {
                headerHeight = mainHeader.offsetHeight;
            }

            const elementPosition = element.getBoundingClientRect().top + window.scrollY;
            const offsetPosition = elementPosition - headerHeight;

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
    }

    // =========================================================================
    // === DOMContentLoaded: メイン処理 ============================================
    // =========================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        loadPageSettings();

        await initializeCommonData();

        initializeListTab();
        initializeTop5Tab();
        initializeCalcTab();

        setupCommonUI();

        const mainHeader = document.querySelector('.main-header');
        const pinButton = document.getElementById('pin-button');
        const isPinned = pageSettings['renma-armor_pin'];
        mainHeader.classList.toggle('pinned', isPinned);
        pinButton.textContent = isPinned ? '📍' : '📌';

        const initialZoomKey = tabToZoomKey[activeTab];
        document.body.style.zoom = pageSettings[initialZoomKey];
    });

    async function initializeCommonData() {
        [armorMainData, armorSubData, renmaAbilityData] = await Promise.all([
            loadCSV_list('data/armor-main.csv'),
            loadCSV_list('data/armor-sub.csv'),
            loadCSV_list('data/renma-armor.csv')
        ]);
        allArmorData = [...armorMainData, ...armorSubData];

        await Promise.all([
            loadCsvData_calc('data/armor-main-ability.csv', mainNativeAbilities),
            loadCsvData_calc('data/armor-sub-ability.csv', subNativeAbilities),
            loadUniqueAbilities_top5()
        ]);
    }

    function setupCommonUI() {
        document.querySelectorAll(".toggle-button").forEach(button => {
            const targetId = button.getAttribute("data-target");
            const list = document.getElementById(targetId);
            if(list) list.style.display = "none";
            button.addEventListener("click", () => {
                if (list.style.display === "block") list.style.display = "none";
                else list.style.display = "block";
            });
        });
        
        const pinButton = document.getElementById('pin-button');
        const mainHeader = document.querySelector('.main-header');

        pinButton.addEventListener('click', () => {
            const isPinned = mainHeader.classList.toggle('pinned');
            pinButton.textContent = isPinned ? '📍' : '📌';
            
            pageSettings['renma-armor_pin'] = isPinned;
            
            savePageSettings();
        });

        let startX = 0, startY = 0;
        document.addEventListener('touchstart', e => {
            startX = e.changedTouches[0].screenX;
            startY = e.changedTouches[0].screenY;
        }, false);

        document.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].screenX;
            const endY = e.changedTouches[0].screenY;
            const diffX = endX - startX;
            const diffY = endY - startY;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 50 && startX < 30) toggleMenu();
                else if (diffX < -50) closeMenu();
            }
        }, false);
        
        // ページ離脱時の警告機能
        window.addEventListener('beforeunload', (event) => {
            if (isDataDirty) {
                event.preventDefault();
            }
        });
    }
    
    // =========================================================================
    // === 1. リストタブ (renma-armor.html) のスクリプト =============================
    // =========================================================================
    
    async function loadCSV_list(filePath) {
        try {
            const response = await fetch(filePath);
            if (!response.ok) throw new Error(`Network response was not ok`);
            const text = await response.text();
            const rows = text.trim().split(/\r\n|\n/);
            const header = rows.shift().split(',');
            return rows.map(row => {
                const values = row.split(',');
                let obj = {};
                header.forEach((key, i) => { obj[key.trim()] = values[i] ? values[i].trim() : ''; });
                return obj;
            });
        } catch (error) {
            console.error(`Error loading CSV from ${filePath}:`, error);
            return [];
        }
    }
    
    function initializeListTab() {
        let isEditMode = false, sortableInstance = null;
        let originalPartOrder = [];
        let valueSortState = 0;

        const partsContainer = document.getElementById('parts-container');
        const searchPanel = document.getElementById('search-panel');
        const sortPanel = document.getElementById('sort-panel');
        const template = document.getElementById('armor-part-template');
        
        const warlordArmorSublist = ['GBSaGa','RS1','RS2','RS3','SF1','SF2','US','ES&IS','SSG','SaGaRS＆その他','SaGaEB'];
        const vanbraceArmorSublist = ['GBSaGa','RS1','RS2','RS3','SF1','SF2','US・ES・IS','SSG','SaGaRS','SaGaEB'];

        let applyFilterFunction = () => {};
        
        const hiraganaToKatakana = (str) => str ? str.replace(/[\u3041-\u3096]/g, match => String.fromCharCode(match.charCodeAt(0) + 0x60)) : '';
        const toHalfWidthBattleVanbrace = (str) => str.replace('バトルヴァンブレイス', 'ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ');

        function setupDropdown(part, armorType, options = {}) {
            const { addNone = false, addListOrder = false } = options;
            const dropdown = part.querySelector('.armor-name-dropdown');
            const button = dropdown.querySelector('.custom-dropdown-button');
            const label = button.querySelector('.button-label');
            const optionsList = dropdown.querySelector('.dropdown-options-list');
            const isControlPanel = part.id === 'search-panel' || part.id === 'sort-panel';

            let data = [];
            if (armorType) {
                data = (armorType === 'main' ? armorMainData : armorSubData);
            } else if (!isControlPanel) {
                data = allArmorData;
            }
            
            label.textContent = '防具を選択';
            button.dataset.value = '';
            optionsList.innerHTML = '';

            if (addNone) {
                const noneOption = document.createElement('div');
                noneOption.className = 'dropdown-option';
                noneOption.textContent = '※指定しない';
                noneOption.dataset.value = 'none';
                optionsList.appendChild(noneOption);
            }
            if (addListOrder) {
                const listOrderOption = document.createElement('div');
                listOrderOption.className = 'dropdown-option';
                listOrderOption.textContent = '※メニューの順番で並び替え';
                listOrderOption.dataset.value = 'list_order';
                optionsList.appendChild(listOrderOption);
            }

            data.forEach(item => {
                if (item.名称) {
                        if (item.名称 === '◆名将の鎧' || item.名称 === '☆バトルヴァンブレイス') {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'dropdown-option';
                        optionEl.dataset.hasSubmenu = 'true';
                        
                        const textSpan = document.createElement('span');
                        textSpan.textContent = item.名称;
                        
                        const arrowSpan = document.createElement('span');
                        arrowSpan.className = 'submenu-arrow';
                        arrowSpan.textContent = '▶';

                        optionEl.appendChild(textSpan);
                        optionEl.appendChild(arrowSpan);
                        optionsList.appendChild(optionEl);
                    } else {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'dropdown-option';
                        optionEl.textContent = item.名称;
                        optionEl.dataset.value = item.名称;
                        optionsList.appendChild(optionEl);
                    }
                }
            });
        }

        function setupAbilityDropdown(part, grade, options = {}) {
            const { addNone = false, addListOrder = false } = options;
            const selectEl = part.querySelector('.ability-select');
            const isControlPanel = part.id === 'search-panel' || part.id === 'sort-panel';

            let filteredData = [];
            if (grade) {
                filteredData = renmaAbilityData.filter(item => item.グレード === grade);
            } else if (!isControlPanel) {
                filteredData = renmaAbilityData;
            }
            
            selectEl.innerHTML = isControlPanel ? '' : '<option value="">アビリティを選択</option>';
            
            if (addNone) {
                const noneOption = document.createElement('option');
                noneOption.value = 'none';
                noneOption.textContent = '※指定しない';
                selectEl.appendChild(noneOption);
            }
                if (addListOrder) {
                const listOrderOption = document.createElement('option');
                listOrderOption.value = 'list_order';
                listOrderOption.textContent = '※メニューの順番で並び替え';
                selectEl.appendChild(listOrderOption);
            }

            filteredData.forEach(item => {
                if (item.種類) {
                    if (isControlPanel && item.種類 === "アビリティを選択") {
                        return; 
                    }
                    const optionEl = document.createElement('option');
                    optionEl.value = item.種類;
                    optionEl.textContent = item.種類;
                    selectEl.appendChild(optionEl);
                }
            });
            if (!isControlPanel) updateValueSymbol(part, '');
        }


        function updateValueSymbol(part, abilityName) {
            const prefix = part.querySelector('.symbol.prefix');
            const suffix = part.querySelector('.symbol.suffix');
            const ability = renmaAbilityData.find(item => item.種類 === abilityName);
            prefix.style.display = 'none';
            suffix.style.display = 'none';
            if (ability && ability.最大値) {
                if (ability.最大値.includes('%')) suffix.style.display = 'inline';
                else prefix.style.display = 'inline';
            }
        }
        function addNewPart(data = null, basePart = null, setDirty = true) { 
            const newPart = template.content.cloneNode(true).querySelector('.armor-part');
            const uniqueId = Date.now() + Math.random();
            newPart.querySelectorAll('input[type="radio"]').forEach(radio => {
                const oldId = radio.id;
                const newId = `${oldId}-${uniqueId}`;
                radio.id = newId;
                radio.name = `${radio.name}-${uniqueId}`;
                const label = newPart.querySelector(`label[for="${oldId}"]`);
                if(label) label.htmlFor = newId;
            });
            newPart.querySelector('.drag-handle').style.display = isEditMode ? 'block' : 'none';
            newPart.querySelector('.favorite-toggle').style.display = isEditMode ? 'none' : 'block';
            newPart.dataset.originalIndex = partsContainer.children.length;

            if (basePart) {
                basePart.after(newPart);
            } else {
                partsContainer.appendChild(newPart);
            }

            if (data) {
                const armorTypeRadio = newPart.querySelector(`input[name*="armor-type"][value="${data.armorType}"]`);
                if (armorTypeRadio) armorTypeRadio.checked = true;
                setupDropdown(newPart, data.armorType);
                const armorBtn = newPart.querySelector('.armor-name-dropdown .custom-dropdown-button');
                
                const armorName = data.armorName || '';
                armorBtn.querySelector('.button-label').textContent = armorName || '防具を選択';
                armorBtn.dataset.value = armorName;

                const gradeRadio = newPart.querySelector(`input[name*="ability-grade"][value="${data.grade}"]`);
                if (gradeRadio) gradeRadio.checked = true;
                setupAbilityDropdown(newPart, data.grade);
                newPart.querySelector('.ability-select').value = data.abilityName;
                updateValueSymbol(newPart, data.abilityName);
                newPart.querySelector('.ability-value').value = data.value;
                const favoriteToggle = newPart.querySelector('.favorite-toggle');
                if (data.favorite) {
                    favoriteToggle.textContent = '★';
                    favoriteToggle.dataset.favorite = 'true';
                    favoriteToggle.classList.add('is-favorite');
                }
            } else {
                setupDropdown(newPart, 'main');
                setupAbilityDropdown(newPart, 'SS');
            }
            
            if (setDirty) {
                setDataDirty(true);
            }
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const scrollY = window.scrollY;
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error("JSON is not an array.");
                    
                    if (isEditMode) {
                        toggleEditMode();
                    }
                    
                    partsContainer.innerHTML = '';
                    // インポート時はsetDirtyをfalseにして、最後にまとめて状態管理する
                    data.forEach(partData => addNewPart(partData, null, false));
                    originalPartOrder = Array.from(partsContainer.children);

                    syncDataFromListTab();
                    updateTop5Tab(sharedArmorData);
                    updateCalcTab(sharedArmorData);
                    
                    // インポート成功時は「保存済み」状態にする（バックアップもクリア）
                    setDataDirty(false);

                } catch (error) {
                    alert('JSONファイルの読み込みに失敗しました。\n' + error);
                    console.error(error);
                }
                window.scrollTo(0, scrollY);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        document.getElementById('tab-list').addEventListener('focusin', (e) => {
            if (e.target.classList.contains('ability-value')) {
                e.target.select();
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.custom-dropdown-panel.show').forEach(panel => {
                    panel.classList.remove('show');
                    panel.querySelectorAll('.focused').forEach(opt => opt.classList.remove('focused'));
                    const submenu = panel.parentElement.querySelector('.custom-dropdown-submenu');
                    if (submenu) {
                        submenu.style.display = 'none';
                    }
                });
            }
        });

        document.getElementById('tab-list').addEventListener('input', (e) => {
            if(e.target.closest('.armor-part') && !e.target.closest('#search-panel') && !e.target.closest('#sort-panel')) {
                setDataDirty(true);
            }
        });

        document.getElementById('tab-list').addEventListener('input', (e) => {
            if (e.target.classList.contains('dropdown-search-input')) {
                const searchTerm = hiraganaToKatakana(e.target.value).toLowerCase();
                const panel = e.target.closest('.custom-dropdown-panel');
                if (!panel) return;
                const optionsList = panel.querySelector('.dropdown-options-list');
                if (!optionsList) return;

                optionsList.querySelectorAll('.dropdown-option').forEach(option => {
                    let textToCompare = '';
                    if (option.dataset.hasSubmenu) {
                        const textSpan = option.querySelector('span:first-child');
                        textToCompare = textSpan ? textSpan.textContent : '';
                    } else {
                        textToCompare = option.textContent;
                    }
                    const optionText = hiraganaToKatakana(textToCompare).toLowerCase();
                    if (optionText.includes(searchTerm)) {
                        option.style.display = ''; 
                    } else {
                        option.style.display = 'none';
                    }
                });
            }
        });
        
        document.getElementById('tab-list').addEventListener('change', e => {
            const part = e.target.closest('.armor-part');
            if(!part) return;
            const isSearchPanel = part.id === 'search-panel';
            const isSortPanel = part.id === 'sort-panel';

            if (!isSearchPanel && !isSortPanel) {
                setDataDirty(true);
            }

            if(e.target.matches('.ability-select')){
                if (!isSearchPanel && !isSortPanel) updateValueSymbol(part, e.target.value);
            } else if (e.target.matches('input[name*="armor-type"]')) {
                const checkedRadio = e.target.closest('.radio-group').querySelector('input:checked');
                const options = { addNone: isSearchPanel || isSortPanel, addListOrder: isSortPanel && !!checkedRadio };
                setupDropdown(part, checkedRadio ? checkedRadio.value : null, options);
                
                if (isSearchPanel) {
                    const armorBtn = part.querySelector('.armor-name-dropdown .custom-dropdown-button');
                    armorBtn.dataset.value = 'none';
                    armorBtn.querySelector('.button-label').textContent = '※指定しない';
                    if (document.getElementById('filter-btn').classList.contains('is-active')) {
                        applyFilterFunction();
                    }
                } else if (isSortPanel) {
                    const armorBtn = part.querySelector('.armor-name-dropdown .custom-dropdown-button');
                    armorBtn.dataset.value = 'none';
                    armorBtn.querySelector('.button-label').textContent = '※指定しない';
                } else {
                    const armorBtn = part.querySelector('.armor-name-dropdown .custom-dropdown-button');
                    armorBtn.dataset.value = '';
                    armorBtn.querySelector('.button-label').textContent = '防具を選択';
                }

            } else if (e.target.matches('input[name*="ability-grade"]')) {
                const checkedRadio = e.target.closest('.radio-group').querySelector('input:checked');
                const options = { addNone: isSearchPanel || isSortPanel, addListOrder: isSortPanel && !!checkedRadio };
                setupAbilityDropdown(part, checkedRadio ? checkedRadio.value : null, options);
                
                if (isSearchPanel) {
                    part.querySelector('.ability-select').value = 'none';
                        if (document.getElementById('filter-btn').classList.contains('is-active')) {
                        applyFilterFunction();
                    }
                } else if (isSortPanel) {
                        part.querySelector('.ability-select').value = 'none';
                } else {
                        part.querySelector('.ability-select').value = '';
                }
            }
        });

        document.getElementById('tab-list').addEventListener('click', (e) => {
            const target = e.target;
            const part = target.closest('.armor-part');

            if (target.matches('.favorite-toggle') && !isEditMode && !target.closest('#search-panel') && !target.closest('#sort-panel')) {
                const isFavorite = target.dataset.favorite === 'true';
                target.dataset.favorite = String(!isFavorite);
                target.textContent = isFavorite ? '☆' : '★';
                target.classList.toggle('is-favorite');
                setDataDirty(true);
                return;
            }
            
            if (target.closest('.custom-dropdown-button')) {
                const button = target.closest('.custom-dropdown-button');
                const panel = button.nextElementSibling;
                const isOpening = !panel.classList.contains('show');
                
                document.querySelectorAll('.custom-dropdown-submenu').forEach(submenu => submenu.style.display = 'none');
                
                document.querySelectorAll('.custom-dropdown-panel.show').forEach(p => {
                    if (p !== panel) {
                        p.classList.remove('show');
                        p.querySelectorAll('.focused').forEach(opt => opt.classList.remove('focused'));
                    }
                });
                
                panel.classList.toggle('show');

                if (!isOpening) {
                    panel.querySelectorAll('.focused').forEach(opt => opt.classList.remove('focused'));
                    const submenu = panel.parentElement.querySelector('.custom-dropdown-submenu');
                    if (submenu) submenu.style.display = 'none';
                } else {
                    const searchInput = panel.querySelector('.dropdown-search-input');
                    if (searchInput) searchInput.value = '';
                    
                    panel.querySelectorAll('.dropdown-option').forEach(opt => {
                        opt.style.display = '';
                        opt.classList.remove('hidden');
                    });

                    const optionsList = panel.querySelector('.dropdown-options-list');
                    optionsList.querySelectorAll('.focused').forEach(opt => opt.classList.remove('focused'));

                    const selectedValue = button.dataset.value;
                    let selectedOption = null;

                    if (selectedValue && selectedValue !== 'none' && selectedValue !== 'list_order') {
                        const selectedText = button.querySelector('.button-label').textContent;
                        selectedOption = optionsList.querySelector(`.dropdown-option[data-value="${selectedValue}"]`);

                        if (!selectedOption) {
                            const match = selectedText.match(/(.+)\(.*\)/);
                            let parentText = match ? match[1] : null;

                            if (parentText) {
                                parentText = parentText.replace('ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ', 'バトルヴァンブレイス');
                            }

                            if (parentText) {
                                const parentOptions = optionsList.querySelectorAll('.dropdown-option[data-has-submenu]');
                                for (const opt of parentOptions) {
                                    const optText = opt.querySelector('span')?.textContent;
                                    if (optText === parentText) {
                                        selectedOption = opt;
                                        break;
                                    }
                                }
                            }
                        }
                    }

                    if (selectedOption) {
                        selectedOption.classList.add('focused');
                        selectedOption.scrollIntoView({ block: 'nearest' });
                    } else {
                        optionsList.scrollTop = 0;
                    }
                }
            }
            else if (target.matches('.dropdown-option') && !target.dataset.hasSubmenu) {
                const dropdown = target.closest('.custom-dropdown');
                const button = dropdown.querySelector('.custom-dropdown-button');
                const label = button.querySelector('.button-label');
                let value, text;

                if (target.dataset.parent) {
                    let parentName = target.dataset.parent;
                    const valueText = target.textContent;

                    if (target.dataset.value && (target.dataset.value.includes('(全対象)') || target.dataset.value.includes('(シリーズ順)'))) {
                            text = target.dataset.value;
                            value = target.dataset.value;
                    } else {
                        if (parentName === '☆バトルヴァンブレイス') {
                            parentName = toHalfWidthBattleVanbrace(parentName);
                        }
                        text = `${parentName}(${valueText})`;
                        value = text;
                    }
                } else {
                    text = target.textContent;
                    value = target.dataset.value;
                }

                if (button.dataset.value !== value) {
                    if (button.closest('.armor-part') && !button.closest('#search-panel') && !button.closest('#sort-panel')) {
                        setDataDirty(true);
                    }
                }

                label.textContent = text;
                button.dataset.value = value;
                
                const mainPanel = dropdown.querySelector('.custom-dropdown-panel');
                const submenu = dropdown.querySelector('.custom-dropdown-submenu');
                if (mainPanel) mainPanel.classList.remove('show');
                if (submenu) submenu.style.display = 'none';
            }
            else if (part && target.matches('.add-part-inline-btn')) {
                addNewPart(null, part);
                if (isEditMode) {
                    originalPartOrder = Array.from(partsContainer.children);
                }
            }
            else if (part && target.matches('.delete-btn')) {
                const deletablePanelCount = document.querySelectorAll('#tab-list .armor-part .delete-btn').length;

                if (deletablePanelCount > 1) {
                    const scrollY = window.scrollY;
                    part.remove();
                    if (isEditMode) {
                        originalPartOrder = Array.from(partsContainer.children);
                    }
                    setDataDirty(true);
                    window.scrollTo(0, scrollY);
                }
            }
        });

        document.getElementById('tab-list').addEventListener('mouseover', e => {
            const option = e.target.closest('.dropdown-option');
            if (!option) return;

            const optionsList = option.closest('.dropdown-options-list');
            if (optionsList) {
                optionsList.querySelectorAll('.focused').forEach(opt => opt.classList.remove('focused'));
            }

            const panel = option.closest('.custom-dropdown-panel');
            if (!panel) return;

            const submenu = panel.parentElement.querySelector('.custom-dropdown-submenu');
            if (!submenu) return;

            if (option.dataset.hasSubmenu) {
                submenu.innerHTML = '';
                const parentText = option.querySelector('span').textContent;
                let sublist = [];
                let formattedParentText = parentText;

                if (parentText === '◆名将の鎧') {
                    sublist = warlordArmorSublist;
                } else if (parentText === '☆バトルヴァンブレイス') {
                    sublist = vanbraceArmorSublist;
                    formattedParentText = toHalfWidthBattleVanbrace(parentText);
                }

                const parentPart = option.closest('.armor-part');
                if (parentPart && (parentPart.id === 'search-panel' || parentPart.id === 'sort-panel')) {
                    const allSeriesOption = document.createElement('div');
                    allSeriesOption.className = 'dropdown-option';
                    allSeriesOption.textContent = '全対象';
                    allSeriesOption.dataset.value = `${formattedParentText}(全対象)`;
                    allSeriesOption.dataset.parent = parentText;
                    submenu.appendChild(allSeriesOption);

                    if (parentPart.id === 'sort-panel') {
                        const seriesOrderOption = document.createElement('div');
                        seriesOrderOption.className = 'dropdown-option';
                        seriesOrderOption.textContent = 'シリーズ順';
                        seriesOrderOption.dataset.value = `${formattedParentText}(シリーズ順)`;
                        seriesOrderOption.dataset.parent = parentText;
                        submenu.appendChild(seriesOrderOption);
                    }
                }
                
                sublist.forEach(subItemText => {
                    const subOption = document.createElement('div');
                    subOption.className = 'dropdown-option';
                    subOption.textContent = subItemText;
                    subOption.dataset.value = subItemText;
                    subOption.dataset.parent = parentText;
                    submenu.appendChild(subOption);
                });
                
                submenu.style.display = 'block';

                const listRect = optionsList.getBoundingClientRect();
                const optionRect = option.getBoundingClientRect();
                const buffer = 5; 

                if (optionRect.bottom > listRect.bottom - buffer) {
                    optionsList.scrollTop += (optionRect.bottom - listRect.bottom + buffer);
                } else if (optionRect.top < listRect.top + buffer) {
                    optionsList.scrollTop -= (listRect.top - optionRect.top + buffer);
                }

            } else if (!e.target.closest('.custom-dropdown-submenu')) {
                submenu.style.display = 'none';
            }
        });

        function exportData() {
            syncDataFromListTab();
            const jsonString = JSON.stringify(sharedArmorData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '練磨_防具_リスト.json';
            a.click();
            URL.revokeObjectURL(a.href);
            // エクスポート後は「保存済み」状態にする（バックアップもクリア）
            setDataDirty(false);
        }

        function setupRadioDeselection(panel) {
            panel.querySelectorAll('.radio-group').forEach(group => {
                if (group.dataset.radioToggleHandler) return;
                group.dataset.radioToggleHandler = 'true';
                
                let wasCheckedOnMousedown = false;

                group.addEventListener('mousedown', e => {
                    const el = e.target;
                    if (el.tagName !== 'INPUT' && el.tagName !== 'LABEL') return;

                    const radio = el.type === 'radio' ? el : document.getElementById(el.htmlFor);
                    if (radio) {
                        wasCheckedOnMousedown = radio.checked;
                    }
                });

                group.addEventListener('click', e => {
                    const el = e.target;
                    if (el.tagName !== 'INPUT' && el.tagName !== 'LABEL') return;

                    if (wasCheckedOnMousedown) {
                        const radio = el.type === 'radio' ? el : document.getElementById(el.htmlFor);
                        if (radio) {
                            e.preventDefault();
                            radio.checked = false;
                            radio.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }
                });
            });
        }
        
        function setupSearchPanel() {
            const filterBtn = document.getElementById('filter-btn');
            const collapseBtn = searchPanel.querySelector('.toggle-collapse-btn');
            const content = searchPanel.querySelector('.part-content');
            const infoText = searchPanel.querySelector('.search-panel-info');
            const approxCheck = document.getElementById('approx-search-check');

            searchPanel.querySelectorAll('input[type=radio]').forEach(radio => radio.checked = false);
            approxCheck.checked = false;
            
            function deactivateFilter() {
                const filterBtn = document.getElementById('filter-btn');
                if (filterBtn.classList.contains('is-active')) {
                    const scrollY = window.scrollY;
                    originalPartOrder.forEach(part => partsContainer.appendChild(part));
                    document.querySelectorAll('#parts-container .armor-part').forEach(part => {
                        part.style.display = '';
                    });
                    filterBtn.textContent = '絞り込み';
                    filterBtn.classList.remove('is-active');
                    updateInfoText();
                    resetValueSortButtons();
                    window.scrollTo(0, scrollY);
                }
            }
            window.deactivateFilter = deactivateFilter;

            function applyFilter() {
                const scrollY = window.scrollY;
                const checkedArmorTypeRadio = searchPanel.querySelector('input[name="search-armor-type"]:checked');
                const filterArmorType = checkedArmorTypeRadio ? checkedArmorTypeRadio.value : null;
                
                const armorDropdown = searchPanel.querySelector('.armor-name-dropdown .custom-dropdown-button');
                const filterArmorName = armorDropdown.dataset.value === 'none' ? '' : armorDropdown.dataset.value;

                const checkedGradeRadio = searchPanel.querySelector('input[name="search-ability-grade"]:checked');
                const filterGrade = checkedGradeRadio ? checkedGradeRadio.value : null;
                
                const abilitySelect = searchPanel.querySelector('.ability-select');
                const filterAbilityName = abilitySelect.value === 'none' ? '' : abilitySelect.value;
                
                const isApprox = approxCheck.checked;
                const filterFavorite = searchPanel.querySelector('.favorite-toggle').dataset.favorite === 'true';
                
                let visibleParts = [];
                originalPartOrder.forEach(part => {
                    partsContainer.appendChild(part);
                    const partArmorType = part.querySelector('input[name*="armor-type"]:checked').value;
                    const partArmorName = part.querySelector('.armor-name-dropdown .custom-dropdown-button').dataset.value;
                    const partGrade = part.querySelector('input[name*="ability-grade"]:checked').value;
                    const partAbilityName = part.querySelector('.ability-select').value;
                    const partFavorite = part.querySelector('.favorite-toggle').dataset.favorite === 'true';

                    const typeMatch = !filterArmorType || filterArmorType === partArmorType;
                    
                    let nameMatch = false;
                    if (!filterArmorName) {
                        nameMatch = true; 
                    } else if (filterArmorName === '◆名将の鎧(全対象)') {
                        nameMatch = partArmorName.startsWith('◆名将の鎧');
                    } else if (filterArmorName === '☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ(全対象)') {
                        nameMatch = partArmorName.startsWith('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ');
                    } else {
                        const parentArmorMatch = partArmorName.match(/(.+)\((.+)\)/);
                        if (parentArmorMatch) {
                            const parentName = parentArmorMatch[1];
                            nameMatch = filterArmorName === parentName || filterArmorName === partArmorName;
                        } else {
                            nameMatch = filterArmorName === partArmorName;
                        }
                    }

                    const gradeMatch = !filterGrade || filterGrade === partGrade;
                    const favoriteMatch = !filterFavorite || partFavorite;
                    
                    let abilityMatch = false;
                    if (isApprox && filterAbilityName && partAbilityName) {
                        const searchTerm = filterAbilityName.split('(')[0];
                        abilityMatch = partAbilityName.startsWith(searchTerm);
                    } else {
                        abilityMatch = (filterAbilityName === "" || filterAbilityName === partAbilityName);
                    }

                    const isVisible = typeMatch && nameMatch && gradeMatch && abilityMatch && favoriteMatch;
                    part.style.display = isVisible ? '' : 'none';
                    if (isVisible) {
                        visibleParts.push(part);
                    }
                });

                if (valueSortState > 0) {
                    visibleParts.sort((a, b) => {
                        const valA = parseFloat(a.querySelector('.ability-value').value) || 0;
                        const valB = parseFloat(b.querySelector('.ability-value').value) || 0;
                        return valueSortState === 1 ? valB - valA : valA - valB;
                    });
                    visibleParts.forEach(part => partsContainer.appendChild(part));
                }
                window.scrollTo(0, scrollY);
            }
            applyFilterFunction = applyFilter;
            
            function triggerLiveFilter() {
                if (filterBtn.classList.contains('is-active')) {
                    applyFilter();
                }
            }

            function updateInfoText() {
                const isFilterActive = filterBtn.classList.contains('is-active');
                if (searchPanel.classList.contains('is-collapsed')) {
                    if (isFilterActive) {
                        infoText.textContent = '絞り込み中...';
                        infoText.style.color = 'red';
                    } else {
                        infoText.textContent = 'クリックして検索パネルを開く';
                        infoText.style.color = '#bbb';
                    }
                    infoText.style.display = 'block';
                } else {
                    infoText.style.display = 'none';
                }
            }

            function toggleCollapse(shouldCollapse) {
                searchPanel.classList.toggle('is-collapsed', shouldCollapse);
                content.style.display = shouldCollapse ? 'none' : '';
                collapseBtn.textContent = shouldCollapse ? '▼' : '▲';
                updateInfoText();
            }

            searchPanel.addEventListener('click', (e) => {
                const target = e.target;
                if (searchPanel.classList.contains('is-collapsed') && !target.closest('button')) {
                    toggleCollapse(false);
                } else if (target.matches('.dropdown-option') && target.closest('#search-panel')) {
                    setTimeout(triggerLiveFilter, 0);
                } else if (target.matches('.favorite-toggle')) {
                    const isFavorite = target.dataset.favorite === 'true';
                    target.dataset.favorite = String(!isFavorite);
                    target.textContent = isFavorite ? '☆' : '★';
                    target.classList.toggle('is-favorite');
                    triggerLiveFilter();
                }
            });

            searchPanel.addEventListener('change', triggerLiveFilter);

            collapseBtn.addEventListener('click', () => {
                    toggleCollapse(!searchPanel.classList.contains('is-collapsed'));
            });
            
            setupDropdown(searchPanel, null, { addNone: true });
            setupAbilityDropdown(searchPanel, null, { addNone: true });
            setupRadioDeselection(searchPanel);
            
            const armorBtn = searchPanel.querySelector('.armor-name-dropdown .custom-dropdown-button');
            armorBtn.dataset.value = 'none';
            armorBtn.querySelector('.button-label').textContent = '※指定しない';
            searchPanel.querySelector('.ability-select').value = 'none';


            filterBtn.addEventListener('click', () => {
                const isActive = filterBtn.classList.contains('is-active');
                if(!isActive) {
                    originalPartOrder = Array.from(partsContainer.children);
                    applyFilter();
                    filterBtn.textContent = '解除';
                } else {
                    deactivateFilter();
                }
                filterBtn.classList.toggle('is-active', !isActive);
                updateInfoText();
            });
            
            toggleCollapse(true);
        }

        function setupSortPanel() {
            const collapseBtn = sortPanel.querySelector('.toggle-collapse-btn');
            const content = sortPanel.querySelector('.part-content');
            const infoText = sortPanel.querySelector('.sort-panel-info');
            const sortBtn = document.getElementById('sort-btn');
            
            function toggleCollapse(shouldCollapse) {
                sortPanel.classList.toggle('is-collapsed', shouldCollapse);
                content.style.display = shouldCollapse ? 'none' : '';
                infoText.style.display = shouldCollapse ? 'block' : 'none';
                collapseBtn.textContent = shouldCollapse ? '▼' : '▲';

                if (sortableInstance) {
                    sortableInstance.option('disabled', !shouldCollapse);
                }
                
                document.querySelectorAll('#parts-container .armor-part').forEach(part => {
                    const addButton = part.querySelector('.add-part-inline-btn');
                    const deleteButton = part.querySelector('.delete-btn');
                    const buttonDisplayStyle = shouldCollapse ? '' : 'none';
                    if (addButton) addButton.style.display = buttonDisplayStyle;
                    if (deleteButton) deleteButton.style.display = buttonDisplayStyle;
                    
                    const handle = part.querySelector('.drag-handle');
                    const favorite = part.querySelector('.favorite-toggle');
                    if (shouldCollapse) {
                        handle.textContent = '☰';
                        handle.style.cursor = 'grab';
                        handle.classList.remove('is-favorite');
                    } else {
                        handle.textContent = favorite.textContent;
                        handle.style.cursor = 'default';
                        handle.classList.toggle('is-favorite', favorite.dataset.favorite === 'true');
                    }
                });
            }

            sortPanel.addEventListener('click', (e) => {
                const target = e.target;
                    if (sortPanel.classList.contains('is-collapsed') && !target.closest('button')) {
                    toggleCollapse(false);
                } else if (target.matches('.favorite-toggle')) {
                    const isFavorite = target.dataset.favorite === 'true';
                    target.dataset.favorite = String(!isFavorite);
                    target.textContent = isFavorite ? '☆' : '★';
                    target.classList.toggle('is-favorite');
                }
            });

            collapseBtn.addEventListener('click', () => {
                    toggleCollapse(!sortPanel.classList.contains('is-collapsed'));
            });

            sortBtn.addEventListener('click', performSort);

            setupRadioDeselection(sortPanel);

            toggleCollapse(true);
            resetSortPanel();
        }

        function resetSortPanel(keepOpen = false) {
            sortPanel.querySelector('.favorite-toggle').textContent = '☆';
            sortPanel.querySelector('.favorite-toggle').dataset.favorite = 'false';
            sortPanel.querySelector('.favorite-toggle').classList.remove('is-favorite');

            document.getElementById('sort-type-asc').checked = true;
            document.getElementById('sort-ability-asc').checked = true;
            document.getElementById('save-sort-check').checked = false;
            
            sortPanel.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
            
            const sortOptions = { addNone: true, addListOrder: false };
            setupDropdown(sortPanel, null, sortOptions);
            setupAbilityDropdown(sortPanel, null, sortOptions);

            const armorBtn = sortPanel.querySelector('.armor-name-dropdown .custom-dropdown-button');
            armorBtn.dataset.value = 'none';
            armorBtn.querySelector('.button-label').textContent = '※指定しない';
            sortPanel.querySelector('.ability-select').value = 'none';

            if (!keepOpen) {
                sortPanel.classList.add('is-collapsed');
                sortPanel.querySelector('.part-content').style.display = 'none';
                sortPanel.querySelector('.sort-panel-info').style.display = 'block';
                sortPanel.querySelector('.toggle-collapse-btn').textContent = '▼';
            }
        }
        
        function performSort() {
            const scrollY = window.scrollY;
            const sortFavorite = sortPanel.querySelector('.favorite-toggle').dataset.favorite === 'true';
            
            const sortArmorTypeRadio = sortPanel.querySelector('input[name="sort-armor-type"]:checked');
            const sortArmorType = sortArmorTypeRadio ? sortArmorTypeRadio.value : null;
            const sortArmorAsc = document.getElementById('sort-type-asc').checked;
            const sortArmorName = sortPanel.querySelector('.armor-name-dropdown .custom-dropdown-button').dataset.value;

            const sortAbilityGradeRadio = sortPanel.querySelector('input[name="sort-ability-grade"]:checked');
            const sortAbilityGrade = sortAbilityGradeRadio ? sortAbilityGradeRadio.value : null;
            const sortAbilityAsc = document.getElementById('sort-ability-asc').checked;
            const sortAbilityName = sortPanel.querySelector('.ability-select').value;
            
            let parts = Array.from(partsContainer.children);
            
            parts.sort((a, b) => {
                const aData = getPartData(a);
                const bData = getPartData(b);
                
                if (sortFavorite) {
                    const aVal = aData.favorite ? 1 : 0;
                    const bVal = bData.favorite ? 1 : 0;
                    if (aVal !== bVal) return bVal - aVal;
                }

                if (sortArmorType) {
                    const direction = sortArmorAsc ? 1 : -1;
                    let result = 0;
                    
                    const aIsType = aData.armorType === sortArmorType;
                    const bIsType = bData.armorType === sortArmorType;
                    if (aIsType !== bIsType) {
                        result = aIsType ? -1 : 1;
                        return result * direction;
                    }

                    if (sortArmorName && sortArmorName !== 'none') {
                        if (sortArmorName.endsWith('(シリーズ順)')) {
                            const isWarlord = sortArmorName.startsWith('◆名将の鎧');
                            const isVanbrace = sortArmorName.startsWith('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ');
                            const prefix = isWarlord ? '◆名将の鎧' : '☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ';
                            const sublist = isWarlord ? warlordArmorSublist : vanbraceArmorSublist;

                            const aIsTarget = aData.armorName.startsWith(prefix);
                            const bIsTarget = bData.armorName.startsWith(prefix);

                            if (aIsTarget !== bIsTarget) {
                                result = aIsTarget ? -1 : 1;
                            } else if (aIsTarget && bIsTarget) {
                                const regex = /\(([^)]+)\)/;
                                const aMatch = aData.armorName.match(regex);
                                const bMatch = bData.armorName.match(regex);
                                const aIndex = aMatch ? sublist.indexOf(aMatch[1]) : -1;
                                const bIndex = bMatch ? sublist.indexOf(bMatch[1]) : -1;
                                result = aIndex - bIndex;
                            }
                        } else if (sortArmorName === 'list_order') {
                            const aIsWarlord = aData.armorName.startsWith('◆名将の鎧');
                            const bIsWarlord = bData.armorName.startsWith('◆名将の鎧');
                            const aIsVanbrace = aData.armorName.startsWith('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ');
                            const bIsVanbrace = bData.armorName.startsWith('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ');
                            const regex = /\(([^)]+)\)/;

                            if (aIsWarlord && bIsWarlord) {
                                const aMatch = aData.armorName.match(regex);
                                const bMatch = bData.armorName.match(regex);
                                const aSeriesIndex = aMatch ? warlordArmorSublist.indexOf(aMatch[1]) : -1;
                                const bSeriesIndex = bMatch ? warlordArmorSublist.indexOf(bMatch[1]) : -1;
                                if(aSeriesIndex !== bSeriesIndex) result = aSeriesIndex - bSeriesIndex;
                            } else if (aIsVanbrace && bIsVanbrace) {
                                const aMatch = aData.armorName.match(regex);
                                const bMatch = bData.armorName.match(regex);
                                const aSeriesIndex = aMatch ? vanbraceArmorSublist.indexOf(aMatch[1]) : -1;
                                const bSeriesIndex = bMatch ? vanbraceArmorSublist.indexOf(bMatch[1]) : -1;
                                if(aSeriesIndex !== bSeriesIndex) result = aSeriesIndex - bSeriesIndex;
                            } else {
                                const aIndex = allArmorData.findIndex(item => item.名称 === aData.armorName);
                                const bIndex = allArmorData.findIndex(item => item.名称 === bData.armorName);
                                if (aIndex !== bIndex) result = aIndex - bIndex;
                            }
                        } else if (sortArmorName === '◆名将の鎧(全対象)') {
                            const aIsTarget = aData.armorName.startsWith('◆名将の鎧');
                            const bIsTarget = bData.armorName.startsWith('◆名将の鎧');
                            if (aIsTarget !== bIsTarget) result = aIsTarget ? -1 : 1;
                        } else if (sortArmorName === '☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ(全対象)') {
                            const aIsTarget = aData.armorName.startsWith('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ');
                            const bIsTarget = bData.armorName.startsWith('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ');
                            if (aIsTarget !== bIsTarget) result = aIsTarget ? -1 : 1;
                        } else {
                            const aIsTarget = aData.armorName === sortArmorName;
                            const bIsTarget = bData.armorName === sortArmorName;
                            if (aIsTarget !== bIsTarget) result = aIsTarget ? -1 : 1;
                        }
                        if (result !== 0) return result * direction;
                    }
                }

                if (sortAbilityGrade) {
                        const direction = sortAbilityAsc ? 1 : -1;
                        let result = 0;

                    const aIsGrade = aData.grade === sortAbilityGrade;
                    const bIsGrade = bData.grade === sortAbilityGrade;
                        if (aIsGrade !== bIsGrade) {
                        result = aIsGrade ? -1 : 1;
                        return result * direction;
                        }
                    
                    if (sortAbilityName && sortAbilityName !== 'none') {
                        if (sortAbilityName === 'list_order') {
                            const aIndex = renmaAbilityData.findIndex(item => item.種類 === aData.abilityName);
                            const bIndex = renmaAbilityData.findIndex(item => item.種類 === bData.abilityName);
                            if (aIndex !== bIndex) result = aIndex - bIndex;
                        } else {
                            const aIsTarget = aData.abilityName === sortAbilityName;
                            const bIsTarget = bData.abilityName === sortAbilityName;
                            if (aIsTarget !== bIsTarget) result = aIsTarget ? -1 : 1;
                        }
                        if (result !== 0) return result * direction;
                    }
                }
                
                if (valueSortState > 0) {
                    const valA = parseFloat(aData.value) || 0;
                    const valB = parseFloat(bData.value) || 0;
                    if (valA !== valB) {
                        return valueSortState === 1 ? valB - valA : valA - valB;
                    }
                }

                return 0;
            });

            parts.forEach(p => partsContainer.appendChild(p));
            
            const isSave = document.getElementById('save-sort-check').checked;
            if(isSave) {
                originalPartOrder = Array.from(partsContainer.children);
                resetSortPanel(true);
                resetValueSortButtons();
                setDataDirty(true);
            }
            window.scrollTo(0, scrollY);
        }

        function getPartData(part) {
            return {
                armorType: part.querySelector('input[name*="armor-type"]:checked')?.value,
                armorName: part.querySelector('.armor-name-dropdown .custom-dropdown-button').dataset.value,
                grade: part.querySelector('input[name*="ability-grade"]:checked')?.value,
                abilityName: part.querySelector('.ability-select').value,
                value: part.querySelector('.ability-value').value,
                favorite: part.querySelector('.favorite-toggle').dataset.favorite === 'true'
            };
        }

        function resetValueSortButtons() {
            const btns = document.querySelectorAll('#tab-list .value-sort-btn');
            btns.forEach(btn => {
                btn.textContent = '9↓';
                btn.classList.remove('active');
            });
            valueSortState = 0;
        }

        function handleValueSort(event) {
            const btn = event.currentTarget;
            valueSortState = (valueSortState + 1) % 3;

            switch (valueSortState) {
                case 0:
                    btn.textContent = '9↓';
                    btn.classList.remove('active');
                    break;
                case 1:
                    btn.textContent = '9↓';
                    btn.classList.add('active');
                    break;
                case 2:
                    btn.textContent = '1↓';
                    btn.classList.add('active');
                    break;
            }
            
            if (document.getElementById('filter-btn').classList.contains('is-active')) {
                const scrollY = window.scrollY;
                if (valueSortState === 0) {
                    applyFilter();
                } else {
                    const visibleParts = Array.from(partsContainer.children).filter(p => p.style.display !== 'none');
                    visibleParts.sort((a, b) => {
                        const valA = parseFloat(a.querySelector('.ability-value').value) || 0;
                        const valB = parseFloat(b.querySelector('.ability-value').value) || 0;
                        return valueSortState === 1 ? valB - valA : valA - valB;
                    });
                    visibleParts.forEach(part => partsContainer.appendChild(part));
                }
                window.scrollTo(0, scrollY);
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            if (window.deactivateFilter) window.deactivateFilter();
            searchPanel.style.display = isEditMode ? 'none' : 'block';
            sortPanel.style.display = isEditMode ? 'block' : 'none';
            document.getElementById('footer-normal-notes').style.display = isEditMode ? 'none' : 'block';
            document.getElementById('footer-edit-notes').style.display = isEditMode ? 'block' : 'none';

            if (isEditMode) {
                originalPartOrder = Array.from(partsContainer.children);
                resetSortPanel();
                resetValueSortButtons();
            } else {
                if (!document.getElementById('save-sort-check').checked) {
                    const scrollY = window.scrollY;
                    originalPartOrder.forEach(part => partsContainer.appendChild(part));
                    window.scrollTo(0, scrollY);
                }
                document.querySelectorAll('#parts-container .armor-part').forEach(part => {
                    const addButton = part.querySelector('.add-part-inline-btn');
                    const deleteButton = part.querySelector('.delete-btn');
                    if (addButton) addButton.style.display = '';
                    if (deleteButton) deleteButton.style.display = '';
                });
            }

            document.querySelectorAll('#parts-container .armor-part').forEach(part => {
                part.querySelector('.drag-handle').style.display = isEditMode ? 'block' : 'none';
                part.querySelector('.favorite-toggle').style.display = isEditMode ? 'none' : 'block';
                
                const handle = part.querySelector('.drag-handle');
                handle.textContent = '☰';
                handle.classList.remove('is-favorite');
            });
            
            const allEditModeBtns = document.querySelectorAll('#edit-mode-btn, #edit-mode-btn-footer');
            allEditModeBtns.forEach(btn => {
                btn.textContent = isEditMode ? '編集モード終了' : '編集モード開始';
                btn.classList.toggle('active', isEditMode);
            });

            if (isEditMode) {
                if (!sortableInstance) {
                        sortableInstance = new Sortable(partsContainer, { 
                        animation: 150, 
                        handle: '.drag-handle',
                        onEnd: function(evt) {
                            originalPartOrder = Array.from(partsContainer.children);
                            setDataDirty(true);
                        }
                    });
                }
                sortableInstance.option('disabled', false);
            } else {
                if(sortableInstance) sortableInstance.option('disabled', true);
            }
        }

        const toggleMaxValueBtn = document.getElementById('toggle-max-value');
        const toggleMaxValueBottomBtn = document.getElementById('toggle-max-value-bottom');
        const maxValueContainer = document.querySelector('#tab-list .container');
        toggleMaxValueBtn.addEventListener('click', () => {
            const isHidden = maxValueContainer.style.display === 'none';
            maxValueContainer.style.display = isHidden ? 'grid' : 'none';
            toggleMaxValueBottomBtn.style.display = isHidden ? 'inline' : 'none';
            toggleMaxValueBtn.textContent = isHidden ? '×確認を終了' : '▼最大値確認';
        });
        toggleMaxValueBottomBtn.addEventListener('click', () => {
            maxValueContainer.style.display = 'none';
            toggleMaxValueBottomBtn.style.display = 'none';
            toggleMaxValueBtn.textContent = '▼最大値確認';
        });

        function checkForUnsavedBackup() {
            try {
                const settings = JSON.parse(localStorage.getItem(BACKUP_SETTINGS_KEY));
                if (settings && settings.hasUnsavedChanges) {
                    const backupData = localStorage.getItem(UNSAVED_DATA_KEY);
                    if (backupData) {
                        const warningDiv = document.createElement('div');
                        warningDiv.id = 'backup-warning';
                        warningDiv.style.color = 'red';
                        warningDiv.style.backgroundColor = '#4d2e2e';
                        warningDiv.style.padding = '10px';
                        warningDiv.style.margin = '10px 0';
                        warningDiv.style.border = '1px solid red';
                        warningDiv.style.borderRadius = '5px';
                        warningDiv.style.textAlign = 'center';
                        
                        warningDiv.innerHTML = `
                            前回、エクスポートされていないデータがあります。
                            <button id="restore-backup-btn" style="margin-left: 15px; padding: 5px 10px; cursor: pointer;">データの復元</button>
                            <button id="delete-backup-btn" style="margin-left: 10px; padding: 5px 10px; cursor: pointer;">データの削除</button>
                        `;
                        
                        const mainElement = document.querySelector('#tab-list main');
                        mainElement.insertBefore(warningDiv, mainElement.firstChild);

                        // Restore button event listener
                        document.getElementById('restore-backup-btn').addEventListener('click', () => {
                            const restoredData = JSON.parse(backupData);
                            
                            partsContainer.innerHTML = '';
                            
                            // 復元時はsetDirtyをfalseにして、最後にまとめて状態管理する
                            if (restoredData && restoredData.length > 0) {
                               restoredData.forEach(partData => addNewPart(partData, null, false));
                            } else {
                               addNewPart(null, null, false);
                            }
                            
                            // バックアップをクリア
                            setDataDirty(false); 
                            alert('データを復元しました。');
                        });
                        
                        // Delete button event listener
                        document.getElementById('delete-backup-btn').addEventListener('click', () => {
                            if (window.confirm('バックアップデータを本当に削除しますか？この操作は元に戻せません。')) {
                                // バックアップをクリア
                                setDataDirty(false); 
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to check for unsaved backup:', error);
            }
        }

        setupSearchPanel();
        setupSortPanel();
        addNewPart(null, null, false); // 初期表示時はDirtyフラグを立てない
        originalPartOrder = Array.from(partsContainer.children);
        
        document.getElementById('edit-mode-btn').addEventListener('click', toggleEditMode);
        document.getElementById('export-btn').addEventListener('click', exportData);
        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
        document.getElementById('import-file-input').addEventListener('change', importData);

        document.getElementById('edit-mode-btn-footer').addEventListener('click', toggleEditMode);
        document.getElementById('export-btn-footer').addEventListener('click', exportData);
        document.getElementById('import-btn-footer').addEventListener('click', () => document.getElementById('import-file-input-footer').click());
        document.getElementById('import-file-input-footer').addEventListener('change', importData);
        
        document.getElementById('search-value-sort').addEventListener('click', handleValueSort);
        document.getElementById('sort-value-sort').addEventListener('click', handleValueSort);

        resetValueSortButtons();
        checkForUnsavedBackup(); // ページ読み込み時にバックアップを確認
    }


    // =========================================================================
    // === 2. TOP5確認タブ (armor-top5.html) のスクリプト ==========================
    // =========================================================================
    
    async function loadUniqueAbilities_top5() {
        const files = ['data/armor-main-ability.csv', 'data/armor-sub-ability.csv'];
        const promises = files.map(file => fetch(file).then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.text();
        }));
        
        try {
            const [mainCsv, subCsv] = await Promise.all(promises);
            uniqueAbilities = parseCsvData_top5(mainCsv + "\n" + subCsv);
        } catch (error) {
            console.error("固有アビリティCSVの読み込みに失敗しました:", error);
            alert("固有アビリティデータ(CSV)の読み込みに失敗しました。\n'data'フォルダにファイルが存在するか確認してください。");
        }
    }

    function parseCsvData_top5(csvText) {
        const data = {};
        const attributeMap = { "斬": "斬", "打": "打", "突": "突", "熱": "熱", "冷": "冷", "雷": "雷", "陽": "陽", "陰": "陰", "味方威力": "味方威力", "威力": "威力" };
        const lines = csvText.split('\n').filter(line => line.trim() !== '');
        lines.forEach(line => {
            const parts = line.split(',');
            if (parts.length < 3) return;
            const armorName = parts[0].trim();
            const target = parts[1].trim();
            const value = parseInt(parts[2].trim(), 10);

            if (attributeMap[target] && !isNaN(value)) {
                if (!data[armorName]) {
                    data[armorName] = {};
                }
                data[armorName][target] = value;
            }
        });
        return data;
    }

    function initializeTop5Tab() {
        document.getElementById('include-unique-ability').addEventListener('change', () => {
            syncDataFromListTab(); // データを最新にしてから更新
            updateTop5Tab(sharedArmorData);
        });
        updateTop5Tab(sharedArmorData);
    }
    
    function updateTop5Tab(data) {
        const placeholder = document.getElementById('top5-placeholder');
        
        try {
            const processed = processData_top5(data || []); 
            displayReport_top5(processed);
        } catch (error) {
            console.error("データ処理中にエラー:", error);
            alert("データ処理中にエラーが発生しました。\n" + error);
        }
        
        if (!data || data.length === 0 || (data.length === 1 && !data[0].armorName)) {
            placeholder.style.display = 'block';
        } else {
            placeholder.style.display = 'none';
        }
    }

    function getTargetFromAbilityName_top5(abilityName) {
        if (abilityName.startsWith('味方威力＋')) return "味方威力";
        const match = abilityName.match(/\(([^)]+)\)/);
        if (!match) return null;
        const content = match[1];
        const attributes = ["斬", "打", "突", "熱", "冷", "雷", "陽", "陰"];
        if (attributes.includes(content)) return content;
        return null;
    }

    function processData_top5(armorData) {
        const selfPowerAbilities = ["威力＋(HP満タン時)", "威力＋(瀕死時)", "威力＋(カウンター)", "威力＋(斬)", "威力＋(打)", "威力＋(突)", "威力＋(熱)", "威力＋(冷)", "威力＋(雷)", "威力＋(陽)", "威力＋(陰)"];
        const partyPowerAbilities = ["味方威力＋(HP満タン時)", "味方威力＋(瀕死時)", "味方威力＋(カウンター)", "味方威力＋(斬)", "味方威力＋(打)", "味方威力＋(突)", "味方威力＋(熱)", "味方威力＋(冷)", "味方威力＋(雷)", "味方威力＋(陽)", "味方威力＋(陰)"];
        const includeUnique = document.getElementById('include-unique-ability').checked;

        const categorizedData = { mainSelf: {}, subSelf: {}, mainParty: {}, subParty: {} };
        [...selfPowerAbilities, ...partyPowerAbilities].forEach(name => {
            Object.keys(categorizedData).forEach(cat => categorizedData[cat][name] = []);
        });

        const dataToProcess = JSON.parse(JSON.stringify(armorData));

        for (const item of dataToProcess) {
            if (!item.abilityName || !item.value) continue;
            let value = parseInt(item.value, 10);
            if (isNaN(value)) continue;

            item.isCombined = false;
            let totalAddedValue = 0;

            if (includeUnique && uniqueAbilities[item.armorName]) {
                const isSpecialArmor = item.armorName.includes("名将の鎧") || item.armorName.includes("ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ");
                if (!isSpecialArmor) {
                    const armorBonuses = uniqueAbilities[item.armorName];
                    const specificTarget = getTargetFromAbilityName_top5(item.abilityName);
                    if (specificTarget && armorBonuses[specificTarget]) {
                        totalAddedValue += armorBonuses[specificTarget];
                    }
                    const isSelfPower = selfPowerAbilities.includes(item.abilityName);
                    if (isSelfPower && armorBonuses['味方威力']) {
                        totalAddedValue += armorBonuses['味方威力'];
                    }
                    if (isSelfPower && armorBonuses['威力']) {
                        totalAddedValue += armorBonuses['威力'];
                    }
                }
            }
            
            if (totalAddedValue > 0) {
                value += totalAddedValue;
                item.isCombined = true;
                item.addedValue = totalAddedValue;
            }

            const newItem = { ...item, value };

            if (selfPowerAbilities.includes(item.abilityName)) {
                if (item.armorType === 'main') categorizedData.mainSelf[item.abilityName].push(newItem);
                else if (item.armorType === 'sub') categorizedData.subSelf[item.abilityName].push(newItem);
            } else if (partyPowerAbilities.includes(item.abilityName)) {
                if (item.armorType === 'main') categorizedData.mainParty[item.abilityName].push(newItem);
                else if (item.armorType === 'sub') categorizedData.subParty[item.abilityName].push(newItem);
            }
        }
        
        for (const category in categorizedData) {
            for (const abilityName in categorizedData[category]) {
                categorizedData[category][abilityName].sort((a, b) => b.value - a.value);
            }
        }
        return categorizedData;
    }
        
    function displayReport_top5(data) {
        const selfPowerAbilities = ["威力＋(HP満タン時)", "威力＋(瀕死時)", "威力＋(カウンター)", "威力＋(斬)", "威力＋(打)", "威力＋(突)", "威力＋(熱)", "威力＋(冷)", "威力＋(雷)", "威力＋(陽)", "威力＋(陰)"];
        const partyPowerAbilities = ["味方威力＋(HP満タン時)", "味方威力＋(瀕死時)", "味方威力＋(カウンター)", "味方威力＋(斬)", "味方威力＋(打)", "味方威力＋(突)", "味方威力＋(熱)", "味方威力＋(冷)", "味方威力＋(雷)", "味方威力＋(陽)", "味方威力＋(陰)"];

        const categories = [
            { id: 'main-self', abilities: selfPowerAbilities, data: data.mainSelf },
            { id: 'sub-self', abilities: selfPowerAbilities, data: data.subSelf },
            { id: 'main-party', abilities: partyPowerAbilities, data: data.mainParty },
            { id: 'sub-party', abilities: partyPowerAbilities, data: data.subParty }
        ];
        
        categories.forEach(cat => {
            const container = document.querySelector(`#${cat.id} .table-wrapper`);
            container.innerHTML = '';
            if (!sharedArmorData || sharedArmorData.length === 0 || (sharedArmorData.length === 1 && !sharedArmorData[0].armorName)) {
                return; 
            }

            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th class="col-ability">アビリティ</th><th class="col-armor">装備</th><th class="col-value value-col">効果値</th></tr></thead>`;
            const tbody = table.createTBody();

            cat.abilities.forEach(abilityName => {
                const items = cat.data[abilityName] || [];
                const showTotal = abilityName.startsWith('味方威力＋');
                
                let abilityTotal = 0;
                if (showTotal) {
                    for (let i = 0; i < 5; i++) {
                        if (items[i]) abilityTotal += items[i].value;
                    }
                }

                for (let i = 0; i < 5; i++) {
                    const item = items[i];
                    const row = tbody.insertRow();
                    
                    let firstCellHTML = '';
                    if (i === 0) {
                        const rowspan = 4;
                        firstCellHTML = `<td class="merged-ability-cell" rowspan="${rowspan}">${abilityName}</td>`;
                    }
                    else if (i === 4) {
                        if (showTotal) {
                            firstCellHTML = `<td class="ability-total-cell">合計: ${abilityTotal}%</td>`;
                        } else {
                            // 「威力＋」系テーブル用に、罫線を表示させるための空セルを挿入
                            firstCellHTML = `<td class="ability-total-cell">&nbsp;</td>`;
                        }
                    }

                    let armorCellHTML = '&nbsp;';
                    let valueCellHTML = '&nbsp;';
                    let valueCellClass = 'value-col';

                    if (item) {
                        if (item.isCombined) {
                            armorCellHTML = `<span class="combined-armor-name">${item.armorName} (+${item.addedValue})</span>`;
                            valueCellClass += ' combined-value';
                        } else if (item.armorName.includes("名将の鎧") || item.armorName.includes("ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ")) {
                            armorCellHTML = `<span class="special-armor-name">${item.armorName}</span>`;
                        } else {
                            armorCellHTML = item.armorName;
                        }
                        valueCellHTML = item.value + '%';
                    }
                    
                    row.innerHTML = `${firstCellHTML}<td>${armorCellHTML}</td><td class="${valueCellClass}">${valueCellHTML}</td>`;
                }
            });
            container.appendChild(table);
        });
    }


    // =========================================================================
    // === 3. 自動選定ツールタブ (armor-calc.html) のスクリプト =======================
    // =========================================================================
    
    let armorData_calc = [];

    async function loadCsvData_calc(url, targetMap) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
            const csvText = await response.text();
            const lines = csvText.trim().split('\n');
            lines.shift();

            lines.forEach(line => {
                const [name, target, valueStr] = line.split(',');
                if (name && target && valueStr) {
                    const value = parseInt(valueStr.trim(), 10);
                    if (!isNaN(value)) {
                        if (!targetMap.has(name.trim())) {
                            targetMap.set(name.trim(), []);
                        }
                        targetMap.get(name.trim()).push({ target: target.trim(), value });
                    }
                }
            });
        } catch (error) {
            console.error(`Error loading or parsing CSV from ${url}:`, error);
        }
    }

    function initializeCalcTab() {
        const characterGrid = document.getElementById('character-grid');
        const calculateAllButton = document.getElementById('calculate-all-button');

        const abilityConditions = [
            { name: "HP満タン時", value: "HP満タン時" }, { name: "瀕死時", value: "瀕死時" },
            { name: "カウンター", value: "カウンター" }, { name: "斬", value: "斬" },
            { name: "打", value: "打" }, { name: "突", value: "突" },
            { name: "熱", value: "熱" }, { name: "冷", value: "冷" },
            { name: "雷", value: "雷" }, { name: "陽", value: "陽" },
            { name: "陰", value: "陰" }
        ];
        const seriesNames = ["未選択", "GBSaGa", "RS1", "RS2", "RS3", "SF1", "SF2", "US", "ES", "IS", "SSG", "SaGaRS", "SaGaEB", "その他"];

        for (let i = 1; i <= 5; i++) {
            const charContainer = document.createElement('div');
            charContainer.className = 'character-container';
            charContainer.id = `char-${i}`;
            
            let checkboxesHTML = '';
            abilityConditions.forEach(cond => {
                const uniqueId = `condition-${i}-${cond.value.replace(/\s/g, '-')}`;
                checkboxesHTML += `<input type="checkbox" name="condition-${i}" value="${cond.value}" id="${uniqueId}"><label for="${uniqueId}">${cond.name}</label>`;
            });
            
            let seriesOptionsHTML = '';
            seriesNames.forEach(name => {
                seriesOptionsHTML += `<option value="${name}">${name}</option>`;
            });

            charContainer.innerHTML = `
                <h2>
                    <span>キャラ ${i}</span>
                    <select class="series-select" id="series-select-${i}">${seriesOptionsHTML}</select>
                    <div class="nav-buttons">
                        <button class="nav-button" id="nav-up-${i}">▲</button>
                        <button class="nav-button" id="nav-down-${i}">▼</button>
                    </div>
                </h2>
                <div class="form-horizontal-row">
                    <div class="form-type">
                        <fieldset class="form-section">
                            <legend>アビリティ</legend>
                            <div class="styled-form-group">
                                <input type="radio" name="ability-type-${i}" value="威力＋" id="ability-type-${i}-power" checked><label for="ability-type-${i}-power">威力＋</label>
                                <input type="radio" name="ability-type-${i}" value="味方威力＋" id="ability-type-${i}-party"><label for="ability-type-${i}-party">味方威力＋</label>
                            </div>
                        </fieldset>
                    </div>
                    <div class="form-conditions">
                        <fieldset class="form-section">
                            <legend>条件 (複数可)</legend>
                            <div class="styled-form-group conditions-wrapper">${checkboxesHTML}</div>
                        </fieldset>
                    </div>
                </div>
                <div class="result-area" id="result-area-${i}"><p>計算結果がここに表示されます。</p></div>
            `;

            characterGrid.appendChild(charContainer);
            
            const navUpButton = charContainer.querySelector(`#nav-up-${i}`);
            const navDownButton = charContainer.querySelector(`#nav-down-${i}`);

            if (i === 1) navUpButton.disabled = true;
            else navUpButton.addEventListener('click', () => scrollToCategory(`char-${i - 1}`));
            if (i === 5) navDownButton.disabled = true;
            else navDownButton.addEventListener('click', () => scrollToCategory(`char-${i + 1}`));

            const newRadios = charContainer.querySelectorAll(`input[name="ability-type-${i}"]`);
            newRadios.forEach(radio => radio.addEventListener('change', () => handleConditionSync(i, 'radio-change')));
            const newCheckboxes = charContainer.querySelectorAll(`input[name="condition-${i}"]`);
            newCheckboxes.forEach(checkbox => checkbox.addEventListener('change', () => handleConditionSync(i, 'checkbox-change')));
        }
        
        calculateAllButton.addEventListener('click', calculateAllCharacters);
    }
    
    function updateCalcTab(data) {
        armorData_calc = data.map(item => ({...item, value: parseInt(item.value, 10)})).filter(item => !isNaN(item.value));
        
        const fileStatus = document.getElementById('file-status');
        if (armorData_calc.length > 0 && armorData_calc[0].armorName) {
            fileStatus.textContent = `データ連携完了: ${armorData_calc.length}件の装備データを認識しました。`;
            fileStatus.style.color = '#98fb98';
            document.getElementById('calculate-all-button').disabled = false;
        } else {
            fileStatus.textContent = '「リスト管理」タブにてJSONファイルをインポートするか、データを登録してください。';
            fileStatus.style.color = '#ffd700';
            document.getElementById('calculate-all-button').disabled = true;
        }
    }

    function handleConditionSync(charId, eventType) {
        if (charId === 2 && eventType === 'radio-change' && document.querySelector('input[name="ability-type-2"]:checked').value === '味方威力＋') {
            const sourceConditions = Array.from(document.querySelectorAll('input[name="condition-1"]:checked')).map(cb => cb.value);
            for (let i = 2; i <= 5; i++) {
                document.querySelector(`input[name="ability-type-${i}"][value="味方威力＋"]`).checked = true;
                const targetCheckboxes = document.querySelectorAll(`input[name="condition-${i}"]`);
                targetCheckboxes.forEach(cb => {
                    cb.checked = sourceConditions.includes(cb.value);
                });
            }
            const calculateButton = document.getElementById('calculate-all-button');
            if (calculateButton) {
                calculateButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return; 
        }

        const currentAbilityType = document.querySelector(`input[name="ability-type-${charId}"]:checked`).value;
        if (eventType === 'radio-change' && currentAbilityType === '味方威力＋') {
            let conditionsToCopy = null;
            for (let i = charId - 1; i >= 1; i--) {
                const prevAbilityType = document.querySelector(`input[name="ability-type-${i}"]:checked`).value;
                if (prevAbilityType === '味方威力＋') {
                    conditionsToCopy = Array.from(document.querySelectorAll(`input[name="condition-${i}"]:checked`)).map(cb => cb.value);
                    break;
                }
            }
            if (conditionsToCopy !== null) {
                const currentCheckboxes = document.querySelectorAll(`input[name="condition-${charId}"]`);
                currentCheckboxes.forEach(cb => {
                    cb.checked = conditionsToCopy.includes(cb.value);
                });
            }
        }

        if (currentAbilityType === '味方威力＋') {
            const sourceConditions = Array.from(document.querySelectorAll(`input[name="condition-${charId}"]:checked`)).map(cb => cb.value);
            for (let i = charId + 1; i <= 5; i++) {
                const nextAbilityType = document.querySelector(`input[name="ability-type-${i}"]:checked`).value;
                if (nextAbilityType === '味方威力＋') {
                    const nextCheckboxes = document.querySelectorAll(`input[name="condition-${i}"]`);
                    nextCheckboxes.forEach(cb => {
                        cb.checked = sourceConditions.includes(cb.value);
                    });
                }
            }
        }
    }

    function getConditionFromAbilityName_calc(abilityName) {
        if (!abilityName) return null;
        const match = abilityName.match(/\((.*)\)/);
        return match ? match[1] : null;
    }

    function getNativeAbilityValue_calc(armorName, armorType, selectedConditions, abilityType, charId) {
        const nativeAbilityMap = armorType === 'main' ? mainNativeAbilities : subNativeAbilities;
        if (!nativeAbilityMap.has(armorName)) return 0;
        
        const selectedSeries = document.getElementById(`series-select-${charId}`).value;
        let totalValue = 0;
        const abilities = nativeAbilityMap.get(armorName);

        for (const ability of abilities) {
            let shouldAddValue = true;
            if (armorName.includes('名将の鎧') || armorName.includes('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ')) {
                if (selectedSeries === '未選択') {
                    shouldAddValue = false;
                } else {
                    const armorSeriesMatch = armorName.match(/\(([^)]+)\)/);
                    if (armorSeriesMatch) {
                        const armorSeriesStr = armorSeriesMatch[1];
                        if (armorName.includes('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ') && armorSeriesStr === 'US・ES・IS') {
                            if (!['US', 'ES', 'IS'].includes(selectedSeries)) shouldAddValue = false;
                        } else {
                            const armorSeriesList = armorSeriesStr.split(/[&＆]/).map(s => s.trim());
                            if (!armorSeriesList.includes(selectedSeries)) shouldAddValue = false;
                        }
                    }
                }
            }

            if (shouldAddValue) {
                const nativeAbilityTarget = ability.target;
                if (abilityType === '味方威力＋') {
                    if (nativeAbilityTarget === '味方威力') totalValue += ability.value;
                } else {
                    const isUnconditional = nativeAbilityTarget === '威力' || nativeAbilityTarget === '味方威力';
                    const isConditionMet = selectedConditions.includes(nativeAbilityTarget);
                    if (isUnconditional || isConditionMet) totalValue += ability.value;
                }
            }
        }
        return totalValue;
    }

    function findBestArmorWithNativeAbilities_calc(armorType, character, excludedItems, partyConfig) {
        const { abilityType, selectedConditions, charId, series } = character;
        const candidates = [];
        const availableArmor = armorData_calc.filter(item => item.armorType === armorType && !excludedItems.has(item.armorName));

        for (const armor of availableArmor) {
            const jsonAbilityCondition = getConditionFromAbilityName_calc(armor.abilityName);
            const jsonAbilityType = armor.abilityName.includes('味方威力＋') ? '味方威力＋' : '威力＋';
            let typeMatch = (abilityType === jsonAbilityType);
            if (abilityType === '威力＋' && jsonAbilityType === '味方威力＋') typeMatch = true;

            if (typeMatch && selectedConditions.includes(jsonAbilityCondition)) {
                const jsonValue = armor.value;
                const nativeValue = getNativeAbilityValue_calc(armor.armorName, armorType, selectedConditions, abilityType, charId);
                let combinedValue;
                if (abilityType === '味方威力＋' && armor.armorName.includes('名将の鎧') && armor.armorType === 'main') {
                    let isBeneficialToParty = false;
                    if (series !== '未選択') {
                        const armorSeriesMatch = armor.armorName.match(/\(([^)]+)\)/);
                        if (armorSeriesMatch) {
                            const armorSeries = armorSeriesMatch[1].split(/[&＆]/).map(s => s.trim());
                            if (armorSeries.includes(series)) {
                                for (const member of partyConfig) {
                                    if (member.charId === charId) continue;
                                    if (member.abilityType === '威力＋' && member.series === series) {
                                        isBeneficialToParty = true;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    combinedValue = isBeneficialToParty ? (jsonValue + nativeValue) : jsonValue;
                } else {
                    combinedValue = jsonValue + nativeValue;
                }
                candidates.push({ ...armor, combinedValue });
            }
        }
        if (candidates.length === 0) return { armorName: '該当なし', value: 0, abilityName: '-' };
        candidates.sort((a, b) => b.combinedValue - a.combinedValue);
        return candidates[0];
    }
    
    function runIterativeSolver_calc(partyConfig, lockedEquipment = new Map()) {
        let partyLoadout = Array(5).fill(null);
        let lastLoadoutStr = "";
        let iterations = 0;

        while (JSON.stringify(partyLoadout) !== lastLoadoutStr && iterations < 5) {
            lastLoadoutStr = JSON.stringify(partyLoadout);
            iterations++;
            const equippedThisPass = new Set();
            lockedEquipment.forEach(loadout => {
                if (loadout.mainArmor) equippedThisPass.add(loadout.mainArmor.armorName);
                if (loadout.subArmor) equippedThisPass.add(loadout.subArmor.armorName);
            });
            const nextLoadout = [];

            for (const character of partyConfig) {
                const { charId } = character;
                let mainArmor, subArmor;
                if (lockedEquipment.has(charId) && lockedEquipment.get(charId).mainArmor) mainArmor = lockedEquipment.get(charId).mainArmor;
                else mainArmor = findBestArmorWithNativeAbilities_calc('main', character, equippedThisPass, partyConfig);
                if (mainArmor.armorName !== '該当なし') equippedThisPass.add(mainArmor.armorName);
                
                if (lockedEquipment.has(charId) && lockedEquipment.get(charId).subArmor) subArmor = lockedEquipment.get(charId).subArmor;
                else subArmor = findBestArmorWithNativeAbilities_calc('sub', character, equippedThisPass, partyConfig);
                if (subArmor.armorName !== '該当なし') equippedThisPass.add(subArmor.armorName);
                
                nextLoadout[charId - 1] = { mainArmor, subArmor };
            }
            partyLoadout = nextLoadout;
        }
        return partyLoadout;
    }

    function calculateFinalResults_calc(partyLoadout, partyConfig) {
        const characterResults = [];
        for (const character of partyConfig) {
            const { charId, abilityType, selectedConditions } = character;
            const equipment = partyLoadout[charId - 1];
            if (!equipment) { 
                characterResults.push({ charId, abilityType, selectedConditions, mainArmor: {armorName: 'エラー'}, subArmor: {armorName: 'エラー'}, totals: {grand: -1}});
                continue;
            }
            const { mainArmor, subArmor } = equipment;
            mainArmor.nativeValue = getNativeAbilityValue_calc(mainArmor.armorName, 'main', selectedConditions, abilityType, charId);
            subArmor.nativeValue = getNativeAbilityValue_calc(subArmor.armorName, 'sub', selectedConditions, abilityType, charId);
            characterResults.push({ ...character, mainArmor, subArmor });
        }

        for (const receiver of characterResults) {
            const selfValue = (receiver.mainArmor.value || 0) + (receiver.subArmor.value || 0) + (receiver.mainArmor.nativeValue || 0) + (receiver.subArmor.nativeValue || 0);
            let partyValue = 0;
            for (const provider of characterResults) {
                if (receiver.charId === provider.charId) continue;
                const commonConditions = receiver.selectedConditions.filter(c => provider.selectedConditions.includes(c));
                if (commonConditions.length === 0) continue;
                let contribution = 0;
                const mainCond = getConditionFromAbilityName_calc(provider.mainArmor.abilityName);
                if (provider.mainArmor.abilityName.includes("味方威力＋") && provider.selectedConditions.includes(mainCond)) {
                    contribution += provider.mainArmor.value;
                }
                if (mainNativeAbilities.has(provider.mainArmor.armorName) && mainNativeAbilities.get(provider.mainArmor.armorName).some(a => a.target === '味方威力')) {
                    const hasMeisho = provider.mainArmor.armorName.includes('名将の鎧');
                    if (hasMeisho) {
                        let isMatch = false;
                        if (receiver.series !== '未選択' && receiver.series === provider.series) {
                            const armorSeriesMatch = provider.mainArmor.armorName.match(/\(([^)]+)\)/);
                            if (armorSeriesMatch) {
                                const armorSeriesList = armorSeriesMatch[1].split(/[&＆]/).map(s => s.trim());
                                if (armorSeriesList.includes(receiver.series)) isMatch = true;
                            }
                        }
                        if (isMatch) contribution += provider.mainArmor.nativeValue;
                    } else {
                        contribution += provider.mainArmor.nativeValue;
                    }
                }

                const subCond = getConditionFromAbilityName_calc(provider.subArmor.abilityName);
                if (provider.subArmor.abilityName.includes("味方威力＋") && provider.selectedConditions.includes(subCond)) {
                    contribution += provider.subArmor.value;
                }
                if (subNativeAbilities.has(provider.subArmor.armorName) && subNativeAbilities.get(provider.subArmor.armorName).some(a => a.target === '味方威力')) {
                    contribution += provider.subArmor.nativeValue;
                }
                partyValue += contribution;
            }
            
            if (receiver.abilityType === '威力＋') {
                receiver.totals = { self: selfValue, party: partyValue, grand: selfValue + partyValue };
            } else {
                const hasMeisho = receiver.mainArmor.armorName.includes('名将の鎧');
                if (hasMeisho) {
                    const normalValue = (receiver.mainArmor.value || 0) + (receiver.subArmor.value || 0) + (receiver.subArmor.nativeValue || 0);
                    receiver.totals = { isMeisho: true, meishoTotal: selfValue, normalTotal: normalValue };
                } else {
                    receiver.totals = { self: selfValue };
                }
            }
        }
        return characterResults;
    }

    function calculateAllCharacters() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        const partyConfig = [];
        let primaryAttacker = null;
        for (let i = 1; i <= 5; i++) {
            const charConfig = {
                charId: i,
                abilityType: document.querySelector(`input[name="ability-type-${i}"]:checked`).value,
                selectedConditions: Array.from(document.querySelectorAll(`input[name="condition-${i}"]:checked`)).map(cb => cb.value),
                series: document.getElementById(`series-select-${i}`).value
            };
            partyConfig.push(charConfig);
            if (charConfig.abilityType === '威力＋' && !primaryAttacker) {
                primaryAttacker = charConfig;
            }
        }

        if (!primaryAttacker) {
            const loadout = runIterativeSolver_calc(partyConfig);
            const results = calculateFinalResults_calc(loadout, partyConfig);
            results.forEach(r => displayResult_calc(r));
            return;
        }

        let bestLoadout = null;
        let bestTotal = -1;

        const attackerCandidates = [];
        const availableMainArmor = armorData_calc.filter(item => item.armorType === 'main');
        for (const armor of availableMainArmor) {
            const jsonAbilityCondition = getConditionFromAbilityName_calc(armor.abilityName);
            if (primaryAttacker.selectedConditions.includes(jsonAbilityCondition)) {
                const jsonAbilityType = armor.abilityName.includes('味方威力＋') ? '味方威力＋' : '威力＋';
                if (jsonAbilityType === '威力＋' || jsonAbilityType === '味方威力＋') {
                        attackerCandidates.push(armor);
                }
            }
        }

        const powerPlusCandidates = attackerCandidates
            .filter(a => !a.abilityName.includes('味方威力＋'))
            .map(a => ({ ...a, totalValue: a.value + getNativeAbilityValue_calc(a.armorName, 'main', primaryAttacker.selectedConditions, primaryAttacker.abilityType, primaryAttacker.charId) }))
            .sort((a, b) => b.totalValue - a.totalValue);
        const partyBuffCandidates = attackerCandidates
            .filter(a => a.abilityName.includes('味方威力＋'))
            .map(a => ({ ...a, totalValue: a.value + getNativeAbilityValue_calc(a.armorName, 'main', primaryAttacker.selectedConditions, primaryAttacker.abilityType, primaryAttacker.charId) }))
            .sort((a, b) => b.totalValue - a.totalValue);
        const scenariosToTest = [...powerPlusCandidates.slice(0, 2), ...partyBuffCandidates.slice(0, 3)];
        const uniqueScenarios = [...new Map(scenariosToTest.map(item => [item.armorName, item])).values()];
        uniqueScenarios.push(null); 

        for (const attackerMainArmor of uniqueScenarios) {
            const lockedEquipment = new Map();
            if (attackerMainArmor) {
                lockedEquipment.set(primaryAttacker.charId, { mainArmor: attackerMainArmor, subArmor: null });
            }
            const scenarioLoadout = runIterativeSolver_calc(partyConfig, lockedEquipment);
            const scenarioResults = calculateFinalResults_calc(scenarioLoadout, partyConfig);
            const scenarioAttackerResult = scenarioResults.find(r => r.charId === primaryAttacker.charId);
            
            if (scenarioAttackerResult && scenarioAttackerResult.totals && scenarioAttackerResult.totals.grand > bestTotal) {
                bestTotal = scenarioAttackerResult.totals.grand;
                bestLoadout = scenarioLoadout;
            }
        }

        if (bestLoadout) {
            const finalResults = calculateFinalResults_calc(bestLoadout, partyConfig);
            finalResults.forEach(r => displayResult_calc(r));
        } else {
            partyConfig.forEach(c => displayEmptyResult_calc(c.charId));
        }
    }
    
    function displayResult_calc(result) {
        const { charId, mainArmor, subArmor, totals } = result;
        const resultArea = document.getElementById(`result-area-${charId}`);
        
        let mainArmorNameStyle = '';
        if (!mainArmor || mainArmor.armorName === '該当なし') mainArmorNameStyle = 'style="color: red;"';
        else if (mainArmor.armorName.includes('名将の鎧') || mainArmor.armorName.includes('ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ')) mainArmorNameStyle = 'style="color: magenta;"';
        else if (mainArmor.nativeValue > 0) mainArmorNameStyle = 'style="color: orange;"';
        const mainArmorNameText = mainArmor.nativeValue > 0 && mainArmor.armorName !== '該当なし' ? `${mainArmor.armorName}(+${mainArmor.nativeValue})` : mainArmor.armorName;
        
        let subArmorNameStyle = '';
            if (!subArmor || subArmor.armorName === '該当なし') subArmorNameStyle = 'style="color: red;"';
        else if (subArmor.armorName.includes('名将の鎧') || subArmor.armorName.includes('ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ')) subArmorNameStyle = 'style="color: magenta;"';
        else if (subArmor.nativeValue > 0) subArmorNameStyle = 'style="color: orange;"';
        const subArmorNameText = subArmor.nativeValue > 0 && subArmor.armorName !== '該当なし' ? `${subArmor.armorName}(+${subArmor.nativeValue})` : subArmor.armorName;

        let totalHTML = '';
        if (totals.isMeisho) {
            totalHTML = `<div class="total-container"><div class="total-row"><span class="label">名将:</span><span class="value">${totals.meishoTotal}%</span></div><div class="total-row final-total"><span class="label">通常:</span><span class="value">${totals.normalTotal}%</span></div></div>`;
        } else if (totals.grand !== undefined) { 
            totalHTML = `<div class="total-container"><div class="total-row"><span class="label">自身:</span><span class="value">${totals.self}%</span></div><div class="total-row"><span class="label">味方:</span><span class="value">${totals.party}%</span></div><div class="total-row final-total"><span class="label">合計:</span><span class="value">${totals.grand}%</span></div></div>`;
        } else { 
            totalHTML = `<div class="total-container"><div class="total-row final-total"><span class="label">合計:</span><span class="value">${totals.self}%</span></div></div>`;
        }

        resultArea.innerHTML = `
            <div class="result-details">
                <table class="result-table"><tbody>
                    <tr>
                        <td class="col-heading"><span class="heading-text">主防具</span></td>
                        <td class="col-armor"><span class="data-label">装備:</span><span class="armor-text" ${mainArmorNameStyle}>${mainArmorNameText || ''}</span></td>
                        <td class="col-ability"><span class="data-label">アビリティ:</span><span class="ability-text">${mainArmor.abilityName || '-'}</span></td>
                        <td class="col-value"><span class="data-label">効果値:</span><span class="value-text">${mainArmor.value || 0}%</span></td>
                    </tr>
                    <tr>
                        <td class="col-heading"><span class="heading-text">副防具</span></td>
                        <td class="col-armor"><span class="data-label">装備:</span><span class="armor-text" ${subArmorNameStyle}>${subArmorNameText || ''}</span></td>
                        <td class="col-ability"><span class="data-label">アビリティ:</span><span class="ability-text">${subArmor.abilityName || '-'}</span></td>
                        <td class="col-value"><span class="data-label">効果値:</span><span class="value-text">${subArmor.value || 0}%</span></td>
                    </tr>
                </tbody></table>
            </div>
            ${totalHTML}
        `;
    }

    function displayEmptyResult_calc(charId) {
        document.getElementById(`result-area-${charId}`).innerHTML = `<p>条件を選択して計算を実行してください。</p>`;
    }

    </script>
</body>
</html>