<!DOCTYPE html>
<html lang="ja">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon-renma.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon-renma.png">
    <link rel="icon" type="image/png" href="web-app-manifest-192x192-renma.png">
    <title>練磨(防具)X用非公開ツール</title> <style>
        /* --- 全体 --- */
        body {
            background-color: #2A2A2A;
            color: #eee;
            font-family: 'Meiryo', sans-serif;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- ヘッダー --- */
        header { 
            text-align: center; 
            margin-bottom: 20px; 
        }

        h1 { 
            color: orangered; 
            margin: 0;
        }

        /* --- グローバルコンテナ --- */
        .main-container {
            width: 100%;
            max-width: 1600px;
        }
        
        /* --- ファイル入力 --- */
        .file-input-container {
            border-radius: 8px;
            margin-bottom: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        #file-status { 
            margin-top: 10px; 
            color: #ffd700; 
        }

        /* --- キャラクターグリッド (1列・5行レイアウト) --- */
        .character-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        /* --- キャラクターコンテナ --- */
        .character-container {
            background-color: #383838;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px 20px;
        }
        
        h2 {
            color: #c0c0ff;
            margin: 0 0 15px 0;
            border-bottom: 2px solid #555;
            padding-bottom: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px; /* Added gap */
        }

        .series-select {
            background-color: #444;
            color: #eee;
            border: 1px solid #777;
            border-radius: 4px;
            padding: 0 6px;
            font-size: 16px;
            margin-left: 10px;
            height: 30px;
            box-sizing: border-box;
        }
        
        .nav-buttons {
            display: flex;
            gap: 6px;
            margin-left: auto; /* Pushes the buttons to the right */
        }

        .nav-button {
            background-color: #555;
            color: #eee;
            border: 1px solid #777;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .nav-button:hover {
            background-color: #666;
        }

        .nav-button:active {
            background-color: #444;
        }

        .nav-button:disabled {
            background-color: #333;
            color: #666;
            cursor: default;
            opacity: 0.5;
        }

        /* --- フォームの横並びコンテナ --- */
        .form-horizontal-row {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* --- フォームスタイル --- */
        .form-section {
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
        }
        .form-section legend {
            font-weight: bold;
            color: #98fb98;
            padding: 0 5px;
        }
        
        .form-type .form-group {
            display: flex;
            gap: 25px;
        }

        .form-conditions {
            flex-grow: 1;
        }
        .conditions-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 20px;
        }
        
        .form-group label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        /* --- 結果表示 --- */
        .result-area {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            border: 1px dashed #777;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .result-details {
            flex-grow: 1;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .result-table td {
            padding: 8px;
            text-align: left;
            vertical-align: middle;
            border-bottom: 1px solid #3a3a3a;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        
        .col-heading { width: 7%; }
        .col-armor   { width: 33%; }
        .col-ability { width: 37%; }
        .col-value   { width: 23%; }

        /* --- NEW: Flex container for label + select alignment --- */
        .td-flex-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .data-label {
            display: inline-block;
            text-align: right;
            color: #a0a0a0;
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        .heading-text { color: #c0c0ff; font-weight: bold; }
        
        /* --- Modified for dropdowns --- */
        .result-area select {
            background-color: #2A2A2A;
            color: #98fb98;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 2px 4px;
            font-family: inherit;
            font-size: 1em;
            /* NEW: Flex properties for auto-width */
            flex-grow: 1;
            min-width: 0;
        }

        .result-area .value-select {
            color: #ffd700;
            font-weight: bold;
        }

        .result-area .armor-text-default { color: #98fb98; }
        .result-area .armor-text-native { color: orange; }
        .result-area .armor-text-special { color: magenta; }
        .result-area .armor-text-none { color: red; }
        
        .total-container {
            padding-left: 20px;
            border-left: 1px solid #555;
            white-space: nowrap;
            text-align: right;
        }

        .total-container .total-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 15px;
        }

        .total-container .label {
            font-size: 16px;
            color: #a0a0a0;
        }

        .total-container .value {
             font-weight: bold;
             font-size: 24px;
             color: #ffd700;
        }

        .total-container .final-total .label,
        .total-container .final-total .value {
            color: red; /* 合計の色 */
        }
        
        .global-controls {
            text-align: center;
            margin-top: 20px;
        }

        .calculate-button {
            background-color: #f0506e;
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }

        .calculate-button:hover:not(:disabled) {
            background-color: #c8405a;
        }

        .calculate-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .calculate-button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        /* 拡大縮小ボタンのスタイル - absolute positioned to not scroll */
        .zoom-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }

        .zoom-buttons button {
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }

        a:link { 
            color: #1D9BF0; 
            text-decoration: underline; 
        }

        a:visited { 
            color: #7755FF; 
            text-decoration: underline; 
        }

        a:hover { 
            color: #0CFF57; 
        }

        a:active { 
            color: #FF0000; 
            text-decoration: underline; 
        }

        footer {
            width: 100%;
            border-top: 1px solid #eee;
            padding-top: 10px;
            font-size: 12pt;
            margin-top: 40px;
        }

        .bottom {
            margin-top: 20px;
            font-size: 16pt;
            line-height: 2;
            text-align: center;
        }

        /* --- レスポンシブデザイン --- */

        /* 中サイズ画面 (幅992px以下) */
        @media (max-width: 992px) {
            .result-table tr {
                display: block;
                padding: 10px 0;
                border-bottom: 1px solid #3a3a3a;
            }
            .result-table tr:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }
            .result-table td {
                display: block;
                width: 100%;
                border-bottom: none;
                padding: 5px 0;
            }

            /* 固定幅を解除 */
            .col-heading, .col-armor, .col-ability, .col-value {
                width: auto;
            }
            .data-label {
                width: 90px;
            }
        }

        /* 小サイズ画面 (幅768px以下) */
        @media (max-width: 768px) {
            /* 結果表示エリア全体を縦並びにする */
            .result-area {
                flex-direction: column;
                align-items: stretch;
            }
            
            /* 合計値コンテナを下に移動させるための調整 */
            .total-container {
                border-left: none;
                border-top: 1px solid #555;
                padding-left: 0;
                padding-top: 15px;
                margin-top: 15px;
                text-align: right;
            }
            .total-container .total-row {
                justify-content: flex-end;
            }
        }

        /* ---【今回追加】画面幅480px以下のためのスタイル --- */
        @media (max-width: 480px) {
            .form-horizontal-row {
                flex-direction: column; /* アビリティと条件のセクションを縦積みにする */
                align-items: stretch;   /* 幅を親要素に合わせる */
            }
        }

    /* ハンバーガーメニューのスタイル */
    .hamburger {
      cursor: pointer;
      margin-left: -5px;
      margin-right: 10px;
      user-select: none;
      color: #eee;
      display: inline-block;
    }
    
    .hamburger:hover {
      color: #2A99E6;
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: -320px;
      width: 320px;
      min-height: 100vh;
      height: 100%;
      text-align: left;
      background-color: #242424;
      border-right: 1px solid #555;
      transition: left 0.3s ease;
      z-index: 1001;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    .side-menu.open {
      left: 0;
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      min-width: 100vw;
      min-height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .menu-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .menu-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #eee;
      user-select: none;
    }

    .menu-close:hover {
      color: #ff6b6b;
    }

    .menu-title {
      font-size: 18px;
      font-weight: bold;
      text-align: left;
      margin-bottom: 10px;
      color: #FF6E3D;
    }

    .menu-item {
      font-size: 18px;
      text-align: left;
      display: inline-block;
      padding: 6px 0;
      color: #eee;
      text-decoration: none;
    }

    .menu-item:hover {
      color: #0CFF57;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-spacer {
      height: 30px;
    }

   .toggle-button {
      cursor: pointer;
      color: #7755FF;
      text-decoration: underline;
      font-size: 18px;
      text-align: left;
      display: block;
      padding: 6px 0;
      user-select: none;
    }

    .toggle-button:hover {
      color: #0CFF57;
      text-decoration: underline;
    }

    #linkList {
      display: none;
      color: #7755FF;
    }

    #linkList1 {
      font-size: 18px;
      text-align: left;
      padding-bottom: 6px;
      display: none;
      color: #7755FF;
    }

    #linkList2 {
      font-size: 18px;
      text-align: left;
      display: none;
      color: #7755FF;
    }

    #linkList a {
      display: inline-block;
      text-decoration: none;
      color: #7755FF;
    }

    #linkList a:visited {
      color: #7755FF;
      text-decoration: underline;
    }

    #linkList a:hover {
      text-decoration: underline;
      color: #0CFF57;
    }

    #linkList a:active {
      color: #FF0000;
      text-decoration: underline;
    }
    
    /* --- renma-armor.html風のボタンスタイル --- */

    /* 共通クラス */
    .styled-form-group {
        display: flex;
        align-items: center;
        flex-wrap: wrap; /* 条件チェックボックスが折り返せるように */
        gap: 5px 10px;   /* ボタン間の隙間 */
    }

    /* 元のラジオボタンとチェックボックスを非表示にする */
    .styled-form-group input[type="radio"],
    .styled-form-group input[type="checkbox"] {
        display: none;
    }

    /* labelをボタンのようにスタイリング */
    .styled-form-group label {
        padding: 5px 15px;
        border: 1px solid #777;
        border-radius: 20px; /* pill型デザインの角丸 */
        cursor: pointer;
        background-color: #555;
        color: white;
        transition: all 0.2s;
        margin: 0; /* 元のlabelスタイルを上書き */
        user-select: none;
    }

    /* 選択された際のスタイル(デフォルト) */
    .styled-form-group input[type="radio"]:checked + label,
    .styled-form-group input[type="checkbox"]:checked + label {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    /* アビリティ選択ボタンの折り返しを禁止 */
    .form-type .styled-form-group {
        flex-wrap: nowrap;
    }

    /* --- 特定の条件ボタンの色を変更 --- */
    .styled-form-group input[value="HP満タン時"]:checked + label {
        background-color: forestgreen;
        border-color: forestgreen;
    }
    .styled-form-group input[value="瀕死時"]:checked + label {
        background-color: forestgreen;
        border-color: forestgreen;
    }
    .styled-form-group input[value="カウンター"]:checked + label {
        background-color: forestgreen;
        border-color: forestgreen;
    }
    .styled-form-group input[value="熱"]:checked + label {
        background-color: red;
        border-color: red;
    }
    .styled-form-group input[value="冷"]:checked + label {
        background-color: dodgerblue;
        border-color: dodgerblue;
    }
    .styled-form-group input[value="雷"]:checked + label {
        background-color: darkorange;
        border-color: darkorange;
    }
    .styled-form-group input[value="陽"]:checked + label {
        background-color: orangered;
        border-color: orangered;
    }
    .styled-form-group input[value="陰"]:checked + label {
        background-color: darkorchid;
        border-color: darkorchid;
    }

    </style>
</head>
<body>

  <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

  <div class="side-menu" id="sideMenu">
    <div class="menu-title">リユニのWeb版いろいろ</div>
    <a class="menu-item" href="kiokucalc.html">記憶再戦時間計算</a><br>
    <a class="menu-item" href="kiokucalc2.html">記憶再戦回数計算</a><br>
    </br>
    <a class="menu-item" href="ikuseicalc.html">育成効率比較ツール</a><br>
    <a class="menu-item" href="raidcalc.html">レイド周回効率比較ツール</a><br>
    </br>
    <a class="menu-item" href="renma-armor.html">練磨(防具)リスト</a><br>
    <a class="menu-item" href="armor-top5.html">練磨(防具)TOP5確認</a><br>
    <a class="menu-item" href="armor-calc.html">練磨(防具)自動選定ツール</a><br>
    </br>
    <span class="toggle-button" data-target="linkList1">アイテム獲得チェッカー</span>
    <div id="linkList1">
      ├ <a class="menu-item" href="checker-4gen.html">四元像ピアスチェッカー</a></br>
      ├ <a class="menu-item" href="checker-stella.html">ステライヤリングチェッカー</a></br>
      └ <a class="menu-item" href="checker-niji.html">虹瑠璃の腕輪チェッカー</a></br>
    </div>
    <span class="toggle-button" data-target="linkList2">アイテム獲得報告用</span>
    <div id="linkList2">
      ├ <a class="menu-item" href="report-4gen.html">四元像ピアス報告用</a></br>
      ├ <a class="menu-item" href="report-stella.html">ステライヤリング報告用</a></br>
      └ <a class="menu-item" href="report-niji.html">虹瑠璃の腕輪報告用</a></br>
    </div>
    </br>
    <a class="menu-item" href="expcalc.html">EXPスタンプ必要数計算</a><br>
    <a class="menu-item" href="https://jessy-rs.github.io/Multi-Stage-Slash/">多段斬りアプリ</a><br>
    </br>
    <a class="menu-item"  href="armor.html">装備候補検索ツール</a><br>
    <a class="menu-item"  href="style-info.html">スタイル情報ビューア</a><br>
    <br>
    <a class="menu-item" href="index.html">インデックスページ</a><br>
    </br>
  </div>

    <div class="main-container">
        <header>
            <h1><span class="hamburger" onclick="toggleMenu()">☰</span>練磨(防具)X用非公開ツール</h1>
        </header>

        <div class="zoom-buttons">
            <button onclick="changeZoom(0.1)">＋</button>
            <button onclick="changeZoom(-0.1)">－</button>
        </div>

        <div class="file-input-container">
            <input type="file" id="json-file-input" accept=".json">
            <p id="file-status">ファイルが選択されていません</p>
        </div>

        <div class="character-grid" id="character-grid">
        </div>

        <div class="global-controls">
            <button class="calculate-button" id="calculate-all-button" disabled>全キャラクターをまとめて計算</button>
        </div>
    </div>

    <footer>
        ※こちらのツールは一般公開しておりません。<br>
        ※合計値は装備固有アビリティの値も加算されています。
    </footer>

    <div class="bottom">
        <a href="renma-armor.html">リストページへ</a>　<a href="armor-top5.html">TOP5ページへ</a>　<a href="armor-calc.html">自動選定ツールへ</a>
    </div>

    <script>

    // ハンバーガーメニューの関数
    function toggleMenu() {
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');

        if (sideMenu.classList.contains('open')) {
            closeMenu();
        } else {
            sideMenu.classList.add('open');
            menuOverlay.classList.add('open');
        }
    }

    function closeMenu() {
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        const menuClose = document.getElementById('menuClose');

        sideMenu.classList.remove('open');
        menuOverlay.classList.remove('open');
        menuClose.style.color = '#eee';
    }

    let startX = 0, startY = 0, endX = 0, endY = 0;
    document.addEventListener('touchstart', e => { startX = e.changedTouches[0].screenX; startY = e.changedTouches[0].screenY; }, false);
    document.addEventListener('touchend', e => { endX = e.changedTouches[0].screenX; endY = e.changedTouches[0].screenY; handleGesture(); }, false);

    function handleGesture() {
      const diffX = endX - startX; const diffY = endY - startY;
      if (Math.abs(diffX) > Math.abs(diffY)) {
        if (diffX > 50 && startX < 30) toggleMenu();
        else if (diffX < -50) closeMenu();
      }
    }

    let zoomLevel = 1;
    function changeZoom(delta) {
        zoomLevel = Math.max(0.5, Math.min(2.0, zoomLevel + delta));
        document.body.style.zoom = zoomLevel;
    }
    
    function scrollToCategory(categoryId) {
        const element = document.getElementById(categoryId);
        if (element) element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    document.addEventListener('DOMContentLoaded', () => {
        let armorData = [];
        let uniqueMainArmorNames = [];
        let uniqueSubArmorNames = [];
        let mainNativeAbilities = new Map();
        let subNativeAbilities = new Map();
        const fileInput = document.getElementById('json-file-input');
        const fileStatus = document.getElementById('file-status');
        const characterGrid = document.getElementById('character-grid');
        const calculateAllButton = document.getElementById('calculate-all-button');
        const abilityConditions = [ { name: "HP満タン時", value: "HP満タン時" }, { name: "瀕死時", value: "瀕死時" }, { name: "カウンター", value: "カウンター" }, { name: "斬", value: "斬" }, { name: "打", value: "打" }, { name: "突", value: "突" }, { name: "熱", value: "熱" }, { name: "冷", value: "冷" }, { name: "雷", value: "雷" }, { name: "陽", value: "陽" }, { name: "陰", value: "陰" } ];
        const seriesNames = ["未選択", "GBSaGa", "RS1", "RS2", "RS3", "SF1", "SF2", "US", "ES", "IS", "SSG", "SaGaRS", "SaGaEB", "その他"];

        async function loadCsvData(url, targetMap) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                lines.shift();
                lines.forEach(line => {
                    const [name, target, valueStr] = line.split(',');
                    if (name && target && valueStr) {
                        const value = parseInt(valueStr.trim(), 10);
                        if (!isNaN(value)) {
                            if (!targetMap.has(name.trim())) targetMap.set(name.trim(), []);
                            targetMap.get(name.trim()).push({ target: target.trim(), value });
                        }
                    }
                });
            } catch (error) {
                console.error(`Error loading or parsing CSV from ${url}:`, error);
                fileStatus.innerHTML += `<br><span style="color: red;">${url} の読み込みに失敗しました。</span>`;
            }
        }
        
        function handleConditionSync(charId, eventType) {
            if (charId === 2 && eventType === 'radio-change' && document.querySelector('input[name="ability-type-2"]:checked').value === '味方威力＋') {
                const sourceConditions = Array.from(document.querySelectorAll('input[name="condition-1"]:checked')).map(cb => cb.value);
                for (let i = 2; i <= 5; i++) {
                    document.querySelector(`input[name="ability-type-${i}"][value="味方威力＋"]`).checked = true;
                    document.querySelectorAll(`input[name="condition-${i}"]`).forEach(cb => { cb.checked = sourceConditions.includes(cb.value); });
                }
                const calculateButton = document.getElementById('calculate-all-button');
                if (calculateButton) calculateButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return; 
            }
            const currentAbilityType = document.querySelector(`input[name="ability-type-${charId}"]:checked`).value;
            if (eventType === 'radio-change' && currentAbilityType === '味方威力＋') {
                let conditionsToCopy = null;
                for (let i = charId - 1; i >= 1; i--) {
                    if (document.querySelector(`input[name="ability-type-${i}"]:checked`).value === '味方威力＋') {
                        conditionsToCopy = Array.from(document.querySelectorAll(`input[name="condition-${i}"]:checked`)).map(cb => cb.value);
                        break; 
                    }
                }
                if (conditionsToCopy !== null) document.querySelectorAll(`input[name="condition-${charId}"]`).forEach(cb => { cb.checked = conditionsToCopy.includes(cb.value); });
            }
            if (currentAbilityType === '味方威力＋') {
                const sourceConditions = Array.from(document.querySelectorAll(`input[name="condition-${charId}"]:checked`)).map(cb => cb.value);
                for (let i = charId + 1; i <= 5; i++) {
                    if (document.querySelector(`input[name="ability-type-${i}"]:checked`).value === '味方威力＋') {
                        document.querySelectorAll(`input[name="condition-${i}"]`).forEach(cb => { cb.checked = sourceConditions.includes(cb.value); });
                    }
                }
            }
        }

        async function initialize() {
            for (let i = 1; i <= 5; i++) {
                const charContainer = document.createElement('div');
                charContainer.className = 'character-container';
                charContainer.id = `char-${i}`;
                let checkboxesHTML = abilityConditions.map(cond => `<input type="checkbox" name="condition-${i}" value="${cond.value}" id="condition-${i}-${cond.value.replace(/\s/g, '-')}"><label for="condition-${i}-${cond.value.replace(/\s/g, '-')}">${cond.name}</label>`).join('');
                let seriesOptionsHTML = seriesNames.map(name => `<option value="${name}">${name}</option>`).join('');
                charContainer.innerHTML = `<h2><span>キャラ ${i}</span><select class="series-select" id="series-select-${i}">${seriesOptionsHTML}</select><div class="nav-buttons"><button class="nav-button" id="nav-up-${i}">▲</button><button class="nav-button" id="nav-down-${i}">▼</button></div></h2><div class="form-horizontal-row"><div class="form-type"><fieldset class="form-section"><legend>アビリティ</legend><div class="styled-form-group"><input type="radio" name="ability-type-${i}" value="威力＋" id="ability-type-${i}-power" checked><label for="ability-type-${i}-power">威力＋</label><input type="radio" name="ability-type-${i}" value="味方威力＋" id="ability-type-${i}-party"><label for="ability-type-${i}-party">味方威力＋</label></div></fieldset></div><div class="form-conditions"><fieldset class="form-section"><legend>条件 (複数可)</legend><div class="styled-form-group conditions-wrapper">${checkboxesHTML}</div></fieldset></div></div><div class="result-area" id="result-area-${i}"><p>計算結果がここに表示されます。</p></div>`;
                characterGrid.appendChild(charContainer);
                const navUpButton = charContainer.querySelector(`#nav-up-${i}`);
                const navDownButton = charContainer.querySelector(`#nav-down-${i}`);
                if (i === 1) navUpButton.disabled = true; else navUpButton.addEventListener('click', () => scrollToCategory(`char-${i - 1}`));
                if (i === 5) navDownButton.disabled = true; else navDownButton.addEventListener('click', () => scrollToCategory(`char-${i + 1}`));
            }
            await Promise.all([ loadCsvData('data/armor-main-ability.csv', mainNativeAbilities), loadCsvData('data/armor-sub-ability.csv', subNativeAbilities) ]);
        }
        
        initialize();

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const rawData = JSON.parse(e.target.result);
                    armorData = rawData.map(item => ({...item, value: parseInt(item.value, 10)})).filter(item => !isNaN(item.value));
                    const mainNames = new Set(armorData.filter(a => a.armorType === 'main').map(a => a.armorName));
                    const subNames = new Set(armorData.filter(a => a.armorType === 'sub').map(a => a.armorName));
                    uniqueMainArmorNames = ['該当なし', ...Array.from(mainNames).sort()];
                    uniqueSubArmorNames = ['該当なし', ...Array.from(subNames).sort()];
                    fileStatus.textContent = `読み込み完了: ${file.name}`;
                    fileStatus.style.color = '#98fb98';
                    calculateAllButton.disabled = false;
                } catch (error) {
                    alert('JSONファイルの読み込みまたは解析に失敗しました。\n' + error);
                    fileStatus.textContent = 'エラー: ファイルを読み込めません';
                    fileStatus.style.color = 'red';
                    armorData = [];
                    calculateAllButton.disabled = true;
                }
            };
            reader.readAsText(file);
        });
        
        function getConditionFromAbilityName(abilityName) {
            if (!abilityName) return null;
            const match = abilityName.match(/\((.*)\)/);
            return match ? match[1] : null;
        }

        function getNativeAbilityValue(armorName, armorType, selectedConditions, abilityType, charId) {
            const nativeAbilityMap = armorType === 'main' ? mainNativeAbilities : subNativeAbilities;
            if (!nativeAbilityMap.has(armorName)) return 0;
            const selectedSeries = document.getElementById(`series-select-${charId}`).value;
            let totalValue = 0;
            const abilities = nativeAbilityMap.get(armorName);
            for (const ability of abilities) {
                let shouldAddValue = true;
                if (armorName.includes('名将の鎧') || armorName.includes('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ')) {
                    if (selectedSeries === '未選択') shouldAddValue = false;
                    else {
                        const armorSeriesMatch = armorName.match(/\(([^)]+)\)/);
                        if (armorSeriesMatch) {
                            const armorSeriesStr = armorSeriesMatch[1];
                            if (armorName.includes('☆ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ') && armorSeriesStr === 'US・ES・IS') { if (!['US', 'ES', 'IS'].includes(selectedSeries)) shouldAddValue = false; }
                            else { const armorSeriesList = armorSeriesStr.split(/[&＆]/).map(s => s.trim()); if (!armorSeriesList.includes(selectedSeries)) shouldAddValue = false; }
                        }
                    }
                }
                if (shouldAddValue) {
                    const { target, value } = ability;
                    if (abilityType === '味方威力＋') { if (target === '味方威力') totalValue += value; }
                    else { if (target === '威力' || target === '味方威力' || selectedConditions.includes(target)) totalValue += value; }
                }
            }
            return totalValue;
        }

        function findBestArmorWithNativeAbilities(armorType, character, excludedItems, partyConfig) {
            const { abilityType, selectedConditions, charId, series } = character;
            const candidates = [];
            const availableArmor = armorData.filter(item => item.armorType === armorType && !excludedItems.has(item.armorName));
            for (const armor of availableArmor) {
                const jsonAbilityCondition = getConditionFromAbilityName(armor.abilityName);
                const jsonAbilityType = armor.abilityName.includes('味方威力＋') ? '味方威力＋' : '威力＋';
                let typeMatch = (abilityType === jsonAbilityType) || (abilityType === '威力＋' && jsonAbilityType === '味方威力＋');
                if (typeMatch && selectedConditions.includes(jsonAbilityCondition)) {
                    const jsonValue = armor.value;
                    const nativeValue = getNativeAbilityValue(armor.armorName, armorType, selectedConditions, abilityType, charId);
                    let combinedValue;
                    if (abilityType === '味方威力＋' && armor.armorName.includes('名将の鎧') && armor.armorType === 'main') {
                        let isBeneficialToParty = false;
                        if (series !== '未選択') {
                            const armorSeriesMatch = armor.armorName.match(/\(([^)]+)\)/);
                            if (armorSeriesMatch) {
                                const armorSeries = armorSeriesMatch[1].split(/[&＆]/).map(s => s.trim());
                                if (armorSeries.includes(series)) {
                                    for (const member of partyConfig) {
                                        if (member.charId === charId) continue;
                                        if (member.abilityType === '威力＋' && member.series === series) { isBeneficialToParty = true; break; }
                                    }
                                }
                            }
                        }
                        combinedValue = isBeneficialToParty ? (jsonValue + nativeValue) : jsonValue;
                    } else combinedValue = jsonValue + nativeValue;
                    candidates.push({ ...armor, combinedValue });
                }
            }
            if (candidates.length === 0) return { armorName: '該当なし', value: 0, abilityName: '-' };
            candidates.sort((a, b) => b.combinedValue - a.combinedValue);
            return candidates[0];
        }
        
        function runIterativeSolver(partyConfig, lockedEquipment = new Map()) {
            let partyLoadout = Array(5).fill(null), lastLoadoutStr = "", iterations = 0;
            while (JSON.stringify(partyLoadout) !== lastLoadoutStr && iterations < 5) {
                lastLoadoutStr = JSON.stringify(partyLoadout);
                iterations++;
                const equippedThisPass = new Set();
                lockedEquipment.forEach(loadout => {
                    if (loadout.mainArmor) equippedThisPass.add(loadout.mainArmor.armorName);
                    if (loadout.subArmor) equippedThisPass.add(loadout.subArmor.armorName);
                });
                const nextLoadout = [];
                for (const character of partyConfig) {
                    const { charId } = character;
                    let mainArmor, subArmor;
                    if (lockedEquipment.has(charId) && lockedEquipment.get(charId).mainArmor) mainArmor = lockedEquipment.get(charId).mainArmor; else mainArmor = findBestArmorWithNativeAbilities('main', character, equippedThisPass, partyConfig);
                    if (mainArmor.armorName !== '該当なし') equippedThisPass.add(mainArmor.armorName);
                    if (lockedEquipment.has(charId) && lockedEquipment.get(charId).subArmor) subArmor = lockedEquipment.get(charId).subArmor; else subArmor = findBestArmorWithNativeAbilities('sub', character, equippedThisPass, partyConfig);
                    if (subArmor.armorName !== '該当なし') equippedThisPass.add(subArmor.armorName);
                    nextLoadout[charId - 1] = { mainArmor, subArmor };
                }
                partyLoadout = nextLoadout;
            }
            return partyLoadout;
        }

        function calculateFinalResults(partyLoadout, partyConfig) {
            const characterResults = [];
            for (const character of partyConfig) {
                const { charId, abilityType, selectedConditions } = character;
                const equipment = partyLoadout[charId - 1];
                if (!equipment) { characterResults.push({ charId, abilityType, selectedConditions, mainArmor: {armorName: 'エラー'}, subArmor: {armorName: 'エラー'}, totals: {grand: -1}}); continue; }
                const { mainArmor, subArmor } = equipment;
                mainArmor.nativeValue = getNativeAbilityValue(mainArmor.armorName, 'main', selectedConditions, abilityType, charId);
                subArmor.nativeValue = getNativeAbilityValue(subArmor.armorName, 'sub', selectedConditions, abilityType, charId);
                characterResults.push({ ...character, mainArmor, subArmor });
            }

            for (const receiver of characterResults) {
                let selfJsonValue = 0;
                const mainCond = getConditionFromAbilityName(receiver.mainArmor.abilityName);
                if (!mainCond || receiver.selectedConditions.includes(mainCond)) selfJsonValue += receiver.mainArmor.value || 0;
                const subCond = getConditionFromAbilityName(receiver.subArmor.abilityName);
                if (!subCond || receiver.selectedConditions.includes(subCond)) selfJsonValue += receiver.subArmor.value || 0;
                const selfValue = selfJsonValue + (receiver.mainArmor.nativeValue || 0) + (receiver.subArmor.nativeValue || 0);

                let partyValue = 0;
                for (const provider of characterResults) {
                    if (receiver.charId === provider.charId) continue;
                    let contribution = 0;
                    
                    const provMainJsonAbility = provider.mainArmor.abilityName;
                    if (provMainJsonAbility && provMainJsonAbility.includes("味方威力＋")) {
                        const cond = getConditionFromAbilityName(provMainJsonAbility);
                        if (receiver.selectedConditions.includes(cond)) {
                            contribution += provider.mainArmor.value;
                        }
                    }
                    const provSubJsonAbility = provider.subArmor.abilityName;
                    if (provSubJsonAbility && provSubJsonAbility.includes("味方威力＋")) {
                        const cond = getConditionFromAbilityName(provSubJsonAbility);
                        if (receiver.selectedConditions.includes(cond)) {
                            contribution += provider.subArmor.value;
                        }
                    }

                    const getNativeContribution = (armorName, armorType) => {
                        const nativeMap = armorType === 'main' ? mainNativeAbilities : subNativeAbilities;
                        if (!nativeMap.has(armorName)) return 0;
                        let value = 0;
                        for (const ability of nativeMap.get(armorName)) {
                            if (ability.target === '味方威力') {
                                if (armorName.includes('名将の鎧')) {
                                    if (receiver.series !== '未選択' && receiver.series === provider.series) {
                                        const seriesMatch = armorName.match(/\(([^)]+)\)/);
                                        if (seriesMatch && seriesMatch[1].split(/[&＆]/).map(s => s.trim()).includes(receiver.series)) {
                                            value += ability.value;
                                        }
                                    }
                                } else {
                                    value += ability.value;
                                }
                            }
                        }
                        return value;
                    };
                    contribution += getNativeContribution(provider.mainArmor.armorName, 'main');
                    contribution += getNativeContribution(provider.subArmor.armorName, 'sub');
                    
                    partyValue += contribution;
                }
                
                if (receiver.abilityType === '威力＋') {
                    receiver.totals = { self: selfValue, party: partyValue, grand: selfValue + partyValue };
                } else {
                    const hasMeisho = receiver.mainArmor.armorName.includes('名将の鎧');
                    if (hasMeisho) {
                        const normalValue = selfJsonValue + getNativeContribution(receiver.subArmor.armorName, 'sub');
                        receiver.totals = { isMeisho: true, meishoTotal: selfValue, normalTotal: normalValue };
                    } else receiver.totals = { self: selfValue };
                }
            }
            return characterResults;
        }

        function calculateAllCharacters() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const partyConfig = [];
            let primaryAttacker = null;
            for (let i = 1; i <= 5; i++) {
                const charConfig = { charId: i, abilityType: document.querySelector(`input[name="ability-type-${i}"]:checked`).value, selectedConditions: Array.from(document.querySelectorAll(`input[name="condition-${i}"]:checked`)).map(cb => cb.value), series: document.getElementById(`series-select-${i}`).value };
                partyConfig.push(charConfig);
                if (charConfig.abilityType === '威力＋' && !primaryAttacker) primaryAttacker = charConfig;
            }
            if (!primaryAttacker) {
                const loadout = runIterativeSolver(partyConfig);
                const results = calculateFinalResults(loadout, partyConfig);
                results.forEach(r => displayResult(r));
                setupRealtimeListeners();
                return;
            }
            let bestLoadout = null, bestTotal = -1;
            const attackerCandidates = [];
            const availableMainArmor = armorData.filter(item => item.armorType === 'main');
            for (const armor of availableMainArmor) {
                const jsonAbilityCondition = getConditionFromAbilityName(armor.abilityName);
                if (primaryAttacker.selectedConditions.includes(jsonAbilityCondition)) {
                    const jsonAbilityType = armor.abilityName.includes('味方威力＋') ? '味方威力＋' : '威力＋';
                    if (jsonAbilityType === '威力＋' || jsonAbilityType === '味方威力＋') attackerCandidates.push(armor);
                }
            }
            const powerPlusCandidates = attackerCandidates.filter(a => !a.abilityName.includes('味方威力＋')).map(a => ({ ...a, totalValue: a.value + getNativeAbilityValue(a.armorName, 'main', primaryAttacker.selectedConditions, primaryAttacker.abilityType, primaryAttacker.charId) })).sort((a, b) => b.totalValue - a.totalValue);
            const partyBuffCandidates = attackerCandidates.filter(a => a.abilityName.includes('味方威力＋')).map(a => ({ ...a, totalValue: a.value + getNativeAbilityValue(a.armorName, 'main', primaryAttacker.selectedConditions, primaryAttacker.abilityType, primaryAttacker.charId) })).sort((a, b) => b.totalValue - a.totalValue);
            const scenariosToTest = [ ...powerPlusCandidates.slice(0, 2), ...partyBuffCandidates.slice(0, 3) ];
            const uniqueScenarios = [...new Map(scenariosToTest.map(item => [item.armorName, item])).values()];
            uniqueScenarios.push(null); 
            for (const attackerMainArmor of uniqueScenarios) {
                const lockedEquipment = new Map();
                if (attackerMainArmor) lockedEquipment.set(primaryAttacker.charId, { mainArmor: attackerMainArmor, subArmor: null });
                const scenarioLoadout = runIterativeSolver(partyConfig, lockedEquipment);
                const scenarioResults = calculateFinalResults(scenarioLoadout, partyConfig);
                const scenarioAttackerResult = scenarioResults.find(r => r.charId === primaryAttacker.charId);
                if (scenarioAttackerResult && scenarioAttackerResult.totals && scenarioAttackerResult.totals.grand > bestTotal) {
                    bestTotal = scenarioAttackerResult.totals.grand;
                    bestLoadout = scenarioLoadout;
                }
            }
            if (bestLoadout) {
                const finalResults = calculateFinalResults(bestLoadout, partyConfig);
                finalResults.forEach(r => displayResult(r));
                setupRealtimeListeners();
            } else {
                partyConfig.forEach(c => displayEmptyResult(c.charId));
            }
        }
        
        function getArmorTextStyleClass(armorName) {
            if (!armorName || armorName === '該当なし') return 'armor-text-none';
            if (armorName.includes('名将の鎧') || armorName.includes('ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ')) return 'armor-text-special';
            if (mainNativeAbilities.has(armorName) || subNativeAbilities.has(armorName)) return 'armor-text-native';
            return 'armor-text-default';
        }

        function updateLinkedDropdowns(charId, armorType, armorSelect, abilitySelect, valueSelect) {
            const selectedArmorName = armorSelect.value;
            armorSelect.className = 'armor-select ' + getArmorTextStyleClass(selectedArmorName);
            abilitySelect.innerHTML = '';
            valueSelect.innerHTML = '';
            if (selectedArmorName === '該当なし') {
                abilitySelect.innerHTML = '<option value="-">-</option>';
                valueSelect.innerHTML = '<option value="0">0%</option>';
                return;
            }
            const abilitiesForArmor = armorData.filter(item => item.armorName === selectedArmorName && item.armorType === armorType);
            if (abilitiesForArmor.length > 0) {
                 abilitiesForArmor.forEach(ability => { abilitySelect.innerHTML += `<option value="${ability.abilityName}">${ability.abilityName}</option>`; });
                valueSelect.innerHTML = `<option value="${abilitiesForArmor[0].value}">${abilitiesForArmor[0].value}%</option>`;
            } else {
                abilitySelect.innerHTML = '<option value="-">-</option>';
                valueSelect.innerHTML = '<option value="0">0%</option>';
            }
        }
        
        function displayResult(result) {
            const { charId, mainArmor, subArmor, totals } = result;
            const resultArea = document.getElementById(`result-area-${charId}`);
            const mainArmorOptions = uniqueMainArmorNames.map(name => `<option value="${name}" class="${getArmorTextStyleClass(name)}" ${name === mainArmor.armorName ? 'selected' : ''}>${name}</option>`).join('');
            const subArmorOptions = uniqueSubArmorNames.map(name => `<option value="${name}" class="${getArmorTextStyleClass(name)}" ${name === subArmor.armorName ? 'selected' : ''}>${name}</option>`).join('');
            resultArea.innerHTML = `<div class="result-details"><table class="result-table"><tbody><tr><td class="col-heading"><span class="heading-text">主防具</span></td><td class="col-armor"><div class="td-flex-container"><span class="data-label">装備:</span><select id="main-armor-select-${charId}">${mainArmorOptions}</select></div></td><td class="col-ability"><div class="td-flex-container"><span class="data-label">アビリティ:</span><select id="main-ability-select-${charId}"></select></div></td><td class="col-value"><div class="td-flex-container"><span class="data-label">効果値:</span><select id="main-value-select-${charId}" class="value-select"></select></div></td></tr><tr><td class="col-heading"><span class="heading-text">副防具</span></td><td class="col-armor"><div class="td-flex-container"><span class="data-label">装備:</span><select id="sub-armor-select-${charId}">${subArmorOptions}</select></div></td><td class="col-ability"><div class="td-flex-container"><span class="data-label">アビリティ:</span><select id="sub-ability-select-${charId}"></select></div></td><td class="col-value"><div class="td-flex-container"><span class="data-label">効果値:</span><select id="sub-value-select-${charId}" class="value-select"></select></div></td></tr></tbody></table></div><div class="total-container" id="total-container-${charId}"></div>`;
            const mainArmorSelect = document.getElementById(`main-armor-select-${charId}`), mainAbilitySelect = document.getElementById(`main-ability-select-${charId}`), mainValueSelect = document.getElementById(`main-value-select-${charId}`);
            updateLinkedDropdowns(charId, 'main', mainArmorSelect, mainAbilitySelect, mainValueSelect);
            mainAbilitySelect.value = mainArmor.abilityName || '-';
            mainAbilitySelect.dispatchEvent(new Event('change'));
            const subArmorSelect = document.getElementById(`sub-armor-select-${charId}`), subAbilitySelect = document.getElementById(`sub-ability-select-${charId}`), subValueSelect = document.getElementById(`sub-value-select-${charId}`);
            updateLinkedDropdowns(charId, 'sub', subArmorSelect, subAbilitySelect, subValueSelect);
            subAbilitySelect.value = subArmor.abilityName || '-';
            subAbilitySelect.dispatchEvent(new Event('change'));
            updateTotalsDisplay(charId, totals);
        }

        function updateTotalsDisplay(charId, totals) {
            const totalContainer = document.getElementById(`total-container-${charId}`);
            if (!totals) return;
            let totalHTML = '';
            if (totals.isMeisho) totalHTML = `<div class="total-row"><span class="label">名将:</span><span class="value">${totals.meishoTotal}%</span></div><div class="total-row final-total"><span class="label">通常:</span><span class="value">${totals.normalTotal}%</span></div>`;
            else if (totals.grand !== undefined) totalHTML = `<div class="total-row"><span class="label">自身:</span><span class="value">${totals.self}%</span></div><div class="total-row"><span class="label">味方:</span><span class="value">${totals.party}%</span></div><div class="total-row final-total"><span class="label">合計:</span><span class="value">${totals.grand}%</span></div>`;
            else totalHTML = `<div class="total-row final-total"><span class="label">合計:</span><span class="value">${totals.self}%</span></div>`;
            totalContainer.innerHTML = totalHTML;
        }

        function recalculateAndUpdateAllTotals() {
            if (armorData.length === 0) return;
            const partyConfig = [], partyLoadout = [];
            for (let i = 1; i <= 5; i++) {
                partyConfig.push({ charId: i, abilityType: document.querySelector(`input[name="ability-type-${i}"]:checked`).value, selectedConditions: Array.from(document.querySelectorAll(`input[name="condition-${i}"]:checked`)).map(cb => cb.value), series: document.getElementById(`series-select-${i}`).value });
                const mainArmorName = document.getElementById(`main-armor-select-${i}`).value, mainAbilityName = document.getElementById(`main-ability-select-${i}`).value;
                const mainArmorEntry = armorData.find(a => a.armorName === mainArmorName && a.abilityName === mainAbilityName);
                const mainValue = mainArmorEntry ? mainArmorEntry.value : 0;
                const subArmorName = document.getElementById(`sub-armor-select-${i}`).value, subAbilityName = document.getElementById(`sub-ability-select-${i}`).value;
                const subArmorEntry = armorData.find(a => a.armorName === subArmorName && a.abilityName === subAbilityName);
                const subValue = subArmorEntry ? subArmorEntry.value : 0;
                partyLoadout.push({ mainArmor: { armorName: mainArmorName, abilityName: mainAbilityName, value: mainValue }, subArmor: { armorName: subArmorName, abilityName: subAbilityName, value: subValue } });
            }
            const finalResults = calculateFinalResults(partyLoadout, partyConfig);
            finalResults.forEach(r => updateTotalsDisplay(r.charId, r.totals));
        }

        function setupRealtimeListeners() {
            for (let i = 1; i <= 5; i++) {
                document.querySelectorAll(`input[name="ability-type-${i}"], input[name="condition-${i}"], #series-select-${i}`).forEach(input => input.addEventListener('change', recalculateAndUpdateAllTotals));
                document.querySelectorAll(`input[name="ability-type-${i}"]`).forEach(radio => radio.addEventListener('change', () => handleConditionSync(i, 'radio-change')));
                document.querySelectorAll(`input[name="condition-${i}"]`).forEach(checkbox => checkbox.addEventListener('change', () => handleConditionSync(i, 'checkbox-change')));
                const mainArmorSelect = document.getElementById(`main-armor-select-${i}`), mainAbilitySelect = document.getElementById(`main-ability-select-${i}`), mainValueSelect = document.getElementById(`main-value-select-${i}`);
                const subArmorSelect = document.getElementById(`sub-armor-select-${i}`), subAbilitySelect = document.getElementById(`sub-ability-select-${i}`), subValueSelect = document.getElementById(`sub-value-select-${i}`);
                mainArmorSelect.addEventListener('change', () => { updateLinkedDropdowns(i, 'main', mainArmorSelect, mainAbilitySelect, mainValueSelect); recalculateAndUpdateAllTotals(); });
                mainAbilitySelect.addEventListener('change', () => {
                    const selectedAbility = armorData.find(a => a.armorName === mainArmorSelect.value && a.abilityName === mainAbilitySelect.value);
                    mainValueSelect.innerHTML = `<option value="${selectedAbility ? selectedAbility.value : 0}">${selectedAbility ? selectedAbility.value : 0}%</option>`;
                    recalculateAndUpdateAllTotals();
                });
                subArmorSelect.addEventListener('change', () => { updateLinkedDropdowns(i, 'sub', subArmorSelect, subAbilitySelect, subValueSelect); recalculateAndUpdateAllTotals(); });
                subAbilitySelect.addEventListener('change', () => {
                    const selectedAbility = armorData.find(a => a.armorName === subArmorSelect.value && a.abilityName === subAbilitySelect.value);
                    subValueSelect.innerHTML = `<option value="${selectedAbility ? selectedAbility.value : 0}">${selectedAbility ? selectedAbility.value : 0}%</option>`;
                    recalculateAndUpdateAllTotals();
                });
            }
        }
        
        function displayEmptyResult(charId) {
            document.getElementById(`result-area-${charId}`).innerHTML = `<p>条件を選択して計算を実行してください。</p>`;
        }

        calculateAllButton.addEventListener('click', calculateAllCharacters);
    });

    document.addEventListener("DOMContentLoaded", function(){
      var toggleButtons = document.querySelectorAll(".toggle-button");
    
      toggleButtons.forEach(function(button) {
        var targetId = button.getAttribute("data-target");
        var list = document.getElementById(targetId);
        list.style.display = "none";
    
        button.addEventListener("click", function(){
          if (list.style.display === "block") {
            list.style.display = "none";
          } else {
            list.style.display = "block";
          }
        });
      });
    });

  </script>

</body>
</html>