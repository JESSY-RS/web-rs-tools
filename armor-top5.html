<!DOCTYPE html>
<html lang="ja">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon-renma.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon-renma.png">
    <link rel="icon" type="image/png" href="web-app-manifest-192x192-renma.png">
    <title>練磨(防具)アビリティ TOP5</title> <!-- Created by じぇ -->

    <style>
        /* --- 全体 --- */
        body {
            background-color: #2A2A2A;
            color: #eee;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- ヘッダー --- */
        header {
            text-align: center;
        }

        h1 {
            color: #50b4f0;
            margin-top: 0px;
            margin-bottom: -5px;
        }

        /* --- コントロールセクション --- */
        .controls-container {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
        }

        .checkbox-container {
            margin-bottom: 15px;
            font-size: 16px;
        }
        .checkbox-container label {
            cursor: pointer;
        }

        /* --- 結果グリッドコンテナ (レスポンシブ対応) --- */
        .results-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* コンテナ間の隙間 */
            justify-content: center;
            max-width: 1400px; /* ページの最大幅をよりコンパクトに設定 */
            width: 100%;
            margin: 0 auto; /* 中央配置を強化 */
        }

        .category-container {
            background-color: #383838;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            justify-content: center;
            flex-basis: 100%; /* モバイルでのデフォルトは1列 */
        }

        /* PCなど広い画面(1200px以上)では2x2グリッドに */
        @media (min-width: 1200px) {
            .category-container {
                flex-basis: 45%; /* 50%より少し小さくしてgapのスペースを確保 */
            }
        }

        h2 {
            color: #c0c0ff;
            margin-top: -5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #555;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 移動ボタンのスタイル */
        .nav-buttons {
            display: flex;
            gap: 6px;
        }

        .nav-button {
            background-color: #555;
            color: #eee;
            border: 1px solid #777;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .nav-button:hover {
            background-color: #666;
        }

        .nav-button:active {
            background-color: #444;
        }

        .nav-button:disabled {
            background-color: #333;
            color: #666;
            cursor: default;
            opacity: 0.5;
        }

        /* --- テーブルスタイル --- */
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* 列幅を固定 */
        }

        th, td {
            padding: 10px;
            border: 1px solid #777; /* 罫線の太さを統一 */
            text-align: left;
            word-wrap: break-word; /* 長い単語を折り返す */
        }

        thead th {
            background-color: #444;
            color: #fff;
        }
        
        /* セル結合されたアビリティ名のスタイル */
        td.merged-ability-cell {
            vertical-align: top; /* 上揃え */
            color: #98fb98;
        }

        /* 列幅の指定 */
        .col-ability { width: 37%; }
        .col-armor { width: 45%; }
        .col-value { width: 18%; }

        /* データセルの効果値は右揃え */
        td.value-col {
            text-align: right;
            font-weight: bold;
            color: #ffd700;
        }

        /* --- 追加スタイル --- */
        .combined-value {
            color: red !important;
        }
        .combined-armor-name {
            color: orange;
        }
        .special-armor-name {
            color: magenta;
        }
        
        /* ヘッダーの効果値は左揃え */
        th.value-col {
            text-align: left;
        }

        .bottom {
            margin-top: 20px;
            font-size: 16pt;
            line-height: 2;
            text-align: center;
        }

        /* リンクのスタイル */
        a:link {
            color: #1D9BF0;
            text-decoration: underline;
        }

        a:visited {
            color: #7755FF;
            text-decoration: underline;
        }

        a:hover {
            color: #0CFF57;
        }

        a:active {
            color: #FF0000;
            text-decoration: underline;
        }

        /* 拡大縮小ボタンのスタイル - absolute positioned to not scroll */
        .zoom-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }

        .zoom-buttons button {
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }

    /* ハンバーガーメニューのスタイル */
    .hamburger {
      cursor: pointer;
      margin-left: -5px;
      margin-right: 10px;
      user-select: none;
      color: #eee;
      display: inline-block;
    }
    
    .hamburger:hover {
      color: #2A99E6;
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: -320px;
      width: 320px;
      min-height: 100vh;
      height: 100%;
      text-align: left;
      background-color: #242424;
      border-right: 1px solid #555;
      transition: left 0.3s ease;
      z-index: 1001;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    .side-menu.open {
      left: 0;
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      min-width: 100vw;
      min-height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .menu-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .menu-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #eee;
      user-select: none;
    }

    .menu-close:hover {
      color: #ff6b6b;
    }

    .menu-title {
      font-size: 18px;
      font-weight: bold;
      text-align: left;
      margin-bottom: 10px;
      color: #FF6E3D;
    }

    .menu-item {
      font-size: 18px;
      text-align: left;
      display: inline-block;
      padding: 6px 0;
      color: #eee;
      text-decoration: none;
    }

    .menu-item:hover {
      color: #0CFF57;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-spacer {
      height: 30px;
    }

   .toggle-button {
      cursor: pointer;
      color: #7755FF;
      text-decoration: underline;
      font-size: 18px;
      text-align: left;
      display: block;
      padding: 6px 0;
      user-select: none;
    }

    .toggle-button:hover {
      color: #0CFF57;
      text-decoration: underline;
    }

    #linkList {
      display: none;
      color: #7755FF;
    }

    #linkList1 {
      font-size: 18px;
      text-align: left;
      padding-bottom: 6px;
      display: none;
      color: #7755FF;
    }

    #linkList2 {
      font-size: 18px;
      text-align: left;
      display: none;
      color: #7755FF;
    }

    #linkList a {
      display: inline-block;
      text-decoration: none;
      color: #7755FF;
    }

    #linkList a:visited {
      color: #7755FF;
      text-decoration: underline;
    }

    #linkList a:hover {
      text-decoration: underline;
      color: #0CFF57;
    }

    #linkList a:active {
      color: #FF0000;
      text-decoration: underline;
    }

    </style>
</head>
<body>

  <!-- サイドメニューオーバーレイ -->
  <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

  <!-- サイドメニュー -->
  <div id="sidemenu-container"></div>

    <header>
        <h1><span class="hamburger" onclick="toggleMenu()">☰</span>練磨(防具)アビリティ TOP5</h1>
    </header>

    <div class="zoom-buttons">
        <button onclick="changeZoom(0.1)">＋</button>
        <button onclick="changeZoom(-0.1)">－</button>
    </div>

    <div class="controls-container">
        <div class="checkbox-container">
            <label>
                <input type="checkbox" id="include-unique-ability" checked>
                装備固有のアビリティも加味する
            </label>
        </div>
        <div class="file-input-container">
            <input type="file" id="json-file-input" accept=".json">
        </div>
    </div>

    <div class="results-grid">
        <div class="category-container" id="main-self">
            <h2>
                ■威力＋ (主防具)
                <div class="nav-buttons">
                    <button class="nav-button" disabled>▲</button>
                    <button class="nav-button" onclick="scrollToCategory('sub-self')">▼</button>
                </div>
            </h2>
            <div class="table-wrapper"></div>
        </div>
        <div class="category-container" id="sub-self">
            <h2>
                ■威力＋ (副防具)
                <div class="nav-buttons">
                    <button class="nav-button" onclick="scrollToCategory('main-self')">▲</button>
                    <button class="nav-button" onclick="scrollToCategory('main-party')">▼</button>
                </div>
            </h2>
            <div class="table-wrapper"></div>
        </div>
        <div class="category-container" id="main-party">
            <h2>
                ■味方威力＋ (主防具)
                <div class="nav-buttons">
                    <button class="nav-button" onclick="scrollToCategory('sub-self')">▲</button>
                    <button class="nav-button" onclick="scrollToCategory('sub-party')">▼</button>
                </div>
            </h2>
            <div class="table-wrapper"></div>
        </div>
        <div class="category-container" id="sub-party">
            <h2>
                ■味方威力＋ (副防具)
                <div class="nav-buttons">
                    <button class="nav-button" onclick="scrollToCategory('main-party')">▲</button>
                    <button class="nav-button" disabled>▼</button>
                </div>
            </h2>
            <div class="table-wrapper"></div>
        </div>
    </div>

    <footer>
<br>
            ※使用は自己責任にて。<br>
            ※名将の鎧(+15)とバトルヴァンブレイス(+20)のシリーズ一致分は加味されていませんので注意してください。
    </footer>

    <div class="bottom">
        <a href="renma-armor.html">リストページへ</a>　<a href="armor-calc.html">自動選定ツールへ</a>
        <br>
        <a href="index.html">INDEXへ戻る</a>
    </div>

    <script>

    // サイドメニューを呼び出す関数
    function loadSideMenu() {
      fetch('sidemenu.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('sidemenu-container').innerHTML = data;

          // メニュー読み込み後に、メニュー内のトグルボタンのイベントリスナーを再設定する
          var toggleButtons = document.querySelectorAll(".toggle-button");
          toggleButtons.forEach(function(button) {
            var targetId = button.getAttribute("data-target");
            var list = document.getElementById(targetId);
            // list.style.display = "none"; // 初期状態はCSSで制御されているため不要

            button.addEventListener("click", function(){
              if (list.style.display === "block") {
                list.style.display = "none";
              } else {
                list.style.display = "block";
              }
            });
          });
        });
    }

    // ハンバーガーメニューの関数
    function toggleMenu() {
        const sideMenu = document.getElementById('sideMenu');
        if (!sideMenu) return;
        const menuOverlay = document.getElementById('menuOverlay');

        if (sideMenu.classList.contains('open')) {
            closeMenu();
        } else {
            sideMenu.classList.add('open');
            menuOverlay.classList.add('open');
        }
    }

    function closeMenu() {
        const sideMenu = document.getElementById('sideMenu');
        if (!sideMenu) return;
        const menuOverlay = document.getElementById('menuOverlay');

        sideMenu.classList.remove('open');
        menuOverlay.classList.remove('open');
    }

    // フリックでメニュー開閉（スクロール誤作動対策版）
    let startX = 0, startY = 0;
    let endX = 0, endY = 0;

    document.addEventListener('touchstart', function (e) {
      // タッチ開始時のX座標とY座標を記録
      startX = e.changedTouches[0].screenX;
      startY = e.changedTouches[0].screenY;
    }, false);

    document.addEventListener('touchend', function (e) {
      // タッチ終了時のX座標とY座標を記録
      endX = e.changedTouches[0].screenX;
      endY = e.changedTouches[0].screenY;
      handleGesture(); // ジェスチャーを判定する関数を呼び出し
    }, false);

    function handleGesture() {
      const diffX = endX - startX; // 水平方向の移動量
      const diffY = endY - startY; // 垂直方向の移動量

      // 条件1: 水平方向の移動量が、垂直方向の移動量よりも大きい場合のみ処理（スワイプかスクロールかを判定）
      if (Math.abs(diffX) > Math.abs(diffY)) {

        // 条件2-1: 右へのスワイプ（50px以上移動し、かつ画面の左端30px以内から開始）
        if (diffX > 50 && startX < 30) {
          // 右にフリックしてメニューを開く
          toggleMenu();
        } 
        // 条件2-2: 左へのスワイプ（50px以上移動）
        else if (diffX < -50) {
          // 左にフリックしてメニューを閉じる
          closeMenu();
        }
      }
      // 垂直方向の移動量が大きい場合は、何もしない（ブラウザの標準スクロールに任せる）
    }

        // --- グローバル変数 ---
        let zoomLevel = 1;
        let loadedJsonData = null;
        let uniqueAbilities = {};

        // --- ユーティリティ関数 ---
        function changeZoom(delta) {
            zoomLevel += delta;
            if (zoomLevel < 0.5) zoomLevel = 0.5;
            if (zoomLevel > 2.0) zoomLevel = 2.0;
            document.body.style.zoom = zoomLevel;
        }

        function scrollToCategory(categoryId) {
            const element = document.getElementById(categoryId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- メイン処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('json-file-input');
            const uniqueAbilityCheckbox = document.getElementById('include-unique-ability');

            fileInput.addEventListener('change', handleFileSelect);
            uniqueAbilityCheckbox.addEventListener('change', runAnalysis);

            // CSVデータを読み込む
            loadUniqueAbilities();
        });

        // CSVファイルを非同期で読み込みパースする
        async function loadUniqueAbilities() {
            const files = ['data/armor-main-ability.csv', 'data/armor-sub-ability.csv'];
            const promises = files.map(file => fetch(file).then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.text();
            }));
            
            try {
                const [mainCsv, subCsv] = await Promise.all(promises);
                uniqueAbilities = parseCsvData(mainCsv + "\n" + subCsv);
            } catch (error) {
                console.error("固有アビリティCSVの読み込みに失敗しました:", error);
                alert("固有アビリティデータ(CSV)の読み込みに失敗しました。\n'data'フォルダにファイルが存在するか確認してください。");
            }
        }

        function parseCsvData(csvText) {
            const data = {};
            const attributeMap = { "斬": "斬", "打": "打", "突": "突", "熱": "熱", "冷": "冷", "雷": "雷", "陽": "陽", "陰": "陰", "味方威力": "味方威力", "威力": "威力" };
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length < 3) return;
                const armorName = parts[0].trim();
                const target = parts[1].trim();
                const value = parseInt(parts[2].trim(), 10);

                if (attributeMap[target] && !isNaN(value)) {
                    if (!data[armorName]) {
                        data[armorName] = {};
                    }
                    data[armorName][target] = value;
                }
            });
            return data;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    loadedJsonData = JSON.parse(e.target.result);
                    runAnalysis(); // 最初の解析を実行
                } catch (error) {
                    alert('JSONの読込に失敗\n' + error);
                    loadedJsonData = null;
                }
            };
            reader.readAsText(file);
        }

        // 解析と表示のメイン関数
        function runAnalysis() {
            if (!loadedJsonData) return;
            try {
                const processed = processData(loadedJsonData);
                displayReport(processed);
            } catch (error) {
                console.error("データ処理中にエラー:", error);
                alert("データ処理中にエラーが発生しました。\n" + error);
            }
        }

        function getTargetFromAbilityName(abilityName) {
            if (abilityName.startsWith('味方威力＋')) return "味方威力";
            const match = abilityName.match(/\(([^)]+)\)/);
            if (!match) return null;
            const content = match[1];
            // 属性名に直接一致するかチェック
            const attributes = ["斬", "打", "突", "熱", "冷", "雷", "陽", "陰"];
            if (attributes.includes(content)) return content;
            return null;
        }

        function processData(armorData) {
            const selfPowerAbilities = ["威力＋(HP満タン時)", "威力＋(瀕死時)", "威力＋(カウンター)", "威力＋(斬)", "威力＋(打)", "威力＋(突)", "威力＋(熱)", "威力＋(冷)", "威力＋(雷)", "威力＋(陽)", "威力＋(陰)"];
            const partyPowerAbilities = ["味方威力＋(HP満タン時)", "味方威力＋(瀕死時)", "味方威力＋(カウンター)", "味方威力＋(斬)", "味方威力＋(打)", "味方威力＋(突)", "味方威力＋(熱)", "味方威力＋(冷)", "味方威力＋(雷)", "味方威力＋(陽)", "味方威力＋(陰)"];
            const includeUnique = document.getElementById('include-unique-ability').checked;

            const categorizedData = { mainSelf: {}, subSelf: {}, mainParty: {}, subParty: {} };
            [...selfPowerAbilities, ...partyPowerAbilities].forEach(name => {
                Object.keys(categorizedData).forEach(cat => categorizedData[cat][name] = []);
            });

            // データをディープコピーして元のデータを変更しないようにする
            const dataToProcess = JSON.parse(JSON.stringify(armorData));

            for (const item of dataToProcess) {
                if (!item.abilityName || !item.value) continue;
                let value = parseInt(item.value, 10);
                if (isNaN(value)) continue;

                item.isCombined = false;
                let totalAddedValue = 0;

                // 固有アビリティを加味する場合の処理
                if (includeUnique && uniqueAbilities[item.armorName]) {
                    const armorBonuses = uniqueAbilities[item.armorName];

                    // 1. 対応する属性のボーナスを加算
                    const specificTarget = getTargetFromAbilityName(item.abilityName);
                    if (specificTarget && armorBonuses[specificTarget]) {
                        totalAddedValue += armorBonuses[specificTarget];
                    }

                    // 2. 「威力＋」系の場合、さらに「味方威力」ボーナスも加算 (重複はしない)
                    const isSelfPower = selfPowerAbilities.includes(item.abilityName);
                    if (isSelfPower && armorBonuses['味方威力']) {
                        totalAddedValue += armorBonuses['味方威力'];
                    }

                    // 3. 「威力＋」系の場合、「威力」ボーナスも加算する
                    if (isSelfPower && armorBonuses['威力']) {
                        totalAddedValue += armorBonuses['威力'];
                    }
                }
                
                if (totalAddedValue > 0) {
                    value += totalAddedValue;
                    item.isCombined = true;
                    item.addedValue = totalAddedValue;
                }

                const newItem = { ...item, value };

                if (selfPowerAbilities.includes(item.abilityName)) {
                    if (item.armorType === 'main') categorizedData.mainSelf[item.abilityName].push(newItem);
                    else if (item.armorType === 'sub') categorizedData.subSelf[item.abilityName].push(newItem);
                } else if (partyPowerAbilities.includes(item.abilityName)) {
                    if (item.armorType === 'main') categorizedData.mainParty[item.abilityName].push(newItem);
                    else if (item.armorType === 'sub') categorizedData.subParty[item.abilityName].push(newItem);
                }
            }
            
            for (const category in categorizedData) {
                for (const abilityName in categorizedData[category]) {
                    categorizedData[category][abilityName].sort((a, b) => b.value - a.value);
                }
            }
            return categorizedData;
        }
            
        function displayReport(data) {
            const selfPowerAbilities = ["威力＋(HP満タン時)", "威力＋(瀕死時)", "威力＋(カウンター)", "威力＋(斬)", "威力＋(打)", "威力＋(突)", "威力＋(熱)", "威力＋(冷)", "威力＋(雷)", "威力＋(陽)", "威力＋(陰)"];
            const partyPowerAbilities = ["味方威力＋(HP満タン時)", "味方威力＋(瀕死時)", "味方威力＋(カウンター)", "味方威力＋(斬)", "味方威力＋(打)", "味方威力＋(突)", "味方威力＋(熱)", "味方威力＋(冷)", "味方威力＋(雷)", "味方威力＋(陽)", "味方威力＋(陰)"];

            const categories = [
                { id: 'main-self', abilities: selfPowerAbilities, data: data.mainSelf },
                { id: 'sub-self', abilities: selfPowerAbilities, data: data.subSelf },
                { id: 'main-party', abilities: partyPowerAbilities, data: data.mainParty },
                { id: 'sub-party', abilities: partyPowerAbilities, data: data.subParty }
            ];
            
            categories.forEach(cat => {
                const container = document.querySelector(`#${cat.id} .table-wrapper`);
                container.innerHTML = '';
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="col-ability">アビリティ</th>
                            <th class="col-armor">装備</th>
                            <th class="col-value value-col">効果値</th>
                        </tr>
                    </thead>`;
                const tbody = table.createTBody();

                cat.abilities.forEach(abilityName => {
                    const items = cat.data[abilityName] || [];
                    
                    for (let i = 0; i < 5; i++) {
                        const item = items[i];
                        const row = tbody.insertRow();
                        
                        let armorCellHTML = '&nbsp;';
                        let valueCellHTML = '&nbsp;';
                        let valueCellClass = 'value-col';

                        if (item) {
                            // 装備名セルのHTMLを生成
                            if (item.isCombined) {
                                // 加算あり(オレンジ色)
                                armorCellHTML = `<span class="combined-armor-name">${item.armorName} (+${item.addedValue})</span>`;
                                valueCellClass += ' combined-value'; // 効果値を赤色に
                            } else if (item.armorName.includes("名将の鎧") || item.armorName.includes("ﾊﾞﾄﾙｳﾞｧﾝﾌﾞﾚｲｽ")) {
                                // 特定装備(紫色)
                                armorCellHTML = `<span class="special-armor-name">${item.armorName}</span>`;
                            } else {
                                // 通常
                                armorCellHTML = item.armorName;
                            }
                            
                            // 効果値セルのHTMLを生成
                            valueCellHTML = item.value + '%';
                        }

                        if (i === 0) {
                            row.innerHTML = `
                                <td class="merged-ability-cell" rowspan="5">${abilityName}</td>
                                <td>${armorCellHTML}</td>
                                <td class="${valueCellClass}">${valueCellHTML}</td>
                            `;
                        } else {
                            row.innerHTML = `
                                <td>${armorCellHTML}</td>
                                <td class="${valueCellClass}">${valueCellHTML}</td>
                            `;
                        }
                    }
                });
                container.appendChild(table);
            });
        }

    // ページをリロードしたらサイドメニューを呼び出す
    window.onload = function () {
        loadSideMenu();
    }

  </script>

</body>
</html>