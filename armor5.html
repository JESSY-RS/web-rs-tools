<!DOCTYPE html>
<html lang="ja">
<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico">
    <title>★装備候補検索ツール</title> <!-- Created by じぇ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>

        /* 全体のスタイル */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* フッターのスタイル */
        footer {
          border-top: 1px solid #eee;
          color: #888;
          font-size: 12pt;
          margin: -20px 30px 30px 30px;
        }

        /* ５人１組の結果リストの行の背景色 */
        .striped-table-row-light {
            background-color: #e0f2fe; /* Soft light blue, distinct from header blue */
        }
        .striped-table-row-dark {
            background-color: #ffffff; /* White */
        }

        /* ヘッダーのカスタム色 */
        .header-gray { background-color: #f9fafb; } /* Tailwind gray-50 */
        .header-blue { background-color: #eff6ff; } /* Tailwind blue-50 */
        .header-red { background-color: #fef2f2; } /* Tailwind red-50 */
        .header-green { background-color: #f0fdf4; } /* Tailwind green-50 */

        /* キャラクターの文字色 */
        .char1-text { color: #dc2626; /* Tailwind red-600 */ }
        .char2-text { color: #ea580c; /* Tailwind orange-600 */ }
        .char3-text { color: #16a34a; /* Tailwind green-600 */ }
        .char4-text { color: #2563eb; /* Tailwind blue-600 */ }
        .char5-text { color: #9333ea; /* Tailwind purple-600 */ }

    /* リンクのスタイル */
    a:link {
      color: dodgerblue;
    }

    a:visited {
      color: blueviolet;
    }

    a:hover {
      color: lime;
    }

    a:active {
      color: orangered;
    }

    </style>

</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // ここにattributesとadditionalAttributesの定義を追加
        const attributes = ['斬', '打', '突', '熱', '冷', '雷', '陽', '陰'];
        const additionalAttributes = ['毒', '暗闇', 'スタン', 'マヒ', '眠り', '石化', '混乱', '魅了', '狂戦士', '気絶', '腕力', '体力', '器用さ', '素早さ', '知力', '精神', '愛', '魅力'];
        const totalAttributes = ['斬', '打', '突', '熱', '冷', '雷', '陽', '陰', '毒', '暗闇', 'スタン', 'マヒ', '眠り', '石化', '混乱', '魅了', '狂戦士', '気絶', '腕力', '体力', '器用さ', '素早さ', '知力', '精神', '愛', '魅力'];

        const { useState, useEffect, useRef, useCallback } = React;

        const ArmorCombinationAnalyzer = () => {
          const [mainArmor, setMainArmor] = useState([]);
          const [subArmor, setSubArmor] = useState([]);
          const [decorations, setDecorations] = useState([]);
          const [characterResistances, setCharacterResistances] = useState([]);
          const [combinations, setCombinations] = useState({});
          const [loading, setLoading] = useState(true);
          const [mainThreadDataLoaded, setMainThreadDataLoaded] = useState(false);
          const [workerDataLoaded, setWorkerDataLoaded] = useState(false);
          const [error, setError] = useState('');
          const [searchResultMessage, setSearchResultMessage] = useState('');
          const [fivePersonSearchResultMessage, setFivePersonSearchResultMessage] = useState(''); // New state for 5-person search
          const [searching, setSearching] = useState({});
          const [activeTab, setActiveTab] = useState('キャラ１');
          const dropdownRefs = useRef({});

          const [countdown, setCountdown] = useState(0);
          const countdownIntervalRef = useRef(null);
          const workerRef = useRef(null);

          const dataFiles = {
            mainArmor: './data/armor-main.csv',
            subArmor: '././data/armor-sub.csv',
            decorations: './data/decoration.csv',
            characterResistances: './data/favorite.csv'
          };

          const characterNames = ['キャラ１', 'キャラ２', 'キャラ３', 'キャラ４', 'キャラ５', '５人１組'];

          const characterColors = {
            'キャラ１': {
              tab: 'text-red-600 border-red-500',
              bg: 'bg-red-50',
              border: 'border-red-300',
              button: 'bg-red-200 hover:bg-red-300',
              search: 'bg-red-500 hover:bg-red-600',
              text: 'text-red-700',
              label: 'text-red-700'
            },
            'キャラ２': {
              tab: 'text-orange-600 border-orange-500',
              bg: 'bg-orange-50',
              border: 'border-orange-300',
              button: 'bg-orange-200 hover:bg-orange-300',
              search: 'bg-orange-500 hover:bg-orange-600',
              text: 'text-orange-700',
              label: 'text-orange-700'
            },
            'キャラ３': {
              tab: 'text-green-600 border-green-500',
              bg: 'bg-green-50',
              border: 'border-green-300',
              button: 'bg-green-200 hover:bg-green-300',
              search: 'bg-green-500 hover:bg-green-600',
              text: 'text-green-700',
              label: 'text-green-700'
            },
            'キャラ４': {
              tab: 'text-blue-600 border-blue-500',
              bg: 'bg-blue-50',
              border: 'border-blue-300',
              button: 'bg-blue-200 hover:bg-blue-300',
              search: 'bg-blue-500 hover:bg-blue-600',
              text: 'text-blue-700',
              label: 'text-blue-700'
            },

            'キャラ５': {
              tab: 'text-purple-600 border-purple-500',
              bg: 'bg-purple-50',
              border: 'border-purple-300',
              button: 'bg-purple-200 hover:bg-purple-300',
              search: 'bg-purple-500 hover:bg-purple-600',
              text: 'text-purple-700',
              label: 'text-purple-700'
            }
            ,
            '５人１組': {
              tab: 'text-gray-700 border-gray-600',
              bg: 'bg-gray-100',
              border: 'border-gray-400',
              button: 'bg-gray-300 hover:bg-gray-400',
              search: 'bg-gray-600 hover:bg-gray-700',
              text: 'text-gray-800',
              label: 'text-gray-800'
            }
          };

          const [targetValues, setTargetValues] = useState({
            斬: 0, 打: 0, 突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0
          });

          const [excludeSettings, setExcludeSettings] = useState({
            main: [], sub: [], deco: [], showMain: false, showSub: false, showDeco: false
          });

          const excludeDropdownRefs = useRef({ main: null, sub: null, deco: null });

          const [excludeSaving, setExcludeSaving] = useState({ main: false, sub: false, deco: false });
          const [excludeDeleting, setExcludeDeleting] = useState({ main: false, sub: false, deco: false });

          const saveExcludeProfile = (type) => {
            let key = '';
            let data = [];
            let category = '';
            if (type === '主防具') { key = 'exclude_main'; data = [...excludeSettings.main]; category = 'main'; }
            else if (type === '副防具') { key = 'exclude_sub'; data = [...excludeSettings.sub]; category = 'sub'; }
            else if (type === '装飾品') { key = 'exclude_deco'; data = [...excludeSettings.deco]; category = 'deco'; }

            setExcludeSaving(prev => ({ ...prev, [category]: true }));
            try { localStorage.setItem(key, JSON.stringify(data)); }
            catch (e) { console.error(`${type}除外設定の保存に失敗しました`, e); }
            finally { setTimeout(() => { setExcludeSaving(prev => ({ ...prev, [category]: false })); }, 800); }
          };

          const deleteExcludeProfile = (type) => {
            let key = '';
            let category = '';
            if (type === '主防具') { key = 'exclude_main'; category = 'main'; }
            else if (type === '副防具') { key = 'exclude_sub'; category = 'sub'; }
            else if (type === '装飾品') { key = 'exclude_deco'; category = 'deco'; }

            setExcludeDeleting(prev => ({ ...prev, [category]: true }));
            setExcludeSettings(prev => ({ ...prev, [category]: [] }));
            try { localStorage.removeItem(key); }
            catch (e) { console.error(`${type}除外設定の削除に失敗`, e); }
            finally { setTimeout(() => { setExcludeDeleting(prev => ({ ...prev, [category]: false })); }, 800); }
          };

          const [profileName, setProfileName] = useState('');
          const [savedProfiles, setSavedProfiles] = useState({});

          const handleSaveProfile = () => {
            if (!profileName.trim()) return;
            const newProfile = { ...targetValues };
            const updatedProfiles = { ...savedProfiles, [profileName.trim()]: newProfile };
            setSavedProfiles(updatedProfiles);
            setProfileName('');
            localStorage.setItem('profiles', JSON.stringify(updatedProfiles));
          };

          const handleDeleteProfile = () => {
            const trimmedName = profileName.trim();
            if (!trimmedName || !savedProfiles[trimmedName]) return;
            const updatedProfiles = { ...savedProfiles };
            delete updatedProfiles[trimmedName];
            if (updatedProfiles[""]) delete updatedProfiles[""];
            if (Object.keys(updatedProfiles).length > 0) { localStorage.setItem('profiles', JSON.stringify(updatedProfiles)); }
            else { localStorage.removeItem('profiles'); }
            setSavedProfiles(updatedProfiles);
            setProfileName('');
            if (selectedPreset === trimmedName) setSelectedPreset('');
          };

          const handlePresetSelect = (presetName) => {
            if (presetName === "All Resist") {
              setTargetValues({ 斬: 35, 打: 35, 突: 35, 熱: 35, 冷: 35, 雷: 35, 陽: 35,陰: 35 });
            } else if (savedProfiles[presetName]) {
              setTargetValues(savedProfiles[presetName]);
            }
          };

          const [selectedPreset, setSelectedPreset] = useState("");

          const [characterValues, setCharacterValues] = useState({
            'キャラ１': { 斬: 0, 打: 0, 突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
            'キャラ２': { 斬: 0, 打: 0, 突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
            'キャラ３': { 斬: 0, 打: 0, 突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
            'キャラ４': { 斬: 0, 打: 0, 突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
            'キャラ５': { 斬: 0, 打: 0, 突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 }
          });

          const [characterAdjustmentValues, setCharacterAdjustmentValues] = useState({
            'キャラ１': { 斬: 0, 打: 0,突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
            'キャラ２': { 斬: 0, 打: 0,突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
            'キャラ３': { 斬: 0, 打: 0,突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
            'キャラ４': { 斬: 0, 打: 0,突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
            'キャラ５': { 斬: 0, 打: 0,突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 },
          });

          const [sortSettings, setSortSettings] = useState({
            'キャラ１': { priority1: '', order1: 'desc', priority2: '', order2: 'desc', priority3: '', order3: 'desc' },
            'キャラ２': { priority1: '', order1: 'desc', priority2: '', order2: 'desc', priority3: '', order3: 'desc' },
            'キャラ３': { priority1: '', order1: 'desc', priority2: '', order2: 'desc', priority3: '', order3: 'desc' },
            'キャラ４': { priority1: '', order1: 'desc', priority2: '', order2: 'desc', priority3: '', order3: 'desc' },
            'キャラ５': { priority1: '', order1: 'desc', priority2: '', order2: 'desc', priority3: '', order3: 'desc' },
            '５人１組': { priority1: '', order1: 'desc', priority2: '', order2: 'desc', priority3: '', order3: 'desc' }
          });

          const sortableAttributes = ['斬', '打', '突', '熱', '冷', '雷', '陽', '陰', '毒', '暗闇', 'スタン', 'マヒ', '眠り', '石化', '混乱', '魅了', '狂戦士', '気絶', '腕力', '体力', '器用さ', '素早さ', '知力', '精神', '愛', '魅力'];

          const [selectedCharacters, setSelectedCharacters] = useState({
            'キャラ１': '', 'キャラ２': '', 'キャラ３': '', 'キャラ４': '', 'キャラ５': ''
          });

          const [fixedEquipments, setFixedEquipments] = useState({
            'キャラ１': { main: '', sub: '', deco: '' },
            'キャラ２': { main: '', sub: '', deco: '' },
            'キャラ３': { main: '', sub: '', deco: '' },
            'キャラ４': { main: '', sub: '', deco: '' },
            'キャラ５': { main: '', sub: '', deco: '' }
          });

          const [statusAilmentSettings, setStatusAilmentSettings] = useState({
            'キャラ１': { selectedTypes: [], value: 20, showDropdown: false },
            'キャラ２': { selectedTypes: [], value: 20, showDropdown: false },
            'キャラ３': { selectedTypes: [], value: 20, showDropdown: false },
            'キャラ４': { selectedTypes: [], value: 20, showDropdown: false },
            'キャラ５': { selectedTypes: [], value: 20, showDropdown: false }
          });

          const statusAilmentTypes = ['毒', '暗闇', 'スタン', 'マヒ', '眠り', '石化', '混乱', '魅了', '狂戦士', '気絶'];

          const [itemQuantities, setItemQuantities] = useState({});

          // Web Workerの初期化とメッセージハンドリング
          useEffect(() => {
            // 初期ロード時のみWorkerを生成し、イベントハンドラを設定
            if (window.Worker && !workerRef.current) {
              workerRef.current = new Worker('./worker.js');

              workerRef.current.onmessage = (event) => {
                const { type, payload, message } = event.data;

                if (type === 'dataLoaded') {
                    console.log("Worker: Data pre-loaded.");
                    setWorkerDataLoaded(true);
                    if (mainThreadDataLoaded) {
                        setLoading(false);
                    }
                    setError(''); // ファイルロードエラーをクリア
                } else if (type === 'results') {
                  setCombinations(prev => ({ ...prev, ['５人１組']: payload }));
                  setSearching(prev => ({ ...prev, ['５人１組']: false }));
                  clearInterval(countdownIntervalRef.current);
                  countdownIntervalRef.current = null;
                  setCountdown(0);
                  if (payload.length === 0) {
                      setFivePersonSearchResultMessage('条件を満たす組み合わせは見つかりませんでした。条件を緩和するか、除外設定を調整してください。');
                  } else {
                      setFivePersonSearchResultMessage(''); // 候補が見つかったらメッセージをクリア
                  }
                  setError(''); // 検索関連のエラーをクリア
                  console.log("Worker: Search completed and results received.");
                } else if (type === 'error') {
                  // 検索エラーはsearchResultMessageで表示
                  setFivePersonSearchResultMessage(`検索エラー: ${payload || '不明なエラーが発生しました。'}`);
                  setSearching(prev => ({ ...prev, ['５人１組']: false }));
                  clearInterval(countdownIntervalRef.current);
                  countdownIntervalRef.current = null;
                  setCountdown(0);
                  console.error("Worker Error: ", payload);
                } else if (type === 'progress') {
                  console.log(`Worker Progress: ${message}`);
                } else if (type === 'dataLoadError') {
                    setError(`Workerでのデータ読み込みエラー: ${payload || '不明なエラー'}`);
                    setWorkerDataLoaded(false);
                    setLoading(false);
                    console.error("Worker Data Load Error: ", payload);
                }
              };

              workerRef.current.onerror = (error) => {
                setError(`Workerからの予期せぬエラー: ${error.message || '不明なWorkerエラー'}`);
                setSearching(prev => ({ ...prev, ['５人１組']: false }));
                clearInterval(countdownIntervalRef.current);
                countdownIntervalRef.current = null;
                setCountdown(0);
                console.error("Worker Error Event:", error);
              };

              workerRef.current.postMessage({
                  type: 'init',
                  payload: { dataFiles: dataFiles }
              });

            } else if (!window.Worker) {
              setError("Web Workersは現在のブラウザではサポートされていません。5人1組の検索は遅くなるか、応答しなくなる可能性があります。");
              setWorkerDataLoaded(false);
              setLoading(false);
            }

            // コンポーネトアンマウント時のクリーンアップ
            return () => {
              if (workerRef.current) {
                workerRef.current.terminate();
                workerRef.current = null;
              }
              if (countdownIntervalRef.current) {
                  clearInterval(countdownIntervalRef.current);
                  countdownIntervalRef.current = null;
              }
            };
          }, []); // 依存配列を空にして、コンポーネントマウント時に一度だけ実行するように戻す

          // メインスレッドでのCSVデータロード（個別のキャラ検索用）
          useEffect(() => {
            const loadDataForMainThread = async () => {
                setError('');
                try {
                    const [mainArmorData, subArmorData, decorationData, characterData] = await Promise.all([
                        loadCSVFile(dataFiles.mainArmor),
                        loadCSVFile(dataFiles.subArmor),
                        loadCSVFile(dataFiles.decorations),
                        loadCharacterResistances()
                    ]);

                    setMainArmor(mainArmorData);
                    setSubArmor(subArmorData);
                    setDecorations(decorationData);
                    setCharacterResistances(characterData);

                    const initialQuantities = {};
                    mainArmorData.forEach(item => initialQuantities[`main_${item['名称']}`] = item['所持数'] || Infinity);
                    subArmorData.forEach(item => initialQuantities[`sub_${item['名称']}`] = item['所持数'] || Infinity);
                    decorationData.forEach(item => initialQuantities[`deco_${item['名称']}`] = item['所持数'] || Infinity);
                    setItemQuantities(initialQuantities);

                    setMainThreadDataLoaded(true);
                    // Workerのデータロード状態も確認して、両方完了したらローディングを解除
                    if (workerDataLoaded) { // ここを調整
                        setLoading(false);
                    }
                    console.log('メインスレッド: データ読み込み完了');
                } catch (error) {
                    setError(`メインスレッドでのデータ読み込みエラー: ${error.message}`);
                    console.error('Main thread Load error:', error);
                    setMainThreadDataLoaded(false);
                    setLoading(false);
                }
            };
            loadDataForMainThread();
          }, [workerDataLoaded]); // workerDataLoaded が変更されたら再実行（Workerのinit完了を待つ）

          useEffect(() => {
            const storedProfiles = localStorage.getItem('profiles');
            if (storedProfiles) {
              setSavedProfiles(JSON.parse(storedProfiles));
            }
          }, []);

          useEffect(() => {
            const main = JSON.parse(localStorage.getItem('exclude_main') || '[]');
            const sub = JSON.parse(localStorage.getItem('exclude_sub') || '[]');
            const deco = JSON.parse(localStorage.getItem('exclude_deco') || '[]');
            setExcludeSettings(prev => ({ ...prev, main, sub, deco }));
          }, []);

          useEffect(() => {
            const handleClickOutside = (event) => {
              characterNames.filter(name => name !== '５人１組').forEach(charNameInLoop => {
                if (statusAilmentSettings[charNameInLoop]?.showDropdown &&
                    dropdownRefs.current[charNameInLoop] &&
                    !dropdownRefs.current[charNameInLoop].contains(event.target)) {
                  setStatusAilmentSettings(prev => ({
                    ...prev,
                    [charNameInLoop]: { ...prev[charNameInLoop], showDropdown: false }
                  }));
                }
              });
              if (excludeSettings.showMain && excludeDropdownRefs.current.main && !excludeDropdownRefs.current.main.contains(event.target)) {
                setExcludeSettings(prev => ({ ...prev, showMain: false }));
              }
              if (excludeSettings.showSub && excludeDropdownRefs.current.sub && !excludeDropdownRefs.current.sub.contains(event.target)) {
                setExcludeSettings(prev => ({ ...prev, showSub: false }));
              }
              if (excludeSettings.showDeco && excludeDropdownRefs.current.deco && !excludeDropdownRefs.current.deco.contains(event.target)) {
                setExcludeSettings(prev => ({ ...prev, showDeco: false }));
              }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => { document.removeEventListener("mousedown", handleClickOutside); };
          }, [statusAilmentSettings, excludeSettings, characterNames]);

          const loadCSVFile = async (url) => {
            try {
              const response = await fetch(url);
              if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
              const text = await response.text();
              const parsed = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: true, transformHeader: (header) => header.trim() });
              if (parsed.errors.length > 0) { console.warn(`CSV parsing warnings for ${url}:`, parsed.errors); }
              return parsed.data;
            } catch (error) {
              throw new Error(`Failed to load ${url}: ${error.message}`);
            }
          };

          const loadCharacterResistances = async () => {
            try {
              const response = await fetch(dataFiles.characterResistances);
              if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
              const text = await response.text();
              const parsed = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: true, transformHeader: (header) => header.trim() });
              if (parsed.errors.length > 0) { console.warn(`CSV parsing warnings for character resistances:`, parsed.errors); }
              return parsed.data;
            } catch (error) {
              throw new Error(`Failed to load character resistances: ${error.message}`);
            }
          };

          const stopFivePersonSearch = useCallback(() => {
            if (workerRef.current) {
                workerRef.current.postMessage({ type: 'terminate' });
            }
            if (countdownIntervalRef.current) {
                clearInterval(countdownIntervalRef.current);
                countdownIntervalRef.current = null;
            }
            setSearching(prev => ({ ...prev, ['５人１組']: false }));
            setFivePersonSearchResultMessage('検索がユーザーによって停止されました。');
            console.log('User stopped 5-person search.');
          }, []);


          const calculateCombinations = (charName) => {
            setError('');
            // Clear only searchResultMessage for individual tabs, not 5-person
            if (charName !== '５人１組') {
                setSearchResultMessage('');
            } else {
                setFivePersonSearchResultMessage(''); // Clear 5-person specific message
                if (searching[charName]) { // If already searching, this click is a stop request
                    stopFivePersonSearch();
                    return;
                }
            }

            if (loading) {
              setError("データ読み込み中です。しばらくお待ちください。");
              return;
            }

            if (charName !== '５人１組' && !mainThreadDataLoaded) {
                setError("個別検索に必要なデータがまだ読み込まれていません。");
                return;
            }
            // Workerが利用可能でない場合、ここでエラーを出す
            if (charName === '５人１組' && !window.Worker) {
                 setError("Web Workersが利用できません。ブラウザをご確認ください。");
                 return;
            }


            setSearching(prev => ({ ...prev, [charName]: true }));
            setCombinations(prev => ({ ...prev, [charName]: [] }));
            setCountdown(0);

            if (charName !== '５人１組') {
              const fixed = fixedEquipments[charName];
              const mainList = fixed.main
                ? mainArmor.filter(a => a['名称'] === fixed.main)
                : mainArmor.filter(a => !excludeSettings.main.includes(a['名称']));

              const subList = fixed.sub
                ? subArmor.filter(a => a['名称'] === fixed.sub)
                : subArmor.filter(a => !excludeSettings.sub.includes(a['名称']));

              const decoList = fixed.deco
                ? decorations.filter(a => a['名称'] === fixed.deco)
                : decorations.filter(a => !excludeSettings.deco.includes(a['名称']));

              setTimeout(() => {
                const results = [];
                const currentCharValues = characterValues[charName];
                const statusAilmentSetting = statusAilmentSettings[charName];

                mainList.forEach(main => {
                  subList.forEach(sub => {
                    decoList.forEach(decoration => {
                      const totals = {};
                      let meetsConditions = true;

                      attributes.forEach(attr => {
                        const mainValue = parseInt(main[attr] || 0);
                        const subValue = parseInt(sub[attr] || 0);
                        const decorationValue = parseInt(decoration[attr] || 0);
                        totals[attr] = mainValue + subValue + decorationValue + currentCharValues[attr] - characterAdjustmentValues[charName][attr];
                        if (totals[attr] < targetValues[attr]) { meetsConditions = false; }
                        totals[attr] = mainValue + subValue + decorationValue;
                      });

                      additionalAttributes.forEach(attr => {
                        const mainValue = parseInt(main[attr] || 0);
                        const subValue = parseInt(sub[attr] || 0);
                        const decorationValue = parseInt(decoration[attr] || 0);
                        totals[attr] = mainValue + subValue + decorationValue;
                      });

                      if (statusAilmentSetting.selectedTypes.length > 0 && statusAilmentSetting.value > 0) {
                        statusAilmentSetting.selectedTypes.forEach(ailmentType => {
                          const statusAilmentTotal = (parseInt(main[ailmentType] || 0)) + (parseInt(sub[ailmentType] || 0)) + (parseInt(decoration[ailmentType] || 0));
                          if (statusAilmentTotal < statusAilmentSetting.value) { meetsConditions = false; }
                          totals[ailmentType] = statusAilmentTotal;
                        });
                      }

                      if (meetsConditions) {
                        results.push({
                          mainArmor: main['名称'] || main[Object.keys(main)[0]],
                          subArmor: sub['名称'] || sub[Object.keys(sub)[0]],
                          decoration: decoration['名称'] || decoration[Object.keys(decoration)[0]],
                          totals
                        });
                      }
                    });
                  });
                });

                const sortConfig = sortSettings[charName];
                if (sortConfig.priority1) {
                  results.sort((a, b) => {
                    let compareValue = 0;
                    const aVal = a.totals[sortConfig.priority1] || 0;
                    const bVal = b.totals[sortConfig.priority1] || 0;
                    compareValue = sortConfig.order1 === 'asc' ? aVal - bVal : bVal - aVal;
                    if (compareValue !== 0) return compareValue;

                    if (sortConfig.priority2) {
                      const aVal2 = a.totals[sortConfig.priority2] || 0;
                      const bVal2 = b.totals[sortConfig.priority2] || 0;
                      compareValue = sortConfig.order2 === 'asc' ? aVal2 - bVal2 : bVal2 - aVal2;
                      if (compareValue !== 0) return compareValue;

                      if (sortConfig.priority3) {
                        const aVal3 = a.totals[sortConfig.priority3] || 0;
                        const bVal3 = b.totals[sortConfig.priority3] || 0;
                        compareValue = sortConfig.order3 === 'asc' ? aVal3 - bVal3 : bVal3 - aVal3;
                      }
                    }
                    return compareValue;
                  });
                }
                setCombinations(prev => ({ ...prev, [charName]: results }));
                setSearching(prev => ({ ...prev, [charName]: false }));
                if (results.length === 0) {
                  setSearchResultMessage('条件を満たす組み合わせは見つかりませんでした。');
                } else {
                  setSearchResultMessage(''); // Clear for individual search if results found
                }
              }, 10);
            } else {
              // [修正点] 5人1組検索の場合、常に新しいWorkerインスタンスを生成する
              if (workerRef.current) {
                  workerRef.current.terminate(); // 既存のWorkerがあれば終了
                  workerRef.current = null;
                  console.log("既存のWorkerを終了しました。新しいWorkerを作成します。"); // デバッグ用ログ
              }
              workerRef.current = new Worker('./worker.js'); // 新しいWorkerを生成

              // [修正点] 新しいWorkerにメッセージハンドラとエラーハンドラを再設定する
              // これをPromisifyしてデータロード完了を待つように変更
              const newWorker = workerRef.current; // 新しいWorkerへの参照を保持

              newWorker.onmessage = (event) => {
                const { type, payload, message } = event.data;

                if (type === 'dataLoaded') {
                    console.log("Worker: Data pre-loaded in new worker instance."); // ログを区別
                    setWorkerDataLoaded(true); // Workerデータロード状態を更新

                    // [修正点] データロード完了後にのみ検索を開始する
                    newWorker.postMessage({
                        type: 'startSearch',
                        payload: {
                            excludeSettings: excludeSettings,
                            characterValues: characterValues,
                            characterAdjustmentValues: characterAdjustmentValues,
                            targetValues: targetValues,
                            statusAilmentSettings: statusAilmentSettings,
                            fixedEquipments: fixedEquipments,
                            itemQuantities: itemQuantities,
                            sortSettings: sortSettings['５人１組']
                        }
                    });
                } else if (type === 'results') {
                  setCombinations(prev => ({ ...prev, ['５人１組']: payload }));
                  setSearching(prev => ({ ...prev, ['５人１組']: false }));
                  clearInterval(countdownIntervalRef.current);
                  countdownIntervalRef.current = null;
                  setCountdown(0);
                  if (payload.length === 0) {
                      setFivePersonSearchResultMessage('条件を満たす組み合わせは見つかりませんでした。条件を緩和するか、除外設定を調整してください。');
                  } else {
                      setFivePersonSearchResultMessage('');
                  }
                  setError('');
                  console.log("Worker: Search completed and results received.");
                } else if (type === 'error') {
                  setFivePersonSearchResultMessage(`検索エラー: ${payload || '不明なエラーが発生しました。'}`);
                  setSearching(prev => ({ ...prev, ['５人１組']: false }));
                  clearInterval(countdownIntervalRef.current);
                  countdownIntervalRef.current = null;
                  setCountdown(0);
                  console.error("Worker Error: ", payload);
                } else if (type === 'progress') {
                  console.log(`Worker Progress: ${message}`);
                } else if (type === 'dataLoadError') {
                    setError(`Workerでのデータ読み込みエラー: ${payload || '不明なエラー'}`);
                    setWorkerDataLoaded(false);
                    setLoading(false);
                    console.error("Worker Data Load Error: ", payload);
                    setFivePersonSearchResultMessage(`Workerでのデータ読み込みエラー: ${payload || '不明なエラー'}`); // エラーメッセージを表示
                    setSearching(prev => ({ ...prev, ['５人１組']: false })); // 検索中状態を解除
                }
              };

              newWorker.onerror = (error) => {
                setError(`Workerからの予期せぬエラー: ${error.message || '不明なWorkerエラー'}`);
                setSearching(prev => ({ ...prev, ['５人１組']: false }));
                clearInterval(countdownIntervalRef.current);
                countdownIntervalRef.current = null;
                setCountdown(0);
                console.error("Worker Error Event:", error);
                setFivePersonSearchResultMessage(`Workerからの予期せぬエラー: ${error.message || '不明なWorkerエラー'}`); // エラーメッセージを表示
              };

              // 新しいWorkerに対してデータを初期化するメッセージを送る
              newWorker.postMessage({
                  type: 'init',
                  payload: { dataFiles: dataFiles }
              });

              if (countdownIntervalRef.current) {
                clearInterval(countdownIntervalRef.current);
                countdownIntervalRef.current = null;
              }

              setCountdown(60);
              countdownIntervalRef.current = setInterval(() => {
                setCountdown(prev => {
                  if (prev <= 1) {
                    clearInterval(countdownIntervalRef.current);
                    countdownIntervalRef.current = null;
                    if (newWorker) { // newWorker を使う
                        newWorker.postMessage({ type: 'terminate' }); // タイムアウト時にWorkerに終了シグナルを送る
                    }
                    setSearching(prevSearch => ({ ...prevSearch, [charName]: false }));
                    setFivePersonSearchResultMessage('検索がタイムアウトしました。条件を緩和するか、除外設定を調整してください。');
                    console.log('Countdown ended: Worker terminated.');
                    return 0;
                  }
                  return prev - 1;
                });
              }, 1000);

              // ここでは startSearch を直接呼ばない。dataLoaded コールバックで呼ぶ
            }
          };

          const handleTargetValueChange = useCallback((attr, value) => {
            setTargetValues(prev => ({ ...prev, [attr]: parseInt(value) || 0 }));
          }, []);

          const handleCharacterValueChange = useCallback((characterName, attr, value) => {
            setCharacterValues(prev => ({ ...prev, [characterName]: { ...prev[characterName], [attr]: parseInt(value) || 0 } }));
          }, []);

          const handleAdjustmentValueChange = useCallback((characterName, attr, value) => {
            setCharacterAdjustmentValues(prev => ({ ...prev, [characterName]: { ...prev[characterName], [attr]: parseInt(value) || 0 } }));
          }, []);

          const handleCharacterSelect = useCallback((characterName, selectedName) => {
            setSelectedCharacters(prev => ({ ...prev, [characterName]: selectedName }));
            if (selectedName === '') {
              setCharacterValues(prev => ({ ...prev, [characterName]: { 斬: 0, 打: 0, 突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0 } }));
              return;
            }
            const character = characterResistances.find(char => char['登録名'] === selectedName);
            if (character) {
              const newValues = {};
              attributes.forEach(attr => { newValues[attr] = parseInt(character[attr] || 0); });
              setCharacterValues(prev => ({ ...prev, [characterName]: newValues }));
            }
          }, [characterResistances, attributes]);

          const handleStatusAilmentValueChange = useCallback((characterName, value) => {
            setStatusAilmentSettings(prev => ({ ...prev, [characterName]: { ...prev[characterName], value: parseInt(value) || 0 } }));
          }, []);

          const toggleStatusAilmentDropdown = useCallback((charNameFromParam) => { // パラメータ名を変更
            setStatusAilmentSettings(prev => {
                const newState = {};
                for (const char of characterNames) { // characterNames をループ
                    if (char === charNameFromParam) { // パラメータ名を使用
                        newState[char] = { ...prev[char], showDropdown: !prev[char].showDropdown };
                    } else if (prev[char]) {
                        newState[char] = { ...prev[char], showDropdown: false };
                    }
                }
                return newState;
            });
          }, [characterNames]); // characterNamesを依存配列に追加

          const handleStatusAilmentTypeChange = useCallback((characterName, type, checked) => {
            setStatusAilmentSettings(prev => {
              const currentSelected = prev[characterName].selectedTypes;
              let newSelected;
              if (checked) {
                newSelected = [...currentSelected, type];
              } else {
                newSelected = currentSelected.filter(t => t !== type);
              }
              return {
                ...prev,
                [characterName]: {
                  ...prev[characterName],
                  selectedTypes: newSelected
                }
              };
            });
          }, []);

          const handleSelectAllStatusAilments = useCallback((characterName, checked) => {
            setStatusAilmentSettings(prev => ({
              ...prev,
              [characterName]: {
                ...prev[characterName],
                selectedTypes: checked ? [...statusAilmentTypes] : []
              }
            }));
          }, [statusAilmentTypes]);

          const isAllStatusAilmentsSelected = useCallback((characterName) => {
            const selected = statusAilmentSettings[characterName].selectedTypes;
            return selected.length === statusAilmentTypes.length;
          }, [statusAilmentTypes, statusAilmentSettings]);

          const getStatusAilmentDisplayText = useCallback((characterName) => {
            const selected = statusAilmentSettings[characterName].selectedTypes;
            if (selected.length === 0) return "(未指定)";
            if (selected.length === statusAilmentTypes.length) return "すべて選択";
            if (selected.length === 1) return selected[0];
            return `${selected.length}個選択`;
          }, [statusAilmentTypes, statusAilmentSettings]);

          const [statusCopyActive, setStatusCopyActive] = useState(false);

          const applySelectedBaseResistanceToAll = useCallback((baseName) => {
            const baseData = characterResistances.find(char => char['登録名'] === baseName);
            if (!baseData) { alert(`${baseName} がキャラクター選択欄に見つかりません`); return; }

            const newCharacterValues = { ...characterValues };
            ['キャラ１', 'キャラ２', 'キャラ３', 'キャラ４', 'キャラ５'].forEach(charName => {
              newCharacterValues[charName] = {};
              attributes.forEach(attr => { newCharacterValues[charName][attr] = parseInt(baseData[attr] || 0); });
            });
            setCharacterValues(newCharacterValues);

            const newCharacterSelections = { ...selectedCharacters };
            ['キャラ１', 'キャラ２', 'キャラ３', 'キャラ４', 'キャラ５'].forEach(charName => { newCharacterSelections[charName] = baseName; });
            setSelectedCharacters(newCharacterSelections);
          }, [characterResistances, characterValues, selectedCharacters, attributes]);

          const copyStatusAilmentsToAll = useCallback(() => {
            const currentStatus = statusAilmentSettings[activeTab];
            const newStatusSettings = { ...statusAilmentSettings };
            ['キャラ１', 'キャラ２', 'キャラ３', 'キャラ４', 'キャラ５'].forEach(charName => {
              if (charName !== activeTab) {
                newStatusSettings[charName] = { ...currentStatus, showDropdown: false };
              }
            });
            setStatusAilmentSettings(newStatusSettings);
          }, [activeTab, statusAilmentSettings]);

          const getHeaderClass = useCallback((attr) => {
            if (['主防具', '副防具', '装飾品', 'キャラ'].includes(attr)) return 'header-gray';
            if (['斬', '打', '突', '熱', '冷', '雷', '陽', '陰'].includes(attr)) return 'header-blue';
            if (['毒', '暗闇', 'スタン', 'マヒ', '眠り', '石化', '混乱', '魅了', '狂戦士', '気絶'].includes(attr)) return 'header-red';
            if (['腕力', '体力', '器用さ', '素早さ', '知力', '精神', '愛', '魅力'].includes(attr)) return 'header-green';
            return '';
          }, []);

          const getCharacterTextColorClass = useCallback((charName) => {
            switch(charName) {
              case 'キャラ１': return 'char1-text';
              case 'キャラ２': return 'char2-text';
              case 'キャラ３': return 'char3-text';
              case 'キャラ４': return 'char4-text';
              case 'キャラ５': return 'char5-text';
              default: return '';
            }
          }, []);


          return (
            <div className="max-w-8xl mx-auto p-0">
              <div className="bg-[#fff] p-6">
                <h1 className="text-2xl font-bold mb-6 text-gray-800"><a href="armor.html">★装備候補検索ツール</a> ver.2025/07/12</h1>

                {loading && (
                  <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                    <div className="flex items-center">
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                      <span className="text-blue-600">データを読み込み中...</span>
                    </div>
                  </div>
                )}

                {/* ファイルロードエラーの表示 */}
                {error && (
                  <div className="mb-6 p-4 bg-red-50 rounded-lg">
                    <div className="text-red-600 mb-2">{error}</div>
                    <div className="text-sm text-red-500 mb-3">
                      以下のファイルが必要です：
                      <ul className="list-disc list-inside mt-1 ml-4">
                        <li>./data/armor-main.csv（主防具データ）</li>
                        <li>./data/armor-sub.csv（副防具データ）</li>
                        <li>./data/decoration.csv（装飾品データ）</li>
                        <li>./data/favorite.csv（キャラ耐性データ）</li>
                      </ul>
                    </div>
                    <button
                      onClick={() => {
                        setError('');
                        setLoading(true);
                        setMainThreadDataLoaded(false);
                        setWorkerDataLoaded(false);
                        // [修正点] 再試行ボタンで、もしWorkerが存在すれば終了し、新しいWorkerを作成してinitを再送する
                        if (workerRef.current) {
                            workerRef.current.terminate();
                            workerRef.current = null;
                        }
                        if (window.Worker) {
                            const newWorkerForRetry = new Worker('./worker.js'); // 新しいWorkerインスタンス
                            workerRef.current = newWorkerForRetry; // workerRefを更新

                            // 再試行時にWorkerハンドラを再設定する必要がある（calculateCombinationsと共通化する）
                            newWorkerForRetry.onmessage = (event) => { // newWorkerForRetryを使用
                              const { type, payload, message } = event.data;
                              if (type === 'dataLoaded') {
                                  console.log("Worker: Data re-pre-loaded after retry.");
                                  setWorkerDataLoaded(true);
                                  if (mainThreadDataLoaded) {
                                      setLoading(false);
                                  }
                                  setError('');
                              } else if (type === 'dataLoadError') {
                                  setError(`Workerでのデータ読み込みエラー: ${payload || '不明なエラー'}`);
                                  setWorkerDataLoaded(false);
                                  setLoading(false);
                                  console.error("Worker Data Load Error during retry: ", payload);
                              }
                              else if (type === 'results') {
                                setCombinations(prev => ({ ...prev, ['５人１組']: payload }));
                                setSearching(prev => ({ ...prev, ['５人１組']: false }));
                                clearInterval(countdownIntervalRef.current);
                                countdownIntervalRef.current = null;
                                setCountdown(0);
                                if (payload.length === 0) {
                                    setFivePersonSearchResultMessage('条件を満たす組み合わせは見つかりませんでした。条件を緩和するか、除外設定を調整してください。');
                                } else {
                                    setFivePersonSearchResultMessage('');
                                }
                                setError('');
                                console.log("Worker: Search completed and results received.");
                              } else if (type === 'error') {
                                setFivePersonSearchResultMessage(`検索エラー: ${payload || '不明なエラーが発生しました。'}`);
                                setSearching(prev => ({ ...prev, ['５人１組']: false }));
                                clearInterval(countdownIntervalRef.current);
                                countdownIntervalRef.current = null;
                                setCountdown(0);
                                console.error("Worker Error: ", payload);
                              } else if (type === 'progress') {
                                console.log(`Worker Progress: ${message}`);
                              }
                            };
                            newWorkerForRetry.onerror = (error) => { // newWorkerForRetryを使用
                                setError(`Workerからの予期せぬエラー: ${error.message || '不明なWorkerエラー'}`);
                                setSearching(prev => ({ ...prev, ['５人１組']: false }));
                                clearInterval(countdownIntervalRef.current);
                                countdownIntervalRef.current = null;
                                setCountdown(0);
                                console.error("Worker Error Event:", error);
                            };

                            newWorkerForRetry.postMessage({ type: 'init', payload: { dataFiles: dataFiles } }); // newWorkerForRetryを使用
                        }

                        const loadDataForMainThread = async () => {
                            setLoading(true);
                            try {
                                const [mainArmorData, subArmorData, decorationData, characterData] = await Promise.all([
                                    loadCSVFile(dataFiles.mainArmor),
                                    loadCSVFile(dataFiles.subArmor),
                                    loadCSVFile(dataFiles.decorations),
                                    loadCharacterResistances()
                                ]);
                                setMainArmor(mainArmorData);
                                setSubArmor(subArmorData);
                                setDecorations(decorationData);
                                setCharacterResistances(characterData);
                                const initialQuantities = {};
                                mainArmorData.forEach(item => initialQuantities[`main_${item['名称']}`] = item['所持数'] || Infinity);
                                subArmorData.forEach(item => initialQuantities[`sub_${item['名称']}`] = item['所持数'] || Infinity);
                                decorationData.forEach(item => initialQuantities[`deco_${item['名称']}`] = item['所持数'] || Infinity);
                                setItemQuantities(initialQuantities);
                                setMainThreadDataLoaded(true);
                                console.log('Main thread: Data re-loaded.');
                            } catch (err) {
                                setError(`再試行エラー: ${err.message}`);
                                console.error('Main thread re-load error:', err);
                                setLoading(false);
                            }
                        };
                        loadDataForMainThread();
                      }}
                      className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors"
                    >
                      再試行
                    </button>
                  </div>
                )}

                {/* 検索結果メッセージの表示 (ファイルロードエラーと区別) */}
                {searchResultMessage && !error && activeTab !== '５人１組' && (
                    <div className="mb-6 p-4 bg-red-50 rounded-lg">
                        <div className="text-red-600 mb-2">{searchResultMessage}</div>
                    </div>
                )}

                {!loading && !error && (
                  <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                    <div className="flex items-center mb-4">
                      <h2 className="text-lg font-semibold text-blue-700 mr-2">目標値設定</h2>
                        <select
                          value={selectedPreset}
                          onChange={(e) => {
                            setSelectedPreset(e.target.value);
                            handlePresetSelect(e.target.value);
                          }}
                          className="border border-blue-300 rounded px-3 py-2 mr-2 text-sm bg-white h-10 min-h-[2.5rem]"
                        >
                        <option value="">プリセット選択</option>
                        <option value="All Resist">All Resist</option>
                        {Object.keys(savedProfiles).map(profileName => (
                          <option key={profileName} value={profileName}>
                            {profileName}
                          </option>
                        ))}
                      </select>
                      <div className="ml-auto">
                        <button
                          onClick={() => {
                            if (window.confirm("リセットしてよろしいですか？")) {
                              setTargetValues({
                                斬: 0, 打: 0,突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0
                              });
                              setSelectedPreset("");

                              setExcludeSettings(prev => ({
                                ...prev,
                                main: [],
                                sub: [],
                                deco: []
                              }));
                            }
                          }}
                          className="text-sm bg-blue-200 hover:bg-blue-300 px-4 py-2 rounded transition-colors"
                        >
                          リセット
                        </button>
                      </div>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-4">
                      {attributes.map(attr => (
                        <div key={attr} className="flex items-center gap-2">
                          <label className="font-medium w-8 text-blue-700">{attr}:</label>
                          <input
                            type="number"
                            value={targetValues[attr]}
                            onChange={(e) => handleTargetValueChange(attr, e.target.value)}
                            onFocus={(e) => e.target.select()}
                            className="border border-blue-300 rounded px-3 py-2 w-20 text-center"
                          />
                        </div>
                      ))}
                    </div>

                    <div className="mt-4 p-3 bg-white rounded border border-blue-200">
                      <div className="flex items-center gap-3 flex-wrap">
                        <label className="font-medium text-blue-700">設定名:</label>
                          <input
                            type="text"
                            value={profileName}onChange={(e) => setProfileName(e.target.value)}
                            placeholder="プリセット名を入力"
                            className="border border-blue-300 rounded px-3 py-2 flex-1 min-w-[200px]"
                          />
                          <button
                            onClick={handleSaveProfile}
                            disabled={!profileName.trim()}
                            className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white px-4 py-2 rounded transition-colors text-sm"
                          >
                          現在の値をプロファイルに保存
                          </button>
                          <button
                            onClick={handleDeleteProfile}
                            disabled={!profileName.trim()}
                            className="bg-red-500 hover:bg-red-600 disabled:bg-gray-400 text-white px-4 py-2 rounded transition-colors text-sm"
                          >
                          削除
                        </button>
                      </div>
                    </div>

                    <div className="grid mb-6"></div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="relative">
                          <label className="text-sm text-blue-700 mb-1 block">主防具 除外:</label>
                          <button
                            onClick={(e) => {
                              setExcludeSettings(prev => ({ ...prev, showMain: !prev.showMain }));
                            }}
                            className={`border rounded px-3 py-2 w-full text-left flex items-center justify-between ${
                              excludeSettings.main.length === 0 ? 'border-gray-300 bg-gray-200' : 'border-blue-300 bg-white'
                            }`}
                          >
                            <span>
                              {excludeSettings.main.length === 0
                                ? '(未指定)'
                                : excludeSettings.main.length === 1
                                ? excludeSettings.main[0]
                                : `${excludeSettings.main.length}個選択`}
                            </span>
                            <span className="text-gray-500">▼</span>
                          </button>

                          {excludeSettings.showMain && (
                            <div
                              className="absolute z-10 mt-1 bg-white border border-blue-300 rounded shadow-lg max-h-80 overflow-y-auto w-full"
                              ref={(el) => (excludeDropdownRefs.current.main = el)}
                            >
                              <div className="p-2 border-b border-gray-200 flex gap-2">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setExcludeSettings(prev => ({
                                      ...prev,
                                      main: []
                                    }));
                                  }}
                                  className="text-sm text-blue-600 hover:underline"
                                >
                                  すべて選択解除
                                </button>
                              </div>

                              <div className="p-2">
                                {mainArmor.map((item, idx) => (
                                  <label key={idx} className="flex items-center gap-2 py-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={excludeSettings.main.includes(item['名称'])}
                                      onChange={(e) => {
                                        const checked = e.target.checked;
                                        setExcludeSettings(prev => ({
                                          ...prev,
                                          main: checked
                                            ? [...prev.main, item['名称']]
                                            : prev.main.filter(v => v !== item['名称'])
                                        }));
                                      }}
                                    />
                                    {item['名称']}
                                  </label>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>

                        <div className="relative">
                          <label className="text-sm text-blue-700 mb-1 block">副防具 除外:</label>
                          <button
                            onClick={(e) => {
                              setExcludeSettings(prev => ({ ...prev, showSub: !prev.showSub }));
                            }}
                            className={`border rounded px-3 py-2 w-full text-left flex items-center justify-between ${
                              excludeSettings.sub.length === 0 ? 'border-gray-300 bg-gray-200' : 'border-blue-300 bg-white'
                            }`}
                          >
                            <span>
                              {excludeSettings.sub.length === 0
                                ? '(未指定)'
                                : excludeSettings.sub.length === 1
                                ? excludeSettings.sub[0]
                                : `${excludeSettings.sub.length}個選択`}
                            </span>
                            <span className="text-gray-500">▼</span>
                          </button>

                          {excludeSettings.showSub && (
                            <div
                              className="absolute z-10 mt-1 bg-white border border-blue-300 rounded shadow-lg max-h-80 overflow-y-auto w-full"
                              ref={(el) => (excludeDropdownRefs.current.sub = el)}
                            >
                              <div className="p-2 border-b border-gray-200 flex gap-2">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setExcludeSettings(prev => ({
                                      ...prev,
                                      sub: []
                                    }));
                                  }}
                                  className="text-sm text-blue-600 hover:underline"
                                >
                                  すべて選択解除
                                </button>
                              </div>

                              <div className="p-2">
                                {subArmor.map((item, idx) => (
                                  <label key={idx} className="flex items-center gap-2 py-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={excludeSettings.sub.includes(item['名称'])}
                                      onChange={(e) => {
                                        const checked = e.target.checked;
                                        setExcludeSettings(prev => ({
                                          ...prev,
                                          sub: checked
                                            ? [...prev.sub, item['名称']]
                                            : prev.sub.filter(v => v !== item['名称'])
                                        }));
                                      }}
                                    />
                                    {item['名称']}
                                  </label>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>

                        <div className="relative">
                          <label className="text-sm text-blue-700 mb-1 block">装飾品 除外:</label>
                          <button
                            onClick={(e) => {
                              setExcludeSettings(prev => ({ ...prev, showDeco: !prev.showDeco }));
                            }}
                            className={`border rounded px-3 py-2 w-full text-left flex items-center justify-between ${
                              excludeSettings.deco.length === 0 ? 'border-gray-300 bg-gray-200' : 'border-blue-300 bg-white'
                            }`}
                          >
                            <span>
                              {excludeSettings.deco.length === 0
                                ? '(未指定)'
                                : excludeSettings.deco.length === 1
                                ? excludeSettings.deco[0]
                                : `${excludeSettings.deco.length}個選択`}
                            </span>
                            <span className="text-gray-500">▼</span>
                          </button>

                          {excludeSettings.showDeco && (
                            <div
                              className="absolute z-10 mt-1 bg-white border border-blue-300 rounded shadow-lg max-h-80 overflow-y-auto w-full"
                              ref={(el) => (excludeDropdownRefs.current.deco = el)}
                            >
                              <div className="p-2 border-b border-gray-200 flex gap-2">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setExcludeSettings(prev => ({
                                      ...prev,
                                      deco: []
                                    }));
                                  }}
                                  className="text-sm text-blue-600 hover:underline"
                                >
                                  すべて選択解除
                                </button>
                              </div>

                              <div className="p-2">
                                {decorations.map((item, idx) => (
                                  <label key={idx} className="flex items-center gap-2 py-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={excludeSettings.deco.includes(item['名称'])}
                                      onChange={(e) => {
                                        const checked = e.target.checked;
                                        setExcludeSettings(prev => ({
                                          ...prev,
                                          deco: checked
                                            ? [...prev.deco, item['名称']]
                                            : prev.deco.filter(v => v !== item['名称'])
                                        }));
                                      }}
                                    />
                                    {item['名称']}
                                  </label>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>

                        <div className="flex gap-2 p-2">
                          <button
                            onClick={() => saveExcludeProfile('主防具')}
                            disabled={excludeSaving.main || excludeSettings.main.length === 0}
                            className={`w-full px-4 py-2 rounded ${
                              excludeSaving.main || excludeSettings.main.length === 0
                                ? 'bg-gray-400 text-white'
                                : 'bg-blue-500 hover:bg-blue-600 text-white'
                            }`}
                          >
                            主防具 除外を保存
                          </button>

                          <button
                            onClick={() => deleteExcludeProfile('主防具')}
                            disabled={excludeSaving.main || excludeSettings.main.length === 0}
                            className={`w-full px-4 py-2 rounded ${
                              excludeDeleting.main || excludeSettings.main.length === 0
                                ? 'bg-gray-400 text-white'
                                : 'bg-red-500 hover:bg-red-600 text-white'
                            }`}
                          >
                            主防具 除外を削除
                          </button>

                        </div>

                        <div className="flex gap-2 p-2">
                          <button
                            onClick={() => saveExcludeProfile('副防具')}
                            disabled={excludeSaving.sub || excludeSettings.sub.length === 0}
                            className={`w-full px-4 py-2 rounded ${
                              excludeSaving.sub || excludeSettings.sub.length === 0
                                ? 'bg-gray-400 text-white'
                                : 'bg-blue-500 hover:bg-blue-600 text-white'
                            }`}
                          >
                            副防具 除外を保存
                          </button>

                          <button
                            onClick={() => deleteExcludeProfile('副防具')}
                            disabled={excludeSaving.sub || excludeSettings.sub.length === 0}
                            className={`w-full px-4 py-21 rounded ${
                              excludeDeleting.sub || excludeSettings.sub.length === 0
                                ? 'bg-gray-400 text-white'
                                : 'bg-red-500 hover:bg-red-600 text-white'
                            }`}
                          >
                            副防具 除外を削除
                          </button>
                        </div>

                        <div className="w-full flex gap-2 p-2">
                          <button
                            onClick={() => saveExcludeProfile('装飾品')}
                            disabled={excludeSaving.deco || excludeSettings.deco.length === 0}
                            className={`w-full px-4 py-2 rounded ${
                              excludeSaving.deco || excludeSettings.deco.length === 0
                                ? 'bg-gray-400 text-white'
                                : 'bg-blue-500 hover:bg-blue-600 text-white'
                            }`}
                          >
                            装飾品 除外を保存
                          </button>

                          <button
                            onClick={() => deleteExcludeProfile('装飾品')}
                            disabled={excludeSaving.deco || excludeSettings.deco.length === 0}
                            className={`w-full px-4 py-2 rounded ${
                              excludeDeleting.deco || excludeSettings.deco.length === 0
                                ? 'bg-gray-400 text-white'
                                : 'bg-red-500 hover:bg-red-600 text-white'
                            }`}
                          >
                            装飾品 除外を削除
                          </button>
                        </div>
                    </div>
                  </div>
                )}

                {!loading && !error && (
                  <div className="mb-6">
                    <div className="flex border-b border-gray-200 mb-4">
                      {characterNames.map(charName => (
                        <button
                          key={charName}
                          onClick={() => setActiveTab(charName)}
                          className={`px-4 py-2 font-medium transition-colors ${
                            activeTab === charName
                              ? `border-b-2 ${characterColors[charName].tab}`
                              : 'text-gray-500 hover:text-gray-700'
                          }`}
                        >
                        {charName}
                        </button>
                      ))}
                    </div>

                    {activeTab === '５人１組' ? (
                      <div className={`p-4 ${characterColors[activeTab].bg} rounded-lg`}>
                        <h2 className={`text-lg font-semibold ${characterColors[activeTab].text} mb-4`}>５人１組 装備候補検索</h2>
                        <p className={`text-sm ${characterColors[activeTab].text} mb-4`}>
                          各キャラの耐性値設定、目標値個別修正、状態異常耐性、装備指定、ソート設定は、それぞれのキャラクタータブで設定してください。
                          このタブでは、それらの設定に基づいて、所持数を考慮した５人分の装備組み合わせを検索します。（最大20件まで）<br/><br/>
                          検索は１分でタイムアウトします。１分を待たずとも、検索中に再度検索ボタンを押すと、検索を途中で停止させる事ができます。
                          ただし、ボタン押下後に停止させる前の検索条件で候補があった場合、リストが表示される事があります。
                        </p>
                         <div className="text-center mt-6">
                            <button
                              onClick={() => calculateCombinations(activeTab)}
                              // Removed disabled={searching[activeTab]}
                              className={`px-8 py-3 rounded-lg font-semibold transition-colors ${
                                searching[activeTab]
                                  ? 'bg-gray-400 text-gray-600' // Still change style when searching
                                  : `${characterColors[activeTab].search} text-white`
                              }`}
                            >
                              {searching[activeTab] ? (
                                <div className="flex items-center justify-center">
                                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                                  <span className="ml-2">
                                    検索中... (残り {countdown} 秒) - **クリックで停止**
                                  </span>
                                </div>
                              ) : (
                                `${activeTab} 装備候補を検索`
                              )}
                            </button>
                            {/* 検索結果メッセージをボタンの下に表示 */}
                            {fivePersonSearchResultMessage && (
                                <div className="mt-4 p-2 rounded-lg bg-red-100 text-red-600 text-sm font-medium">
                                    {fivePersonSearchResultMessage}
                                </div>
                            )}
                          </div>
                      </div>
                    ) : (
                      <div className={`p-4 ${characterColors[activeTab].bg} rounded-lg`}>
                      <div className="flex items-center justify-between mb-4">
                        <h2 className={`text-lg font-semibold ${characterColors[activeTab].text}`}>{activeTab} 耐性値設定</h2>
                        <button
                          onClick={() => {
                            const confirmed = window.confirm("リセットしてよろしいですか？");
                            if (!confirmed) return;

                            setCharacterValues(prev => ({
                              ...prev,
                              [activeTab]: {
                                斬: 0, 打: 0,突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0
                              }
                            }));

                            setCharacterAdjustmentValues(prev => ({
                              ...prev,
                              [activeTab]: {
                                斬: 0, 打: 0,突: 0, 熱: 0, 冷: 0, 雷: 0, 陽: 0, 陰: 0
                              }
                            }));

                            setSelectedCharacters(prev => ({
                              ...prev,
                              [activeTab]: ''
                            }));

                            setStatusAilmentSettings(prev => ({
                              ...prev,
                              [activeTab]: {
                                selectedTypes: [],
                                value: 20,
                                showDropdown: false
                              }
                            }));

                            setFixedEquipments(prev => ({
                              ...prev,
                              [activeTab]: { main: '', sub: '', deco: '' }
                            }));

                            setSortSettings(prev => ({
                              ...prev,
                              [activeTab]: { priority1: '', order1: 'desc', priority2: '', order2: 'desc', priority3: '', order3: 'desc' }
                            }));
                          }}
                          className={`text-sm ${characterColors[activeTab].button} px-4 py-2 rounded transition-colors`}
                        >
                        リセット
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div className="flex items-center gap-2">
                          <label className={`w-120 text-sm ${characterColors[activeTab].text}`}>キャラクター選択:</label>
                          <select
                            value={selectedCharacters[activeTab]}
                            onChange={(e) => handleCharacterSelect(activeTab, e.target.value)}
                            className={`flex-1 border rounded px-3 py-2 h-10 min-h-[2.5rem] ${
                              selectedCharacters[activeTab] === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                            }`}
                          >
                          <option value="">(未指定)</option>
                          {characterResistances.map((char, index) => (
                            <option key={index} value={char['登録名']}>
                              {char['登録名']}
                            </option>
                          ))}
                          </select>
                        </div>

                        <div className="flex items-center gap-1">
                          <label className={`w-15 text-sm ${characterColors[activeTab].text}`}>状態異常耐性:</label>
                          <div className="relative flex-1 min-w-40" ref={el => dropdownRefs.current[activeTab] = el}>
                            <button
                              onClick={() => toggleStatusAilmentDropdown(activeTab)}
                              className={`border rounded px-3 py-2 flex items-center gap-2 w-full justify-between ${
                                statusAilmentSettings[activeTab].selectedTypes.length === 0 ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                              }`}
                            >
                              <span>{getStatusAilmentDisplayText(activeTab)}</span>
                              <span className="text-gray-500">▼</span>
                            </button>

                            {statusAilmentSettings[activeTab].showDropdown && (
                              <div className={`absolute top-full left-0 mt-1 bg-white border ${characterColors[activeTab].border} rounded shadow-lg z-10 w-full`}>
                                <div className="p-2 border-b border-gray-200">
                                  <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={isAllStatusAilmentsSelected(activeTab)}
                                      onChange={(e) => handleSelectAllStatusAilments(activeTab, e.target.checked)}
                                      className="rounded"
                                    />
                                    <span className={`font-medium ${characterColors[activeTab].label}`}>すべて選択</span>
                                  </label>
                                </div>

                                <div className="max-h-100 overflow-y-auto">
                                  {statusAilmentTypes.map(type => (
                                    <div key={type} className="p-2 hover:bg-gray-50">
                                      <label key={type} className="flex items-center gap-2 cursor-pointer">
                                        <input
                                          type="checkbox"
                                          checked={statusAilmentSettings[activeTab].selectedTypes.includes(type)}
                                          onChange={(e) => handleStatusAilmentTypeChange(activeTab, type, e.target.checked)}
                                          className="rounded"
                                        />
                                        <span>{type}</span>
                                      </label>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                            <div className="flex items-center gap-1">
                              <label className={`w-15 text-sm ${characterColors[activeTab].text}`}>耐性値:</label>
                              <input
                                type="number"
                                value={statusAilmentSettings[activeTab].value}
                                onChange={(e) => handleStatusAilmentValueChange(activeTab, e.target.value)}
                                onFocus={(e) => e.target.select()}
                                className={`border rounded px-3 py-2 w-20 text-center ${
                                  statusAilmentSettings[activeTab].selectedTypes.length === 0 ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                                }`}
                                min="0"
                              />
                            </div>
                        </div>

                        <div className="flex items-center gap-1">
                          <button
                            onClick={() => applySelectedBaseResistanceToAll('斬基本')}
                            className="flex-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                          >
                            全斬基本
                          </button>
                          <button
                            onClick={() => applySelectedBaseResistanceToAll('打基本')}
                            className="flex-1 px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                          >
                            全打基本
                          </button>
                          <button
                            onClick={() => applySelectedBaseResistanceToAll('突基本')}
                            className="flex-1 px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"
                          >
                            全突基本
                          </button>
                          <button
                            onClick={() => {
                              copyStatusAilmentsToAll();
                              setStatusCopyActive(true);
                              setTimeout(() => setStatusCopyActive(false), 100);
                            }}
                            disabled={statusAilmentSettings[activeTab].selectedTypes.length === 0}
                            className={`flex-1 px-3 py-2 text-white rounded transition ${
                              statusAilmentSettings[activeTab].selectedTypes.length === 0
                                ? 'bg-gray-400'
                                : statusCopyActive
                                ? 'bg-orange-500'
                                : 'bg-red-500 hover:bg-red-600'
                            }`}
                          >
                            全異反映
                          </button>
                        </div>
                      </div>

                      <div className={`${characterColors[activeTab].label}`}>[スタイル耐性値]</div>

                      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-4">
                        {attributes.map(attr => (
                          <div key={attr} className="flex items-center gap-2">
                            <label className={`font-medium w-8 ${characterColors[activeTab].text}`}>{attr}:</label>
                            <input
                              type="number"
                              value={characterValues[activeTab][attr]}
                              onChange={(e) => handleCharacterValueChange(activeTab, attr, e.target.value)}
                              onFocus={(e) => e.target.select()}
                              className={`border ${characterColors[activeTab].border} rounded px-3 py-2 w-20 text-center`}
                            />
                          </div>
                        ))}
                      </div>

                      <div className={`${characterColors[activeTab].label}`}>[目標値個別修正] ※目標値に対し増減したい数を入力</div>

                      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-4">
                        {attributes.map(attr => (
                          <div key={attr} className="flex items-center gap-2">
                            <label className={`font-medium w-8 ${characterColors[activeTab].text}`}>{attr}:</label>
                            <input
                              type="number"
                              value={characterAdjustmentValues[activeTab][attr]}
                              onChange={(e) => handleAdjustmentValueChange(activeTab, attr, e.target.value)}
                              onFocus={(e) => e.target.select()}
                              className={`border ${characterColors[activeTab].border} rounded px-3 py-2 w-20 text-center`}
                            />
                          </div>
                        ))}
                      </div>

                     <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                          <label className={`text-sm ${characterColors[activeTab].text}`}>主防具 指定:</label>
                          <select
                            value={fixedEquipments[activeTab].main}
                            onChange={(e) =>
                              setFixedEquipments((prev) => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], main: e.target.value }
                              }))
                            }
                            className={`w-full border rounded px-3 py-2 h-10 min-h-[2.5rem] ${
                              fixedEquipments[activeTab].main === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                            }`}
                          >
                            <option value="">（未指定）</option>
                            {mainArmor.map((item, idx) => (
                              <option key={idx} value={item['名称']}>{item['名称']}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label className={`text-sm ${characterColors[activeTab].text}`}>副防具 指定:</label>
                          <select
                            value={fixedEquipments[activeTab].sub}
                            onChange={(e) =>
                              setFixedEquipments((prev) => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], sub: e.target.value }
                              }))
                            }
                            className={`w-full border rounded px-3 py-2 h-10 min-h-[2.5rem] ${
                              fixedEquipments[activeTab].sub === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                            }`}
                          >
                            <option value="">（未指定）</option>
                            {subArmor.map((item, idx) => (
                              <option key={idx} value={item['名称']}>{item['名称']}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label className={`text-sm ${characterColors[activeTab].text}`}>装飾品 指定:</label>
                          <select
                            value={fixedEquipments[activeTab].deco}
                            onChange={(e) =>
                              setFixedEquipments((prev) => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], deco: e.target.value }
                              }))
                            }
                            className={`w-full border rounded px-3 py-2 h-10 min-h-[2.5rem] ${
                              fixedEquipments[activeTab].deco === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                            }`}
                          >
                            <option value="">（未指定）</option>
                            {decorations.map((item, idx) => (
                              <option key={idx} value={item['名称']}>{item['名称']}</option>
                            ))}
                          </select>
                        </div>
                      </div>

                      <div className="grid mb-6"></div>

                      <div className="mb-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="flex items-center gap-2">
                            <label className={`text-sm min-w-[60px] ${characterColors[activeTab].text}`}>ソート第一優先:</label>
                            <select
                              value={sortSettings[activeTab].priority1}
                              onChange={(e) => setSortSettings(prev => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], priority1: e.target.value }
                              }))}
                              className={`flex-1 border rounded px-3 py-2 h-10 min-h-[2.5rem] text-sm ${
                                sortSettings[activeTab].priority1 === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                              }`}
                            >
                              <option value="">(未指定)</option>
                              {sortableAttributes.map(attr => (
                                <option key={attr} value={attr}>{attr}</option>
                              ))}
                            </select>
                            <select
                              value={sortSettings[activeTab].order1}
                              onChange={(e) => setSortSettings(prev => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], order1: e.target.value }
                              }))}
                              className={`w-20 border rounded px-3 py-2 h-10 min-h-[2.5rem] text-sm ${
                                sortSettings[activeTab].priority1 === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                              }`}
                            >
                              <option value="asc">昇順</option>
                              <option value="desc">降順</option>
                            </select>
                          </div>
                          <div className="flex items-center gap-2">
                            <label className={`text-sm min-w-[60px] ${characterColors[activeTab].text}`}>ソート第二優先:</label>
                            <select
                              value={sortSettings[activeTab].priority2}
                              onChange={(e) => setSortSettings(prev => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], priority2: e.target.value }
                              }))}
                              className={`flex-1 border rounded px-3 py-2 h-10 min-h-[2.5rem] text-sm ${
                                sortSettings[activeTab].priority2 === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                              }`}
                            >
                              <option value="">(未指定)</option>
                              {sortableAttributes.map(attr => (
                                <option key={attr} value={attr}>{attr}</option>
                              ))}
                            </select>
                            <select
                              value={sortSettings[activeTab].order2}
                              onChange={(e) => setSortSettings(prev => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], order2: e.target.value }
                              }))}
                              className={`w-20 border rounded px-3 py-2 h-10 min-h-[2.5rem] text-sm ${
                                sortSettings[activeTab].priority2 === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                              }`}
                            >
                              <option value="asc">昇順</option>
                              <option value="desc">降順</option>
                            </select>
                          </div>

                          <div className="flex items-center gap-2">
                            <label className={`text-sm min-w-[60px] ${characterColors[activeTab].text}`}>ソート第三優先:</label>
                            <select
                              value={sortSettings[activeTab].priority3}
                              onChange={(e) => setSortSettings(prev => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], priority3: e.target.value }
                              }))}
                              className={`flex-1 border rounded px-3 py-2 h-10 min-h-[2.5rem] text-sm ${
                                sortSettings[activeTab].priority3 === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                              }`}
                            >
                              <option value="">(未指定)</option>
                              {sortableAttributes.map(attr => (
                                <option key={attr} value={attr}>{attr}</option>
                              ))}
                            </select>
                            <select
                              value={sortSettings[activeTab].order3}
                              onChange={(e) => setSortSettings(prev => ({
                                ...prev,
                                [activeTab]: { ...prev[activeTab], order3: e.target.value }
                              }))}
                              className={`w-20 border rounded px-3 py-2 h-10 min-h-[2.5rem] text-sm ${
                                sortSettings[activeTab].priority3 === '' ? 'border-gray-300 bg-gray-200' : `${characterColors[activeTab].border} bg-white`
                              }`}
                            >
                              <option value="asc">昇順</option>
                              <option value="desc">降順</option>
                            </select>
                          </div>
                        </div>
                      </div>

                      <div className="text-center">
                        <button
                          onClick={() => calculateCombinations(activeTab)}
                          disabled={searching[activeTab]}
                          className={`px-8 py-3 rounded-lg font-semibold transition-colors ${
                            searching[activeTab]
                              ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                              : `${characterColors[activeTab].search} text-white`
                          }`}
                        >
                          {searching[activeTab] ? (
                            <div className="flex items-center justify-center">
                              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                              {activeTab} 検索中...
                            </div>
                          ) : (
                            `${activeTab} 装備候補を検索`
                          )}
                        </button>
                        {/* 個別検索の検索結果メッセージをボタンの下に表示 */}
                        {searchResultMessage && activeTab !== '５人１組' && (
                             <div className="mt-4 p-2 rounded-lg bg-red-50 text-red-600 text-sm font-medium">
                                 {searchResultMessage}
                             </div>
                         )}
                      </div>
                    </div>
                    )}
                  </div>
                )}

                {mainArmor.length > 0 && (
                  <div className="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-blue-50 p-3 rounded-lg">
                      <div className="text-sm text-blue-600">主防具 登録数</div>
                      <div className="text-xl font-bold text-blue-800">{mainArmor.length}</div>
                    </div>
                    <div className="bg-green-50 p-3 rounded-lg">
                      <div className="text-sm text-green-600">副防具 登録数</div>
                      <div className="text-xl font-bold text-green-800">{subArmor.length}</div>
                    </div>
                    <div className="bg-purple-50 p-3 rounded-lg">
                      <div className="text-sm text-purple-600">装飾品 登録数</div>
                      <div className="text-xl font-bold text-purple-800">{decorations.length}</div>
                    </div>
                    <div className="bg-red-50 p-3 rounded-lg">
                      <div className="text-sm text-red-600">{activeTab} 適合組み合わせ</div>
                      <div className="text-xl font-bold text-red-800">{combinations[activeTab]?.length || 0}</div>
                    </div>
                  </div>
                )}

                {combinations[activeTab] && combinations[activeTab].length > 0 && (
                  <div className="overflow-x-auto pb-10">
                    <h2 className="text-lg font-semibold mb-4">
                      {activeTab} - 条件を満たす組み合わせ ({combinations[activeTab].length}件)
                    </h2>

                    {activeTab === '５人１組' ? (
                      <table className="min-w-full bg-white border border-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className={`px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase whitespace-nowrap ${getHeaderClass('キャラ')}`}>キャラ</th>
                            <th className={`px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase whitespace-nowrap ${getHeaderClass('主防具')}`}>主防具</th>
                            <th className={`px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase whitespace-nowrap ${getHeaderClass('副防具')}`}>副防具</th>
                            <th className={`px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase whitespace-nowrap ${getHeaderClass('装飾品')}`}>装飾品</th>
                            {totalAttributes.map(attr => (
                              <th key={attr} className={`px-2 py-1 text-center text-xs font-medium text-gray-800 uppercase ${getHeaderClass(attr)}`}>
                                {attr}
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {combinations[activeTab].slice(0, 20).map((teamCombo, teamIndex) => (
                            <React.Fragment key={teamIndex}>
                              {teamCombo.map((charEquip, charIdx) => {
                                const rowClassName = (Math.floor(teamIndex / 1) % 2 === 0) ? 'striped-table-row-light' : 'striped-table-row-dark';
                                const characterClass = getCharacterTextColorClass(charEquip.character);
                                return (
                                  <tr key={`${teamIndex}-${charIdx}`} className={`hover:bg-gray-100 ${rowClassName}`}>
                                    <td className={`px-3 py-2 text-sm whitespace-nowrap ${characterClass}`}>
                                      {charEquip.character}
                                    </td>
                                    <td className="px-3 py-2 text-sm text-gray-900 whitespace-nowrap">
                                      {charEquip.mainArmor}
                                    </td>
                                    <td className="px-3 py-2 text-sm text-gray-900 whitespace-nowrap">
                                      {charEquip.subArmor}
                                    </td>
                                    <td className="px-3 py-2 text-sm text-gray-900 whitespace-nowrap">
                                      {charEquip.decoration}
                                    </td>
                                    {totalAttributes.map(attr => {
                                      const value = charEquip.totals[attr] || 0;
                                      return (
                                        <td key={`${charIdx}-${attr}`} className={`px-3 py-2 text-sm text-center ${
                                          value > 0 ? 'text-blue-600' : value < 0 ? 'text-red-500' : 'text-gray-500'
                                        }`}>
                                          {value}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                );
                              })}
                            </React.Fragment>
                          ))}
                        </tbody>
                      </table>
                    ) : (
                      <table className="min-w-full bg-white border border-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className={`px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase whitespace-nowrap ${getHeaderClass('主防具')}`}>主防具</th>
                            <th className={`px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase whitespace-nowrap ${getHeaderClass('副防具')}`}>副防具</th>
                            <th className={`px-4 py-2 text-left text-xs font-medium text-gray-800 uppercase whitespace-nowrap ${getHeaderClass('装飾品')}`}>装飾品</th>

                            {totalAttributes.map(attr => (
                              <th key={attr} className={`px-2 py-1 text-center text-xs font-medium text-gray-800 uppercase ${getHeaderClass(attr)}`}>
                                {attr}
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {combinations[activeTab].slice(0, 100).map((combo, index) => (
                            <tr key={index} className="hover:bg-gray-50">
                              <td className="px-3 py-2 text-sm text-gray-900 whitespace-nowrap">{combo.mainArmor}</td>
                              <td className="px-3 py-2 text-sm text-gray-900 whitespace-nowrap">{combo.subArmor}</td>
                              <td className="px-3 py-2 text-sm text-gray-900 whitespace-nowrap">{combo.decoration}</td>

                              {totalAttributes.map(attr => {
                                const value = combo.totals[attr] || 0;
                                return (
                                  <td key={attr} className={`px-3 py-2 text-sm text-right ${
                                    value > 0 ? 'text-blue-600' : value < 0 ? 'text-red-500' : 'text-gray-500'
                                  }`}>
                                    {value}
                                  </td>
                                );
                              })}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}

                    {activeTab === '５人１組' ? (
                        combinations[activeTab].length > 20 && (
                            <div className="mt-4 text-sm text-gray-600 text-center">
                                上位20件を表示しています。全{combinations[activeTab].length}件の組み合わせがあります。
                            </div>
                        )
                    ) : (
                        combinations[activeTab].length > 100 && (
                            <div className="mt-4 text-sm text-gray-600 text-center">
                                上位100件を表示しています。全{combinations[activeTab].length}件の組み合わせがあります。
                            </div>
                        )
                    )}

                  </div>
                )}
              </div>
            </div>
          );
        };
        ReactDOM.render(<ArmorCombinationAnalyzer />, document.getElementById('root'));

        const footer = document.createElement('footer');
        footer.innerHTML = `
          ※使用は自己責任にて。<br>
          ※装飾品は基本的には耐性値が全項目ゼロのものはリストから除外しています。<br>
        `;
        document.body.appendChild(footer);

    </script>

</body>
</html>