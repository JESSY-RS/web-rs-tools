<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon-renma.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon-renma.png">
    <link rel="icon" type="image/png" href="web-app-manifest-192x192-renma.png">
    <title>ç·´ç£¨(é˜²å…·) çµ±åˆãƒ„ãƒ¼ãƒ«</title>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- å…¨ä½“ --- */
        body {
            font-family: 'Meiryo', sans-serif;
            background-color: #2A2A2A;
            color: #eee;
            margin: 0;
            user-select: none;
        }

        .bottom2 {
            margin-top: 20px;
            font-size: 16pt;
            line-height: 2;
            text-align: center;
        }

        .bottom3 {
            margin-top: 20px;
            font-size: 16pt;
            line-height: 2;
            text-align: left;
        }

        #backup-warning{
            line-height: 2;
        }

        #delete-backup-btn {
            color: #fff;
            background-color: #e53e3e;
        }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠ --- */
        .main-container {
            padding: 0 20px 20px 20px; /* ä¸Šä½™ç™½ã‚’0ã«ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼ãŒãƒšãƒ¼ã‚¸æœ€ä¸Šéƒ¨ã«ãã‚‹ã‚ˆã†ã« */
            box-sizing: border-box;
        }
        
        .main-header {
            position: relative; /* æ‹¡å¤§ãƒ»ç¸®å°ãƒœã‚¿ãƒ³ã®åŸºæº–ä½ç½® */
            padding-bottom: 7px;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« (ãƒ”ãƒ³ç•™ã‚æ©Ÿèƒ½) --- */
        .main-header.pinned {
            position: sticky;
            top: 0;
            z-index: 998; /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ˆã‚Šä¸‹ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚ˆã‚Šä¸Š */
            background-color: #2A2A2A; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ä¸‹ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒé€ã‘ãªã„ã‚ˆã†ã«èƒŒæ™¯è‰²ã‚’æŒ‡å®š */
        }
        
        /* --- ã‚¿ãƒ–UI --- */
        .tabs {
            display: flex;
            border-bottom: 2px solid #555;
            margin-bottom: 0;
            flex-wrap: nowrap;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #383838;
            border: 1px solid #555;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            font-size: 1.1em;
            color: #ccc;
            transition: background-color 0.3s, color 0.3s;
            flex-basis: auto;
            text-align: center;
        }
        .tab-button:hover {
            background-color: #4a4a4a;
        }
        .tab-button.active {
            background-color: #424242;
            color: #50b4ff;
            border-color: #555;
            border-bottom: 2px solid #424242;
            margin-bottom: -2px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* --- ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .pin-button {
            /* margin-left: auto; ã‚’å‰Šé™¤ã—ã€ã‚¿ãƒ–ã®ç›´å¾Œã«é…ç½® */
            padding: 0px 5px;
            font-size: 1.5em;
            cursor: pointer;
            user-select: none;
            align-self: center; /* Flexã‚³ãƒ³ãƒ†ãƒŠå†…ã§å‚ç›´ä¸­å¤®ã«é…ç½® */
        }

        /* --- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        h1 {
            margin: 0 0 15px 0;
            padding-top: 20px; /* main-containerã®ä¸Šä½™ç™½ã®ä»£ã‚ã‚Š */
            font-size: 1.8em;
        }
        
        a:link { color: #1D9BF0; text-decoration: underline; }
        a:visited { color: #7755FF; text-decoration: underline; }
        a:hover { color: #0CFF57; }
        a:active { color: #FF0000; text-decoration: underline; }

        /* --- å…±é€šUI: ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
        .hamburger {
            cursor: pointer;
            user-select: none;
            color: #eee;

        }
        .hamburger:hover { color: #2A99E6; }
        .side-menu {
            position: fixed; top: 0; left: -320px; width: 320px; min-height: 100vh;
            height: 100%; text-align: left; background-color: #242424;
            border-right: 1px solid #555; transition: left 0.3s ease; z-index: 1001;
            padding: 20px; box-sizing: border-box; overflow-y: auto; overscroll-behavior: contain;
        }
        .side-menu.open { left: 0; }
        .menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 999;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .menu-overlay.open { opacity: 1; visibility: visible; }
        .menu-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #FF6E3D; }
        .menu-item { font-size: 18px; display: inline-block; padding: 6px 0; color: #eee; text-decoration: none; }
        .menu-item:hover { color: #0CFF57; }
        .toggle-button {
            cursor: pointer; color: #7755FF; text-decoration: underline; font-size: 18px;
            display: block; padding: 6px 0; user-select: none;
        }
        .toggle-button:hover { color: #0CFF57; }
        #linkList1, #linkList2 { display: none; }
        #linkList a { display: inline-block; text-decoration: none; color: #7755FF; }
        #linkList a:hover { color: #0CFF57; }

        /* --- å…±é€šUI: ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ --- */
        .zoom-buttons {
            position: absolute; /* è¦ªè¦ç´ (.main-header)ã‚’åŸºæº–ã«é…ç½® */
            top: 20px; /* h1ã®padding-topã«åˆã‚ã›ã‚‹ */
            right: 0; 
            display: flex;
            flex-direction: column; 
            gap: 5px; 
            z-index: 1000;
        }
        .zoom-buttons button { padding: 5px 10px; font-size: 14px; cursor: pointer; }
        
        .bottom-links {
            margin-top: 20px;
            font-size: 16pt;
            line-height: 2;
            text-align: left;
        }

        /* ============================================= */
        /* === 1. ãƒªã‚¹ãƒˆ (renma-armor.html) ã®ã‚¹ã‚¿ã‚¤ãƒ« === */
        /* ============================================= */
        #tab-list header {
            display: flex; flex-direction: column; align-items: stretch;
            gap: 15px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #555;
            margin-top: 8px;
        }
        #tab-list .header-controls {
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        #tab-list .header-controls .left-buttons, #tab-list .header-controls .right-buttons { display: flex; gap: 10px; align-items: center; }
        #tab-list button {
            padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer;
            font-size: 0.9em; transition: background-color 0.3s, box-shadow 0.3s;
        }
        #import-btn, #import-btn-footer { background-color: hotpink; color: white; }
        #export-btn, #export-btn-footer { background-color: orange; color: white; }
        #edit-mode-btn, #edit-mode-btn-footer { background-color: #007bff; color: white; }
        #edit-mode-btn.active, #edit-mode-btn-footer.active { background-color: #dc3545; }
        
        #export-btn.needs-export, #export-btn-footer.needs-export {
            background-color: #ff4500; /* ã‚ªãƒ¬ãƒ³ã‚¸ãƒ¬ãƒƒãƒ‰ */
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 69, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
        }

        #import-file-input { display: none; }
        #parts-container { display: flex; flex-direction: column; gap: 15px; margin-top: 12px; }
        .armor-part {
            background-color: #424242; border: 1px solid #555; border-radius: 8px;
            padding: 18px 50px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #search-panel, #sort-panel { background-color: #2A2A2A; border-color: #555; }
        #search-panel.is-collapsed, #sort-panel.is-collapsed {
            min-height: 50px; padding-top: 0; padding-bottom: 0; cursor: pointer;
        }
        #search-panel.is-collapsed .favorite-toggle, #sort-panel.is-collapsed .favorite-toggle,
        #search-panel.is-collapsed .value-sort-btn, #sort-panel.is-collapsed .value-sort-btn { display: none; }
        #search-panel .part-content.collapsed, #sort-panel .part-content.collapsed { display: none; }
        .search-panel-info, .sort-panel-info {
            display: none; position: absolute; top: 50%; left: 40px; transform: translateY(-50%);
            color: #bbb; font-style: italic; white-space: nowrap;
        }
        #filter-btn { background-color: #28a745; color: white; width: 120px; min-height: 40px; }
        #filter-btn.is-active { background-color: #dc3545; }
        #sort-btn { background-color: darkviolet; color: white; width: 120px; min-height: 40px; }
        #tab-list .toggle-collapse-btn, #tab-list .add-part-inline-btn, #tab-list .delete-btn {
            position: absolute; right: 10px; width: 32px; height: 32px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; padding: 0;
            line-height: 1; font-weight: bold; user-select: none;
            font-size: 1.5em;
        }
        #tab-list .toggle-collapse-btn { top: 4px; background: transparent; color: white; font-size: 1.2em; }
        #search-panel.is-collapsed .toggle-collapse-btn, #sort-panel.is-collapsed .toggle-collapse-btn { top: 50%; transform: translateY(-50%); }
        #tab-list .delete-btn { top: 4px; background: transparent; color: white; }
        #tab-list .add-part-inline-btn { bottom: 10px; background-color: #28a745; color: white; border-radius: 50%; }
        .value-sort-btn {
            position: absolute; right: 10px; bottom: 5px; width: 32px; height: 32px;
            display: flex; justify-content: center; align-items: center; font-size: 1.2em;
            font-weight: bold; cursor: pointer; color: gray; user-select: none; border-radius: 5px;
        }
        .value-sort-btn.active { color: dodgerblue; }
        .drag-handle, .favorite-toggle {
            position: absolute; left: 5px; top: 50%; transform: translateY(-50%);
            font-size: 1.5em; padding: 5px; user-select: none;
        }
        .drag-handle { color: white; cursor: grab; display: none; }
        .drag-handle.is-favorite { color: gold; }
        .favorite-toggle { color: #eee; cursor: pointer; transition: color 0.2s; }
        .favorite-toggle.is-favorite { color: gold; }
        #tab-list footer { margin-top: 12px; padding-top: 10px; border-top: 2px solid #555; text-align: left; font-size: 1em; color: white; }
        #tab-list .custom-dropdown-button, #tab-list select {
            min-height: 40px; box-sizing: border-box; background-color: #555;
            color: white; border: 1px solid #777; border-radius: 4px;
            padding: 8px; font-size: 1em;
        }
        .ability-select { height: 40px; }
        input[type="number"].ability-value {
            width: 120px; min-height: 40px; box-sizing: border-box; background-color: #555;
            color: white; border: 1px solid #777; border-radius: 4px; font-size: 1.1em;
            padding: 8px; text-align: right; letter-spacing: 2px;
        }
        .container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .ability-section { margin-top: 10px; background-color: #2A2A2A; overflow: hidden; }
        .ability-section h2 { padding: 8px 12px; margin: 0 0 -1px 0; font-size: 1.2em; text-align: left; border: 1px solid #ccc; }
        #tab-list table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #tab-list th, #tab-list td { padding: 6px 12px; text-align: left; word-wrap: break-word; border: 1px solid #ccc; }
        #tab-list thead th { font-weight: bold; background-color: #333; }
        .ss-ability h2 { background-color: #C99004; color: #e0e0e0; }
        .s-ability h2 { background-color: #616161; color: #e0e0e0; }
        .a-ability h2 { background-color: #c62828; color: #e0e0e0; }
        .type-keigen { background-color: #2a3a4a; }
        .type-iryoku { background-color: #5c3c3c; }
        .type-mikata-iryoku { background-color: #6b4a37; }
        .type-nouryoku { background-color: #394a34; }
        .type-joutai-ijou { background-color: #4a3f5a; }
        #tab-list th:nth-child(3) { text-align: left; }
        #tab-list td:nth-child(3) { text-align: right; }
        .part-content, .form-section, .controls-wrapper { display: flex; gap: 8px; }
        .group-label { font-weight: bold; white-space: nowrap; min-width: 70px; text-align: right; margin-right: 2px; }
        .radio-group { display: flex; align-items: center; flex-shrink: 0; }
        .checkbox-group { display: flex; align-items: center; gap: 5px; min-height: 40px; justify-content: flex-end; width: 100%;}
        .checkbox-group label { cursor: pointer; }
        .part-content { flex-direction: column; }
        .form-section { display: grid; grid-template-columns: 80px 1fr; align-items: flex-start; }
        .controls-wrapper { flex-direction: column; align-items: flex-start; width: 100%; }
        .custom-dropdown, #tab-list select { width: 100%; }
        .group-label { padding-top: 8px; }
        .form-section:has(#approx-search-check), .form-section:has(#save-sort-check) { align-items: center; }
        .form-section:has(#approx-search-check) > .group-label, .form-section:has(#save-sort-check) > .group-label { padding-top: 0; }
        .search-panel-info, .sort-panel-info { font-size: 1.0em; }
        .radio-group input[type="radio"] { display: none; }
        .radio-group label {
            padding: 5px 15px; border: 1px solid #777; border-radius: 20px; cursor: pointer;
            background-color: #555; color: white; transition: all 0.2s; margin-right: 5px;
        }
        .radio-group input[type="radio"]:checked + label { background-color: #007bff; color: white; border-color: #007bff; }
        .value-input-group { display: flex; align-items: center; gap: 5px; }
        .value-input-group .symbol { font-size: 1.2em; font-weight: bold; color: white; display: none; }
        .custom-dropdown { position: relative; }
        .custom-dropdown-button { width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; font-weight: normal; }
        .custom-dropdown-button .button-arrow:after { content: 'â–¼'; margin-left: 8px; font-size: 0.8em; }
        .custom-dropdown-panel {
            display: none; position: absolute; top: 100%; left: 0; width: 100%;
            max-height: 380px; background-color: #3a3a3a; border: 1px solid #777;
            border-radius: 4px; z-index: 100; margin-top: 4px; flex-direction: column; box-sizing: border-box;
        }
        .custom-dropdown-panel.show { display: flex; }
        .dropdown-search-input {
            width: calc(100% - 16px); margin: 8px; padding: 8px; border: 1px solid #777;
            border-radius: 4px; background-color: #555; color: white; box-sizing: border-box; font-size: 1em;
        }
        .dropdown-options-list { overflow-y: auto; flex-grow: 1; }
        .dropdown-option { padding: 8px 12px; cursor: pointer; font-size: 1em; }
        .dropdown-option:hover, .dropdown-option.focused { background-color: #007bff; }
        .dropdown-option.hidden { display: none; }
        .custom-dropdown-submenu {
            display: none; position: absolute; left: 100%; width: 200px;
            background-color: #3a3a3a; border: 1px solid #777; border-radius: 4px;
            z-index: 101; overflow-y: auto; margin-top: 4px;
        }
        .dropdown-option[data-has-submenu] { display: flex; justify-content: space-between; align-items: center; }
        .submenu-arrow { color: #aaa; font-size: 0.8em; }
        
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
        @media (min-width: 769px) {
            .form-section { display: flex; flex-direction: row; align-items: center; }
            .controls-wrapper { flex-direction: row; align-items: center; width: auto; }
            .custom-dropdown, #tab-list select { min-width: 270px; width: auto; }
            .group-label { padding-top: 0; }
        }
        @media (min-width: 1281px) { .part-content { flex-direction: row; align-items: center; flex-wrap: wrap; gap: 16px; } }
        
        /* ================================================= */
        /* === 2. TOP5ç¢ºèª (armor-top5.html) ã®ã‚¹ã‚¿ã‚¤ãƒ« === */
        /* ================================================= */
        .top5-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 8px;
        }
        #tab-top5 .controls-container { text-align: center; border-radius: 8px;}
        #tab-top5 .checkbox-container { padding-top: 5px; margin-bottom: 20px; font-size: 16px; }
        #tab-top5 .checkbox-container label { cursor: pointer; }
        #tab-top5 .results-grid {
            display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
            max-width: 1400px; width: 100%; margin: 0 auto;
        }
        #tab-top5 .category-container {
            background-color: #383838; border: 1px solid #555; border-radius: 8px;
            padding: 20px; box-sizing: border-box; justify-content: center; flex-basis: 100%;
        }
        #tab-top5 h2 {
            color: #c0c0ff; margin-top: -5px; margin-bottom: 15px; border-bottom: 2px solid #555;
            padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        #tab-top5 .nav-buttons { display: flex; gap: 6px; }
        #tab-top5 .nav-button {
            background-color: #555; color: #eee; border: 1px solid #777; padding: 4px 8px;
            cursor: pointer; font-size: 12px; border-radius: 3px; transition: background-color 0.2s;
        }
        #tab-top5 .nav-button:hover { background-color: #666; }
        #tab-top5 .nav-button:disabled { background-color: #333; color: #666; cursor: default; opacity: 0.5; }
        #tab-top5 table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #tab-top5 th, #tab-top5 td { padding: 10px; border: 1px solid #777; text-align: left; word-wrap: break-word; }
        #tab-top5 thead th { background-color: #444; color: #fff; }
        #tab-top5 td.merged-ability-cell { vertical-align: top; color: #98fb98; border-bottom: none; }
        #tab-top5 .ability-total-cell { font-weight: bold; color: #f0e68c; vertical-align: bottom; border-top: none; text-align: right; }
        #tab-top5 .col-ability { width: 37%; }
        #tab-top5 .col-armor { width: 45%; }
        #tab-top5 .col-value { width: 18%; }
        #tab-top5 td.value-col { text-align: right; font-weight: bold; color: #ffd700; }
        #tab-top5 .combined-value { color: red !important; }
        #tab-top5 .combined-armor-name { color: orange; }
        #tab-top5 .special-armor-name { color: magenta; }
        #tab-top5 th.value-col { text-align: left; }
        @media (min-width: 1200px) { #tab-top5 .category-container { flex-basis: 45%; } }
        #top5-placeholder {
            display: none; 
            color: #ffd700;
            font-size: 1em;
            text-align: center;
            padding: 5px 0;
        }


        /* ==================================================== */
        /* === 3. è‡ªå‹•é¸å®šãƒ„ãƒ¼ãƒ« (armor-calc.html) ã®ã‚¹ã‚¿ã‚¤ãƒ« === */
        /* ==================================================== */
        #tab-calc .file-input-container {
            border-radius: 8px; padding-top: 5px; margin-bottom: 20px; box-sizing: border-box; text-align: center;
            margin-top: 8px;
        }
        #file-status { margin-top: 0px; color: #ffd700; font-size: 1em; }
        #tab-calc .character-grid { margin-top: 0px; display: flex; flex-direction: column; gap: 20px; width: 100%; }
        #tab-calc .character-container { background-color: #383838; border: 1px solid #555; border-radius: 8px; padding: 20px; }
        #tab-calc h2 {
            color: #c0c0ff; margin: 0 0 15px 0; border-bottom: 2px solid #555; padding-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        #tab-calc .series-select {
            background-color: #444; color: #eee; border: 1px solid #777; border-radius: 4px;
            padding: 0 6px; font-size: 16px; margin-left: 10px; height: 30px; box-sizing: border-box;
        }
        #tab-calc .nav-buttons { display: flex; gap: 6px; margin-left: auto; }
        #tab-calc .nav-button {
            background-color: #555; color: #eee; border: 1px solid #777; padding: 4px 8px;
            cursor: pointer; font-size: 12px; border-radius: 3px; transition: background-color 0.2s;
        }
        #tab-calc .nav-button:hover { background-color: #666; }
        #tab-calc .nav-button:disabled { background-color: #333; color: #666; cursor: default; opacity: 0.5; }
        #tab-calc .form-horizontal-row { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px; }
        #tab-calc .form-section { display: block; padding: 15px; border: 1px solid #444; border-radius: 5px; }
        #tab-calc .form-section legend { font-weight: bold; color: #98fb98; padding: 0 5px; }
        #tab-calc .form-type .form-group { display: flex; gap: 25px; }
        #tab-calc .form-conditions { flex-grow: 1; }
        #tab-calc .conditions-wrapper { display: flex; flex-wrap: wrap; gap: 5px 10px; }
        #tab-calc .form-group label { display: inline-flex; align-items: center; gap: 5px; cursor: pointer; }
        #tab-calc .result-area {
            background-color: #2a2a2a; padding: 15px; border-radius: 5px;
            border: 1px dashed #777; display: flex; justify-content: space-between; align-items: center; gap: 20px;
        }
        #tab-calc .result-details { flex-grow: 1; }
        #tab-calc .result-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #tab-calc .result-table td { padding: 8px; text-align: left; vertical-align: middle; border-bottom: 1px solid #3a3a3a; }
        #tab-calc .result-table tr:last-child td { border-bottom: none; }
        #tab-calc .col-heading { width: 7%; } #tab-calc .col-armor { width: 33%; }
        #tab-calc .col-ability { width: 37%; } #tab-calc .col-value { width: 23%; }
        #tab-calc .data-label { display: inline-block; text-align: right; margin-right: 8px; color: #a0a0a0; }
        #tab-calc .heading-text { color: #c0c0ff; font-weight: bold; }
        #tab-calc .armor-text { color: #98fb98; } #tab-calc .ability-text { color: #ccc; }
        #tab-calc .value-text { color: #ffd700; font-weight: bold; }
        #tab-calc .total-container { padding-left: 20px; border-left: 1px solid #555; white-space: nowrap; text-align: right; }
        #tab-calc .total-container .total-row { display: flex; justify-content: space-between; align-items: baseline; gap: 15px; }
        #tab-calc .total-container .label { font-size: 16px; color: #a0a0a0; }
        #tab-calc .total-container .value { font-weight: bold; font-size: 24px; color: #ffd700; }
        #tab-calc .total-container .final-total .label, #tab-calc .total-container .final-total .value { color: red; }
        #tab-calc .global-controls { text-align: center; margin-top: 20px; }
        #calculate-all-button {
            background-color: #f0506e; color: #fff; border: none; padding: 15px 30px;
            border-radius: 8px; cursor: pointer; font-size: 20px; font-weight: bold;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }
        #calculate-all-button:hover:not(:disabled) { background-color: #c8405a; }
        #calculate-all-button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #tab-calc footer { border-top: 1px solid #eee; padding-top: 10px; font-size: 12pt; margin-top: 40px; }
        .styled-form-group { display: flex; align-items: center; flex-wrap: wrap; gap: 5px 10px; }
        .styled-form-group input[type="radio"], .styled-form-group input[type="checkbox"] { display: none; }
        .styled-form-group label {
            padding: 5px 15px; border: 1px solid #777; border-radius: 20px; cursor: pointer;
            background-color: #555; color: white; transition: all 0.2s; margin: 0; user-select: none;
        }
        .styled-form-group input[type="radio"]:checked + label, .styled-form-group input[type="checkbox"]:checked + label {
            background-color: #007bff; color: white; border-color: #007bff;
        }
        #tab-calc .form-type .styled-form-group { flex-wrap: nowrap; }
        .styled-form-group input[value="HPæº€ã‚¿ãƒ³æ™‚"]:checked + label,
        .styled-form-group input[value="ç€•æ­»æ™‚"]:checked + label,
        .styled-form-group input[value="ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼"]:checked + label { background-color: forestgreen; border-color: forestgreen; }
        .styled-form-group input[value="ç†±"]:checked + label { background-color: red; border-color: red; }
        .styled-form-group input[value="å†·"]:checked + label { background-color: dodgerblue; border-color: dodgerblue; }
        .styled-form-group input[value="é›·"]:checked + label { background-color: darkorange; border-color: darkorange; }
        .styled-form-group input[value="é™½"]:checked + label { background-color: orangered; border-color: orangered; }
        .styled-form-group input[value="é™°"]:checked + label { background-color: darkorchid; border-color: darkorchid; }
        
        @media (max-width: 992px) {
            #tab-calc .result-table tr { display: block; padding: 10px 0; border-bottom: 1px solid #3a3a3a; }
            #tab-calc .result-table tr:last-child { border-bottom: none; padding-bottom: 0; }
            #tab-calc .result-table td { display: block; width: 100%; border-bottom: none; padding: 5px 0; }
            #tab-calc .col-heading, #tab-calc .col-armor, #tab-calc .col-ability, #tab-calc .col-value { width: auto; }
            #tab-calc .data-label { width: 90px; }
        }
        @media (max-width: 768px) {
            #tab-calc .result-area { flex-direction: column; align-items: stretch; }
            #tab-calc .total-container {
                border-left: none; border-top: 1px solid #555;
                padding-left: 0; padding-top: 15px; margin-top: 15px; text-align: right;
            }
            #tab-calc .total-container .total-row { justify-content: flex-end; }
        }
        
        @media (max-width: 480px) {
            h1 {
                display: block;
            }

            .armor-part { padding-left: 40px; padding-right: 20px; }
            .search-panel-info, .sort-panel-info { font-size: 0.8em; }
            .form-section { grid-template-columns: 65px 1fr; }
            .custom-dropdown, #tab-list select { min-width: 0; }
            #tab-calc .form-horizontal-row { flex-direction: column; align-items: stretch; }
            #tab-calc .form-type .styled-form-group { flex-wrap: wrap; }
        }

        /* â–¼â–¼â–¼ Firebaseãƒ­ã‚°ã‚¤ãƒ³ãƒ»ã‚¯ãƒ©ã‚¦ãƒ‰ç”¨UIã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
        .cloud-ui-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 10px;
            border-left: 1px solid #555;
        }

        .user-icon-small {
            width: 36px; /* 36pxã«å¤‰æ›´ */
            height: 36px; /* 36pxã«å¤‰æ›´ */
            border-radius: 50%;
            object-fit: cover; /* ç”»åƒã®æ­ªã¿é˜²æ­¢ */
        }
        
        .cloud-status {
            font-size: 1em;
            color: #aaa;
            white-space: nowrap;
        }
        .cloud-status.saving { color: #ffd700; } /* ä¿å­˜ä¸­: é‡‘ (æ–‡å­—éè¡¨ç¤ºåˆ¶å¾¡ã¯JSã§è¡Œã†) */
        .cloud-status.saved { color: #98fb98; } /* ä¿å­˜å®Œäº†: ç·‘ (æ–‡å­—éè¡¨ç¤ºåˆ¶å¾¡ã¯JSã§è¡Œã†) */
        .cloud-status.error { color: #ff4500; } /* ã‚¨ãƒ©ãƒ¼: èµ¤ */

        #login-btn-header {
            background-color: #dd4b39; /* Google Red */
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        #login-btn-header:hover { background-color: #c23321; }

        #logout-btn-header {
            background-color: #555;
            color: white;
            border: 1px solid #777;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        #logout-btn-header:hover { background-color: #666; }
        /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

        /* â–¼â–¼â–¼ å…è²¬äº‹é …ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ â–¼â–¼â–¼ */
        .cloud-disclaimer {
            display: none; /* JSã§åˆ¶å¾¡ */
            border-top: 1px dashed #555;
            margin-top: 15px;
            padding-top: 10px;
            font-size: 1em; /* 1emã«å¤‰æ›´ */
            color: #ff4444; /* èµ¤æ–‡å­— */
            line-height: 1.5;
        }
        /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */
        
    </style>
</head>
<body>

  <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

  <div class="side-menu" id="sideMenu">
    <div class="menu-title">ãƒªãƒ¦ãƒ‹ã®Webç‰ˆã„ã‚ã„ã‚</div>
    <a class="menu-item" href="kiokucalc.html">è¨˜æ†¶å†æˆ¦æ™‚é–“è¨ˆç®—</a><br>
    <a class="menu-item" href="kiokucalc2.html">è¨˜æ†¶å†æˆ¦å›æ•°è¨ˆç®—</a><br>
    </br>
    <a class="menu-item" href="ikuseicalc.html">è‚²æˆåŠ¹ç‡æ¯”è¼ƒãƒ„ãƒ¼ãƒ«</a><br>
    <a class="menu-item" href="raidcalc.html">ãƒ¬ã‚¤ãƒ‰å ±é…¬åŠ¹ç‡æ¯”è¼ƒãƒ„ãƒ¼ãƒ«</a><br>
    </br>
    <a class="menu-item" href="renma-armor.html">ç·´ç£¨(é˜²å…·)çµ±åˆãƒ„ãƒ¼ãƒ«</a><br>
    <span class="toggle-button" data-target="linkList3">ç·´ç£¨(é˜²å…·)å€‹åˆ¥ãƒšãƒ¼ã‚¸</span>
    <div id="linkList3">
      â”œ <a class="menu-item" href="armor-renma.html">ç·´ç£¨(é˜²å…·)ãƒªã‚¹ãƒˆ</a><br>
      â”œ <a class="menu-item" href="armor-top5.html">ç·´ç£¨(é˜²å…·)TOP5ç¢ºèª</a><br>
      â”” <a class="menu-item" href="armor-calc.html">ç·´ç£¨(é˜²å…·)è‡ªå‹•é¸å®šãƒ„ãƒ¼ãƒ«</a><br>
    </div>
    </br>
    <span class="toggle-button" data-target="linkList1">ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—ãƒã‚§ãƒƒã‚«ãƒ¼</span>
    <div id="linkList1">
      â”œ <a class="menu-item" href="checker-4gen.html">å››å…ƒåƒãƒ”ã‚¢ã‚¹ãƒã‚§ãƒƒã‚«ãƒ¼</a></br>
      â”œ <a class="menu-item" href="checker-stella.html">ã‚¹ãƒ†ãƒ©ã‚¤ãƒ¤ãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚«ãƒ¼</a></br>
      â”” <a class="menu-item" href="checker-niji.html">è™¹ç‘ ç’ƒã®è…•è¼ªãƒã‚§ãƒƒã‚«ãƒ¼</a></br>
    </div>
    <span class="toggle-button" data-target="linkList2">ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—å ±å‘Šç”¨</span>
    <div id="linkList2">
      â”œ <a class="menu-item" href="report-4gen.html">å››å…ƒåƒãƒ”ã‚¢ã‚¹å ±å‘Šç”¨</a></br>
      â”œ <a class="menu-item" href="report-stella.html">ã‚¹ãƒ†ãƒ©ã‚¤ãƒ¤ãƒªãƒ³ã‚°å ±å‘Šç”¨</a></br>
      â”” <a class="menu-item" href="report-niji.html">è™¹ç‘ ç’ƒã®è…•è¼ªå ±å‘Šç”¨</a></br>
    </div>
    </br>
    <a class="menu-item" href="expcalc.html">EXPã‚¹ã‚¿ãƒ³ãƒ—å¿…è¦æ•°è¨ˆç®—</a><br>
    <a class="menu-item" href="https://jessy-rs.github.io/Multi-Stage-Slash/">å¤šæ®µæ–¬ã‚Šã‚¢ãƒ—ãƒª</a><br>
    </br>
    <a class="menu-item"  href="armor.html">è£…å‚™å€™è£œæ¤œç´¢ãƒ„ãƒ¼ãƒ«</a><br>
    <a class="menu-item"  href="style-info.html">ã‚¹ã‚¿ã‚¤ãƒ«æƒ…å ±ãƒ“ãƒ¥ãƒ¼ã‚¢</a><br>
    <br>
    <a class="menu-item"  href="repeat.html">å‘¨å›ç·¨æˆã¾ã¨ã‚</a><br>
    <br>
    <a class="menu-item" href="index.html">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¸</a><br>
    </br>
  </div>

    <div class="main-container">
        <div class="main-header">
            <div class="zoom-buttons">
                <button onclick="changeZoom(0.1)">ï¼‹</button>
                <button onclick="changeZoom(-0.1)">ï¼</button>
            </div>
            <h1>
                <span class="hamburger" onclick="toggleMenu()">â˜°</span>
                <span id="page-title">ç·´ç£¨(é˜²å…·)ãƒªã‚¹ãƒˆç®¡ç†</span>
            </h1>
            
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('list', event)">ãƒªã‚¹ãƒˆç®¡ç†</button>
                <button class="tab-button" onclick="showTab('top5', event)">TOP5ç¢ºèª</button>
                <button class="tab-button" onclick="showTab('calc', event)">è‡ªå‹•é¸å®šãƒ„ãƒ¼ãƒ«</button>
                <span id="pin-button" class="pin-button">ğŸ“</span>
            </div>
        </div>

        <div id="tab-list" class="tab-content active">
            <header>
                <div class="header-controls">
                    <div class="left-buttons">
                        <button id="import-btn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input type="file" id="import-file-input" accept=".json">
                        <button id="export-btn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        
                        <div id="cloud-ui-container" class="cloud-ui-group" style="display: none;">
                            <button id="login-btn-header">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
                            <button id="logout-btn-header" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                            <img id="header-user-icon" src="" class="user-icon-small" style="display: none;" title="ãƒ­ã‚°ã‚¤ãƒ³ä¸­">
                            <span id="cloud-status-text" class="cloud-status"></span>
                        </div>
                        </div>
                    <div class="right-buttons">
                        <button id="edit-mode-btn">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
                    </div>
                </div>
            </header>

            <main>
                <div id="search-panel" class="armor-part">
                    <div class="drag-handle" style="visibility: hidden;">â˜°</div>
                    <div class="favorite-toggle" data-favorite="false">â˜†</div>
                    <div class="part-content">
                        <div class="form-section">
                            <span class="group-label">é˜²å…·ç¨®åˆ¥:</span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="search-type-main" name="search-armor-type" value="main"><label for="search-type-main">ä¸»é˜²å…·</label>
                                    <input type="radio" id="search-type-sub" name="search-armor-type" value="sub"><label for="search-type-sub">å‰¯é˜²å…·</label>
                                </div>
                                <div class="custom-dropdown armor-name-dropdown">
                                    <button class="custom-dropdown-button" data-value=""><span class="button-label">é˜²å…·ã‚’é¸æŠ</span><span class="button-arrow"></span></button>
                                    <div class="custom-dropdown-panel">
                                        <input type="text" class="dropdown-search-input" placeholder="æ¤œç´¢...">
                                        <div class="dropdown-options-list"></div>
                                    </div>
                                    <div class="custom-dropdown-submenu"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">ç·´ç£¨ã‚¢ãƒ“:</span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="search-grade-ss" name="search-ability-grade" value="SS"><label for="search-grade-ss">SS</label>
                                    <input type="radio" id="search-grade-s" name="search-ability-grade" value="S"><label for="search-grade-s">S</label>
                                    <input type="radio" id="search-grade-a" name="search-ability-grade" value="A"><label for="search-grade-a">A</label>
                                </div>
                                <select class="ability-select"><option value="">ã‚¢ãƒ“ãƒªãƒ†ã‚£ã‚’é¸æŠ</option></select>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="approx-search-check">
                                    <label for="approx-search-check">è¿‘ä¼¼</label>
                                </div>
                            </span>
                            <div class="controls-wrapper">
                                <button id="filter-btn">çµã‚Šè¾¼ã¿</button>
                            </div>
                        </div>
                    </div>
                    <div class="search-panel-info">ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¤œç´¢ãƒ‘ãƒãƒ«ã‚’é–‹ã</div>
                    <button class="toggle-collapse-btn">â–¼</button>
                    <div id="search-value-sort" class="value-sort-btn" title="åŠ¹æœå€¤ã§ä¸¦ã³æ›¿ãˆ">9â†“</div>
                </div>
                
                <div id="sort-panel" class="armor-part" style="display: none;">
                    <div class="drag-handle" style="visibility: hidden;">â˜°</div>
                    <div class="favorite-toggle" data-favorite="false">â˜†</div>
                    <div class="part-content">
                        <div class="form-section">
                            <span class="group-label">
                                <div class="sort-checkbox-group">
                                <input type="checkbox" id="sort-type-asc"><label for="sort-type-asc">æ˜‡é †</label>
                                </div>
                            </span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="sort-type-main" name="sort-armor-type" value="main"><label for="sort-type-main">ä¸»é˜²å…·</label>
                                    <input type="radio" id="sort-type-sub" name="sort-armor-type" value="sub"><label for="sort-type-sub">å‰¯é˜²å…·</label>
                                </div>
                                <div class="custom-dropdown armor-name-dropdown">
                                    <button class="custom-dropdown-button" data-value=""><span class="button-label">é˜²å…·ã‚’é¸æŠ</span><span class="button-arrow"></span></button>
                                    <div class="custom-dropdown-panel">
                                        <input type="text" class="dropdown-search-input" placeholder="æ¤œç´¢...">
                                        <div class="dropdown-options-list"></div>
                                    </div>
                                    <div class="custom-dropdown-submenu"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">
                                <div class="sort-checkbox-group">
                                <input type="checkbox" id="sort-ability-asc"><label for="sort-ability-asc">æ˜‡é †</label>
                                </div>
                            </span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="sort-grade-ss" name="sort-ability-grade" value="SS"><label for="sort-grade-ss">SS</label>
                                    <input type="radio" id="sort-grade-s" name="sort-ability-grade" value="S"><label for="sort-grade-s">S</label>
                                    <input type="radio" id="sort-grade-a" name="sort-ability-grade" value="A"><label for="sort-grade-a">A</label>
                                </div>
                                <select class="ability-select"><option value="">ã‚¢ãƒ“ãƒªãƒ†ã‚£ã‚’é¸æŠ</option></select>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">
                                <div class="sort-checkbox-group">
                                    <input type="checkbox" id="save-sort-check">
                                    <label for="save-sort-check">ä¿å­˜</label>
                                </div>
                            </span>
                            <div class="controls-wrapper">
                                <button id="sort-btn">ä¸¦ã³æ›¿ãˆ</button>
                            </div>
                        </div>
                    </div>
                    <div class="sort-panel-info">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¸¦ã³æ›¿ãˆãƒ‘ãƒãƒ«ã‚’é–‹ã</div>
                    <button class="toggle-collapse-btn">â–¼</button>
                    <div id="sort-value-sort" class="value-sort-btn" title="åŠ¹æœå€¤ã§ä¸¦ã³æ›¿ãˆ">9â†“</div>
                </div>
                <div id="parts-container"></div>
            </main>

            <template id="armor-part-template">
                <div class="armor-part" draggable="false">
                    <div class="drag-handle">â˜°</div>
                    <div class="favorite-toggle" data-favorite="false">â˜†</div>
                    <div class="part-content">
                        <div class="form-section">
                            <span class="group-label">é˜²å…·ç¨®åˆ¥:</span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="armor-main" name="armor-type" value="main" checked><label for="armor-main">ä¸»é˜²å…·</label>
                                    <input type="radio" id="armor-sub" name="armor-type" value="sub"><label for="armor-sub">å‰¯é˜²å…·</label>
                                </div>
                                <div class="custom-dropdown armor-name-dropdown">
                                    <button class="custom-dropdown-button" data-value=""><span class="button-label">é˜²å…·ã‚’é¸æŠ</span><span class="button-arrow"></span></button>
                                    <div class="custom-dropdown-panel">
                                        <input type="text" class="dropdown-search-input" placeholder="æ¤œç´¢..."><div class="dropdown-options-list"></div>
                                    </div>
                                    <div class="custom-dropdown-submenu"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">ç·´ç£¨ã‚¢ãƒ“:</span>
                            <div class="controls-wrapper">
                                <div class="radio-group">
                                    <input type="radio" id="grade-ss" name="ability-grade" value="SS" checked><label for="grade-ss">SS</label>
                                    <input type="radio" id="grade-s" name="ability-grade" value="S"><label for="grade-s">S</label>
                                    <input type="radio" id="grade-a" name="ability-grade" value="A"><label for="grade-a">A</label>
                                </div>
                                <select class="ability-select"><option value="">ã‚¢ãƒ“ãƒªãƒ†ã‚£ã‚’é¸æŠ</option></select>
                            </div>
                        </div>
                        <div class="form-section">
                            <span class="group-label">åŠ¹æœå€¤:</span>
                            <div class="controls-wrapper">
                                <div class="value-input-group">
                                    <span class="symbol prefix">+</span>
                                    <input type="number" class="ability-value">
                                    <span class="symbol suffix">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="delete-btn">Ã—</button>
                    <button class="add-part-inline-btn">+</button>
                </div>
            </template>

            <footer>
                <div class="header-controls" style="margin-bottom: 20px;">
                    <div class="left-buttons">
                        <button id="import-btn-footer">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input type="file" id="import-file-input-footer" accept=".json" style="display: none;">
                        <button id="export-btn-footer">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    </div>
                    <div class="right-buttons">
                        <button id="edit-mode-btn-footer">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
                    </div>
                </div>
                <div id="footer-normal-notes">
                    â€»ä½¿ç”¨ã¯è‡ªå·±è²¬ä»»ã«ã¦ã€‚<br>
                    â€»ã‚¢ãƒ“ãƒªãƒ†ã‚£ã®è¡¨è¨˜ãŒå®Ÿéš›ã®ã‚²ãƒ¼ãƒ å†…ã®è¡¨è¨˜ã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
                    â€»æ¤œç´¢ã§æ˜ŸãŒâ˜†ã®çŠ¶æ…‹ã®å ´åˆã¯â˜…ã‚‚æ¤œç´¢å¯¾è±¡ã«å«ã¾ã‚Œã¾ã™ã€‚<br>
                    â€»æ¤œç´¢ã§é˜²å…·ç¨®åˆ¥ãŠã‚ˆã³ç·´ç£¨ã‚¢ãƒ“ã§ã€é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’å†åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å…¨é¸æŠè§£é™¤ã•ã‚Œã¾ã™ã€‚ã“ã®çŠ¶æ…‹ã§ã¯æ¤œç´¢å¯¾è±¡ã¯â€ã™ã¹ã¦â€ã«ãªã‚Šã¾ã™ã€‚<br>
                </div>
                <div id="footer-edit-notes" style="display: none;">
                    â€»ä½¿ç”¨ã¯è‡ªå·±è²¬ä»»ã«ã¦ã€‚<br>
                    â€»ã‚¢ãƒ“ãƒªãƒ†ã‚£ã®è¡¨è¨˜ãŒå®Ÿéš›ã®ã‚²ãƒ¼ãƒ å†…ã®è¡¨è¨˜ã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
                    â€»ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½ã§æ˜‡é †ã®ãƒã‚§ãƒƒã‚¯ãŒã‚ªãƒ•ã®å ´åˆã¯é™é †ã§ä¸¦ã³æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚<br>
                    â€»ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½ã§ä¿å­˜ã®ãƒã‚§ãƒƒã‚¯ãŒã‚ªãƒ•ã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦ã€ä¸¦ã³é †ãŒå¸Œæœ›ã®é †ç•ªã«ãªã£ã¦ã„ã‚Œã°ã€ä¿å­˜ã®ãƒã‚§ãƒƒã‚¯ã‚’ã‚ªãƒ³ã«ã—ã¦ã€å†ã³ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦çŠ¶æ…‹ã‚’åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚ä¸¦ã³é †ãŒå¸Œæœ›ã®é †ç•ªã«ãªã£ã¦ã„ãªã„å ´åˆã¯ã€ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ä¸€åº¦çµ‚äº†ã•ã›ã‚‹äº‹ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡ºæ¥ã¾ã™ã€‚<br>
                </div>
                <div id="cloud-disclaimer" class="cloud-disclaimer">
                    ã€å…è²¬äº‹é …ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã€‘<br>
                    â€»ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã§ã¯Google Firebaseã‚’åˆ©ç”¨ã—ã¦èªè¨¼ãŠã‚ˆã³ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚<br>
                    â€»ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸç·´ç£¨(é˜²å…·)ãƒªã‚¹ãƒˆã®ã¿ã§ã‚ã‚Šã€å€‹äººã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ã¯åé›†ã—ã¦ã„ã¾ã›ã‚“ã€‚<br>
                    â€»Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æƒ…å ±ã¯Googleå´ã§ç®¡ç†ã•ã‚Œã¦ãŠã‚Šã€å½“ãƒ„ãƒ¼ãƒ«ç®¡ç†è€…ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                </div>
                </footer>
            <div class="bottom-links">
                <a href="#">â–²TOPã¸æˆ»ã‚‹</a>ã€€<a href="index.html">â– INDEXã¸æˆ»ã‚‹</a><br>
                <span id="toggle-max-value" style="cursor: pointer; color: dodgerblue; text-decoration: underline;">â–¼æœ€å¤§å€¤ç¢ºèª</span>
            </div>
            <div class="container" style="display: none;">
                <div class="ability-section ss-ability">
                    <h2>SSã‚¢ãƒ“ãƒªãƒ†ã‚£</h2>
                    <table><colgroup><col style="width: 40%;"><col style="width: 35%;"><col style="width: 25%;"></colgroup><thead><tr><th>ç¨®é¡</th><th>åˆ†é¡</th><th>æœ€å¤§å€¤</th></tr></thead><tbody><tr class="type-keigen"><td>è»½æ¸›</td><td>å…¨</td><td>10%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>å…¨</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>å…¨</td><td>30%</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>å…¨</td><td>+50</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›/å™¨/é€Ÿ/çŸ¥</td><td>+75</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ä½“/ç²¾/æ„›/é­…</td><td>+75</td></tr></tbody></table>
                </div>
                <div class="ability-section s-ability">
                    <h2>Sã‚¢ãƒ“ãƒªãƒ†ã‚£</h2>
                    <table><colgroup><col style="width: 40%;"><col style="width: 35%;"><col style="width: 25%;"></colgroup><thead><tr><th>ç¨®é¡</th><th>åˆ†é¡</th><th>æœ€å¤§å€¤</th></tr></thead><tbody><tr class="type-keigen"><td>è»½æ¸›</td><td>æ–¬æ‰“çª</td><td>15%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>ç†±å†·é›·é™½é™°</td><td>15%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>HPæº€ã‚¿ãƒ³æ™‚</td><td>30%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>ç€•æ­»æ™‚</td><td>40%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>HPæº€ã‚¿ãƒ³æ™‚</td><td>400%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>ç€•æ­»æ™‚</td><td>600%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</td><td>600%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>HPæº€ã‚¿ãƒ³æ™‚</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>ç€•æ­»æ™‚</td><td>200%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</td><td>200%</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›/ä½“</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›/å™¨</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›/é€Ÿ</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›/çŸ¥</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›/ç²¾</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›/æ„›</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›/é­…</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ä½“/é€Ÿ</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ä½“/çŸ¥</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ä½“/ç²¾</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ä½“/æ„›</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ä½“/é­…</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>å™¨/é€Ÿ</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>å™¨/çŸ¥</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>å™¨/ç²¾</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>å™¨/æ„›</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>å™¨/é­…</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>é€Ÿ/çŸ¥</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>é€Ÿ/ç²¾</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>é€Ÿ/æ„›</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>é€Ÿ/é­…</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>çŸ¥/ç²¾</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>çŸ¥/æ„›</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>çŸ¥/é­…</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ç²¾/æ„›</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ç²¾/é­…</td><td>+100</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>æ„›/é­…</td><td>+100</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>ã™ã¹ã¦</td><td>+100</td></tr></tbody></table>
                </div>
                <div class="ability-section a-ability">
                    <h2>Aã‚¢ãƒ“ãƒªãƒ†ã‚£</h2>
                    <table><colgroup><col style="width: 40%;"><col style="width: 35%;"><col style="width: 25%;"></colgroup><thead><tr><th>ç¨®é¡</th><th>åˆ†é¡</th><th>æœ€å¤§å€¤</th></tr></thead><tbody><tr class="type-keigen"><td>è»½æ¸›</td><td>æ–¬</td><td>30%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>æ‰“</td><td>30%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>çª</td><td>30%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>ç†±</td><td>30%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>å†·</td><td>30%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>é›·</td><td>30%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>é™½</td><td>30%</td></tr><tr class="type-keigen"><td>è»½æ¸›</td><td>é™°</td><td>30%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>æ–¬</td><td>300%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>æ‰“</td><td>300%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>çª</td><td>300%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>ç†±</td><td>300%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>å†·</td><td>300%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>é›·</td><td>300%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>é™½</td><td>300%</td></tr><tr class="type-iryoku"><td>å¨åŠ›ï¼‹</td><td>é™°</td><td>300%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>æ–¬</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>æ‰“</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>çª</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>ç†±</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>å†·</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>é›·</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>é™½</td><td>100%</td></tr><tr class="type-mikata-iryoku"><td>å‘³æ–¹å¨åŠ›ï¼‹</td><td>é™°</td><td>100%</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>åŠ›</td><td>+150</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ä½“</td><td>+150</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>å™¨</td><td>+150</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>é€Ÿ</td><td>+150</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>çŸ¥</td><td>+150</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>ç²¾</td><td>+150</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>æ„›</td><td>+150</td></tr><tr class="type-nouryoku"><td>èƒ½åŠ›ï¼‹</td><td>é­…</td><td>+150</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>æ¯’</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>æš—é—‡</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>ã‚¹ã‚¿ãƒ³</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>ãƒãƒ’</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>çœ ã‚Š</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>çŸ³åŒ–</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>æ··ä¹±</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>é­…äº†</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>ç‹‚æˆ¦å£«</td><td>+250</td></tr><tr class="type-joutai-ijou"><td>çŠ¶æ…‹ç•°å¸¸è€æ€§ï¼‹</td><td>æ°—çµ¶</td><td>+250</td></tr></tbody></table>
                </div>
            </div>
            <div class="bottom-links">
                <span id="toggle-max-value-bottom" style="cursor: pointer; color: dodgerblue; text-decoration: underline; display: none;">Ã—ç¢ºèªã‚’çµ‚äº†</span>
            </div>
        </div>

        <div id="tab-top5" class="tab-content">
            <div class="top5-content-wrapper">
                <div class="controls-container">
                    <div id="top5-placeholder">
                        ã€Œãƒªã‚¹ãƒˆç®¡ç†ã€ã‚¿ãƒ–ã«ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
                    </div>
                    <div class="checkbox-container">
                        <label>
                            <input type="checkbox" id="include-unique-ability" checked>
                            è£…å‚™å›ºæœ‰ã®ã‚¢ãƒ“ãƒªãƒ†ã‚£ã‚‚åŠ å‘³ã™ã‚‹
                        </label>
                    </div>
                </div>
            
                <div class="results-grid">
                    <div class="category-container" id="main-self">
                        <h2>
                            â– å¨åŠ›ï¼‹ (ä¸»é˜²å…·)
                            <div class="nav-buttons">
                                <button class="nav-button" disabled>â–²</button>
                                <button class="nav-button" onclick="scrollToCategory('sub-self')">â–¼</button>
                            </div>
                        </h2>
                        <div class="table-wrapper"></div>
                    </div>
                    <div class="category-container" id="sub-self">
                        <h2>
                            â– å¨åŠ›ï¼‹ (å‰¯é˜²å…·)
                            <div class="nav-buttons">
                                <button class="nav-button" onclick="scrollToCategory('main-self')">â–²</button>
                                <button class="nav-button" onclick="scrollToCategory('main-party')">â–¼</button>
                            </div>
                        </h2>
                        <div class="table-wrapper"></div>
                    </div>
                    <div class="category-container" id="main-party">
                        <h2>
                            â– å‘³æ–¹å¨åŠ›ï¼‹ (ä¸»é˜²å…·)
                            <div class="nav-buttons">
                                <button class="nav-button" onclick="scrollToCategory('sub-self')">â–²</button>
                                <button class="nav-button" onclick="scrollToCategory('sub-party')">â–¼</button>
                            </div>
                        </h2>
                        <div class="table-wrapper"></div>
                    </div>
                    <div class="category-container" id="sub-party">
                        <h2>
                            â– å‘³æ–¹å¨åŠ›ï¼‹ (å‰¯é˜²å…·)
                            <div class="nav-buttons">
                                <button class="nav-button" onclick="scrollToCategory('main-party')">â–²</button>
                                <button class="nav-button" disabled>â–¼</button>
                            </div>
                        </h2>
                        <div class="table-wrapper"></div>
                    </div>
                </div>
            
                <footer>
                    <br>
                    â€»ä½¿ç”¨ã¯è‡ªå·±è²¬ä»»ã«ã¦ã€‚<br>
                    â€»åå°†ã®é§(+15)ã¨ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹(+20)ã®ã‚·ãƒªãƒ¼ã‚ºä¸€è‡´åˆ†ã¯åŠ å‘³ã•ã‚Œã¦ã„ã¾ã›ã‚“ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
                </footer>
    <div class="bottom2">
        <a href="#">â–²TOPã¸æˆ»ã‚‹</a>ã€€<a href="index.html">â– INDEXã¸æˆ»ã‚‹</a>
    </div>
              </div>
        </div>

        <div id="tab-calc" class="tab-content">
            <div class="file-input-container">
                <p id="file-status">ã€Œãƒªã‚¹ãƒˆç®¡ç†ã€ã‚¿ãƒ–ã«ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
    
            <div class="character-grid" id="character-grid">
            </div>
    
            <div class="global-controls">
                <button class="calculate-button" id="calculate-all-button" disabled>å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã¾ã¨ã‚ã¦è¨ˆç®—</button>
            </div>
            
            <footer>
                â€»ä½¿ç”¨ã¯è‡ªå·±è²¬ä»»ã«ã¦ã€‚<br>
                â€»æœ€é©ãªçµ„ã¿åˆã‚ã›ãŒé¸å®šå‡ºæ¥ãªã„å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚ã‚ãã¾ã§å‚è€ƒã¨ã—ã¦ãŠè€ƒãˆãã ã•ã„ã€‚<br>
                â€»åå°†ã®é§ã®å›ºæœ‰ã‚¢ãƒ“ãƒªãƒ†ã‚£è€ƒæ…®ã§å¨åŠ›ï¼‹é¸æŠã®ã‚­ãƒ£ãƒ©ã«ã‚·ãƒªãƒ¼ã‚ºæŒ‡å®šã—ãŸå ´åˆã¯ã€å‘³æ–¹å¨åŠ›ï¼‹é¸æŠã®ã‚­ãƒ£ãƒ©ã‚‚å¨åŠ›ï¼‹é¸æŠã®ã‚­ãƒ£ãƒ©ã¨ã‚·ãƒªãƒ¼ã‚ºãŒåŒã˜ã§ã‚ã‚‹ãªã‚‰å¿…ãšæŒ‡å®šã—ã¦ãã ã•ã„ã€‚<br>
                â€»ã‚·ãƒªãƒ¼ã‚ºã§ã€Œãã®ä»–ã€ã‚’é¸æŠã—ã¦ã‚‚ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹ã«å¯¾å¿œã™ã‚‹ã‚‚ã®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
            </footer>
    <div class="bottom3">
        <a href="#">â–²TOPã¸æˆ»ã‚‹</a>ã€€<a href="index.html">â– INDEXã¸æˆ»ã‚‹</a>
    </div>
        </div>
    </div>
<script>
    // =========================================================================
    // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨å…±é€šé–¢æ•° ==================================================
    // =========================================================================
    
    const urlParams = new URLSearchParams(window.location.search);
    const paramMode = urlParams.get('mode');
    
    const ADMIN_MODE_PERSIST_KEY = 'RenmaArmorAdminModeEnabled'; 
    const ADMIN_DATA_KEY = 'RenmaArmorAdminData'; 
    const CLOUD_MODE_KEY = 'RenmaArmorCloudMode'; 
    const CLOUD_TEMP_KEY = 'RenmaArmorCloudTemp'; // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰ç”¨ä¸€æ™‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚­ãƒ¼
    const EXPORT_STATE_KEY = 'RenmaArmorExportDirty'; // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæœªå®Œäº†çŠ¶æ…‹ã®ç¶­æŒç”¨

    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒ»ç«¶åˆå›é¿ãƒ­ã‚¸ãƒƒã‚¯
    if (paramMode === 'secret_admin_on') {
        localStorage.setItem(ADMIN_MODE_PERSIST_KEY, 'true');
        localStorage.removeItem(CLOUD_MODE_KEY); 
    } else if (paramMode === 'secret_debug_on') {
        localStorage.removeItem(ADMIN_MODE_PERSIST_KEY);
        localStorage.removeItem(CLOUD_MODE_KEY); 
    } else if (paramMode === 'secret_cloud_on') {
        localStorage.setItem(CLOUD_MODE_KEY, 'true');
        localStorage.removeItem(ADMIN_MODE_PERSIST_KEY); 
    } else if (paramMode === 'secret_cloud_off') {
        localStorage.removeItem(CLOUD_MODE_KEY);
    }

    // ç«¶åˆçŠ¶æ…‹ã®å¼·åˆ¶è§£æ±º
    if (localStorage.getItem(CLOUD_MODE_KEY) === 'true') {
        localStorage.removeItem(ADMIN_MODE_PERSIST_KEY);
    }

    const isAdminMode = (localStorage.getItem(ADMIN_MODE_PERSIST_KEY) === 'true');
    const isCloudMode = (localStorage.getItem(CLOUD_MODE_KEY) === 'true');
    const isDebugMode = (paramMode === 'secret_debug_on');

    function debugLog(...args) {
        if (isDebugMode) console.log('[DEBUG]', ...args);
    }

    if (isAdminMode) debugLog("Admin Mode Active.");
    if (isCloudMode) debugLog("Cloud Mode Active.");

    let sharedArmorData = []; 
    window.sharedArmorData = sharedArmorData; 

    let tabScrollPositions = { list: 0, top5: 0, calc: 0 };
    let isDataDirty = false;
    
    // --- CSVãƒ‡ãƒ¼ã‚¿ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let armorMainData = [], armorSubData = [], renmaAbilityData = [], allArmorData = [];
    let mainNativeAbilities = new Map();
    let subNativeAbilities = new Map();
    let uniqueAbilities = {};

    const PAGE_SETTING_KEY = 'PageSettings';
    const BACKUP_SETTINGS_KEY = 'RenmaArmorBackupSettings';
    const UNSAVED_DATA_KEY = 'RenmaArmorUnsavedData';
    let activeTab = 'list';

    let pageSettings = {
        'renma-armor_zoom1': 1.0,
        'renma-armor_zoom2': 1.0,
        'renma-armor_zoom3': 1.0,
        'renma-armor_pin': true
    };

    const tabToZoomKey = {
        list: 'renma-armor_zoom1',
        top5: 'renma-armor_zoom2',
        calc: 'renma-armor_zoom3'
    };

    function loadPageSettings() {
        try {
            const savedSettings = localStorage.getItem(PAGE_SETTING_KEY);
            if (savedSettings) pageSettings = { ...pageSettings, ...JSON.parse(savedSettings) };
        } catch (error) {
            console.error("ãƒšãƒ¼ã‚¸è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        }
    }

    function savePageSettings() {
        try {
            localStorage.setItem(PAGE_SETTING_KEY, JSON.stringify(pageSettings));
        } catch (error) {
            console.error("ãƒšãƒ¼ã‚¸è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        }
    }

    function setDataDirty(isDirty) {
        isDataDirty = isDirty;
        
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆçŠ¶æ…‹ã‚’LocalStorageã«ä¿å­˜
        if (isDirty) {
            localStorage.setItem(EXPORT_STATE_KEY, 'true');
        } else {
            localStorage.removeItem(EXPORT_STATE_KEY);
        }
        
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è­¦å‘Šè¡¨ç¤ºåˆ¶å¾¡
        const exportButtons = document.querySelectorAll('#export-btn, #export-btn-footer');
        exportButtons.forEach(button => {
            if (isDirty) {
                button.classList.add('needs-export');
                button.textContent = 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (æœªä¿å­˜)';
            } else {
                button.classList.remove('needs-export');
                button.textContent = 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
            }
        });

        syncDataFromListTab();

        // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ä¿å­˜å‡¦ç†ã®åˆ†å²
        if (isCloudMode) {
            // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ: è‡ªå‹•ä¿å­˜ãƒ•ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
            if (isDirty && window.handleAutoSave) {
                window.handleAutoSave(); 
            }
        } else {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æœªä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
            if (isDirty) {
                localStorage.setItem(UNSAVED_DATA_KEY, JSON.stringify(sharedArmorData));
                localStorage.setItem(BACKUP_SETTINGS_KEY, JSON.stringify({ hasUnsavedChanges: true }));
                if (isAdminMode) localStorage.setItem(ADMIN_DATA_KEY, JSON.stringify(sharedArmorData));
            } else {
                localStorage.removeItem(UNSAVED_DATA_KEY);
                localStorage.setItem(BACKUP_SETTINGS_KEY, JSON.stringify({ hasUnsavedChanges: false }));
                const existingWarning = document.getElementById('backup-warning');
                if (existingWarning) existingWarning.remove();
            }
        }
    }
    window.setDataDirty = setDataDirty;

    function syncDataFromListTab() {
        const partsData = [];
        document.querySelectorAll('#parts-container .armor-part').forEach(part => {
            let armorName = part.querySelector('.armor-name-dropdown .custom-dropdown-button').dataset.value;
            
            if (armorName && armorName.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹')) {
                armorName = armorName.replace('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹', 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½');
            }

            partsData.push({
                armorType: part.querySelector('input[name*="armor-type"]:checked')?.value || 'main',
                armorName: armorName,
                grade: part.querySelector('input[name*="ability-grade"]:checked')?.value || 'SS',
                abilityName: part.querySelector('.ability-select').value,
                value: part.querySelector('.ability-value').value,
                favorite: part.querySelector('.favorite-toggle').dataset.favorite === 'true'
            });
        });
        sharedArmorData = partsData;
        window.sharedArmorData = sharedArmorData;
    }
    window.syncDataFromListTab = syncDataFromListTab;

    function showTab(tabName, event) {
        const previousTabName = activeTab;
        tabScrollPositions[previousTabName] = window.scrollY;

        const clickedButton = event ? event.currentTarget : document.querySelector(`.tab-button[onclick*="showTab('${tabName}'"]`);
        if (clickedButton && clickedButton.classList.contains('active') && window.scrollY > 0) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }

        activeTab = tabName;
        const zoomKey = tabToZoomKey[activeTab];
        document.body.style.zoom = pageSettings[zoomKey];

        if (tabName === 'top5' || tabName === 'calc') {
            syncDataFromListTab();
            if (tabName === 'top5') updateTop5Tab(sharedArmorData);
            if (tabName === 'calc') updateCalcTab(sharedArmorData);
        }

        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

        document.getElementById(`tab-${tabName}`).classList.add('active');
        if (clickedButton) clickedButton.classList.add('active');
        
        const titles = {
            'list': 'ç·´ç£¨(é˜²å…·)ãƒªã‚¹ãƒˆç®¡ç†',
            'top5': 'ç·´ç£¨(é˜²å…·)ã‚¢ãƒ“ãƒªãƒ†ã‚£ TOP5',
            'calc': 'ç·´ç£¨(é˜²å…·)è‡ªå‹•é¸å®šãƒ„ãƒ¼ãƒ«'
        };
        const pageTitleEl = document.getElementById('page-title');
        pageTitleEl.innerHTML = titles[tabName];
        
        if (isAdminMode) {
            pageTitleEl.innerHTML += " <span style='color: red;'>[Admin Mode: Auto-Save ON]</span>";
        } else if (isCloudMode) {
            pageTitleEl.innerHTML += " <span style='color: dodgerblue;'>[Cloud Mode: Auto-Save ON]</span>";
        }

        const newScrollY = tabScrollPositions[tabName] || 0;
        window.scrollTo(0, newScrollY);
    }
    
    function toggleMenu() {
        document.getElementById('sideMenu').classList.toggle('open');
        document.getElementById('menuOverlay').classList.toggle('open');
    }

    function closeMenu() {
        document.getElementById('sideMenu').classList.remove('open');
        document.getElementById('menuOverlay').classList.remove('open');
    }

    function changeZoom(delta) {
        const zoomKey = tabToZoomKey[activeTab];
        let currentZoom = pageSettings[zoomKey];
        currentZoom += delta;
        currentZoom = Math.round(currentZoom * 10) / 10;
        if (currentZoom < 0.5) currentZoom = 0.5;
        if (currentZoom > 2.0) currentZoom = 2.0;
        document.body.style.zoom = currentZoom;
        pageSettings[zoomKey] = currentZoom;
        savePageSettings();
    }

    function scrollToCategory(categoryId) {
        const element = document.getElementById(categoryId);
        if (element) {
            const mainHeader = document.querySelector('.main-header');
            let headerHeight = mainHeader.classList.contains('pinned') ? mainHeader.offsetHeight : 0;
            const elementPosition = element.getBoundingClientRect().top + window.scrollY;
            window.scrollTo({ top: elementPosition - headerHeight, behavior: 'smooth' });
        }
    }

    // =========================================================================
    // === DOMContentLoaded: ãƒ¡ã‚¤ãƒ³å‡¦ç† ============================================
    // =========================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        loadPageSettings();
        await initializeCommonData();

        initializeListTab();
        initializeTop5Tab();
        initializeCalcTab();

        setupCommonUI();

        const mainHeader = document.querySelector('.main-header');
        const pinButton = document.getElementById('pin-button');
        const isPinned = pageSettings['renma-armor_pin'];
        mainHeader.classList.toggle('pinned', isPinned);
        pinButton.textContent = isPinned ? 'ğŸ“' : 'ğŸ“Œ';
        document.body.style.zoom = pageSettings[tabToZoomKey[activeTab]];
        
        const pageTitleEl = document.getElementById('page-title');
        if (isAdminMode) {
             pageTitleEl.innerHTML += " <span style='color: red;'>[Admin Mode: Auto-Save ON]</span>";
        } else if (isCloudMode) {
             pageTitleEl.innerHTML += " <span style='color: dodgerblue;'>[Cloud Mode: Auto-Save ON]</span>";
        }
    });

    async function initializeCommonData() {
        [armorMainData, armorSubData, renmaAbilityData] = await Promise.all([
            loadCSV_list('data/armor-main.csv'),
            loadCSV_list('data/armor-sub.csv'),
            loadCSV_list('data/renma-armor.csv')
        ]);
        allArmorData = [...armorMainData, ...armorSubData];

        await Promise.all([
            loadCsvData_calc('data/armor-main-ability.csv', mainNativeAbilities),
            loadCsvData_calc('data/armor-sub-ability.csv', subNativeAbilities),
            loadUniqueAbilities_top5()
        ]);
        debugLog("Common Data Initialized");
    }

    function setupCommonUI() {
        document.querySelectorAll(".toggle-button").forEach(button => {
            const targetId = button.getAttribute("data-target");
            const list = document.getElementById(targetId);
            if(list) list.style.display = "none";
            button.addEventListener("click", () => {
                list.style.display = (list.style.display === "block") ? "none" : "block";
            });
        });
        
        const pinButton = document.getElementById('pin-button');
        pinButton.addEventListener('click', () => {
            const mainHeader = document.querySelector('.main-header');
            const isPinned = mainHeader.classList.toggle('pinned');
            pinButton.textContent = isPinned ? 'ğŸ“' : 'ğŸ“Œ';
            pageSettings['renma-armor_pin'] = isPinned;
            savePageSettings();
        });

        let startX = 0;
        document.addEventListener('touchstart', e => { startX = e.changedTouches[0].screenX; }, false);
        document.addEventListener('touchend', e => {
            const diffX = e.changedTouches[0].screenX - startX;
            if (diffX > 50 && startX < 30) toggleMenu();
            else if (diffX < -50) closeMenu();
        }, false);
        
        window.addEventListener('beforeunload', (event) => {
            if (isDataDirty) event.preventDefault();
        });
    }
    
    // =========================================================================
    // === 1. ãƒªã‚¹ãƒˆã‚¿ãƒ– (renma-armor.html) ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ =============================
    // =========================================================================
    
    async function loadCSV_list(filePath) {
        try {
            const response = await fetch(filePath);
            if (!response.ok) throw new Error(`Network response was not ok`);
            const text = await response.text();
            const rows = text.trim().split(/\r\n|\n/);
            const header = rows.shift().split(',');
            return rows.map(row => {
                const values = row.split(',');
                let obj = {};
                header.forEach((key, i) => { obj[key.trim()] = values[i] ? values[i].trim() : ''; });
                
                const symbol = obj['è¨˜å·'] || ''; 
                const rawName = obj['åç§°'] || ''; 

                let baseName = rawName;
                if (baseName === 'ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹') {
                    baseName = 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½'; 
                }

                obj.symbol = symbol;
                obj.baseName = baseName;       
                obj.rawBaseName = rawName;     
                
                obj.displayName = symbol + rawName; 
                obj.åç§° = obj.displayName; 

                return obj;
            });
        } catch (error) {
            console.error(`Error loading CSV from ${filePath}:`, error);
            return [];
        }
    }
    
    function resolveArmorName(inputName) {
        if (!inputName) return "";

        let targetBaseName = null;
        let extractedSeries = "";

        if (inputName.includes('åå°†ã®é§')) {
            targetBaseName = 'åå°†ã®é§';
            const match = inputName.match(/[\(ï¼ˆ](.+)[\)ï¼‰]/);
            if (match) extractedSeries = `(${match[1]})`;
        }
        else if (inputName.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹') || inputName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½')) {
            targetBaseName = 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½'; 
            const match = inputName.match(/[\(ï¼ˆ](.+)[\)ï¼‰]/);
            if (match) extractedSeries = `(${match[1]})`;
        }

        if (targetBaseName) {
            const currentItem = allArmorData.find(item => item.baseName === targetBaseName);
            if (currentItem) {
                if (targetBaseName === 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½' && extractedSeries) {
                    return currentItem.symbol + currentItem.baseName + extractedSeries;
                } else {
                    return currentItem.symbol + currentItem.rawBaseName + extractedSeries;
                }
            }
        }

        const exactMatch = allArmorData.find(item => item.displayName === inputName);
        if (exactMatch) return exactMatch.displayName;
        
        const baseMatch = allArmorData.find(item => item.baseName === inputName);
        if (baseMatch) return baseMatch.displayName;

        const fuzzyMatch = allArmorData.find(item => item.baseName && inputName.endsWith(item.baseName));
        if (fuzzyMatch) return fuzzyMatch.displayName;

        return inputName;
    }
    window.resolveArmorName = resolveArmorName; 

    function initializeListTab() {
        let isEditMode = false, sortableInstance = null;
        let originalPartOrder = [];
        let valueSortState = 0;

        const partsContainer = document.getElementById('parts-container');
        const searchPanel = document.getElementById('search-panel');
        const sortPanel = document.getElementById('sort-panel');
        const template = document.getElementById('armor-part-template');
        
        const warlordArmorSublist = ['GBSaGa','RS1','RS2','RS3','SF1','SF2','US','ES&IS','SSG','SaGaRSï¼†ãã®ä»–','SaGaEB'];
        const vanbraceArmorSublist = ['GBSaGa','RS1','RS2','RS3','SF1','SF2','USãƒ»ESãƒ»IS','SSG','SaGaRS','SaGaEB'];

        let applyFilterFunction = () => {};
        
        const hiraganaToKatakana = (str) => str ? str.replace(/[\u3041-\u3096]/g, match => String.fromCharCode(match.charCodeAt(0) + 0x60)) : '';
        const toHalfWidthBattleVanbrace = (str) => str.replace('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹', 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½');

        function setupDropdown(part, armorType, options = {}) {
            const { addNone = false, addListOrder = false } = options;
            const dropdown = part.querySelector('.armor-name-dropdown');
            const button = dropdown.querySelector('.custom-dropdown-button');
            const label = button.querySelector('.button-label');
            const optionsList = dropdown.querySelector('.dropdown-options-list');
            const isControlPanel = part.id === 'search-panel' || part.id === 'sort-panel';

            let data = [];
            if (armorType) {
                data = (armorType === 'main' ? armorMainData : armorSubData);
            } else if (!isControlPanel) {
                data = allArmorData;
            }
            
            label.textContent = 'é˜²å…·ã‚’é¸æŠ';
            button.dataset.value = '';
            optionsList.innerHTML = '';

            if (addNone) {
                const noneOption = document.createElement('div');
                noneOption.className = 'dropdown-option';
                noneOption.textContent = 'â€»æŒ‡å®šã—ãªã„';
                noneOption.dataset.value = 'none';
                optionsList.appendChild(noneOption);
            }
            if (addListOrder) {
                const listOrderOption = document.createElement('div');
                listOrderOption.className = 'dropdown-option';
                listOrderOption.textContent = 'â€»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é †ç•ªã§ä¸¦ã³æ›¿ãˆ';
                listOrderOption.dataset.value = 'list_order';
                optionsList.appendChild(listOrderOption);
            }

            data.forEach(item => {
                if (item.åç§°) {
                    if (item.baseName === 'åå°†ã®é§' || item.baseName === 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½') {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'dropdown-option';
                        optionEl.dataset.hasSubmenu = 'true';
                        
                        const textSpan = document.createElement('span');
                        textSpan.textContent = item.displayName; 
                        
                        const arrowSpan = document.createElement('span');
                        arrowSpan.className = 'submenu-arrow';
                        arrowSpan.textContent = 'â–¶';

                        optionEl.appendChild(textSpan);
                        optionEl.appendChild(arrowSpan);
                        optionsList.appendChild(optionEl);
                    } else {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'dropdown-option';
                        optionEl.textContent = item.displayName;
                        optionEl.dataset.value = item.displayName;
                        optionsList.appendChild(optionEl);
                    }
                }
            });
        }

        function setupAbilityDropdown(part, grade, options = {}) {
            const { addNone = false, addListOrder = false } = options;
            const selectEl = part.querySelector('.ability-select');
            const isControlPanel = part.id === 'search-panel' || part.id === 'sort-panel';

            let filteredData = [];
            if (grade) {
                filteredData = renmaAbilityData.filter(item => item.ã‚°ãƒ¬ãƒ¼ãƒ‰ === grade);
            } else if (!isControlPanel) {
                filteredData = renmaAbilityData;
            }
            
            selectEl.innerHTML = isControlPanel ? '' : '<option value="">ã‚¢ãƒ“ãƒªãƒ†ã‚£ã‚’é¸æŠ</option>';
            
            if (addNone) {
                const noneOption = document.createElement('option');
                noneOption.value = 'none';
                noneOption.textContent = 'â€»æŒ‡å®šã—ãªã„';
                selectEl.appendChild(noneOption);
            }
            if (addListOrder) {
                const listOrderOption = document.createElement('option');
                listOrderOption.value = 'list_order';
                listOrderOption.textContent = 'â€»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é †ç•ªã§ä¸¦ã³æ›¿ãˆ';
                selectEl.appendChild(listOrderOption);
            }

            filteredData.forEach(item => {
                if (item.ç¨®é¡ && (!isControlPanel || item.ç¨®é¡ !== "ã‚¢ãƒ“ãƒªãƒ†ã‚£ã‚’é¸æŠ")) {
                    const optionEl = document.createElement('option');
                    optionEl.value = item.ç¨®é¡;
                    optionEl.textContent = item.ç¨®é¡;
                    selectEl.appendChild(optionEl);
                }
            });
            if (!isControlPanel) updateValueSymbol(part, '');
        }

        function updateValueSymbol(part, abilityName) {
            const prefix = part.querySelector('.symbol.prefix');
            const suffix = part.querySelector('.symbol.suffix');
            const ability = renmaAbilityData.find(item => item.ç¨®é¡ === abilityName);
            prefix.style.display = 'none';
            suffix.style.display = 'none';
            if (ability && ability.æœ€å¤§å€¤) {
                if (ability.æœ€å¤§å€¤.includes('%')) suffix.style.display = 'inline';
                else prefix.style.display = 'inline';
            }
        }
        
        function addNewPart(data = null, basePart = null, setDirty = true) { 
            const newPart = template.content.cloneNode(true).querySelector('.armor-part');
            const uniqueId = Date.now() + Math.random();
            newPart.querySelectorAll('input[type="radio"]').forEach(radio => {
                const oldId = radio.id;
                const newId = `${oldId}-${uniqueId}`;
                radio.id = newId;
                radio.name = `${radio.name}-${uniqueId}`;
                const label = newPart.querySelector(`label[for="${oldId}"]`);
                if(label) label.htmlFor = newId;
            });
            newPart.querySelector('.drag-handle').style.display = isEditMode ? 'block' : 'none';
            newPart.querySelector('.favorite-toggle').style.display = isEditMode ? 'none' : 'block';
            
            if (basePart) {
                basePart.after(newPart);
                const baseIndex = originalPartOrder.indexOf(basePart);
                if (baseIndex > -1) originalPartOrder.splice(baseIndex + 1, 0, newPart);
                else originalPartOrder = Array.from(partsContainer.children);
            } else {
                partsContainer.appendChild(newPart);
                originalPartOrder.push(newPart); 
            }

            if (data) {
                const armorTypeRadio = newPart.querySelector(`input[name*="armor-type"][value="${data.armorType}"]`);
                if (armorTypeRadio) armorTypeRadio.checked = true;
                setupDropdown(newPart, data.armorType);
                const armorBtn = newPart.querySelector('.armor-name-dropdown .custom-dropdown-button');
                
                const armorName = data.armorName || '';
                armorBtn.querySelector('.button-label').textContent = armorName || 'é˜²å…·ã‚’é¸æŠ';
                armorBtn.dataset.value = armorName;

                const gradeRadio = newPart.querySelector(`input[name*="ability-grade"][value="${data.grade}"]`);
                if (gradeRadio) gradeRadio.checked = true;
                setupAbilityDropdown(newPart, data.grade);
                newPart.querySelector('.ability-select').value = data.abilityName;
                updateValueSymbol(newPart, data.abilityName);
                newPart.querySelector('.ability-value').value = data.value;
                const favoriteToggle = newPart.querySelector('.favorite-toggle');
                if (data.favorite) {
                    favoriteToggle.textContent = 'â˜…';
                    favoriteToggle.dataset.favorite = 'true';
                    favoriteToggle.classList.add('is-favorite');
                }
            } else {
                setupDropdown(newPart, 'main');
                setupAbilityDropdown(newPart, 'SS');
            }
            
            if (setDirty) setDataDirty(true);
        }
        window.addNewPart = addNewPart; 
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const scrollY = window.scrollY;
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error("JSON is not an array.");
                    
                    if (isEditMode) toggleEditMode();
                    partsContainer.innerHTML = '';
                    
                    if (data.length === 0) {
                        addNewPart(null, null, false);
                    } else {
                        data.forEach(partData => {
                            if (partData.armorName) {
                                partData.armorName = resolveArmorName(partData.armorName);
                            }
                            addNewPart(partData, null, false);
                        });
                    }

                    originalPartOrder = Array.from(partsContainer.children);
                    syncDataFromListTab();
                    updateTop5Tab(sharedArmorData);
                    updateCalcTab(sharedArmorData);
                    
                    // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ã“ã“ã‹ã‚‰ â–¼â–¼â–¼
                    
                    // 1. ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å³æ™‚ä¿å­˜ (åŒæœŸ)
                    if (isCloudMode && window.saveToCloud) {
                        await window.saveToCloud();
                    }

                    // 2. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã¯ã€Œæœªä¿å­˜ã€ã«ã›ãšé€šå¸¸çŠ¶æ…‹ã«ã™ã‚‹
                    setDataDirty(false);

                    // â–²â–²â–² ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â–²â–²â–²

                    if (isAdminMode) {
                         localStorage.setItem(ADMIN_DATA_KEY, JSON.stringify(sharedArmorData));
                         debugLog("Imported data saved to Admin Key.");
                    }

                } catch (error) {
                    alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + error);
                    console.error(error);
                }
                window.scrollTo(0, scrollY);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        document.getElementById('tab-list').addEventListener('focusin', (e) => {
            if (e.target.classList.contains('ability-value')) e.target.select();
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.custom-dropdown-panel.show').forEach(panel => {
                    panel.classList.remove('show');
                    panel.querySelectorAll('.focused').forEach(opt => opt.classList.remove('focused'));
                    const submenu = panel.parentElement.querySelector('.custom-dropdown-submenu');
                    if (submenu) submenu.style.display = 'none';
                });
            }
        });

        document.getElementById('tab-list').addEventListener('input', (e) => {
            if(e.target.closest('.armor-part') && !e.target.closest('#search-panel') && !e.target.closest('#sort-panel')) {
                setDataDirty(true);
            }
            if (e.target.classList.contains('dropdown-search-input')) {
                const searchTerm = hiraganaToKatakana(e.target.value).toLowerCase();
                const panel = e.target.closest('.custom-dropdown-panel');
                if (panel) {
                    panel.querySelectorAll('.dropdown-option').forEach(option => {
                        const text = option.dataset.hasSubmenu ? option.querySelector('span').textContent : option.textContent;
                        option.style.display = hiraganaToKatakana(text).toLowerCase().includes(searchTerm) ? '' : 'none';
                    });
                }
            }
        });
        
        document.getElementById('tab-list').addEventListener('change', e => {
            const part = e.target.closest('.armor-part');
            if(!part) return;
            const isSearchPanel = part.id === 'search-panel';
            const isSortPanel = part.id === 'sort-panel';

            if (!isSearchPanel && !isSortPanel) setDataDirty(true);

            if(e.target.matches('.ability-select')){
                if (!isSearchPanel && !isSortPanel) updateValueSymbol(part, e.target.value);
            } else if (e.target.matches('input[name*="armor-type"]')) {
                const checkedRadio = e.target.closest('.radio-group').querySelector('input:checked');
                const options = { addNone: isSearchPanel || isSortPanel, addListOrder: isSortPanel && !!checkedRadio };
                setupDropdown(part, checkedRadio ? checkedRadio.value : null, options);
                
                const armorBtn = part.querySelector('.armor-name-dropdown .custom-dropdown-button');
                if (isSearchPanel || isSortPanel) {
                    armorBtn.dataset.value = 'none';
                    armorBtn.querySelector('.button-label').textContent = 'â€»æŒ‡å®šã—ãªã„';
                } else {
                    armorBtn.dataset.value = '';
                    armorBtn.querySelector('.button-label').textContent = 'é˜²å…·ã‚’é¸æŠ';
                }
                if (isSearchPanel && document.getElementById('filter-btn').classList.contains('is-active')) {
                    applyFilterFunction();
                }

            } else if (e.target.matches('input[name*="ability-grade"]')) {
                const checkedRadio = e.target.closest('.radio-group').querySelector('input:checked');
                const options = { addNone: isSearchPanel || isSortPanel, addListOrder: isSortPanel && !!checkedRadio };
                setupAbilityDropdown(part, checkedRadio ? checkedRadio.value : null, options);
                
                const select = part.querySelector('.ability-select');
                select.value = (isSearchPanel || isSortPanel) ? 'none' : '';
                if (isSearchPanel && document.getElementById('filter-btn').classList.contains('is-active')) {
                    applyFilterFunction();
                }
            }
        });

        document.getElementById('tab-list').addEventListener('click', (e) => {
            const target = e.target;
            const part = target.closest('.armor-part');

            if (target.matches('.favorite-toggle') && !isEditMode && !target.closest('#search-panel') && !target.closest('#sort-panel')) {
                const isFavorite = target.dataset.favorite === 'true';
                target.dataset.favorite = String(!isFavorite);
                target.textContent = isFavorite ? 'â˜†' : 'â˜…';
                target.classList.toggle('is-favorite');
                setDataDirty(true);
                return;
            }
            
            if (target.closest('.custom-dropdown-button')) {
                const button = target.closest('.custom-dropdown-button');
                const panel = button.nextElementSibling;
                const isOpening = !panel.classList.contains('show');
                
                document.querySelectorAll('.custom-dropdown-submenu').forEach(submenu => submenu.style.display = 'none');
                document.querySelectorAll('.custom-dropdown-panel.show').forEach(p => {
                    if (p !== panel) p.classList.remove('show');
                });
                
                panel.classList.toggle('show');

                if (isOpening) {
                    const searchInput = panel.querySelector('.dropdown-search-input');
                    if (searchInput) searchInput.value = '';
                    panel.querySelectorAll('.dropdown-option').forEach(opt => opt.style.display = '');
                    
                    const selectedValue = button.dataset.value;
                    if (selectedValue && selectedValue !== 'none' && selectedValue !== 'list_order') {
                        const selectedOption = Array.from(panel.querySelectorAll('.dropdown-option')).find(opt => opt.dataset.value === selectedValue || opt.textContent === selectedValue.split('(')[0]);
                        if(selectedOption) selectedOption.scrollIntoView({ block: 'nearest' });
                    }
                }
            }
            else if (target.matches('.dropdown-option') && !target.dataset.hasSubmenu) {
                const dropdown = target.closest('.custom-dropdown');
                const button = dropdown.querySelector('.custom-dropdown-button');
                const label = button.querySelector('.button-label');
                let value, text;

                if (target.dataset.parent) {
                    let parentName = target.dataset.parent; 
                    const valueText = target.textContent; 

                    if (target.dataset.value && (target.dataset.value.includes('(å…¨å¯¾è±¡)') || target.dataset.value.includes('(ã‚·ãƒªãƒ¼ã‚ºé †)'))) {
                        text = target.dataset.value;
                        value = target.dataset.value;
                    } else {
                        // çµåˆæ™‚ã«å¼·åˆ¶çš„ã«åŠè§’ã«ã™ã‚‹
                        if (parentName.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹')) {
                            parentName = toHalfWidthBattleVanbrace(parentName);
                        }
                        text = `${parentName}(${valueText})`;
                        value = text;
                    }
                } else {
                    text = target.textContent;
                    value = target.dataset.value;
                }

                if (button.dataset.value !== value) {
                    if (button.closest('.armor-part') && !button.closest('#search-panel') && !button.closest('#sort-panel')) {
                        setDataDirty(true);
                    }
                }

                label.textContent = text;
                button.dataset.value = value;
                
                dropdown.querySelector('.custom-dropdown-panel').classList.remove('show');
                const submenu = dropdown.querySelector('.custom-dropdown-submenu');
                if (submenu) submenu.style.display = 'none';
            }
            else if (part && target.matches('.add-part-inline-btn')) {
                addNewPart(null, part);
            }
            else if (part && target.matches('.delete-btn')) {
                if (document.querySelectorAll('#tab-list .armor-part .delete-btn').length > 1) {
                    const scrollY = window.scrollY;
                    part.remove();
                    const partIndex = originalPartOrder.indexOf(part);
                    if (partIndex > -1) originalPartOrder.splice(partIndex, 1);
                    setDataDirty(true);
                    window.scrollTo(0, scrollY);
                }
            }
        });

        document.getElementById('tab-list').addEventListener('mouseover', e => {
            const option = e.target.closest('.dropdown-option');
            if (!option) return;

            const panel = option.closest('.custom-dropdown-panel');
            if (!panel) return;
            const submenu = panel.parentElement.querySelector('.custom-dropdown-submenu');
            if (!submenu) return;

            if (option.dataset.hasSubmenu) {
                submenu.innerHTML = '';
                const parentText = option.querySelector('span').textContent; 
                let sublist = [];
                let formattedParentText = parentText;

                if (parentText.includes('åå°†ã®é§')) {
                    sublist = warlordArmorSublist;
                } else if (parentText.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½') || parentText.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹')) {
                    sublist = vanbraceArmorSublist;
                    formattedParentText = toHalfWidthBattleVanbrace(parentText);
                }

                const parentPart = option.closest('.armor-part');
                if (parentPart && (parentPart.id === 'search-panel' || parentPart.id === 'sort-panel')) {
                    const createOpt = (txt, val) => {
                         const d = document.createElement('div');
                         d.className = 'dropdown-option';
                         d.textContent = txt;
                         d.dataset.value = val;
                         d.dataset.parent = parentText;
                         return d;
                    };
                    submenu.appendChild(createOpt('å…¨å¯¾è±¡', `${formattedParentText}(å…¨å¯¾è±¡)`));
                    if (parentPart.id === 'sort-panel') {
                        submenu.appendChild(createOpt('ã‚·ãƒªãƒ¼ã‚ºé †', `${formattedParentText}(ã‚·ãƒªãƒ¼ã‚ºé †)`));
                    }
                }
                
                sublist.forEach(subItemText => {
                    const subOption = document.createElement('div');
                    subOption.className = 'dropdown-option';
                    subOption.textContent = subItemText; 
                    subOption.dataset.value = subItemText;
                    subOption.dataset.parent = parentText;
                    submenu.appendChild(subOption);
                });
                
                submenu.style.display = 'block';

                const listRect = panel.querySelector('.dropdown-options-list').getBoundingClientRect();
                const optionRect = option.getBoundingClientRect();
                const buffer = 5; 
                if (optionRect.bottom > listRect.bottom - buffer) {
                    panel.querySelector('.dropdown-options-list').scrollTop += (optionRect.bottom - listRect.bottom + buffer);
                }
            } else if (!e.target.closest('.custom-dropdown-submenu')) {
                submenu.style.display = 'none';
            }
        });

        async function exportData() {
            syncDataFromListTab();
            
            // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å³æ™‚ä¿å­˜
            if (isCloudMode && window.saveToCloud) {
                await window.saveToCloud();
            }

            const jsonString = JSON.stringify(sharedArmorData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ç·´ç£¨_é˜²å…·_ãƒªã‚¹ãƒˆ.json';
            a.click();
            URL.revokeObjectURL(a.href);
            
            // ã©ã®ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã‚‰ã€Œæœªä¿å­˜ã€ãƒ•ãƒ©ã‚°ï¼ˆãƒœã‚¿ãƒ³ã®è­¦å‘Šï¼‰ã‚’æ¶ˆã™
            setDataDirty(false);
        }

        function setupRadioDeselection(panel) {
            panel.querySelectorAll('.radio-group').forEach(group => {
                if (group.dataset.radioToggleHandler) return;
                group.dataset.radioToggleHandler = 'true';
                let wasCheckedOnMousedown = false;
                group.addEventListener('mousedown', e => {
                    const el = e.target;
                    if (el.tagName !== 'INPUT' && el.tagName !== 'LABEL') return;
                    const radio = el.type === 'radio' ? el : document.getElementById(el.htmlFor);
                    if (radio) wasCheckedOnMousedown = radio.checked;
                });
                group.addEventListener('click', e => {
                    const el = e.target;
                    if (el.tagName !== 'INPUT' && el.tagName !== 'LABEL') return;
                    if (wasCheckedOnMousedown) {
                        const radio = el.type === 'radio' ? el : document.getElementById(el.htmlFor);
                        if (radio) { e.preventDefault(); radio.checked = false; radio.dispatchEvent(new Event('change', { bubbles: true })); }
                    }
                });
            });
        }
        
        function setupSearchPanel() {
            const filterBtn = document.getElementById('filter-btn');
            const collapseBtn = searchPanel.querySelector('.toggle-collapse-btn');
            const content = searchPanel.querySelector('.part-content');
            const infoText = searchPanel.querySelector('.search-panel-info');
            const approxCheck = document.getElementById('approx-search-check');

            searchPanel.querySelectorAll('input[type=radio]').forEach(radio => radio.checked = false);
            approxCheck.checked = false;
            
            function deactivateFilter() {
                if (filterBtn.classList.contains('is-active')) {
                    const scrollY = window.scrollY;
                    originalPartOrder.forEach(part => partsContainer.appendChild(part));
                    document.querySelectorAll('#parts-container .armor-part').forEach(part => part.style.display = '');
                    filterBtn.textContent = 'çµã‚Šè¾¼ã¿';
                    filterBtn.classList.remove('is-active');
                    updateInfoText();
                    resetValueSortButtons();
                    window.scrollTo(0, scrollY);
                }
            }
            window.deactivateFilter = deactivateFilter;

            function applyFilter() {
                const scrollY = window.scrollY;
                const checkedArmorTypeRadio = searchPanel.querySelector('input[name="search-armor-type"]:checked');
                const filterArmorType = checkedArmorTypeRadio ? checkedArmorTypeRadio.value : null;
                const armorDropdown = searchPanel.querySelector('.armor-name-dropdown .custom-dropdown-button');
                const filterArmorName = armorDropdown.dataset.value === 'none' ? '' : armorDropdown.dataset.value;
                const checkedGradeRadio = searchPanel.querySelector('input[name="search-ability-grade"]:checked');
                const filterGrade = checkedGradeRadio ? checkedGradeRadio.value : null;
                const abilitySelect = searchPanel.querySelector('.ability-select');
                const filterAbilityName = abilitySelect.value === 'none' ? '' : abilitySelect.value;
                const isApprox = approxCheck.checked;
                const filterFavorite = searchPanel.querySelector('.favorite-toggle').dataset.favorite === 'true';
                
                let visibleParts = [];
                originalPartOrder.forEach(part => {
                    partsContainer.appendChild(part);
                    const partArmorType = part.querySelector('input[name*="armor-type"]:checked').value;
                    const partArmorName = part.querySelector('.armor-name-dropdown .custom-dropdown-button').dataset.value;
                    const partGrade = part.querySelector('input[name*="ability-grade"]:checked').value;
                    const partAbilityName = part.querySelector('.ability-select').value;
                    const partFavorite = part.querySelector('.favorite-toggle').dataset.favorite === 'true';

                    const typeMatch = !filterArmorType || filterArmorType === partArmorType;
                    let nameMatch = false;
                    
                    if (!filterArmorName) {
                        nameMatch = true; 
                    } else if (filterArmorName.endsWith('(å…¨å¯¾è±¡)')) {
                        if (filterArmorName.includes('åå°†ã®é§')) nameMatch = partArmorName.includes('åå°†ã®é§');
                        else if (filterArmorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½')) nameMatch = partArmorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½');
                    } else {
                        const parentArmorMatch = partArmorName.match(/(.+)\((.+)\)/);
                        if (parentArmorMatch) {
                            const parentName = parentArmorMatch[1];
                            const filterParentMatch = filterArmorName.match(/(.+)\((.+)\)/);
                            if(filterParentMatch) {
                                nameMatch = filterArmorName === partArmorName; 
                            } else {
                                nameMatch = filterArmorName === parentName || filterArmorName === partArmorName;
                            }
                        } else {
                            nameMatch = filterArmorName === partArmorName;
                        }
                    }

                    const gradeMatch = !filterGrade || filterGrade === partGrade;
                    const favoriteMatch = !filterFavorite || partFavorite;
                    let abilityMatch = false;
                    if (isApprox && filterAbilityName && partAbilityName) {
                        const searchTerm = filterAbilityName.split('(')[0];
                        abilityMatch = partAbilityName.startsWith(searchTerm);
                    } else {
                        abilityMatch = (filterAbilityName === "" || filterAbilityName === partAbilityName);
                    }

                    const isVisible = typeMatch && nameMatch && gradeMatch && abilityMatch && favoriteMatch;
                    part.style.display = isVisible ? '' : 'none';
                    if (isVisible) visibleParts.push(part);
                });

                if (valueSortState > 0) {
                    visibleParts.sort((a, b) => {
                        const valA = parseFloat(a.querySelector('.ability-value').value) || 0;
                        const valB = parseFloat(b.querySelector('.ability-value').value) || 0;
                        return valueSortState === 1 ? valB - valA : valA - valB;
                    });
                    visibleParts.forEach(part => partsContainer.appendChild(part));
                }
                window.scrollTo(0, scrollY);
            }
            applyFilterFunction = applyFilter;
            
            function triggerLiveFilter() {
                if (filterBtn.classList.contains('is-active')) applyFilter();
            }

            function updateInfoText() {
                const isFilterActive = filterBtn.classList.contains('is-active');
                if (searchPanel.classList.contains('is-collapsed')) {
                    infoText.textContent = isFilterActive ? 'çµã‚Šè¾¼ã¿ä¸­...' : 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¤œç´¢ãƒ‘ãƒãƒ«ã‚’é–‹ã';
                    infoText.style.color = isFilterActive ? 'red' : '#bbb';
                    infoText.style.display = 'block';
                } else {
                    infoText.style.display = 'none';
                }
            }

            function toggleCollapse(shouldCollapse) {
                searchPanel.classList.toggle('is-collapsed', shouldCollapse);
                content.style.display = shouldCollapse ? 'none' : '';
                collapseBtn.textContent = shouldCollapse ? 'â–¼' : 'â–²';
                updateInfoText();
            }

            searchPanel.addEventListener('click', (e) => {
                const target = e.target;
                if (searchPanel.classList.contains('is-collapsed') && !target.closest('button')) toggleCollapse(false);
                else if (target.matches('.dropdown-option') && target.closest('#search-panel')) setTimeout(triggerLiveFilter, 0);
                else if (target.matches('.favorite-toggle')) {
                    const isFavorite = target.dataset.favorite === 'true';
                    target.dataset.favorite = String(!isFavorite);
                    target.textContent = isFavorite ? 'â˜†' : 'â˜…';
                    target.classList.toggle('is-favorite');
                    triggerLiveFilter();
                }
            });

            searchPanel.addEventListener('change', triggerLiveFilter);
            collapseBtn.addEventListener('click', () => toggleCollapse(!searchPanel.classList.contains('is-collapsed')));
            
            setupDropdown(searchPanel, null, { addNone: true });
            setupAbilityDropdown(searchPanel, null, { addNone: true });
            setupRadioDeselection(searchPanel);
            
            const armorBtn = searchPanel.querySelector('.armor-name-dropdown .custom-dropdown-button');
            armorBtn.dataset.value = 'none';
            armorBtn.querySelector('.button-label').textContent = 'â€»æŒ‡å®šã—ãªã„';
            searchPanel.querySelector('.ability-select').value = 'none';

            filterBtn.addEventListener('click', () => {
                const isActive = filterBtn.classList.contains('is-active');
                if(!isActive) {
                    originalPartOrder = Array.from(partsContainer.children);
                    applyFilter();
                    filterBtn.textContent = 'è§£é™¤';
                } else {
                    deactivateFilter();
                }
                filterBtn.classList.toggle('is-active', !isActive);
                updateInfoText();
            });
            toggleCollapse(true);
        }

        function setupSortPanel() {
            const collapseBtn = sortPanel.querySelector('.toggle-collapse-btn');
            const content = sortPanel.querySelector('.part-content');
            const infoText = sortPanel.querySelector('.sort-panel-info');
            const sortBtn = document.getElementById('sort-btn');
            
            function toggleCollapse(shouldCollapse) {
                sortPanel.classList.toggle('is-collapsed', shouldCollapse);
                content.style.display = shouldCollapse ? 'none' : '';
                infoText.style.display = shouldCollapse ? 'block' : 'none';
                collapseBtn.textContent = shouldCollapse ? 'â–¼' : 'â–²';
                if (sortableInstance) sortableInstance.option('disabled', !shouldCollapse);
                
                document.querySelectorAll('#parts-container .armor-part').forEach(part => {
                    const addButton = part.querySelector('.add-part-inline-btn');
                    const deleteButton = part.querySelector('.delete-btn');
                    const display = shouldCollapse ? '' : 'none';
                    if (addButton) addButton.style.display = display;
                    if (deleteButton) deleteButton.style.display = display;
                    
                    const handle = part.querySelector('.drag-handle');
                    const favorite = part.querySelector('.favorite-toggle');
                    if (shouldCollapse) {
                        handle.textContent = 'â˜°';
                        handle.style.cursor = 'grab';
                        handle.classList.remove('is-favorite');
                    } else {
                        handle.textContent = favorite.textContent;
                        handle.style.cursor = 'default';
                        handle.classList.toggle('is-favorite', favorite.dataset.favorite === 'true');
                    }
                });
            }

            sortPanel.addEventListener('click', (e) => {
                const target = e.target;
                if (sortPanel.classList.contains('is-collapsed') && !target.closest('button')) toggleCollapse(false);
                else if (target.matches('.favorite-toggle')) {
                    const isFavorite = target.dataset.favorite === 'true';
                    target.dataset.favorite = String(!isFavorite);
                    target.textContent = isFavorite ? 'â˜†' : 'â˜…';
                    target.classList.toggle('is-favorite');
                }
            });
            collapseBtn.addEventListener('click', () => toggleCollapse(!sortPanel.classList.contains('is-collapsed')));
            sortBtn.addEventListener('click', performSort);
            setupRadioDeselection(sortPanel);

            toggleCollapse(true);
            resetSortPanel();
        }

        function resetSortPanel(keepOpen = false) {
            sortPanel.querySelector('.favorite-toggle').textContent = 'â˜†';
            sortPanel.querySelector('.favorite-toggle').dataset.favorite = 'false';
            sortPanel.querySelector('.favorite-toggle').classList.remove('is-favorite');
            document.getElementById('sort-type-asc').checked = true;
            document.getElementById('sort-ability-asc').checked = true;
            document.getElementById('save-sort-check').checked = false;
            sortPanel.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
            
            setupDropdown(sortPanel, null, { addNone: true, addListOrder: false });
            setupAbilityDropdown(sortPanel, null, { addNone: true, addListOrder: false });

            const armorBtn = sortPanel.querySelector('.armor-name-dropdown .custom-dropdown-button');
            armorBtn.dataset.value = 'none';
            armorBtn.querySelector('.button-label').textContent = 'â€»æŒ‡å®šã—ãªã„';
            sortPanel.querySelector('.ability-select').value = 'none';

            if (!keepOpen) {
                sortPanel.classList.add('is-collapsed');
                sortPanel.querySelector('.part-content').style.display = 'none';
                sortPanel.querySelector('.sort-panel-info').style.display = 'block';
                sortPanel.querySelector('.toggle-collapse-btn').textContent = 'â–¼';
            }
        }
        
        function performSort() {
            const scrollY = window.scrollY;
            const sortFavorite = sortPanel.querySelector('.favorite-toggle').dataset.favorite === 'true';
            
            const sortArmorTypeRadio = sortPanel.querySelector('input[name="sort-armor-type"]:checked');
            const sortArmorType = sortArmorTypeRadio ? sortArmorTypeRadio.value : null;
            const sortArmorAsc = document.getElementById('sort-type-asc').checked;
            const sortArmorName = sortPanel.querySelector('.armor-name-dropdown .custom-dropdown-button').dataset.value;

            const sortAbilityGradeRadio = sortPanel.querySelector('input[name="sort-ability-grade"]:checked');
            const sortAbilityGrade = sortAbilityGradeRadio ? sortAbilityGradeRadio.value : null;
            const sortAbilityAsc = document.getElementById('sort-ability-asc').checked;
            const sortAbilityName = sortPanel.querySelector('.ability-select').value;
            
            let parts = Array.from(partsContainer.children);
            
            parts.sort((a, b) => {
                const aData = getPartData(a);
                const bData = getPartData(b);
                
                if (sortFavorite) {
                    const aVal = aData.favorite ? 1 : 0;
                    const bVal = bData.favorite ? 1 : 0;
                    if (aVal !== bVal) return bVal - aVal;
                }

                if (sortArmorType) {
                    const direction = sortArmorAsc ? 1 : -1;
                    const aIsType = aData.armorType === sortArmorType;
                    const bIsType = bData.armorType === sortArmorType;
                    if (aIsType !== bIsType) return (aIsType ? -1 : 1) * direction;

                    if (sortArmorName && sortArmorName !== 'none') {
                        let result = 0;
                        if (sortArmorName.endsWith('(ã‚·ãƒªãƒ¼ã‚ºé †)')) {
                            const isWarlord = sortArmorName.includes('åå°†ã®é§');
                            const isVanbrace = sortArmorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½');
                            const targetStr = isWarlord ? 'åå°†ã®é§' : (isVanbrace ? 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½' : '');
                            const sublist = isWarlord ? warlordArmorSublist : vanbraceArmorSublist;

                            const aIsTarget = aData.armorName.includes(targetStr);
                            const bIsTarget = bData.armorName.includes(targetStr);

                            if (aIsTarget !== bIsTarget) {
                                result = aIsTarget ? -1 : 1;
                            } else if (aIsTarget && bIsTarget) {
                                const regex = /\(([^)]+)\)/;
                                const aMatch = aData.armorName.match(regex);
                                const bMatch = bData.armorName.match(regex);
                                const aIndex = aMatch ? sublist.indexOf(aMatch[1]) : -1;
                                const bIndex = bMatch ? sublist.indexOf(bMatch[1]) : -1;
                                result = aIndex - bIndex;
                            }
                        } else if (sortArmorName === 'list_order') {
                            const regex = /\(([^)]+)\)/;
                            const isWarlordA = aData.armorName.includes('åå°†ã®é§');
                            const isWarlordB = bData.armorName.includes('åå°†ã®é§');
                            // ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹ã¯åŠè§’ãƒ»å…¨è§’ã®ä¸¡æ–¹ã‚’è€ƒæ…®
                            const isVanbraceA = aData.armorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½') || aData.armorName.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹');
                            const isVanbraceB = bData.armorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½') || bData.armorName.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹');

                            // ä¸¡æ–¹ã¨ã‚‚åå°†ã®é§ã‚·ãƒªãƒ¼ã‚ºã®å ´åˆã®ã‚½ãƒ¼ãƒˆ
                            if (isWarlordA && isWarlordB) {
                                const aMatch = aData.armorName.match(regex);
                                const bMatch = bData.armorName.match(regex);
                                const aIdx = aMatch ? warlordArmorSublist.indexOf(aMatch[1]) : -1;
                                const bIdx = bMatch ? warlordArmorSublist.indexOf(bMatch[1]) : -1;
                                if(aIdx !== bIdx) result = aIdx - bIdx;
                            // ä¸¡æ–¹ã¨ã‚‚ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹ã‚·ãƒªãƒ¼ã‚ºã®å ´åˆã®ã‚½ãƒ¼ãƒˆ
                            } else if (isVanbraceA && isVanbraceB) {
                                const aMatch = aData.armorName.match(regex);
                                const bMatch = bData.armorName.match(regex);
                                const aIdx = aMatch ? vanbraceArmorSublist.indexOf(aMatch[1]) : -1;
                                const bIdx = bMatch ? vanbraceArmorSublist.indexOf(bMatch[1]) : -1;
                                if(aIdx !== bIdx) result = aIdx - bIdx;
                            } else {
                                // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å–å¾—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
                                const getMasterIndex = (name) => {
                                    // 1. å®Œå…¨ä¸€è‡´ã§æ¤œç´¢
                                    let idx = allArmorData.findIndex(item => item.displayName === name);
                                    if (idx !== -1) return idx;
                                    
                                    // 2. ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹ï¼ˆåŠè§’/å…¨è§’æ··åœ¨ï¼‰ã®å¯¾å¿œ
                                    // CSVèª­ã¿è¾¼ã¿æ™‚ã«baseNameã¯åŠè§’ã€Œï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½ã€ã«å¤‰æ›ã•ã‚Œã¦ã„ã¾ã™
                                    if (name.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½') || name.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹')) {
                                        return allArmorData.findIndex(item => item.baseName === 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½');
                                    }
                                    
                                    // 3. åå°†ã®é§ï¼ˆã‚·ãƒªãƒ¼ã‚ºä»˜ãï¼‰ã®å¯¾å¿œ
                                    if (name.includes('åå°†ã®é§')) {
                                        return allArmorData.findIndex(item => item.baseName === 'åå°†ã®é§');
                                    }
                                    return -1;
                                };

                                const aIndex = getMasterIndex(aData.armorName);
                                const bIndex = getMasterIndex(bData.armorName);
                                if (aIndex !== bIndex) result = aIndex - bIndex;
                            }
                        } else if (sortArmorName.endsWith('(å…¨å¯¾è±¡)')) {
                            const targetStr = sortArmorName.includes('åå°†ã®é§') ? 'åå°†ã®é§' : 'ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½';
                            const aIsTarget = aData.armorName.includes(targetStr);
                            const bIsTarget = bData.armorName.includes(targetStr);
                            if (aIsTarget !== bIsTarget) result = aIsTarget ? -1 : 1;
                        } else {
                            const aIsTarget = aData.armorName === sortArmorName;
                            const bIsTarget = bData.armorName === sortArmorName;
                            if (aIsTarget !== bIsTarget) result = aIsTarget ? -1 : 1;
                        }
                        if (result !== 0) return result * direction;
                    }
                }

                if (sortAbilityGrade) {
                    const direction = sortAbilityAsc ? 1 : -1;
                    const aIsGrade = aData.grade === sortAbilityGrade;
                    const bIsGrade = bData.grade === sortAbilityGrade;
                    if (aIsGrade !== bIsGrade) return (aIsGrade ? -1 : 1) * direction;
                    
                    if (sortAbilityName && sortAbilityName !== 'none') {
                        let result = 0;
                        if (sortAbilityName === 'list_order') {
                            const aIndex = renmaAbilityData.findIndex(item => item.ç¨®é¡ === aData.abilityName);
                            const bIndex = renmaAbilityData.findIndex(item => item.ç¨®é¡ === bData.abilityName);
                            if (aIndex !== bIndex) result = aIndex - bIndex;
                        } else {
                            const aIsTarget = aData.abilityName === sortAbilityName;
                            const bIsTarget = bData.abilityName === sortAbilityName;
                            if (aIsTarget !== bIsTarget) result = aIsTarget ? -1 : 1;
                        }
                        if (result !== 0) return result * direction;
                    }
                }
                
                if (valueSortState > 0) {
                    const valA = parseFloat(aData.value) || 0;
                    const valB = parseFloat(bData.value) || 0;
                    if (valA !== valB) return (valueSortState === 1 ? valB - valA : valA - valB);
                }
                return 0;
            });

            parts.forEach(p => partsContainer.appendChild(p));
            
            if(document.getElementById('save-sort-check').checked) {
                originalPartOrder = Array.from(partsContainer.children);
                resetSortPanel(true);
                resetValueSortButtons();
                setDataDirty(true);
            }
            window.scrollTo(0, scrollY);
        }

        function getPartData(part) {
            return {
                armorType: part.querySelector('input[name*="armor-type"]:checked')?.value,
                armorName: part.querySelector('.armor-name-dropdown .custom-dropdown-button').dataset.value,
                grade: part.querySelector('input[name*="ability-grade"]:checked')?.value,
                abilityName: part.querySelector('.ability-select').value,
                value: part.querySelector('.ability-value').value,
                favorite: part.querySelector('.favorite-toggle').dataset.favorite === 'true'
            };
        }

        function resetValueSortButtons() {
            document.querySelectorAll('#tab-list .value-sort-btn').forEach(btn => {
                btn.textContent = '9â†“';
                btn.classList.remove('active');
            });
            valueSortState = 0;
        }

        function handleValueSort(event) {
            const btn = event.currentTarget;
            valueSortState = (valueSortState + 1) % 3;
            btn.textContent = (valueSortState === 2) ? '1â†“' : '9â†“';
            btn.classList.toggle('active', valueSortState > 0);
            
            if (document.getElementById('filter-btn').classList.contains('is-active')) {
                const scrollY = window.scrollY;
                if (valueSortState === 0) applyFilterFunction();
                else {
                    const visibleParts = Array.from(partsContainer.children).filter(p => p.style.display !== 'none');
                    visibleParts.sort((a, b) => {
                        const valA = parseFloat(a.querySelector('.ability-value').value) || 0;
                        const valB = parseFloat(b.querySelector('.ability-value').value) || 0;
                        return valueSortState === 1 ? valB - valA : valA - valB;
                    });
                    visibleParts.forEach(part => partsContainer.appendChild(part));
                }
                window.scrollTo(0, scrollY);
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            if (window.deactivateFilter) window.deactivateFilter();
            searchPanel.style.display = isEditMode ? 'none' : 'block';
            sortPanel.style.display = isEditMode ? 'block' : 'none';
            document.getElementById('footer-normal-notes').style.display = isEditMode ? 'none' : 'block';
            document.getElementById('footer-edit-notes').style.display = isEditMode ? 'block' : 'none';

            if (isEditMode) {
                originalPartOrder = Array.from(partsContainer.children);
                resetSortPanel();
                resetValueSortButtons();
            } else {
                if (!document.getElementById('save-sort-check').checked) {
                    const scrollY = window.scrollY;
                    originalPartOrder.forEach(part => partsContainer.appendChild(part));
                    window.scrollTo(0, scrollY);
                }
                document.querySelectorAll('#parts-container .armor-part').forEach(part => {
                    const addButton = part.querySelector('.add-part-inline-btn');
                    const deleteButton = part.querySelector('.delete-btn');
                    if (addButton) addButton.style.display = '';
                    if (deleteButton) deleteButton.style.display = '';
                });
            }

            document.querySelectorAll('#parts-container .armor-part').forEach(part => {
                part.querySelector('.drag-handle').style.display = isEditMode ? 'block' : 'none';
                part.querySelector('.favorite-toggle').style.display = isEditMode ? 'none' : 'block';
                
                const handle = part.querySelector('.drag-handle');
                handle.textContent = 'â˜°';
                handle.classList.remove('is-favorite');
            });
            
            const allEditModeBtns = document.querySelectorAll('#edit-mode-btn, #edit-mode-btn-footer');
            allEditModeBtns.forEach(btn => {
                btn.textContent = isEditMode ? 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†' : 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹';
                btn.classList.toggle('active', isEditMode);
            });

            if (isEditMode) {
                if (!sortableInstance) {
                    sortableInstance = new Sortable(partsContainer, { 
                        animation: 150, 
                        handle: '.drag-handle',
                        onEnd: function(evt) {
                            originalPartOrder = Array.from(partsContainer.children);
                            setDataDirty(true);
                        }
                    });
                }
                sortableInstance.option('disabled', false);
            } else {
                if(sortableInstance) sortableInstance.option('disabled', true);
            }
        }

        const toggleMaxValueBtn = document.getElementById('toggle-max-value');
        const toggleMaxValueBottomBtn = document.getElementById('toggle-max-value-bottom');
        const maxValueContainer = document.querySelector('#tab-list .container');
        toggleMaxValueBtn.addEventListener('click', () => {
            const isHidden = maxValueContainer.style.display === 'none';
            maxValueContainer.style.display = isHidden ? 'grid' : 'none';
            toggleMaxValueBottomBtn.style.display = isHidden ? 'inline' : 'none';
            toggleMaxValueBtn.textContent = isHidden ? 'Ã—ç¢ºèªã‚’çµ‚äº†' : 'â–¼æœ€å¤§å€¤ç¢ºèª';
        });
        toggleMaxValueBottomBtn.addEventListener('click', () => {
            maxValueContainer.style.display = 'none';
            toggleMaxValueBottomBtn.style.display = 'none';
            toggleMaxValueBtn.textContent = 'â–¼æœ€å¤§å€¤ç¢ºèª';
        });

        function checkForUnsavedBackup() {
            // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒã‚§ãƒƒã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (isCloudMode) return;

            try {
                const settings = JSON.parse(localStorage.getItem(BACKUP_SETTINGS_KEY));
                if (settings && settings.hasUnsavedChanges) {
                    const backupData = localStorage.getItem(UNSAVED_DATA_KEY);
                    if (backupData) {
                        const warningDiv = document.createElement('div');
                        warningDiv.id = 'backup-warning';
                        warningDiv.style.cssText = 'color: red; background-color: rgb(67, 46, 46); padding: 10px; margin: 10px 0; border: 1px solid red; border-radius: 5px; text-align: center;';
                        warningDiv.innerHTML = `å‰å›ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚<button id="restore-backup-btn" style="margin-left: 15px; padding: 5px 10px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ</button><button id="delete-backup-btn" style="margin-left: 10px; padding: 5px 10px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤</button>`;
                        const mainElement = document.querySelector('#tab-list main');
                        mainElement.insertBefore(warningDiv, mainElement.firstChild);

                        document.getElementById('restore-backup-btn').addEventListener('click', () => {
                            const restoredData = JSON.parse(backupData);
                            partsContainer.innerHTML = '';
                            if (restoredData && restoredData.length > 0) {
                                restoredData.forEach(partData => {
                                    if (partData.armorName) {
                                        partData.armorName = resolveArmorName(partData.armorName);
                                    }
                                    addNewPart(partData, null, false);
                                });
                            } else {
                                addNewPart(null, null, false);
                            }
                            setDataDirty(true);
                            warningDiv.remove();
                        });
                        document.getElementById('delete-backup-btn').addEventListener('click', () => {
                            if (window.confirm('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) setDataDirty(false);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to check for unsaved backup:', error);
            }
        }

        setupSearchPanel();
        setupSortPanel();
        window.updateTop5Tab = updateTop5Tab;
        window.updateCalcTab = updateCalcTab;
        
        let loadedFromAdmin = false;
        if (isAdminMode) {
            const adminSavedData = localStorage.getItem(ADMIN_DATA_KEY);
            if (adminSavedData) {
                try {
                    const parsedData = JSON.parse(adminSavedData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        parsedData.forEach(partData => {
                            if (partData.armorName) {
                                partData.armorName = resolveArmorName(partData.armorName);
                            }
                            addNewPart(partData, null, false);
                        });
                        loadedFromAdmin = true;
                        debugLog("Loaded data from Admin Key");
                        syncDataFromListTab();
                        updateTop5Tab(sharedArmorData);
                        updateCalcTab(sharedArmorData);
                    }
                } catch (e) {
                    console.error("Admin data corrupted", e);
                }
            }
        }

        if (!loadedFromAdmin) addNewPart(null, null, false);
        originalPartOrder = Array.from(partsContainer.children);
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæœªå®Œäº†çŠ¶æ…‹ã‚’å¾©å…ƒ
        if (localStorage.getItem(EXPORT_STATE_KEY) === 'true') {
            setDataDirty(true);
        }

        document.getElementById('edit-mode-btn').addEventListener('click', toggleEditMode);
        document.getElementById('export-btn').addEventListener('click', exportData);
        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
        document.getElementById('import-file-input').addEventListener('change', importData);

        document.getElementById('edit-mode-btn-footer').addEventListener('click', toggleEditMode);
        document.getElementById('export-btn-footer').addEventListener('click', exportData);
        document.getElementById('import-btn-footer').addEventListener('click', () => document.getElementById('import-file-input-footer').click());
        document.getElementById('import-file-input-footer').addEventListener('change', importData);
        
        document.getElementById('search-value-sort').addEventListener('click', handleValueSort);
        document.getElementById('sort-value-sort').addEventListener('click', handleValueSort);

        resetValueSortButtons();
        checkForUnsavedBackup();
    }


    // =========================================================================
    // === 2. TOP5ç¢ºèªã‚¿ãƒ– (armor-top5.html) ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ==========================
    // =========================================================================
    
    async function loadUniqueAbilities_top5() {
        const files = ['data/armor-main-ability.csv', 'data/armor-sub-ability.csv'];
        const promises = files.map(file => fetch(file).then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.text();
        }));
        
        try {
            const [mainCsv, subCsv] = await Promise.all(promises);
            uniqueAbilities = parseCsvData_top5(mainCsv + "\n" + subCsv);
        } catch (error) {
            console.error("å›ºæœ‰ã‚¢ãƒ“ãƒªãƒ†ã‚£CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            alert("å›ºæœ‰ã‚¢ãƒ“ãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿(CSV)ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n'data'ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
    }

    function parseCsvData_top5(csvText) {
        const data = {};
        const attributeMap = { "æ–¬": "æ–¬", "æ‰“": "æ‰“", "çª": "çª", "ç†±": "ç†±", "å†·": "å†·", "é›·": "é›·", "é™½": "é™½", "é™°": "é™°", "å‘³æ–¹å¨åŠ›": "å‘³æ–¹å¨åŠ›", "å¨åŠ›": "å¨åŠ›" };
        const lines = csvText.split('\n').filter(line => line.trim() !== '');
        lines.forEach(line => {
            const parts = line.split(',');
            if (parts.length < 3) return;
            const armorName = parts[0].trim();
            const target = parts[1].trim();
            const value = parseInt(parts[2].trim(), 10);

            if (attributeMap[target] && !isNaN(value)) {
                if (!data[armorName]) data[armorName] = {};
                data[armorName][target] = value;
            }
        });
        return data;
    }

    function initializeTop5Tab() {
        document.getElementById('include-unique-ability').addEventListener('change', () => {
            syncDataFromListTab(); 
            updateTop5Tab(sharedArmorData);
        });
        updateTop5Tab(sharedArmorData);
    }
    
    function updateTop5Tab(data) {
        const placeholder = document.getElementById('top5-placeholder');
        try {
            const processed = processData_top5(data || []); 
            displayReport_top5(processed);
        } catch (error) {
            console.error("ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
            alert("ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + error);
        }
        
        if (!data || data.length === 0 || (data.length === 1 && !data[0].armorName)) {
            placeholder.style.display = 'block';
        } else {
            placeholder.style.display = 'none';
        }
    }

    function getTargetFromAbilityName_top5(abilityName) {
        if (abilityName.startsWith('å‘³æ–¹å¨åŠ›ï¼‹')) return "å‘³æ–¹å¨åŠ›";
        const match = abilityName.match(/\(([^)]+)\)/);
        if (!match) return null;
        const content = match[1];
        const attributes = ["æ–¬", "æ‰“", "çª", "ç†±", "å†·", "é›·", "é™½", "é™°"];
        if (attributes.includes(content)) return content;
        return null;
    }

    function processData_top5(armorData) {
        const selfPowerAbilities = ["å¨åŠ›ï¼‹(HPæº€ã‚¿ãƒ³æ™‚)", "å¨åŠ›ï¼‹(ç€•æ­»æ™‚)", "å¨åŠ›ï¼‹(ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼)", "å¨åŠ›ï¼‹(æ–¬)", "å¨åŠ›ï¼‹(æ‰“)", "å¨åŠ›ï¼‹(çª)", "å¨åŠ›ï¼‹(ç†±)", "å¨åŠ›ï¼‹(å†·)", "å¨åŠ›ï¼‹(é›·)", "å¨åŠ›ï¼‹(é™½)", "å¨åŠ›ï¼‹(é™°)"];
        const partyPowerAbilities = ["å‘³æ–¹å¨åŠ›ï¼‹(HPæº€ã‚¿ãƒ³æ™‚)", "å‘³æ–¹å¨åŠ›ï¼‹(ç€•æ­»æ™‚)", "å‘³æ–¹å¨åŠ›ï¼‹(ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼)", "å‘³æ–¹å¨åŠ›ï¼‹(æ–¬)", "å‘³æ–¹å¨åŠ›ï¼‹(æ‰“)", "å‘³æ–¹å¨åŠ›ï¼‹(çª)", "å‘³æ–¹å¨åŠ›ï¼‹(ç†±)", "å‘³æ–¹å¨åŠ›ï¼‹(å†·)", "å‘³æ–¹å¨åŠ›ï¼‹(é›·)", "å‘³æ–¹å¨åŠ›ï¼‹(é™½)", "å‘³æ–¹å¨åŠ›ï¼‹(é™°)"];
        const includeUnique = document.getElementById('include-unique-ability').checked;

        const categorizedData = { mainSelf: {}, subSelf: {}, mainParty: {}, subParty: {} };
        [...selfPowerAbilities, ...partyPowerAbilities].forEach(name => {
            Object.keys(categorizedData).forEach(cat => categorizedData[cat][name] = []);
        });

        const dataToProcess = JSON.parse(JSON.stringify(armorData));

        for (const item of dataToProcess) {
            if (!item.abilityName || !item.value) continue;
            let value = parseInt(item.value, 10);
            if (isNaN(value)) continue;

            item.isCombined = false;
            let totalAddedValue = 0;

            if (includeUnique) {
                const isSpecialArmor = item.armorName.includes("åå°†ã®é§") || item.armorName.includes("ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½") || item.armorName.includes("ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹");
                if (!isSpecialArmor) {
                    let armorBonuses = uniqueAbilities[item.armorName];
                    if (!armorBonuses) {
                        const foundKey = Object.keys(uniqueAbilities).find(k => item.armorName.endsWith(k) || k.endsWith(item.armorName));
                        if(foundKey) armorBonuses = uniqueAbilities[foundKey];
                    }

                    if (armorBonuses) {
                        const specificTarget = getTargetFromAbilityName_top5(item.abilityName);
                        if (specificTarget && armorBonuses[specificTarget]) totalAddedValue += armorBonuses[specificTarget];
                        const isSelfPower = selfPowerAbilities.includes(item.abilityName);
                        if (isSelfPower && armorBonuses['å‘³æ–¹å¨åŠ›']) totalAddedValue += armorBonuses['å‘³æ–¹å¨åŠ›'];
                        if (isSelfPower && armorBonuses['å¨åŠ›']) totalAddedValue += armorBonuses['å¨åŠ›'];
                    }
                }
            }
            
            if (totalAddedValue > 0) {
                value += totalAddedValue;
                item.isCombined = true;
                item.addedValue = totalAddedValue;
            }

            const newItem = { ...item, value };
            if (selfPowerAbilities.includes(item.abilityName)) {
                if (item.armorType === 'main') categorizedData.mainSelf[item.abilityName].push(newItem);
                else if (item.armorType === 'sub') categorizedData.subSelf[item.abilityName].push(newItem);
            } else if (partyPowerAbilities.includes(item.abilityName)) {
                if (item.armorType === 'main') categorizedData.mainParty[item.abilityName].push(newItem);
                else if (item.armorType === 'sub') categorizedData.subParty[item.abilityName].push(newItem);
            }
        }
        
        for (const category in categorizedData) {
            for (const abilityName in categorizedData[category]) {
                categorizedData[category][abilityName].sort((a, b) => b.value - a.value);
            }
        }
        return categorizedData;
    }
        
    function displayReport_top5(data) {
        const selfPowerAbilities = ["å¨åŠ›ï¼‹(HPæº€ã‚¿ãƒ³æ™‚)", "å¨åŠ›ï¼‹(ç€•æ­»æ™‚)", "å¨åŠ›ï¼‹(ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼)", "å¨åŠ›ï¼‹(æ–¬)", "å¨åŠ›ï¼‹(æ‰“)", "å¨åŠ›ï¼‹(çª)", "å¨åŠ›ï¼‹(ç†±)", "å¨åŠ›ï¼‹(å†·)", "å¨åŠ›ï¼‹(é›·)", "å¨åŠ›ï¼‹(é™½)", "å¨åŠ›ï¼‹(é™°)"];
        const partyPowerAbilities = ["å‘³æ–¹å¨åŠ›ï¼‹(HPæº€ã‚¿ãƒ³æ™‚)", "å‘³æ–¹å¨åŠ›ï¼‹(ç€•æ­»æ™‚)", "å‘³æ–¹å¨åŠ›ï¼‹(ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼)", "å‘³æ–¹å¨åŠ›ï¼‹(æ–¬)", "å‘³æ–¹å¨åŠ›ï¼‹(æ‰“)", "å‘³æ–¹å¨åŠ›ï¼‹(çª)", "å‘³æ–¹å¨åŠ›ï¼‹(ç†±)", "å‘³æ–¹å¨åŠ›ï¼‹(å†·)", "å‘³æ–¹å¨åŠ›ï¼‹(é›·)", "å‘³æ–¹å¨åŠ›ï¼‹(é™½)", "å‘³æ–¹å¨åŠ›ï¼‹(é™°)"];

        const categories = [
            { id: 'main-self', abilities: selfPowerAbilities, data: data.mainSelf },
            { id: 'sub-self', abilities: selfPowerAbilities, data: data.subSelf },
            { id: 'main-party', abilities: partyPowerAbilities, data: data.mainParty },
            { id: 'sub-party', abilities: partyPowerAbilities, data: data.subParty }
        ];
        
        categories.forEach(cat => {
            const container = document.querySelector(`#${cat.id} .table-wrapper`);
            container.innerHTML = '';
            if (!sharedArmorData || sharedArmorData.length === 0 || (sharedArmorData.length === 1 && !sharedArmorData[0].armorName)) return; 

            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th class="col-ability">ã‚¢ãƒ“ãƒªãƒ†ã‚£</th><th class="col-armor">è£…å‚™</th><th class="col-value value-col">åŠ¹æœå€¤</th></tr></thead>`;
            const tbody = table.createTBody();

            cat.abilities.forEach(abilityName => {
                const items = cat.data[abilityName] || [];
                const showTotal = abilityName.startsWith('å‘³æ–¹å¨åŠ›ï¼‹');
                
                let abilityTotal = 0;
                if (showTotal) {
                    for (let i = 0; i < 5; i++) {
                        if (items[i]) abilityTotal += items[i].value;
                    }
                }

                for (let i = 0; i < 5; i++) {
                    const item = items[i];
                    const row = tbody.insertRow();
                    
                    let firstCellHTML = '';
                    if (i === 0) {
                        firstCellHTML = `<td class="merged-ability-cell" rowspan="4">${abilityName}</td>`;
                    } else if (i === 4) {
                        firstCellHTML = showTotal ? `<td class="ability-total-cell">åˆè¨ˆ: ${abilityTotal}%</td>` : `<td class="ability-total-cell">&nbsp;</td>`;
                    }

                    let armorCellHTML = '&nbsp;', valueCellHTML = '&nbsp;', valueCellClass = 'value-col';
                    if (item) {
                        if (item.isCombined) {
                            armorCellHTML = `<span class="combined-armor-name">${item.armorName} (+${item.addedValue})</span>`;
                            valueCellClass += ' combined-value';
                        } else if (item.armorName.includes("åå°†ã®é§") || item.armorName.includes("ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½")) {
                            armorCellHTML = `<span class="special-armor-name">${item.armorName}</span>`;
                        } else {
                            armorCellHTML = item.armorName;
                        }
                        valueCellHTML = item.value + '%';
                    }
                    row.innerHTML = `${firstCellHTML}<td>${armorCellHTML}</td><td class="${valueCellClass}">${valueCellHTML}</td>`;
                }
            });
            container.appendChild(table);
        });
    }


    // =========================================================================
    // === 3. è‡ªå‹•é¸å®šãƒ„ãƒ¼ãƒ«ã‚¿ãƒ– (armor-calc.html) ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ =======================
    // =========================================================================
    
    let armorData_calc = [];

    async function loadCsvData_calc(url, targetMap) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
            const csvText = await response.text();
            const lines = csvText.trim().split('\n');
            lines.shift();

            lines.forEach(line => {
                const [name, target, valueStr] = line.split(',');
                if (name && target && valueStr) {
                    const value = parseInt(valueStr.trim(), 10);
                    if (!isNaN(value)) {
                        if (!targetMap.has(name.trim())) targetMap.set(name.trim(), []);
                        targetMap.get(name.trim()).push({ target: target.trim(), value });
                    }
                }
            });
        } catch (error) {
            console.error(`Error loading or parsing CSV from ${url}:`, error);
        }
    }

    function initializeCalcTab() {
        const characterGrid = document.getElementById('character-grid');
        const calculateAllButton = document.getElementById('calculate-all-button');

        const abilityConditions = [
            { name: "HPæº€ã‚¿ãƒ³æ™‚", value: "HPæº€ã‚¿ãƒ³æ™‚" }, { name: "ç€•æ­»æ™‚", value: "ç€•æ­»æ™‚" },
            { name: "ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼", value: "ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" }, { name: "æ–¬", value: "æ–¬" },
            { name: "æ‰“", value: "æ‰“" }, { name: "çª", value: "çª" },
            { name: "ç†±", value: "ç†±" }, { name: "å†·", value: "å†·" },
            { name: "é›·", value: "é›·" }, { name: "é™½", value: "é™½" },
            { name: "é™°", value: "é™°" }
        ];
        const seriesNames = ["æœªé¸æŠ", "GBSaGa", "RS1", "RS2", "RS3", "SF1", "SF2", "US", "ES", "IS", "SSG", "SaGaRS", "SaGaEB", "ãã®ä»–"];

        for (let i = 1; i <= 5; i++) {
            const charContainer = document.createElement('div');
            charContainer.className = 'character-container';
            charContainer.id = `char-${i}`;
            
            let checkboxesHTML = '';
            abilityConditions.forEach(cond => {
                const uniqueId = `condition-${i}-${cond.value.replace(/\s/g, '-')}`;
                checkboxesHTML += `<input type="checkbox" name="condition-${i}" value="${cond.value}" id="${uniqueId}"><label for="${uniqueId}">${cond.name}</label>`;
            });
            
            let seriesOptionsHTML = '';
            seriesNames.forEach(name => {
                seriesOptionsHTML += `<option value="${name}">${name}</option>`;
            });

            charContainer.innerHTML = `
                <h2>
                    <span>ã‚­ãƒ£ãƒ© ${i}</span>
                    <select class="series-select" id="series-select-${i}">${seriesOptionsHTML}</select>
                    <div class="nav-buttons">
                        <button class="nav-button" id="nav-up-${i}">â–²</button>
                        <button class="nav-button" id="nav-down-${i}">â–¼</button>
                    </div>
                </h2>
                <div class="form-horizontal-row">
                    <div class="form-type">
                        <fieldset class="form-section">
                            <legend>ã‚¢ãƒ“ãƒªãƒ†ã‚£</legend>
                            <div class="styled-form-group">
                                <input type="radio" name="ability-type-${i}" value="å¨åŠ›ï¼‹" id="ability-type-${i}-power" checked><label for="ability-type-${i}-power">å¨åŠ›ï¼‹</label>
                                <input type="radio" name="ability-type-${i}" value="å‘³æ–¹å¨åŠ›ï¼‹" id="ability-type-${i}-party"><label for="ability-type-${i}-party">å‘³æ–¹å¨åŠ›ï¼‹</label>
                            </div>
                        </fieldset>
                    </div>
                    <div class="form-conditions">
                        <fieldset class="form-section">
                            <legend>æ¡ä»¶ (è¤‡æ•°å¯)</legend>
                            <div class="styled-form-group conditions-wrapper">${checkboxesHTML}</div>
                        </fieldset>
                    </div>
                </div>
                <div class="result-area" id="result-area-${i}"><p>è¨ˆç®—çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p></div>
            `;

            characterGrid.appendChild(charContainer);
            
            const navUpButton = charContainer.querySelector(`#nav-up-${i}`);
            const navDownButton = charContainer.querySelector(`#nav-down-${i}`);
            if (i === 1) navUpButton.disabled = true;
            else navUpButton.addEventListener('click', () => scrollToCategory(`char-${i - 1}`));
            if (i === 5) navDownButton.disabled = true;
            else navDownButton.addEventListener('click', () => scrollToCategory(`char-${i + 1}`));

            const newRadios = charContainer.querySelectorAll(`input[name="ability-type-${i}"]`);
            newRadios.forEach(radio => radio.addEventListener('change', () => handleConditionSync(i, 'radio-change')));
            const newCheckboxes = charContainer.querySelectorAll(`input[name="condition-${i}"]`);
            newCheckboxes.forEach(checkbox => checkbox.addEventListener('change', () => handleConditionSync(i, 'checkbox-change')));
        }
        calculateAllButton.addEventListener('click', calculateAllCharacters);
    }
    
    function updateCalcTab(data) {
        armorData_calc = data.map((item, index) => ({
            ...item, 
            value: parseInt(item.value, 10),
            uniqueId: `item-${index}-${Date.now()}`
        })).filter(item => !isNaN(item.value));
        
        const fileStatus = document.getElementById('file-status');
        if (armorData_calc.length > 0 && armorData_calc[0].armorName) {
            fileStatus.textContent = `ãƒ‡ãƒ¼ã‚¿é€£æºå®Œäº†: ${armorData_calc.length}ä»¶ã®è£…å‚™ãƒ‡ãƒ¼ã‚¿ã‚’èªè­˜ã—ã¾ã—ãŸã€‚`;
            fileStatus.style.color = '#98fb98';
            document.getElementById('calculate-all-button').disabled = false;
        } else {
            fileStatus.textContent = 'ã€Œãƒªã‚¹ãƒˆç®¡ç†ã€ã‚¿ãƒ–ã«ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚';
            fileStatus.style.color = '#ffd700';
            document.getElementById('calculate-all-button').disabled = true;
        }
    }

    function handleConditionSync(charId, eventType) {
        if (charId === 2 && eventType === 'radio-change' && document.querySelector('input[name="ability-type-2"]:checked').value === 'å‘³æ–¹å¨åŠ›ï¼‹') {
            const sourceConditions = Array.from(document.querySelectorAll('input[name="condition-1"]:checked')).map(cb => cb.value);
            for (let i = 2; i <= 5; i++) {
                document.querySelector(`input[name="ability-type-${i}"][value="å‘³æ–¹å¨åŠ›ï¼‹"]`).checked = true;
                const targetCheckboxes = document.querySelectorAll(`input[name="condition-${i}"]`);
                targetCheckboxes.forEach(cb => cb.checked = sourceConditions.includes(cb.value));
            }
            document.getElementById('calculate-all-button').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return; 
        }

        const currentAbilityType = document.querySelector(`input[name="ability-type-${charId}"]:checked`).value;
        if (eventType === 'radio-change' && currentAbilityType === 'å‘³æ–¹å¨åŠ›ï¼‹') {
            let conditionsToCopy = null;
            for (let i = charId - 1; i >= 1; i--) {
                const prevAbilityType = document.querySelector(`input[name="ability-type-${i}"]:checked`).value;
                if (prevAbilityType === 'å‘³æ–¹å¨åŠ›ï¼‹') {
                    conditionsToCopy = Array.from(document.querySelectorAll(`input[name="condition-${i}"]:checked`)).map(cb => cb.value);
                    break;
                }
            }
            if (conditionsToCopy !== null) {
                const currentCheckboxes = document.querySelectorAll(`input[name="condition-${charId}"]`);
                currentCheckboxes.forEach(cb => cb.checked = conditionsToCopy.includes(cb.value));
            }
        }

        if (currentAbilityType === 'å‘³æ–¹å¨åŠ›ï¼‹') {
            const sourceConditions = Array.from(document.querySelectorAll(`input[name="condition-${charId}"]:checked`)).map(cb => cb.value);
            for (let i = charId + 1; i <= 5; i++) {
                const nextAbilityType = document.querySelector(`input[name="ability-type-${i}"]:checked`).value;
                if (nextAbilityType === 'å‘³æ–¹å¨åŠ›ï¼‹') {
                    const nextCheckboxes = document.querySelectorAll(`input[name="condition-${i}"]`);
                    nextCheckboxes.forEach(cb => cb.checked = sourceConditions.includes(cb.value));
                }
            }
        }
    }

    function getConditionFromAbilityName_calc(abilityName) {
        if (!abilityName) return null;
        const match = abilityName.match(/[\(ï¼ˆ](.*)[\)ï¼‰]/);
        return match ? match[1].trim() : null;
    }

    function getNativeAbilityValue_calc(armorName, armorType, selectedConditions, abilityType, charId) {
        const nativeAbilityMap = armorType === 'main' ? mainNativeAbilities : subNativeAbilities;
        let abilities = nativeAbilityMap.get(armorName);
        if (!abilities) {
            for (const [key, val] of nativeAbilityMap.entries()) {
                if (armorName.endsWith(key) || key.endsWith(armorName) || 
                    (armorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½') && key.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹'))) {
                    abilities = val;
                    break;
                }
            }
        }
        if (!abilities) return 0;
        
        const selectedSeries = document.getElementById(`series-select-${charId}`).value;
        let totalValue = 0;

        for (const ability of abilities) {
            let shouldAddValue = true;
            if (armorName.includes('åå°†ã®é§') || armorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½') || armorName.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹')) {
                if (selectedSeries === 'æœªé¸æŠ') {
                    shouldAddValue = false;
                } else {
                    const armorSeriesMatch = armorName.match(/\(([^)]+)\)/);
                    if (armorSeriesMatch) {
                        const armorSeriesStr = armorSeriesMatch[1];
                        if ((armorName.includes('â˜†ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½') || armorName.includes('ãƒãƒˆãƒ«ãƒ´ã‚¡ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¹')) && armorSeriesStr === 'USãƒ»ESãƒ»IS') {
                            if (!['US', 'ES', 'IS'].includes(selectedSeries)) shouldAddValue = false;
                        } else {
                            const armorSeriesList = armorSeriesStr.split(/[&ï¼†]/).map(s => s.trim());
                            if (!armorSeriesList.includes(selectedSeries)) shouldAddValue = false;
                        }
                    }
                }
            }

            if (shouldAddValue) {
                const nativeAbilityTarget = ability.target;
                if (abilityType === 'å‘³æ–¹å¨åŠ›ï¼‹') {
                    if (nativeAbilityTarget === 'å‘³æ–¹å¨åŠ›') totalValue += ability.value;
                } else {
                    const isUnconditional = nativeAbilityTarget === 'å¨åŠ›' || nativeAbilityTarget === 'å‘³æ–¹å¨åŠ›';
                    const isConditionMet = selectedConditions.includes(nativeAbilityTarget);
                    if (isUnconditional || isConditionMet) totalValue += ability.value;
                }
            }
        }
        return totalValue;
    }

    function findBestArmorWithNativeAbilities_calc(armorType, character, excludedItems, partyConfig) {
        const { abilityType, selectedConditions, charId, series } = character;
        const candidates = [];
        const availableArmor = armorData_calc.filter(item => item.armorType === armorType && !excludedItems.has(item.uniqueId));

        for (const armor of availableArmor) {
            const jsonAbilityCondition = getConditionFromAbilityName_calc(armor.abilityName);
            const jsonAbilityType = armor.abilityName.includes('å‘³æ–¹å¨åŠ›ï¼‹') ? 'å‘³æ–¹å¨åŠ›ï¼‹' : 'å¨åŠ›ï¼‹';
            let typeMatch = (abilityType === jsonAbilityType);
            if (abilityType === 'å¨åŠ›ï¼‹' && jsonAbilityType === 'å‘³æ–¹å¨åŠ›ï¼‹') typeMatch = true;

            if (typeMatch && selectedConditions.includes(jsonAbilityCondition)) {
                const jsonValue = armor.value;
                const nativeValue = getNativeAbilityValue_calc(armor.armorName, armorType, selectedConditions, abilityType, charId);
                let combinedValue;
                if (abilityType === 'å‘³æ–¹å¨åŠ›ï¼‹' && armor.armorName.includes('åå°†ã®é§') && armor.armorType === 'main') {
                    let isBeneficialToParty = false;
                    if (series !== 'æœªé¸æŠ') {
                        const armorSeriesMatch = armor.armorName.match(/\(([^)]+)\)/);
                        if (armorSeriesMatch) {
                            const armorSeries = armorSeriesMatch[1].split(/[&ï¼†]/).map(s => s.trim());
                            if (armorSeries.includes(series)) {
                                for (const member of partyConfig) {
                                    if (member.charId === charId) continue;
                                    if (member.abilityType === 'å¨åŠ›ï¼‹' && member.series === series) {
                                        isBeneficialToParty = true;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    combinedValue = isBeneficialToParty ? (jsonValue + nativeValue) : jsonValue;
                } else {
                    combinedValue = jsonValue + nativeValue;
                }
                candidates.push({ ...armor, combinedValue });
            }
        }
        if (candidates.length === 0) return { armorName: 'è©²å½“ãªã—', value: 0, abilityName: '-' };
        candidates.sort((a, b) => b.combinedValue - a.combinedValue);
        return candidates[0];
    }
    
    function runIterativeSolver_calc(partyConfig, lockedEquipment = new Map()) {
        let partyLoadout = Array(5).fill(null);
        let lastLoadoutStr = "";
        let iterations = 0;

        while (JSON.stringify(partyLoadout) !== lastLoadoutStr && iterations < 5) {
            lastLoadoutStr = JSON.stringify(partyLoadout);
            iterations++;
            const equippedThisPass = new Set();
            lockedEquipment.forEach(loadout => {
                if (loadout.mainArmor) equippedThisPass.add(loadout.mainArmor.uniqueId);
                if (loadout.subArmor) equippedThisPass.add(loadout.subArmor.uniqueId);
            });
            const nextLoadout = [];
            for (const character of partyConfig) {
                const { charId } = character;
                let mainArmor, subArmor;
                if (lockedEquipment.has(charId) && lockedEquipment.get(charId).mainArmor) mainArmor = lockedEquipment.get(charId).mainArmor;
                else mainArmor = findBestArmorWithNativeAbilities_calc('main', character, equippedThisPass, partyConfig);
                if (mainArmor.armorName !== 'è©²å½“ãªã—') equippedThisPass.add(mainArmor.uniqueId);
                
                if (lockedEquipment.has(charId) && lockedEquipment.get(charId).subArmor) subArmor = lockedEquipment.get(charId).subArmor;
                else subArmor = findBestArmorWithNativeAbilities_calc('sub', character, equippedThisPass, partyConfig);
                if (subArmor.armorName !== 'è©²å½“ãªã—') equippedThisPass.add(subArmor.uniqueId);
                
                nextLoadout[charId - 1] = { mainArmor, subArmor };
            }
            partyLoadout = nextLoadout;
        }
        return partyLoadout;
    }

    function calculateFinalResults_calc(partyLoadout, partyConfig) {
        const characterResults = [];
        for (const character of partyConfig) {
            const { charId, abilityType, selectedConditions } = character;
            const equipment = partyLoadout[charId - 1];
            if (!equipment) { 
                characterResults.push({ charId, abilityType, selectedConditions, mainArmor: {armorName: 'ã‚¨ãƒ©ãƒ¼'}, subArmor: {armorName: 'ã‚¨ãƒ©ãƒ¼'}, totals: {grand: -1}});
                continue;
            }
            const { mainArmor, subArmor } = equipment;
            mainArmor.nativeValue = getNativeAbilityValue_calc(mainArmor.armorName, 'main', selectedConditions, abilityType, charId);
            subArmor.nativeValue = getNativeAbilityValue_calc(subArmor.armorName, 'sub', selectedConditions, abilityType, charId);
            characterResults.push({ ...character, mainArmor, subArmor });
        }

        for (const receiver of characterResults) {
            const selfValue = (receiver.mainArmor.value || 0) + (receiver.subArmor.value || 0) + (receiver.mainArmor.nativeValue || 0) + (receiver.subArmor.nativeValue || 0);
            let partyValue = 0;
            for (const provider of characterResults) {
                if (receiver.charId === provider.charId) continue;
                const commonConditions = receiver.selectedConditions.filter(c => provider.selectedConditions.includes(c));
                if (commonConditions.length === 0) continue;
                let contribution = 0;
                const mainCond = getConditionFromAbilityName_calc(provider.mainArmor.abilityName);
                if (provider.mainArmor.abilityName.includes("å‘³æ–¹å¨åŠ›ï¼‹") && provider.selectedConditions.includes(mainCond)) {
                    contribution += provider.mainArmor.value;
                }
                if (mainNativeAbilities.has(provider.mainArmor.armorName) || Array.from(mainNativeAbilities.keys()).some(k => provider.mainArmor.armorName.endsWith(k))) {
                    const abilities = mainNativeAbilities.get(provider.mainArmor.armorName) || Array.from(mainNativeAbilities.entries()).find(e => provider.mainArmor.armorName.endsWith(e[0]))?.[1];
                    if (abilities && abilities.some(a => a.target === 'å‘³æ–¹å¨åŠ›')) {
                        const hasMeisho = provider.mainArmor.armorName.includes('åå°†ã®é§');
                        if (hasMeisho) {
                            let isMatch = false;
                            if (receiver.series !== 'æœªé¸æŠ' && receiver.series === provider.series) {
                                const armorSeriesMatch = provider.mainArmor.armorName.match(/\(([^)]+)\)/);
                                if (armorSeriesMatch) {
                                    const armorSeriesList = armorSeriesMatch[1].split(/[&ï¼†]/).map(s => s.trim());
                                    if (armorSeriesList.includes(receiver.series)) isMatch = true;
                                }
                            }
                            if (isMatch) contribution += provider.mainArmor.nativeValue;
                        } else {
                            contribution += provider.mainArmor.nativeValue;
                        }
                    }
                }

                const subCond = getConditionFromAbilityName_calc(provider.subArmor.abilityName);
                if (provider.subArmor.abilityName.includes("å‘³æ–¹å¨åŠ›ï¼‹") && provider.selectedConditions.includes(subCond)) {
                    contribution += provider.subArmor.value;
                }
                const subAbilities = subNativeAbilities.get(provider.subArmor.armorName) || Array.from(subNativeAbilities.entries()).find(e => provider.subArmor.armorName.endsWith(e[0]))?.[1];
                if (subAbilities && subAbilities.some(a => a.target === 'å‘³æ–¹å¨åŠ›')) {
                    contribution += provider.subArmor.nativeValue;
                }
                partyValue += contribution;
            }
            
            if (receiver.abilityType === 'å¨åŠ›ï¼‹') {
                receiver.totals = { self: selfValue, party: partyValue, grand: selfValue + partyValue };
            } else {
                const hasMeisho = receiver.mainArmor.armorName.includes('åå°†ã®é§');
                if (hasMeisho) {
                    const normalValue = (receiver.mainArmor.value || 0) + (receiver.subArmor.value || 0) + (receiver.subArmor.nativeValue || 0);
                    receiver.totals = { isMeisho: true, meishoTotal: selfValue, normalTotal: normalValue };
                } else {
                    receiver.totals = { self: selfValue };
                }
            }
        }
        return characterResults;
    }

    function calculateAllCharacters() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        const partyConfig = [];
        let primaryAttacker = null;
        for (let i = 1; i <= 5; i++) {
            const charConfig = {
                charId: i,
                abilityType: document.querySelector(`input[name="ability-type-${i}"]:checked`).value,
                selectedConditions: Array.from(document.querySelectorAll(`input[name="condition-${i}"]:checked`)).map(cb => cb.value),
                series: document.getElementById(`series-select-${i}`).value
            };
            partyConfig.push(charConfig);
            if (charConfig.abilityType === 'å¨åŠ›ï¼‹' && !primaryAttacker) primaryAttacker = charConfig;
        }

        if (!primaryAttacker) {
            const loadout = runIterativeSolver_calc(partyConfig);
            const results = calculateFinalResults_calc(loadout, partyConfig);
            results.forEach(r => displayResult_calc(r));
            return;
        }

        let bestLoadout = null;
        let bestTotal = -1;
        const attackerCandidates = [];
        const availableMainArmor = armorData_calc.filter(item => item.armorType === 'main');
        for (const armor of availableMainArmor) {
            const jsonAbilityCondition = getConditionFromAbilityName_calc(armor.abilityName);
            if (primaryAttacker.selectedConditions.includes(jsonAbilityCondition)) {
                const jsonAbilityType = armor.abilityName.includes('å‘³æ–¹å¨åŠ›ï¼‹') ? 'å‘³æ–¹å¨åŠ›ï¼‹' : 'å¨åŠ›ï¼‹';
                if (jsonAbilityType === 'å¨åŠ›ï¼‹' || jsonAbilityType === 'å‘³æ–¹å¨åŠ›ï¼‹') attackerCandidates.push(armor);
            }
        }

        const powerPlusCandidates = attackerCandidates.filter(a => !a.abilityName.includes('å‘³æ–¹å¨åŠ›ï¼‹')).map(a => ({ ...a, totalValue: a.value + getNativeAbilityValue_calc(a.armorName, 'main', primaryAttacker.selectedConditions, primaryAttacker.abilityType, primaryAttacker.charId) })).sort((a, b) => b.totalValue - a.totalValue);
        const partyBuffCandidates = attackerCandidates.filter(a => a.abilityName.includes('å‘³æ–¹å¨åŠ›ï¼‹')).map(a => ({ ...a, totalValue: a.value + getNativeAbilityValue_calc(a.armorName, 'main', primaryAttacker.selectedConditions, primaryAttacker.abilityType, primaryAttacker.charId) })).sort((a, b) => b.totalValue - a.totalValue);
        const scenariosToTest = [...powerPlusCandidates.slice(0, 2), ...partyBuffCandidates.slice(0, 3)];
        const uniqueScenarios = [...new Map(scenariosToTest.map(item => [item.armorName, item])).values()];
        uniqueScenarios.push(null); 

        for (const attackerMainArmor of uniqueScenarios) {
            const lockedEquipment = new Map();
            if (attackerMainArmor) lockedEquipment.set(primaryAttacker.charId, { mainArmor: attackerMainArmor, subArmor: null });
            const scenarioLoadout = runIterativeSolver_calc(partyConfig, lockedEquipment);
            const scenarioResults = calculateFinalResults_calc(scenarioLoadout, partyConfig);
            const scenarioAttackerResult = scenarioResults.find(r => r.charId === primaryAttacker.charId);
            
            if (scenarioAttackerResult && scenarioAttackerResult.totals && scenarioAttackerResult.totals.grand > bestTotal) {
                bestTotal = scenarioAttackerResult.totals.grand;
                bestLoadout = scenarioLoadout;
            }
        }

        if (bestLoadout) {
            const finalResults = calculateFinalResults_calc(bestLoadout, partyConfig);
            finalResults.forEach(r => displayResult_calc(r));
        } else {
            partyConfig.forEach(c => displayEmptyResult_calc(c.charId));
        }
    }
    
    function displayResult_calc(result) {
        const { charId, mainArmor, subArmor, totals } = result;
        const resultArea = document.getElementById(`result-area-${charId}`);
        
        let mainArmorNameStyle = '', subArmorNameStyle = '';
        if (!mainArmor || mainArmor.armorName === 'è©²å½“ãªã—') mainArmorNameStyle = 'style="color: red;"';
        else if (mainArmor.armorName.includes('åå°†ã®é§') || mainArmor.armorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½')) mainArmorNameStyle = 'style="color: magenta;"';
        else if (mainArmor.nativeValue > 0) mainArmorNameStyle = 'style="color: orange;"';
        
        if (!subArmor || subArmor.armorName === 'è©²å½“ãªã—') subArmorNameStyle = 'style="color: red;"';
        else if (subArmor.armorName.includes('åå°†ã®é§') || subArmor.armorName.includes('ï¾Šï¾ï¾„ï¾™ï½³ï¾ï½§ï¾ï¾Œï¾ï¾šï½²ï½½')) subArmorNameStyle = 'style="color: magenta;"';
        else if (subArmor.nativeValue > 0) subArmorNameStyle = 'style="color: orange;"';

        const mainArmorNameText = mainArmor.nativeValue > 0 && mainArmor.armorName !== 'è©²å½“ãªã—' ? `${mainArmor.armorName}(+${mainArmor.nativeValue})` : mainArmor.armorName;
        const subArmorNameText = subArmor.nativeValue > 0 && subArmor.armorName !== 'è©²å½“ãªã—' ? `${subArmor.armorName}(+${subArmor.nativeValue})` : subArmor.armorName;

        let totalHTML = '';
        if (totals.isMeisho) {
            totalHTML = `<div class="total-container"><div class="total-row"><span class="label">åå°†:</span><span class="value">${totals.meishoTotal}%</span></div><div class="total-row final-total"><span class="label">é€šå¸¸:</span><span class="value">${totals.normalTotal}%</span></div></div>`;
        } else if (totals.grand !== undefined) { 
            totalHTML = `<div class="total-container"><div class="total-row"><span class="label">è‡ªèº«:</span><span class="value">${totals.self}%</span></div><div class="total-row"><span class="label">å‘³æ–¹:</span><span class="value">${totals.party}%</span></div><div class="total-row final-total"><span class="label">åˆè¨ˆ:</span><span class="value">${totals.grand}%</span></div></div>`;
        } else { 
            totalHTML = `<div class="total-container"><div class="total-row final-total"><span class="label">åˆè¨ˆ:</span><span class="value">${totals.self}%</span></div></div>`;
        }

        resultArea.innerHTML = `
            <div class="result-details">
                <table class="result-table"><tbody>
                    <tr><td class="col-heading"><span class="heading-text">ä¸»é˜²å…·</span></td><td class="col-armor"><span class="data-label">è£…å‚™:</span><span class="armor-text" ${mainArmorNameStyle}>${mainArmorNameText || ''}</span></td><td class="col-ability"><span class="data-label">ã‚¢ãƒ“ãƒªãƒ†ã‚£:</span><span class="ability-text">${mainArmor.abilityName || '-'}</span></td><td class="col-value"><span class="data-label">åŠ¹æœå€¤:</span><span class="value-text">${mainArmor.value || 0}%</span></td></tr>
                    <tr><td class="col-heading"><span class="heading-text">å‰¯é˜²å…·</span></td><td class="col-armor"><span class="data-label">è£…å‚™:</span><span class="armor-text" ${subArmorNameStyle}>${subArmorNameText || ''}</span></td><td class="col-ability"><span class="data-label">ã‚¢ãƒ“ãƒªãƒ†ã‚£:</span><span class="ability-text">${subArmor.abilityName || '-'}</span></td><td class="col-value"><span class="data-label">åŠ¹æœå€¤:</span><span class="value-text">${subArmor.value || 0}%</span></td></tr>
                </tbody></table>
            </div>
            ${totalHTML}
        `;
    }

    function displayEmptyResult_calc(charId) {
        document.getElementById(`result-area-${charId}`).innerHTML = `<p>æ¡ä»¶ã‚’é¸æŠã—ã¦è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>`;
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } 
           from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } 
           from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // â–¼â–¼â–¼ ã”è‡ªèº«ã® firebaseConfig ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
    const firebaseConfig = {
  apiKey: "AIzaSyCEaZLuD45Zu6OKco8EHtNjfBBmTW2SPik",
  authDomain: "renmabase.firebaseapp.com",
  projectId: "renmabase",
  storageBucket: "renmabase.firebasestorage.app",
  messagingSenderId: "154320130326",
  appId: "1:154320130326:web:cb448ec515f709fcbf4037"
    };
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const isCloudMode = (localStorage.getItem('RenmaArmorCloudMode') === 'true');
    // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã§ä½¿ã†ã‚­ãƒ¼å®šç¾©
    const CLOUD_TEMP_KEY = 'RenmaArmorCloudTemp';

    if (isCloudMode) {
        document.getElementById('cloud-ui-container').style.display = 'flex';
        // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å…è²¬äº‹é …ã‚’è¡¨ç¤º
        const disclaimer = document.getElementById('cloud-disclaimer');
        if (disclaimer) disclaimer.style.display = 'block';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let autoSaveTimer = null;
        const AUTO_SAVE_DELAY = 3000;

        // UIè¦ç´ 
        const loginBtn = document.getElementById('login-btn-header');
        const logoutBtn = document.getElementById('logout-btn-header');
        const userIcon = document.getElementById('header-user-icon');
        const statusText = document.getElementById('cloud-status-text');

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ™‚
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                userIcon.src = user.photoURL || '';
                userIcon.style.display = 'block';
                userIcon.title = user.displayName;
                statusText.textContent = '';
                
                // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯ã‹ã‚‰é–‹å§‹
                await checkCloudTempData();
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                userIcon.style.display = 'none';
                statusText.textContent = '';
            }
        });

        loginBtn.onclick = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        logoutBtn.onclick = () => signOut(auth).then(() => location.reload());

        // --- è‡ªå‹•ä¿å­˜ãƒ•ãƒƒã‚¯ ---
        window.handleAutoSave = function() {
            if (!currentUser) return;
            
            // 1. å³æ™‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— (ä¿é™º: ã‚¯ãƒ©ã‚¦ãƒ‰å°‚ç”¨ã‚­ãƒ¼)
            saveToLocalBackup();
            
            // 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° (ä¿å­˜ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯éè¡¨ç¤º)
            updateStatus('saving');
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            
            // 3. 3ç§’å¾Œã«ã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡
            autoSaveTimer = setTimeout(() => {
                saveToCloud();
            }, AUTO_SAVE_DELAY);
        };

        // --- ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜å‡¦ç† ---
        async function saveToCloud() {
            if (!currentUser) return;

            try {
                if (typeof window.syncDataFromListTab === 'function') window.syncDataFromListTab();
                const dataToSave = window.sharedArmorData || [];

                await setDoc(doc(db, "users", currentUser.uid, "renma_data", "armor_list"), {
                    updatedAt: new Date(),
                    armorData: dataToSave
                });

                // ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ãŒå®Œäº†ã—ãŸã®ã§ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ç”¨ä¸€æ™‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ã¯æ¶ˆã™
                localStorage.removeItem(CLOUD_TEMP_KEY);
                updateStatus('saved');

            } catch (e) {
                console.error(e);
                updateStatus('error');
            }
        }
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.saveToCloud = saveToCloud;

        // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
        async function checkCloudTempData() {
            const tempBackup = localStorage.getItem(CLOUD_TEMP_KEY);
            
            if (tempBackup) {
                console.log("æœªå®Œäº†ã®ã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚");
                updateStatus('waiting'); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
                
                // å¾©å…ƒãƒ‘ãƒãƒ«ã‚’ç”Ÿæˆ
                const warningDiv = document.createElement('div');
                warningDiv.id = 'cloud-backup-warning';
                warningDiv.style.cssText = 'color: red; background-color: rgb(67, 46, 46); padding: 10px; margin: 10px 0; border: 1px solid red; border-radius: 5px; text-align: center;';
                
                // ãƒœã‚¿ãƒ³ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
                warningDiv.innerHTML = `å‰å›ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚<button id="cloud-restore-btn" style="margin-left: 15px; padding: 5px 10px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜</button><button id="cloud-discard-btn" style="color: #fff; background-color: #e53e3e; margin-left: 10px; padding: 5px 10px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ã®ç ´æ£„</button>`;
                
                const mainElement = document.querySelector('#tab-list main');
                mainElement.insertBefore(warningDiv, mainElement.firstChild);

                // ä¿å­˜ãƒœã‚¿ãƒ³ (æ—§å¾©å…ƒãƒœã‚¿ãƒ³)
                document.getElementById('cloud-restore-btn').addEventListener('click', () => {
                    const restoredData = JSON.parse(tempBackup);
                    applyDataToUI(restoredData);
                    warningDiv.remove();
                    // å¾©å…ƒã—ãŸã‚‰ã™ãã«ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜ã—ã¦åŒæœŸã‚’ã¨ã‚‹
                    saveToCloud();
                    // å¾©å…ƒï¼ãƒ­ãƒ¼ã‚«ãƒ«ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ã®å·®åˆ†ã‚’åŸ‹ã‚ãŸ -> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆçš„ã«ã¯Dirtyã«ã™ã¹ã
                    if (typeof window.setDataDirty === 'function') window.setDataDirty(true);
                });

                // ç ´æ£„ãƒœã‚¿ãƒ³
                document.getElementById('cloud-discard-btn').addEventListener('click', () => {
                    // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    if (window.confirm('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                        localStorage.removeItem(CLOUD_TEMP_KEY);
                        warningDiv.remove();
                        loadFromCloud();
                    }
                });

            } else {
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒãªã‘ã‚Œã°é€šå¸¸é€šã‚Šãƒ­ãƒ¼ãƒ‰
                await loadFromCloud();
            }
        }

        // --- ã‚¯ãƒ©ã‚¦ãƒ‰èª­è¾¼å‡¦ç† ---
        async function loadFromCloud() {
            if (!currentUser) return;
            updateStatus('loading');

            try {
                const docRef = doc(db, "users", currentUser.uid, "renma_data", "armor_list");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const loadedData = docSnap.data().armorData;
                    applyDataToUI(loadedData);
                    updateStatus('loaded');
                } else {
                    updateStatus('');
                }
            } catch (e) {
                console.error(e);
                alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                updateStatus('error');
            }
        }

        // UIåæ˜ ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function applyDataToUI(data) {
            const partsContainer = document.getElementById('parts-container');
            const searchPanel = document.getElementById('search-panel');
            if (searchPanel.style.display === 'none') {
                document.getElementById('edit-mode-btn').click(); 
            }

            partsContainer.innerHTML = ''; 

            if (data && data.length > 0) {
                data.forEach(partData => {
                    if (window.resolveArmorName && partData.armorName) {
                        partData.armorName = window.resolveArmorName(partData.armorName);
                    }
                    if (typeof window.addNewPart === 'function') {
                        window.addNewPart(partData, null, false);
                    }
                });
            } else {
                if (typeof window.addNewPart === 'function') window.addNewPart(null, null, false);
            }

            if (typeof window.syncDataFromListTab === 'function') window.syncDataFromListTab();
            if (typeof window.updateTop5Tab === 'function') window.updateTop5Tab(window.sharedArmorData);
            if (typeof window.updateCalcTab === 'function') window.updateCalcTab(window.sharedArmorData);
            
            // ã‚¯ãƒ©ã‚¦ãƒ‰èª­è¾¼æ™‚ã€LocalStorageã«ä¿å­˜ã•ã‚ŒãŸã€Œã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæœªå®Œäº†çŠ¶æ…‹ã€ã‚’ç¢ºèªã—ã¦å¾©å…ƒ
            if (typeof window.setDataDirty === 'function') {
                const isExportDirty = localStorage.getItem('RenmaArmorExportDirty') === 'true';
                if (isExportDirty) {
                    window.setDataDirty(true);
                } else {
                    // ãƒœã‚¿ãƒ³ã‚’é€šå¸¸çŠ¶æ…‹ã«æˆ»ã™
                    const exportButtons = document.querySelectorAll('#export-btn, #export-btn-footer');
                    exportButtons.forEach(button => {
                        button.classList.remove('needs-export');
                        button.textContent = 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
                    });
                }
            }
        }

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function updateStatus(state) {
            statusText.className = 'cloud-status';
            statusText.style.color = ''; 

            if (state === 'saving') {
                statusText.textContent = ''; 
                statusText.classList.add('saving');
            } else if (state === 'saved') {
                statusText.textContent = ''; 
                statusText.classList.add('saved');
            } else if (state === 'loading') {
                statusText.textContent = 'èª­è¾¼ä¸­...';
            } else if (state === 'loaded') {
                statusText.textContent = 'èª­è¾¼å®Œäº†';
                setTimeout(() => { statusText.textContent = ''; }, 3000);
            } else if (state === 'waiting') {
                statusText.textContent = 'æœªä¿å­˜ãƒ‡ãƒ¼ã‚¿æœ‰';
                statusText.style.color = '#ff4500'; 
            } else if (state === 'error') {
                statusText.textContent = 'ã‚¨ãƒ©ãƒ¼';
                statusText.classList.add('error');
            } else {
                statusText.textContent = '';
            }
        }

        function saveToLocalBackup() {
            if (window.sharedArmorData) {
                // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã‚­ãƒ¼ã«ä¿å­˜
                localStorage.setItem(CLOUD_TEMP_KEY, JSON.stringify(window.sharedArmorData));
            }
        }

        window.addEventListener('beforeunload', (e) => {
            if (statusText.classList.contains('saving')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && statusText.classList.contains('saving')) {
                if (autoSaveTimer) clearTimeout(autoSaveTimer);
                saveToCloud(); 
            }
        });
    }
</script>
</body>
</html>
